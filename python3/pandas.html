<!DOCTYPE html>
<html>
<head>
<title>Pandas</title>
<!-- 2018-02-21 Wed 21:55 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="Hao Ruan">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link href="http://fonts.googleapis.com/css?family=Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet" type="text/css" />
<link href="../org-html-themes/css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Pandas</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 核心数据结构</a>
<ul>
<li><a href="#sec-1-1">1.1. Panel</a></li>
<li><a href="#sec-1-2">1.2. Series</a>
<ul>
<li><a href="#sec-1-2-1">1.2.1. 创建</a>
<ul>
<li><a href="#sec-1-2-1-1">1.2.1.1. 从 ndarray 创建</a></li>
<li><a href="#sec-1-2-1-2">1.2.1.2. 从字典创建</a></li>
<li><a href="#sec-1-2-1-3">1.2.1.3. 从标量创建</a></li>
</ul>
</li>
<li><a href="#sec-1-2-2">1.2.2. 特性</a>
<ul>
<li><a href="#sec-1-2-2-1">1.2.2.1. 类 ndarray 对象</a></li>
<li><a href="#sec-1-2-2-2">1.2.2.2. 类字典对象</a></li>
<li><a href="#sec-1-2-2-3">1.2.2.3. 标签对齐</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-1-3">1.3. DataFrame</a>
<ul>
<li><a href="#sec-1-3-1">1.3.1. 创建</a>
<ul>
<li><a href="#sec-1-3-1-1">1.3.1.1. 从字典创建</a></li>
<li><a href="#sec-1-3-1-2">1.3.1.2. 从结构化数据列表创建</a></li>
<li><a href="#sec-1-3-1-3">1.3.1.3. 从字典列表创建</a></li>
<li><a href="#sec-1-3-1-4">1.3.1.4. 从元组字典创建</a></li>
<li><a href="#sec-1-3-1-5">1.3.1.5. 从 Series 创建</a></li>
<li><a href="#sec-1-3-1-6">1.3.1.6. 指定行列索引创建</a></li>
</ul>
</li>
<li><a href="#sec-1-3-2">1.3.2. 数据操作</a>
<ul>
<li><a href="#sec-1-3-2-1">1.3.2.1. 列选择(Series)</a></li>
<li><a href="#sec-1-3-2-2">1.3.2.2. 列选择(DataFrame)</a></li>
<li><a href="#sec-1-3-2-3">1.3.2.3. 列赋值</a></li>
<li><a href="#sec-1-3-2-4">1.3.2.4. 列删除</a></li>
<li><a href="#sec-1-3-2-5">1.3.2.5. 增加列</a>
<ul>
<li><a href="#sec-1-3-2-5-1">1.3.2.5.1. 添加到最后</a></li>
<li><a href="#sec-1-3-2-5-2">1.3.2.5.2. 指定位置添加</a></li>
<li><a href="#sec-1-3-2-5-3">1.3.2.5.3. assign()</a></li>
</ul>
</li>
<li><a href="#sec-1-3-2-6">1.3.2.6. 行选择(Series)</a></li>
<li><a href="#sec-1-3-2-7">1.3.2.7. 行选择(DataFrame)</a></li>
<li><a href="#sec-1-3-2-8">1.3.2.8. 行删除</a></li>
<li><a href="#sec-1-3-2-9">1.3.2.9. 增加行</a></li>
<li><a href="#sec-1-3-2-10">1.3.2.10. 行与列选择</a></li>
<li><a href="#sec-1-3-2-11">1.3.2.11. 选择指定坐标</a></li>
<li><a href="#sec-1-3-2-12">1.3.2.12. 数据对齐</a></li>
<li><a href="#sec-1-3-2-13">1.3.2.13. 使用 numpy 函数</a>
<ul>
<li><a href="#sec-1-3-2-13-1">1.3.2.13.1. DataFrame 转换为 ndarray 对象</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-2">2. 函数应用</a>
<ul>
<li><a href="#sec-2-1">2.1. 将数据按行或列进行计算(apply)</a>
<ul>
<li>
<ul>
<li><a href="#sec-2-1-0-1">2.1.0.1. 按列进行运算</a></li>
<li><a href="#sec-2-1-0-2">2.1.0.2. 按行进行运算</a></li>
<li><a href="#sec-2-1-0-3">2.1.0.3. 返回多个值组成的 Series</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-2-2">2.2. 逐元素运算(applymap)</a></li>
<li><a href="#sec-2-3">2.3. 排序(sort_values)</a>
<ul>
<li><a href="#sec-2-3-1">2.3.1. 按列排序</a></li>
<li><a href="#sec-2-3-2">2.3.2. 按行排序</a></li>
</ul>
</li>
<li><a href="#sec-2-4">2.4. 索引排序(sort_index)</a></li>
<li><a href="#sec-2-5">2.5. 排名(rank)</a></li>
<li><a href="#sec-2-6">2.6. Series 元素统计</a>
<ul>
<li><a href="#sec-2-6-1">2.6.1. 个数统计(value_counts)</a></li>
<li><a href="#sec-2-6-2">2.6.2. 唯一性统计(uniq)</a></li>
<li><a href="#sec-2-6-3">2.6.3. 成员资格统计(isin)</a></li>
</ul>
</li>
<li><a href="#sec-2-7">2.7. 出现最频繁值的统计(mode)</a></li>
<li><a href="#sec-2-8">2.8. 数据联结(concat)</a></li>
<li><a href="#sec-2-9">2.9. 数据合并(merge)</a></li>
<li><a href="#sec-2-10">2.10. 行列索引转换</a>
<ul>
<li><a href="#sec-2-10-1">2.10.1. 将列索引变为行索引 (stack)</a></li>
<li><a href="#sec-2-10-2">2.10.2. 将行索引变为列索引 (unstack)</a></li>
</ul>
</li>
<li><a href="#sec-2-11">2.11. 透视图（pivot_table）</a></li>
<li><a href="#sec-2-12">2.12. 数据分类(astype('category'))</a></li>
</ul>
</li>
<li><a href="#sec-3">3. 索引</a>
<ul>
<li><a href="#sec-3-1">3.1. 重新索引</a>
<ul>
<li><a href="#sec-3-1-1">3.1.1. Series</a>
<ul>
<li>
<ul>
<li><a href="#sec-3-1-1-0-1">3.1.1.0.1. 填充默认值</a></li>
<li><a href="#sec-3-1-1-0-2">3.1.1.0.2. 往前填充</a></li>
<li><a href="#sec-3-1-1-0-3">3.1.1.0.3. 往后填充</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-3-1-2">3.1.2. DataFrame</a>
<ul>
<li>
<ul>
<li><a href="#sec-3-1-2-0-1">3.1.2.0.1. 对行重新索引</a>
<ul>
<li><a href="#sec-3-1-2-0-1-1">3.1.2.0.1.1. 向前填充</a></li>
</ul>
</li>
<li><a href="#sec-3-1-2-0-2">3.1.2.0.2. 对列重新索引</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-3-2">3.2. 索引命名</a></li>
<li><a href="#sec-3-3">3.3. 重复索引</a>
<ul>
<li><a href="#sec-3-3-1">3.3.1. 对重复索引的处理（清洗）</a></li>
</ul>
</li>
<li><a href="#sec-3-4">3.4. 多级索引</a>
<ul>
<li><a href="#sec-3-4-1">3.4.1. 层次化索引的作用</a></li>
<li><a href="#sec-3-4-2">3.4.2. Series 多级索引</a>
<ul>
<li><a href="#sec-3-4-2-1">3.4.2.1. 创建</a></li>
<li><a href="#sec-3-4-2-2">3.4.2.2. 选取</a></li>
</ul>
</li>
<li><a href="#sec-3-4-3">3.4.3. DataFrame 多级索引</a>
<ul>
<li><a href="#sec-3-4-3-1">3.4.3.1. 创建</a></li>
<li><a href="#sec-3-4-3-2">3.4.3.2. 选取</a></li>
<li><a href="#sec-3-4-3-3">3.4.3.3. 多级索引交换</a></li>
<li><a href="#sec-3-4-3-4">3.4.3.4. 多级索引排序</a></li>
<li><a href="#sec-3-4-3-5">3.4.3.5. 多级索引统计</a></li>
<li><a href="#sec-3-4-3-6">3.4.3.6. 列与索引的转换</a>
<ul>
<li><a href="#sec-3-4-3-6-1">3.4.3.6.1. 列转换为索引</a></li>
<li><a href="#sec-3-4-3-6-2">3.4.3.6.2. 索引转换为列</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. 分组与聚合</a>
<ul>
<li><a href="#sec-4-1">4.1. 原理</a></li>
<li><a href="#sec-4-2">4.2. 分组</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. 对 Series 进行分组</a></li>
<li><a href="#sec-4-2-2">4.2.2. 对 DataFrame 进行分组（默认按行分组）</a></li>
<li><a href="#sec-4-2-3">4.2.3. 对分组对象进行迭代</a></li>
<li><a href="#sec-4-2-4">4.2.4. 通过字典进行分组</a></li>
<li><a href="#sec-4-2-5">4.2.5. 通过函数分组</a></li>
<li><a href="#sec-4-2-6">4.2.6. 多级索引数据根据索引级别来分组</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. 数据聚合</a>
<ul>
<li><a href="#sec-4-3-1">4.3.1. 内置聚合函数</a>
<ul>
<li><a href="#sec-4-3-1-1">4.3.1.1. sum</a></li>
<li><a href="#sec-4-3-1-2">4.3.1.2. mean</a></li>
<li><a href="#sec-4-3-1-3">4.3.1.3. size</a></li>
<li><a href="#sec-4-3-1-4">4.3.1.4. count</a></li>
<li><a href="#sec-4-3-1-5">4.3.1.5. min/max</a></li>
<li><a href="#sec-4-3-1-6">4.3.1.6. describe</a></li>
</ul>
</li>
<li><a href="#sec-4-3-2">4.3.2. 自定义聚合函数</a></li>
<li><a href="#sec-4-3-3">4.3.3. 应用多个聚合函数</a></li>
<li><a href="#sec-4-3-4">4.3.4. 给聚合后的列起别名</a></li>
<li><a href="#sec-4-3-5">4.3.5. 自定义需要显示的列</a></li>
<li><a href="#sec-4-3-6">4.3.6. 给不同的列应用不同的聚合函数</a></li>
<li><a href="#sec-4-3-7">4.3.7. 索引重置</a></li>
<li><a href="#sec-4-3-8">4.3.8. transform</a>
<ul>
<li><a href="#sec-4-3-8-1">4.3.8.1. 案例一（给每行都添加一个分组后的平均值）</a>
<ul>
<li><a href="#sec-4-3-8-1-1">4.3.8.1.1. 使用 merge 实现</a></li>
<li><a href="#sec-4-3-8-1-2">4.3.8.1.2. 使用 transform 实现</a></li>
</ul>
</li>
<li><a href="#sec-4-3-8-2">4.3.8.2. 案例二（计算分组后每个值与平均值的差异）</a></li>
</ul>
</li>
<li><a href="#sec-4-3-9">4.3.9. apply</a>
<ul>
<li><a href="#sec-4-3-9-1">4.3.9.1. 案例一（根据 column 排序，输出其最大的 n 行数据）</a></li>
<li><a href="#sec-4-3-9-2">4.3.9.2. 案例二（用不同的分组平均值填充空缺数据）</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">5. 处理丢失数据</a>
<ul>
<li><a href="#sec-5-1">5.1. 丢弃 NaN 行</a></li>
<li><a href="#sec-5-2">5.2. 用默认值替换 NaN</a></li>
<li><a href="#sec-5-3">5.3. 判断数据集是否包含 NaN</a></li>
<li><a href="#sec-5-4">5.4. NaN 不参与运算</a></li>
</ul>
</li>
<li><a href="#sec-6">6. 时间序列</a>
<ul>
<li><a href="#sec-6-1">6.1. 固定时刻(pd.Timestamp)</a>
<ul>
<li><a href="#sec-6-1-1">6.1.1. 日期范围(data_range)</a>
<ul>
<li><a href="#sec-6-1-1-1">6.1.1.1. 小时</a></li>
<li><a href="#sec-6-1-1-2">6.1.1.2. 日</a></li>
<li><a href="#sec-6-1-1-3">6.1.1.3. 星期</a></li>
<li><a href="#sec-6-1-1-4">6.1.1.4. 月</a></li>
<li><a href="#sec-6-1-1-5">6.1.1.5. 每个月最后一个工作日组成的索引</a></li>
<li><a href="#sec-6-1-1-6">6.1.1.6. 规则化时间戳</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-6-2">6.2. 固定时期(pd.Period)</a>
<ul>
<li><a href="#sec-6-2-1">6.2.1. 运算</a></li>
<li><a href="#sec-6-2-2">6.2.2. 时期范围</a>
<ul>
<li><a href="#sec-6-2-2-1">6.2.2.1. 月</a></li>
<li><a href="#sec-6-2-2-2">6.2.2.2. 季度</a></li>
</ul>
</li>
<li><a href="#sec-6-2-3">6.2.3. 频率转换</a>
<ul>
<li><a href="#sec-6-2-3-1">6.2.3.1. 年转月</a></li>
<li><a href="#sec-6-2-3-2">6.2.3.2. 指定年的结束月份</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-6-3">6.3. Timestamp 和 Period 相互转换</a></li>
<li><a href="#sec-6-4">6.4. 重采样</a>
<ul>
<li><a href="#sec-6-4-1">6.4.1. 降采样（高频率 -&gt; 低频率）</a>
<ul>
<li><a href="#sec-6-4-1-1">6.4.1.1. 起始时间为行索引</a></li>
<li><a href="#sec-6-4-1-2">6.4.1.2. 结束时间为行索引</a></li>
<li><a href="#sec-6-4-1-3">6.4.1.3. OHLC 重采样</a></li>
</ul>
</li>
<li><a href="#sec-6-4-2">6.4.2. 升采样/插值（低频率 -&gt; 高频率）</a></li>
</ul>
</li>
<li><a href="#sec-6-5">6.5. 时期重采样</a>
<ul>
<li><a href="#sec-6-5-1">6.5.1. 降采样</a></li>
<li><a href="#sec-6-5-2">6.5.2. 升采样</a></li>
</ul>
</li>
<li><a href="#sec-6-6">6.6. 从文件中读取日期序列</a>
<ul>
<li><a href="#sec-6-6-1">6.6.1. 自定义时间日期解析函数</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-7">7. 可视化</a>
<ul>
<li><a href="#sec-7-1">7.1. 线形图</a></li>
<li><a href="#sec-7-2">7.2. 柱状图</a></li>
<li><a href="#sec-7-3">7.3. 直方图</a>
<ul>
<li><a href="#sec-7-3-1">7.3.1. 密度图</a></li>
<li><a href="#sec-7-3-2">7.3.2. 带密度估计的直方图</a></li>
</ul>
</li>
<li><a href="#sec-7-4">7.4. 散布图</a></li>
<li><a href="#sec-7-5">7.5. 饼图</a></li>
<li><a href="#sec-7-6">7.6. 高级绘图函数</a></li>
</ul>
</li>
<li><a href="#sec-8">8. 导入导出</a>
<ul>
<li><a href="#sec-8-1">8.1. 读入 csv</a>
<ul>
<li><a href="#sec-8-1-1">8.1.1. 处理列名缺失</a></li>
<li><a href="#sec-8-1-2">8.1.2. 指定某一列作为行索引</a></li>
<li><a href="#sec-8-1-3">8.1.3. 处理不规则分隔符</a></li>
<li><a href="#sec-8-1-4">8.1.4. 处理缺失值</a></li>
<li><a href="#sec-8-1-5">8.1.5. 逐块读取</a>
<ul>
<li><a href="#sec-8-1-5-1">8.1.5.1. 按行读取</a></li>
<li><a href="#sec-8-1-5-2">8.1.5.2. 按 chunk 读取</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-8-2">8.2. 导出 csv</a>
<ul>
<li><a href="#sec-8-2-1">8.2.1. 不导出索引（推荐）</a></li>
<li><a href="#sec-8-2-2">8.2.2. 不导出列名</a></li>
<li><a href="#sec-8-2-3">8.2.3. 指定分隔符</a></li>
<li><a href="#sec-8-2-4">8.2.4. 导出部分列</a></li>
</ul>
</li>
<li><a href="#sec-8-3">8.3. 其他格式</a></li>
</ul>
</li>
<li><a href="#sec-9">9. 示例工程</a>
<ul>
<li><a href="#sec-9-1">9.1. 电影数据分析</a>
<ul>
<li><a href="#sec-9-1-1">9.1.1. 数据读取</a></li>
<li><a href="#sec-9-1-2">9.1.2. 数据合并 (merge)</a></li>
<li><a href="#sec-9-1-3">9.1.3. 按性别查看各个电影的平均评分 (pivot_table)</a></li>
<li><a href="#sec-9-1-4">9.1.4. 男女意见想差最大的电影 (sort_values)</a></li>
<li><a href="#sec-9-1-5">9.1.5. 参与评分人数最多 (group_by)</a></li>
<li><a href="#sec-9-1-6">9.1.6. 活跃度超过 1000 的高分电影</a></li>
</ul>
</li>
<li><a href="#sec-9-2">9.2. 股票数据分析</a>
<ul>
<li><a href="#sec-9-2-1">9.2.1. 导入数据</a></li>
<li><a href="#sec-9-2-2">9.2.2. 分析波动幅度</a>
<ul>
<li><a href="#sec-9-2-2-1">9.2.2.1. 针对复权收盘价进行重采样</a></li>
<li><a href="#sec-9-2-2-2">9.2.2.2. 计算平均波动幅度</a></li>
</ul>
</li>
<li><a href="#sec-9-2-3">9.2.3. 分析价格变化</a></li>
<li><a href="#sec-9-2-4">9.2.4. 最大年均复合增长率</a></li>
<li><a href="#sec-9-2-5">9.2.5. 当前年均复合增长率</a></li>
<li><a href="#sec-9-2-6">9.2.6. 平均年化增长率</a></li>
</ul>
</li>
<li><a href="#sec-9-3">9.3. 小市值策略分析</a>
<ul>
<li><a href="#sec-9-3-1">9.3.1. 导入数据</a></li>
<li><a href="#sec-9-3-2">9.3.2. 按照交易日期，股票代码排序</a></li>
<li><a href="#sec-9-3-3">9.3.3. 设定分析起始日期</a></li>
<li><a href="#sec-9-3-4">9.3.4. 过滤不符合分析要求的股票</a></li>
<li><a href="#sec-9-3-5">9.3.5. 计算所有股票平均涨幅</a></li>
<li><a href="#sec-9-3-6">9.3.6. 选取低市值股票</a>
<ul>
<li><a href="#sec-9-3-6-1">9.3.6.1. 计算每月市值排名</a></li>
<li><a href="#sec-9-3-6-2">9.3.6.2. 选取市值排名前十低的股票</a></li>
</ul>
</li>
<li><a href="#sec-9-3-7">9.3.7. 计算低市值股票平均涨幅</a></li>
<li><a href="#sec-9-3-8">9.3.8. 统计绘图</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-10">10. 参考资料</a></li>
</ul>
</div>
</div>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 核心数据结构</a>
<ul>
<li><a href="#sec-1-1">1.1. Panel</a></li>
<li><a href="#sec-1-2">1.2. Series</a>
<ul>
<li><a href="#sec-1-2-1">1.2.1. 创建</a>
<ul>
<li><a href="#sec-1-2-1-1">1.2.1.1. 从 ndarray 创建</a></li>
<li><a href="#sec-1-2-1-2">1.2.1.2. 从字典创建</a></li>
<li><a href="#sec-1-2-1-3">1.2.1.3. 从标量创建</a></li>
</ul>
</li>
<li><a href="#sec-1-2-2">1.2.2. 特性</a>
<ul>
<li><a href="#sec-1-2-2-1">1.2.2.1. 类 ndarray 对象</a></li>
<li><a href="#sec-1-2-2-2">1.2.2.2. 类字典对象</a></li>
<li><a href="#sec-1-2-2-3">1.2.2.3. 标签对齐</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-1-3">1.3. DataFrame</a>
<ul>
<li><a href="#sec-1-3-1">1.3.1. 创建</a>
<ul>
<li><a href="#sec-1-3-1-1">1.3.1.1. 从字典创建</a></li>
<li><a href="#sec-1-3-1-2">1.3.1.2. 从结构化数据列表创建</a></li>
<li><a href="#sec-1-3-1-3">1.3.1.3. 从字典列表创建</a></li>
<li><a href="#sec-1-3-1-4">1.3.1.4. 从元组字典创建</a></li>
<li><a href="#sec-1-3-1-5">1.3.1.5. 从 Series 创建</a></li>
<li><a href="#sec-1-3-1-6">1.3.1.6. 指定行列索引创建</a></li>
</ul>
</li>
<li><a href="#sec-1-3-2">1.3.2. 数据操作</a>
<ul>
<li><a href="#sec-1-3-2-1">1.3.2.1. 列选择(Series)</a></li>
<li><a href="#sec-1-3-2-2">1.3.2.2. 列选择(DataFrame)</a></li>
<li><a href="#sec-1-3-2-3">1.3.2.3. 列赋值</a></li>
<li><a href="#sec-1-3-2-4">1.3.2.4. 列删除</a></li>
<li><a href="#sec-1-3-2-5">1.3.2.5. 增加列</a></li>
<li><a href="#sec-1-3-2-6">1.3.2.6. 行选择(Series)</a></li>
<li><a href="#sec-1-3-2-7">1.3.2.7. 行选择(DataFrame)</a></li>
<li><a href="#sec-1-3-2-8">1.3.2.8. 行删除</a></li>
<li><a href="#sec-1-3-2-9">1.3.2.9. 增加行</a></li>
<li><a href="#sec-1-3-2-10">1.3.2.10. 行与列选择</a></li>
<li><a href="#sec-1-3-2-11">1.3.2.11. 选择指定坐标</a></li>
<li><a href="#sec-1-3-2-12">1.3.2.12. 数据对齐</a></li>
<li><a href="#sec-1-3-2-13">1.3.2.13. 使用 numpy 函数</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-2">2. 函数应用</a>
<ul>
<li><a href="#sec-2-1">2.1. 将数据按行或列进行计算(apply)</a>
<ul>
<li>
<ul>
<li><a href="#sec-2-1-0-1">2.1.0.1. 按列进行运算</a></li>
<li><a href="#sec-2-1-0-2">2.1.0.2. 按行进行运算</a></li>
<li><a href="#sec-2-1-0-3">2.1.0.3. 返回多个值组成的 Series</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-2-2">2.2. 逐元素运算(applymap)</a></li>
<li><a href="#sec-2-3">2.3. 排序(sort_values)</a>
<ul>
<li><a href="#sec-2-3-1">2.3.1. 按列排序</a></li>
<li><a href="#sec-2-3-2">2.3.2. 按行排序</a></li>
</ul>
</li>
<li><a href="#sec-2-4">2.4. 索引排序(sort_index)</a></li>
<li><a href="#sec-2-5">2.5. 排名(rank)</a></li>
<li><a href="#sec-2-6">2.6. Series 元素统计</a>
<ul>
<li><a href="#sec-2-6-1">2.6.1. 个数统计(value_counts)</a></li>
<li><a href="#sec-2-6-2">2.6.2. 唯一性统计(uniq)</a></li>
<li><a href="#sec-2-6-3">2.6.3. 成员资格统计(isin)</a></li>
</ul>
</li>
<li><a href="#sec-2-7">2.7. 出现最频繁值的统计(mode)</a></li>
<li><a href="#sec-2-8">2.8. 数据联结(concat)</a></li>
<li><a href="#sec-2-9">2.9. 数据合并(merge)</a></li>
<li><a href="#sec-2-10">2.10. 行列索引转换</a>
<ul>
<li><a href="#sec-2-10-1">2.10.1. 将列索引变为行索引 (stack)</a></li>
<li><a href="#sec-2-10-2">2.10.2. 将行索引变为列索引 (unstack)</a></li>
</ul>
</li>
<li><a href="#sec-2-11">2.11. 透视图（pivot_table）</a></li>
<li><a href="#sec-2-12">2.12. 数据分类(astype('category'))</a></li>
</ul>
</li>
<li><a href="#sec-3">3. 索引</a>
<ul>
<li><a href="#sec-3-1">3.1. 重新索引</a>
<ul>
<li><a href="#sec-3-1-1">3.1.1. Series</a></li>
<li><a href="#sec-3-1-2">3.1.2. DataFrame</a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2. 索引命名</a></li>
<li><a href="#sec-3-3">3.3. 重复索引</a>
<ul>
<li><a href="#sec-3-3-1">3.3.1. 对重复索引的处理（清洗）</a></li>
</ul>
</li>
<li><a href="#sec-3-4">3.4. 多级索引</a>
<ul>
<li><a href="#sec-3-4-1">3.4.1. 层次化索引的作用</a></li>
<li><a href="#sec-3-4-2">3.4.2. Series 多级索引</a>
<ul>
<li><a href="#sec-3-4-2-1">3.4.2.1. 创建</a></li>
<li><a href="#sec-3-4-2-2">3.4.2.2. 选取</a></li>
</ul>
</li>
<li><a href="#sec-3-4-3">3.4.3. DataFrame 多级索引</a>
<ul>
<li><a href="#sec-3-4-3-1">3.4.3.1. 创建</a></li>
<li><a href="#sec-3-4-3-2">3.4.3.2. 选取</a></li>
<li><a href="#sec-3-4-3-3">3.4.3.3. 多级索引交换</a></li>
<li><a href="#sec-3-4-3-4">3.4.3.4. 多级索引排序</a></li>
<li><a href="#sec-3-4-3-5">3.4.3.5. 多级索引统计</a></li>
<li><a href="#sec-3-4-3-6">3.4.3.6. 列与索引的转换</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. 分组与聚合</a>
<ul>
<li><a href="#sec-4-1">4.1. 原理</a></li>
<li><a href="#sec-4-2">4.2. 分组</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. 对 Series 进行分组</a></li>
<li><a href="#sec-4-2-2">4.2.2. 对 DataFrame 进行分组（默认按行分组）</a></li>
<li><a href="#sec-4-2-3">4.2.3. 对分组对象进行迭代</a></li>
<li><a href="#sec-4-2-4">4.2.4. 通过字典进行分组</a></li>
<li><a href="#sec-4-2-5">4.2.5. 通过函数分组</a></li>
<li><a href="#sec-4-2-6">4.2.6. 多级索引数据根据索引级别来分组</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. 数据聚合</a>
<ul>
<li><a href="#sec-4-3-1">4.3.1. 内置聚合函数</a>
<ul>
<li><a href="#sec-4-3-1-1">4.3.1.1. sum</a></li>
<li><a href="#sec-4-3-1-2">4.3.1.2. mean</a></li>
<li><a href="#sec-4-3-1-3">4.3.1.3. size</a></li>
<li><a href="#sec-4-3-1-4">4.3.1.4. count</a></li>
<li><a href="#sec-4-3-1-5">4.3.1.5. min/max</a></li>
<li><a href="#sec-4-3-1-6">4.3.1.6. describe</a></li>
</ul>
</li>
<li><a href="#sec-4-3-2">4.3.2. 自定义聚合函数</a></li>
<li><a href="#sec-4-3-3">4.3.3. 应用多个聚合函数</a></li>
<li><a href="#sec-4-3-4">4.3.4. 给聚合后的列起别名</a></li>
<li><a href="#sec-4-3-5">4.3.5. 自定义需要显示的列</a></li>
<li><a href="#sec-4-3-6">4.3.6. 给不同的列应用不同的聚合函数</a></li>
<li><a href="#sec-4-3-7">4.3.7. 索引重置</a></li>
<li><a href="#sec-4-3-8">4.3.8. transform</a>
<ul>
<li><a href="#sec-4-3-8-1">4.3.8.1. 案例一（给每行都添加一个分组后的平均值）</a></li>
<li><a href="#sec-4-3-8-2">4.3.8.2. 案例二（计算分组后每个值与平均值的差异）</a></li>
</ul>
</li>
<li><a href="#sec-4-3-9">4.3.9. apply</a>
<ul>
<li><a href="#sec-4-3-9-1">4.3.9.1. 案例一（根据 column 排序，输出其最大的 n 行数据）</a></li>
<li><a href="#sec-4-3-9-2">4.3.9.2. 案例二（用不同的分组平均值填充空缺数据）</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">5. 处理丢失数据</a>
<ul>
<li><a href="#sec-5-1">5.1. 丢弃 NaN 行</a></li>
<li><a href="#sec-5-2">5.2. 用默认值替换 NaN</a></li>
<li><a href="#sec-5-3">5.3. 判断数据集是否包含 NaN</a></li>
<li><a href="#sec-5-4">5.4. NaN 不参与运算</a></li>
</ul>
</li>
<li><a href="#sec-6">6. 时间序列</a>
<ul>
<li><a href="#sec-6-1">6.1. 固定时刻(pd.Timestamp)</a>
<ul>
<li><a href="#sec-6-1-1">6.1.1. 日期范围(data_range)</a>
<ul>
<li><a href="#sec-6-1-1-1">6.1.1.1. 小时</a></li>
<li><a href="#sec-6-1-1-2">6.1.1.2. 日</a></li>
<li><a href="#sec-6-1-1-3">6.1.1.3. 星期</a></li>
<li><a href="#sec-6-1-1-4">6.1.1.4. 月</a></li>
<li><a href="#sec-6-1-1-5">6.1.1.5. 每个月最后一个工作日组成的索引</a></li>
<li><a href="#sec-6-1-1-6">6.1.1.6. 规则化时间戳</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-6-2">6.2. 固定时期(pd.Period)</a>
<ul>
<li><a href="#sec-6-2-1">6.2.1. 运算</a></li>
<li><a href="#sec-6-2-2">6.2.2. 时期范围</a>
<ul>
<li><a href="#sec-6-2-2-1">6.2.2.1. 月</a></li>
<li><a href="#sec-6-2-2-2">6.2.2.2. 季度</a></li>
</ul>
</li>
<li><a href="#sec-6-2-3">6.2.3. 频率转换</a>
<ul>
<li><a href="#sec-6-2-3-1">6.2.3.1. 年转月</a></li>
<li><a href="#sec-6-2-3-2">6.2.3.2. 指定年的结束月份</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-6-3">6.3. Timestamp 和 Period 相互转换</a></li>
<li><a href="#sec-6-4">6.4. 重采样</a>
<ul>
<li><a href="#sec-6-4-1">6.4.1. 降采样（高频率 -&gt; 低频率）</a>
<ul>
<li><a href="#sec-6-4-1-1">6.4.1.1. 起始时间为行索引</a></li>
<li><a href="#sec-6-4-1-2">6.4.1.2. 结束时间为行索引</a></li>
<li><a href="#sec-6-4-1-3">6.4.1.3. OHLC 重采样</a></li>
</ul>
</li>
<li><a href="#sec-6-4-2">6.4.2. 升采样/插值（低频率 -&gt; 高频率）</a></li>
</ul>
</li>
<li><a href="#sec-6-5">6.5. 时期重采样</a>
<ul>
<li><a href="#sec-6-5-1">6.5.1. 降采样</a></li>
<li><a href="#sec-6-5-2">6.5.2. 升采样</a></li>
</ul>
</li>
<li><a href="#sec-6-6">6.6. 从文件中读取日期序列</a>
<ul>
<li><a href="#sec-6-6-1">6.6.1. 自定义时间日期解析函数</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-7">7. 可视化</a>
<ul>
<li><a href="#sec-7-1">7.1. 线形图</a></li>
<li><a href="#sec-7-2">7.2. 柱状图</a></li>
<li><a href="#sec-7-3">7.3. 直方图</a>
<ul>
<li><a href="#sec-7-3-1">7.3.1. 密度图</a></li>
<li><a href="#sec-7-3-2">7.3.2. 带密度估计的直方图</a></li>
</ul>
</li>
<li><a href="#sec-7-4">7.4. 散布图</a></li>
<li><a href="#sec-7-5">7.5. 饼图</a></li>
<li><a href="#sec-7-6">7.6. 高级绘图函数</a></li>
</ul>
</li>
<li><a href="#sec-8">8. 导入导出</a>
<ul>
<li><a href="#sec-8-1">8.1. 读入 csv</a>
<ul>
<li><a href="#sec-8-1-1">8.1.1. 处理列名缺失</a></li>
<li><a href="#sec-8-1-2">8.1.2. 指定某一列作为行索引</a></li>
<li><a href="#sec-8-1-3">8.1.3. 处理不规则分隔符</a></li>
<li><a href="#sec-8-1-4">8.1.4. 处理缺失值</a></li>
<li><a href="#sec-8-1-5">8.1.5. 逐块读取</a>
<ul>
<li><a href="#sec-8-1-5-1">8.1.5.1. 按行读取</a></li>
<li><a href="#sec-8-1-5-2">8.1.5.2. 按 chunk 读取</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-8-2">8.2. 导出 csv</a>
<ul>
<li><a href="#sec-8-2-1">8.2.1. 不导出索引（推荐）</a></li>
<li><a href="#sec-8-2-2">8.2.2. 不导出列名</a></li>
<li><a href="#sec-8-2-3">8.2.3. 指定分隔符</a></li>
<li><a href="#sec-8-2-4">8.2.4. 导出部分列</a></li>
</ul>
</li>
<li><a href="#sec-8-3">8.3. 其他格式</a></li>
</ul>
</li>
<li><a href="#sec-9">9. 示例工程</a>
<ul>
<li><a href="#sec-9-1">9.1. 电影数据分析</a>
<ul>
<li><a href="#sec-9-1-1">9.1.1. 数据读取</a></li>
<li><a href="#sec-9-1-2">9.1.2. 数据合并 (merge)</a></li>
<li><a href="#sec-9-1-3">9.1.3. 按性别查看各个电影的平均评分 (pivot_table)</a></li>
<li><a href="#sec-9-1-4">9.1.4. 男女意见想差最大的电影 (sort_values)</a></li>
<li><a href="#sec-9-1-5">9.1.5. 参与评分人数最多 (group_by)</a></li>
<li><a href="#sec-9-1-6">9.1.6. 活跃度超过 1000 的高分电影</a></li>
</ul>
</li>
<li><a href="#sec-9-2">9.2. 股票数据分析</a>
<ul>
<li><a href="#sec-9-2-1">9.2.1. 导入数据</a></li>
<li><a href="#sec-9-2-2">9.2.2. 分析波动幅度</a>
<ul>
<li><a href="#sec-9-2-2-1">9.2.2.1. 针对复权收盘价进行重采样</a></li>
<li><a href="#sec-9-2-2-2">9.2.2.2. 计算平均波动幅度</a></li>
</ul>
</li>
<li><a href="#sec-9-2-3">9.2.3. 分析价格变化</a></li>
<li><a href="#sec-9-2-4">9.2.4. 最大年均复合增长率</a></li>
<li><a href="#sec-9-2-5">9.2.5. 当前年均复合增长率</a></li>
<li><a href="#sec-9-2-6">9.2.6. 平均年化增长率</a></li>
</ul>
</li>
<li><a href="#sec-9-3">9.3. 小市值策略分析</a>
<ul>
<li><a href="#sec-9-3-1">9.3.1. 导入数据</a></li>
<li><a href="#sec-9-3-2">9.3.2. 按照交易日期，股票代码排序</a></li>
<li><a href="#sec-9-3-3">9.3.3. 设定分析起始日期</a></li>
<li><a href="#sec-9-3-4">9.3.4. 过滤不符合分析要求的股票</a></li>
<li><a href="#sec-9-3-5">9.3.5. 计算所有股票平均涨幅</a></li>
<li><a href="#sec-9-3-6">9.3.6. 选取低市值股票</a>
<ul>
<li><a href="#sec-9-3-6-1">9.3.6.1. 计算每月市值排名</a></li>
<li><a href="#sec-9-3-6-2">9.3.6.2. 选取市值排名前十低的股票</a></li>
</ul>
</li>
<li><a href="#sec-9-3-7">9.3.7. 计算低市值股票平均涨幅</a></li>
<li><a href="#sec-9-3-8">9.3.8. 统计绘图</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-10">10. 参考资料</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="meta">
<table>


<colgroup>
<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="left">Author</td>
<td class="left">Hao Ruan (haoru@cisco.com)</td>
</tr>

<tr>
<td class="left">Date</td>
<td class="left">2018-02-21 21:52:40</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 核心数据结构</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Panel</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Panel 是三维带标签的数组。
</p>

<p>
Panel 由三个标签组成：
</p>

<dl class="org-dl">
<dt> items </dt><dd>坐标轴 0 ，索引对应的元素是一个 DataFrame
</dd>
<dt> major_axis </dt><dd>坐标轴 1 , DataFrame 里的行标签
</dd>
<dt> minor_axis </dt><dd>坐标轴 2 , DataFrame 里的列标签
</dd>
</dl>
</div>
</div>



<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Series</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Series 是一维带标签的数组，数组里可以放任意的数据（整数，浮点数，字符串，Python Object）。
</p>

<p>
其基本的创建函数是： <code>pd.Series(data, index=index)</code>
</p>

<p>
其中 index 是一个列表，用来作为数据的标签。data 可以是不同的数据类型：
</p>

<ul class="org-ul">
<li>Python 字典
</li>
<li>ndarray 对象
</li>
<li>一个标量值，如 5
</li>
</ul>
</div>

<div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> 创建</h4>
<div class="outline-text-4" id="text-1-2-1">
</div><div id="outline-container-sec-1-2-1-1" class="outline-5">
<h5 id="sec-1-2-1-1"><span class="section-number-5">1.2.1.1</span> 从 ndarray 创建</h5>
<div class="outline-text-5" id="text-1-2-1-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(np.random.randn(5), index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'e'</span>])
log(<span style="color: #ff4ea3;">"s"</span>, s)
log(<span style="color: #ff4ea3;">"s.index"</span>, s.index)
<span style="color: #ff8700;">s2</span> = pd.Series(np.random.randn(5))
log(<span style="color: #ff4ea3;">"s2"</span>, s2)
log(<span style="color: #ff4ea3;">"s2.index"</span>, s2.index)
</pre>
</div>

<pre class="example">
====================================== s =======================================
a    2.100013
b    0.310119
c   -0.989646
d   -0.756308
e   -1.137259
dtype: float64
=================================== s.index ====================================
Index(['a', 'b', 'c', 'd', 'e'], dtype='object')
====================================== s2 ======================================
0    0.402350
1    0.665836
2    1.344499
3    0.748183
4    0.288010
dtype: float64
=================================== s2.index ===================================
RangeIndex(start=0, stop=5, step=1)
</pre>
</div>
</div>

<div id="outline-container-sec-1-2-1-2" class="outline-5">
<h5 id="sec-1-2-1-2"><span class="section-number-5">1.2.1.2</span> 从字典创建</h5>
<div class="outline-text-5" id="text-1-2-1-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">d</span> = {<span style="color: #ff4ea3;">'a'</span> : 0., <span style="color: #ff4ea3;">'b'</span> : 1., <span style="color: #ff4ea3;">'d'</span> : 3}
<span style="color: #ff8700;">s</span> = pd.Series(d, index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcd'</span>))
log(<span style="color: #ff4ea3;">"s"</span>, s)
</pre>
</div>

<pre class="example">
====================================== s =======================================
a    0.0
b    1.0
c    NaN
d    3.0
dtype: float64
</pre>
</div>
</div>

<div id="outline-container-sec-1-2-1-3" class="outline-5">
<h5 id="sec-1-2-1-3"><span class="section-number-5">1.2.1.3</span> 从标量创建</h5>
<div class="outline-text-5" id="text-1-2-1-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(3, index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcde'</span>))
log(<span style="color: #ff4ea3;">"s"</span>, s)
</pre>
</div>

<pre class="example">
====================================== s =======================================
a    3
b    3
c    3
d    3
e    3
dtype: int64
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> 特性</h4>
<div class="outline-text-4" id="text-1-2-2">
</div><div id="outline-container-sec-1-2-2-1" class="outline-5">
<h5 id="sec-1-2-2-1"><span class="section-number-5">1.2.2.1</span> 类 ndarray 对象</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(np.random.randn(5))

log(<span style="color: #ff4ea3;">"s[0]"</span>, s[0])
log(<span style="color: #ff4ea3;">"s[:3]"</span>, s[:3])
log(<span style="color: #ff4ea3;">"s[[1, 3, 4]]"</span>, s[[1, 3, 4]])
log(<span style="color: #ff4ea3;">"np.exp(s)"</span>, np.exp(s))
log(<span style="color: #ff4ea3;">"np.sin(s)"</span>, np.sin(s))
</pre>
</div>

<pre class="example">
===================================== s[0] =====================================
1.5776697888512055
==================================== s[:3] =====================================
0    1.577670
1    1.531556
2    0.616357
dtype: float64
================================= s[[1, 3, 4]] =================================
1    1.531556
3    0.200175
4   -0.264828
dtype: float64
================================== np.exp(s) ===================================
0    4.843656
1    4.625370
2    1.852168
3    1.221617
4    0.767338
dtype: float64
================================== np.sin(s) ===================================
0    0.999976
1    0.999230
2    0.578066
3    0.198841
4   -0.261743
dtype: float64
</pre>
</div>
</div>


<div id="outline-container-sec-1-2-2-2" class="outline-5">
<h5 id="sec-1-2-2-2"><span class="section-number-5">1.2.2.2</span> 类字典对象</h5>
<div class="outline-text-5" id="text-1-2-2-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(np.random.randn(5), index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'e'</span>])
<span style="color: #ff8700;">s</span>[<span style="color: #ff4ea3;">'e'</span>] = 5
log(<span style="color: #ff4ea3;">"s"</span>, s)
log(<span style="color: #ff4ea3;">"'e' in s"</span>, <span style="color: #ff4ea3;">'e'</span> <span style="color: #a1db00;">in</span> s)
log(<span style="color: #ff4ea3;">"s.get('f', np.nan)"</span>, s.get(<span style="color: #ff4ea3;">'f'</span>, np.nan))
</pre>
</div>

<pre class="example">
====================================== s =======================================
a    0.313574
b    1.412671
c    0.558592
d    1.575591
e    5.000000
dtype: float64
=================================== 'e' in s ===================================
True
============================== s.get('f', np.nan) ==============================
nan
</pre>
</div>
</div>


<div id="outline-container-sec-1-2-2-3" class="outline-5">
<h5 id="sec-1-2-2-3"><span class="section-number-5">1.2.2.3</span> 标签对齐</h5>
<div class="outline-text-5" id="text-1-2-2-3">
<p>
相同索引值才进行操作
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s1</span> = pd.Series(np.random.randn(3), index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'e'</span>])
<span style="color: #ff8700;">s2</span> = pd.Series(np.random.randn(3), index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'e'</span>])

log(<span style="color: #ff4ea3;">"s1"</span>, s1)
log(<span style="color: #ff4ea3;">"s2"</span>, s2)


log(<span style="color: #ff4ea3;">"s1 + s2"</span>, s1 + s2)
</pre>
</div>

<pre class="example">
====================================== s1 ======================================
a    1.861968
c   -0.937306
e    0.739111
dtype: float64
====================================== s2 ======================================
a    0.537091
d   -0.527021
e   -0.576973
dtype: float64
=================================== s1 + s2 ====================================
a    2.399058
c         NaN
d         NaN
e    0.162138
dtype: float64
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> DataFrame</h3>
<div class="outline-text-3" id="text-1-3">
<p>
DataFrame 是 <b>二维带行标签和列标签的数组</b> 。
</p>

<p>
可以把 DataFrame 想象成一个 Excel 表格或一个 SQL 数据库的表格，还可以想象成是一个 Series 对象字典。
</p>

<p>
它是 Pandas 里最常用的数据结构。
</p>

<p>
创建 DataFrame 的基本格式是：
</p>

<div class="org-src-container">

<pre class="src src-ipython">pd.DataFrame(data, index=index, columns=columns)
</pre>
</div>

<p>
其中 index 是行标签，columns 是列标签，data 可以是下面的数据：
</p>

<ul class="org-ul">
<li>由一维 numpy 数组，list，Series 构成的字典
</li>
<li>二维 numpy 数组
</li>
<li>一个 Series
</li>
<li>另外的 DataFrame 对象
</li>
</ul>
</div>

<div id="outline-container-sec-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><span class="section-number-4">1.3.1</span> 创建</h4>
<div class="outline-text-4" id="text-1-3-1">
</div><div id="outline-container-sec-1-3-1-1" class="outline-5">
<h5 id="sec-1-3-1-1"><span class="section-number-5">1.3.1.1</span> 从字典创建</h5>
<div class="outline-text-5" id="text-1-3-1-1">
<p>
key 为 DataFrame 的列；value 为对应列下的值
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">d</span> = {<span style="color: #ff4ea3;">'one'</span> : pd.Series([1, 2, 3], index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>]),
     <span style="color: #ff4ea3;">'two'</span> : pd.Series([1, 2, 3, 4], index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>])}

log(<span style="color: #ff4ea3;">"pd.DataFrame(d)"</span>, pd.DataFrame(d))
log(<span style="color: #ff4ea3;">"pd.DataFrame(d, index=['d', 'b', 'a'])"</span>, pd.DataFrame(d, index=[<span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>]))
log(<span style="color: #ff4ea3;">"pd.DataFrame(d, index=['d', 'b', 'a'], columns=['two', 'three'])"</span>,
    pd.DataFrame(d, index=[<span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>], columns=[<span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>]))
</pre>
</div>

<pre class="example">
=============================== pd.DataFrame(d) ================================
   one  two
a  1.0    1
b  2.0    2
c  3.0    3
d  NaN    4
==================== pd.DataFrame(d, index=['d', 'b', 'a']) ====================
   one  two
d  NaN    4
b  2.0    2
a  1.0    1
======= pd.DataFrame(d, index=['d', 'b', 'a'], columns=['two', 'three']) =======
   two three
d    4   NaN
b    2   NaN
a    1   NaN
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">d</span> = {<span style="color: #ff4ea3;">'one'</span> : [1, 2, 3, 4],
     <span style="color: #ff4ea3;">'two'</span> : [21, 22, 23, 24]}

log(<span style="color: #ff4ea3;">"pd.DataFrame(d)"</span>, pd.DataFrame(d))
log(<span style="color: #ff4ea3;">"pd.DataFrame(d, index=['a', 'b', 'c', 'd'])"</span>, pd.DataFrame(d, index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>]))
</pre>
</div>

<pre class="example">
=============================== pd.DataFrame(d) ================================
   one  two
0    1   21
1    2   22
2    3   23
3    4   24
================= pd.DataFrame(d, index=['a', 'b', 'c', 'd']) ==================
   one  two
a    1   21
b    2   22
c    3   23
d    4   24
</pre>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({
                  <span style="color: #ff4ea3;">'A'</span>: 1,
                  <span style="color: #ff4ea3;">'B'</span>: pd.Timestamp(<span style="color: #ff4ea3;">'20160301'</span>),
                  <span style="color: #ff4ea3;">'C'</span>: <span style="color: #d18aff;">range</span>(4),
                  <span style="color: #ff4ea3;">'D'</span>: np.arange(5, 9),
                  <span style="color: #ff4ea3;">'E'</span>: <span style="color: #ff4ea3;">'text'</span>,
                  <span style="color: #ff4ea3;">'F'</span>: [<span style="color: #ff4ea3;">'AA'</span>, <span style="color: #ff4ea3;">'BB'</span>, <span style="color: #ff4ea3;">'CC'</span>, <span style="color: #ff4ea3;">'DD'</span>]})
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
   A          B  C  D     E   F
0  1 2016-03-01  0  5  text  AA
1  1 2016-03-01  1  6  text  BB
2  1 2016-03-01  2  7  text  CC
3  1 2016-03-01  3  8  text  DD
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-1-2" class="outline-5">
<h5 id="sec-1-3-1-2"><span class="section-number-5">1.3.1.2</span> 从结构化数据列表创建</h5>
<div class="outline-text-5" id="text-1-3-1-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">data</span> = [(1, 2.2, <span style="color: #ff4ea3;">'Hello'</span>), (2, 3., <span style="color: #ff4ea3;">"World"</span>)]

log(<span style="color: #ff4ea3;">"pd.DataFrame(data)"</span>, pd.DataFrame(data))
log(<span style="color: #ff4ea3;">"pd.DataFrame(data, index=['first', 'second'], columns=['A', 'B', 'C'])"</span>,
    pd.DataFrame(data, index=[<span style="color: #ff4ea3;">'first'</span>, <span style="color: #ff4ea3;">'second'</span>], columns=[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>, <span style="color: #ff4ea3;">'C'</span>]))
</pre>
</div>

<pre class="example">
============================== pd.DataFrame(data) ==============================
   0    1      2
0  1  2.2  Hello
1  2  3.0  World
==== pd.DataFrame(data, index=['first', 'second'], columns=['A', 'B', 'C']) ====
        A    B      C
first   1  2.2  Hello
second  2  3.0  World
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-1-3" class="outline-5">
<h5 id="sec-1-3-1-3"><span class="section-number-5">1.3.1.3</span> 从字典列表创建</h5>
<div class="outline-text-5" id="text-1-3-1-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">data</span> = [{<span style="color: #ff4ea3;">'a'</span>: 1, <span style="color: #ff4ea3;">'b'</span>: 2}, {<span style="color: #ff4ea3;">'a'</span>: 5, <span style="color: #ff4ea3;">'b'</span>: 10, <span style="color: #ff4ea3;">'c'</span>: 20}]

log(<span style="color: #ff4ea3;">"pd.DataFrame(data)"</span>, pd.DataFrame(data))
log(<span style="color: #ff4ea3;">"pd.DataFrame(data, index=['first', 'second'])"</span>,
    pd.DataFrame(data, index=[<span style="color: #ff4ea3;">'first'</span>, <span style="color: #ff4ea3;">'second'</span>]))
log(<span style="color: #ff4ea3;">"pd.DataFrame(data, columns=['a', 'b'])"</span>,
    pd.DataFrame(data, columns=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>]))
</pre>
</div>

<pre class="example">
============================== pd.DataFrame(data) ==============================
   a   b     c
0  1   2   NaN
1  5  10  20.0
================ pd.DataFrame(data, index=['first', 'second']) =================
        a   b     c
first   1   2   NaN
second  5  10  20.0
==================== pd.DataFrame(data, columns=['a', 'b']) ====================
   a   b
0  1   2
1  5  10
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-1-4" class="outline-5">
<h5 id="sec-1-3-1-4"><span class="section-number-5">1.3.1.4</span> 从元组字典创建</h5>
<div class="outline-text-5" id="text-1-3-1-4">
<p>
实际应用中，会通过数据清洗的方式，把数据整理成方便 Pandas 导入且可读性好的格式。
然后再通过 <b>reindex/groupby</b> 等方式转换成复杂数据结构。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">d</span> = {(<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>): {(<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>): 1, (<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'C'</span>): 2},
     (<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>): {(<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'C'</span>): 3, (<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>): 4},
     (<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'c'</span>): {(<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>): 5, (<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'C'</span>): 6},
     (<span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>): {(<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'C'</span>): 7, (<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>): 8},
     (<span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>): {(<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'D'</span>): 9, (<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>): 10}}

<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#22810;&#32423;&#26631;&#31614;</span>
log(<span style="color: #ff4ea3;">"pd.DataFrame(d)"</span>, pd.DataFrame(d))
</pre>
</div>

<pre class="example">
=============================== pd.DataFrame(d) ================================
       a              b
       a    b    c    a     b
A B  4.0  1.0  5.0  8.0  10.0
  C  3.0  2.0  6.0  7.0   NaN
  D  NaN  NaN  NaN  NaN   9.0
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-1-5" class="outline-5">
<h5 id="sec-1-3-1-5"><span class="section-number-5">1.3.1.5</span> 从 Series 创建</h5>
<div class="outline-text-5" id="text-1-3-1-5">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(np.random.randn(5), index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'e'</span>])
log(<span style="color: #ff4ea3;">"pd.DataFrame(s)"</span>, pd.DataFrame(s))
log(<span style="color: #ff4ea3;">"pd.DataFrame(s, index=['a', 'c', 'd'])"</span>,
    pd.DataFrame(s, index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>]))
log(<span style="color: #ff4ea3;">"pd.DataFrame(s, index=['a', 'c', 'd'], columns=['A'])"</span>,
    pd.DataFrame(s, index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>], columns=[<span style="color: #ff4ea3;">'A'</span>]))
</pre>
</div>

<pre class="example">
=============================== pd.DataFrame(s) ================================
          0
a -0.463642
b -0.437101
c  0.493508
d  0.901178
e  0.710309
==================== pd.DataFrame(s, index=['a', 'c', 'd']) ====================
          0
a -0.463642
c  0.493508
d  0.901178
============ pd.DataFrame(s, index=['a', 'c', 'd'], columns=['A']) =============
          A
a -0.463642
c  0.493508
d  0.901178
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-1-6" class="outline-5">
<h5 id="sec-1-3-1-6"><span class="section-number-5">1.3.1.6</span> 指定行列索引创建</h5>
<div class="outline-text-5" id="text-1-3-1-6">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">dates</span> = pd.date_range(<span style="color: #ff4ea3;">'20160301'</span>, periods=6)
log(<span style="color: #ff4ea3;">"dates"</span>, dates)

<span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(6,4), index=dates, columns=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCD'</span>))
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
==================================== dates =====================================
DatetimeIndex(['2016-03-01', '2016-03-02', '2016-03-03', '2016-03-04',
               '2016-03-05', '2016-03-06'],
              dtype='datetime64[ns]', freq='D')
====================================== df ======================================
                   A         B         C         D
2016-03-01 -1.135095  0.645389  0.261528  0.006286
2016-03-02 -1.398516  0.933692  1.171984  0.190349
2016-03-03 -0.156743 -0.413400 -0.341773 -0.436914
2016-03-04 -1.680793  1.255623  0.710777  1.111086
2016-03-05  0.367721 -0.703373 -0.003139 -0.722008
2016-03-06 -0.219554 -0.092635 -0.418657 -1.195445
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-1-3-2" class="outline-4">
<h4 id="sec-1-3-2"><span class="section-number-4">1.3.2</span> 数据操作</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(6, 4),
                  index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCDEF'</span>),
                  columns=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>, <span style="color: #ff4ea3;">'four'</span>])
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
        one       two     three      four
A -1.636889 -0.152187 -0.345509 -0.183278
B  0.706041 -0.915191 -0.351342  1.194307
C -0.393915 -0.509089 -0.675040 -0.754762
D  0.089809 -0.200281 -0.060704 -0.008419
E  0.434580 -1.832528 -1.257836 -0.731157
F  1.750935 -0.405841  0.099753  0.875137
</pre>
</div>

<div id="outline-container-sec-1-3-2-1" class="outline-5">
<h5 id="sec-1-3-2-1"><span class="section-number-5">1.3.2.1</span> 列选择(Series)</h5>
<div class="outline-text-5" id="text-1-3-2-1">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df['one']"</span>, df[<span style="color: #ff4ea3;">'one'</span>])
log(<span style="color: #ff4ea3;">"df.one"</span>, df.one)
</pre>
</div>

<pre class="example">
================================== df['one'] ===================================
A   -1.636889
B    0.706041
C   -0.393915
D    0.089809
E    0.434580
F    1.750935
Name: one, dtype: float64
==================================== df.one ====================================
A   -1.636889
B    0.706041
C   -0.393915
D    0.089809
E    0.434580
F    1.750935
Name: one, dtype: float64
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-2" class="outline-5">
<h5 id="sec-1-3-2-2"><span class="section-number-5">1.3.2.2</span> 列选择(DataFrame)</h5>
<div class="outline-text-5" id="text-1-3-2-2">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.loc[:, ['one', 'two']]"</span>, df.loc[:, [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>]])
log(<span style="color: #ff4ea3;">"df.iloc[:, 0:1]"</span>, df.iloc[:, 0:1])
</pre>
</div>

<pre class="example">
========================== df.loc[:, ['one', 'two']] ===========================
        one       two
A -1.636889 -0.152187
B  0.706041 -0.915191
C -0.393915 -0.509089
D  0.089809 -0.200281
E  0.434580 -1.832528
F  1.750935 -0.405841
=============================== df.iloc[:, 0:1] ================================
        one
A -1.636889
B  0.706041
C -0.393915
D  0.089809
E  0.434580
F  1.750935
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-3" class="outline-5">
<h5 id="sec-1-3-2-3"><span class="section-number-5">1.3.2.3</span> 列赋值</h5>
<div class="outline-text-5" id="text-1-3-2-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span>[<span style="color: #ff4ea3;">'three'</span>] = df[<span style="color: #ff4ea3;">'one'</span>] + df[<span style="color: #ff4ea3;">'two'</span>]
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
        one       two     three      four
A -1.636889 -0.152187 -1.789076 -0.183278
B  0.706041 -0.915191 -0.209150  1.194307
C -0.393915 -0.509089 -0.903004 -0.754762
D  0.089809 -0.200281 -0.110472 -0.008419
E  0.434580 -1.832528 -1.397948 -0.731157
F  1.750935 -0.405841  1.345094  0.875137
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-4" class="outline-5">
<h5 id="sec-1-3-2-4"><span class="section-number-5">1.3.2.4</span> 列删除</h5>
<div class="outline-text-5" id="text-1-3-2-4">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">del</span> df[<span style="color: #ff4ea3;">'three'</span>]
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
        one       two      four
A -1.636889 -0.152187 -0.183278
B  0.706041 -0.915191  1.194307
C -0.393915 -0.509089 -0.754762
D  0.089809 -0.200281 -0.008419
E  0.434580 -1.832528 -0.731157
F  1.750935 -0.405841  0.875137
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = df.pop(<span style="color: #ff4ea3;">'four'</span>)
log(<span style="color: #ff4ea3;">"s"</span>, s)
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== s =======================================
A   -0.183278
B    1.194307
C   -0.754762
D   -0.008419
E   -0.731157
F    0.875137
Name: four, dtype: float64
====================================== df ======================================
        one       two
A -1.636889 -0.152187
B  0.706041 -0.915191
C -0.393915 -0.509089
D  0.089809 -0.200281
E  0.434580 -1.832528
F  1.750935 -0.405841
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = df.drop([<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>], axis=1)  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">df &#19981;&#21464;</span>
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
Empty DataFrame
Columns: []
Index: [A, B, C, D, E, F]
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-5" class="outline-5">
<h5 id="sec-1-3-2-5"><span class="section-number-5">1.3.2.5</span> 增加列</h5>
<div class="outline-text-5" id="text-1-3-2-5">
</div><div id="outline-container-sec-1-3-2-5-1" class="outline-6">
<h6 id="sec-1-3-2-5-1"><span class="section-number-6">1.3.2.5.1</span> 添加到最后</h6>
<div class="outline-text-6" id="text-1-3-2-5-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span>[<span style="color: #ff4ea3;">'flag'</span>] = df[<span style="color: #ff4ea3;">'one'</span>] &gt; 0
<span style="color: #ff8700;">df</span>[<span style="color: #ff4ea3;">'five'</span>] = 5
<span style="color: #ff8700;">df</span>[<span style="color: #ff4ea3;">'one_trunc'</span>] = df[<span style="color: #ff4ea3;">'one'</span>][:2]
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
        one       two   flag  five  one_trunc
A -1.636889 -0.152187  False     5  -1.636889
B  0.706041 -0.915191   True     5   0.706041
C -0.393915 -0.509089  False     5        NaN
D  0.089809 -0.200281   True     5        NaN
E  0.434580 -1.832528   True     5        NaN
F  1.750935 -0.405841   True     5        NaN
</pre>
</div>
</div>

<div id="outline-container-sec-1-3-2-5-2" class="outline-6">
<h6 id="sec-1-3-2-5-2"><span class="section-number-6">1.3.2.5.2</span> 指定位置添加</h6>
<div class="outline-text-6" id="text-1-3-2-5-2">
<div class="org-src-container">

<pre class="src src-ipython">df.insert(1, <span style="color: #ff4ea3;">'bar'</span>, df.one + df.two)
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
        one       bar       two   flag  five  one_trunc
A -1.636889 -1.789076 -0.152187  False     5  -1.636889
B  0.706041 -0.209150 -0.915191   True     5   0.706041
C -0.393915 -0.903004 -0.509089  False     5        NaN
D  0.089809 -0.110472 -0.200281   True     5        NaN
E  0.434580 -1.397948 -1.832528   True     5        NaN
F  1.750935  1.345094 -0.405841   True     5        NaN
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-5-3" class="outline-6">
<h6 id="sec-1-3-2-5-3"><span class="section-number-6">1.3.2.5.3</span> assign()</h6>
<div class="outline-text-6" id="text-1-3-2-5-3">
<p>
assign 方法并不会 inplace 地改变原来的 dataframe ，
该方法的 <b>优势</b> 在于可以对 dataframe 对象使用链式操作。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df1</span> = df.assign(Ratio=df.one/df.two)
log(<span style="color: #ff4ea3;">"df1"</span>, df1)
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
===================================== df1 ======================================
        one       bar       two   flag  five  one_trunc      Ratio
A -1.636889 -1.789076 -0.152187  False     5  -1.636889  10.755800
B  0.706041 -0.209150 -0.915191   True     5   0.706041  -0.771469
C -0.393915 -0.903004 -0.509089  False     5        NaN   0.773764
D  0.089809 -0.110472 -0.200281   True     5        NaN  -0.448414
E  0.434580 -1.397948 -1.832528   True     5        NaN  -0.237148
F  1.750935  1.345094 -0.405841   True     5        NaN  -4.314338
====================================== df ======================================
        one       bar       two   flag  five  one_trunc
A -1.636889 -1.789076 -0.152187  False     5  -1.636889
B  0.706041 -0.209150 -0.915191   True     5   0.706041
C -0.393915 -0.903004 -0.509089  False     5        NaN
D  0.089809 -0.110472 -0.200281   True     5        NaN
E  0.434580 -1.397948 -1.832528   True     5        NaN
F  1.750935  1.345094 -0.405841   True     5        NaN
</pre>

<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.assign(Ratio=lambda x: x.one - x.two)"</span>,
    df.assign(Ratio=<span style="color: #a1db00;">lambda</span> x: x.one - x.two))

log(<span style="color: #ff4ea3;">"df.assign(ABRatio=df.one/df.two).assign(BarValue=lambda x: x.ABRatio*x.bar)"</span>,
    df.assign(ABRatio=df.one/df.two).assign(BarValue=<span style="color: #a1db00;">lambda</span> x: x.ABRatio*x.bar))
</pre>
</div>

<pre class="example">
=================== df.assign(Ratio=lambda x: x.one - x.two) ===================
        one       bar       two   flag  five  one_trunc     Ratio
A -1.636889 -1.789076 -0.152187  False     5  -1.636889 -1.484703
B  0.706041 -0.209150 -0.915191   True     5   0.706041  1.621232
C -0.393915 -0.903004 -0.509089  False     5        NaN  0.115174
D  0.089809 -0.110472 -0.200281   True     5        NaN  0.290090
E  0.434580 -1.397948 -1.832528   True     5        NaN  2.267107
F  1.750935  1.345094 -0.405841   True     5        NaN  2.156776
= df.assign(ABRatio=df.one/df.two).assign(BarValue=lambda x: x.ABRatio*x.bar) ==
        one       bar       two   flag  five  one_trunc    ABRatio   BarValue
A -1.636889 -1.789076 -0.152187  False     5  -1.636889  10.755800 -19.242945
B  0.706041 -0.209150 -0.915191   True     5   0.706041  -0.771469   0.161353
C -0.393915 -0.903004 -0.509089  False     5        NaN   0.773764  -0.698712
D  0.089809 -0.110472 -0.200281   True     5        NaN  -0.448414   0.049537
E  0.434580 -1.397948 -1.832528   True     5        NaN  -0.237148   0.331520
F  1.750935  1.345094 -0.405841   True     5        NaN  -4.314338  -5.803192
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-1-3-2-6" class="outline-5">
<h5 id="sec-1-3-2-6"><span class="section-number-5">1.3.2.6</span> 行选择(Series)</h5>
<div class="outline-text-5" id="text-1-3-2-6">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.loc['A']"</span>, df.loc[<span style="color: #ff4ea3;">'A'</span>])  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#34892;&#26631;&#31614;&#26041;&#24335;</span>
log(<span style="color: #ff4ea3;">"df.iloc[0]"</span>, df.iloc[0])    <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#34892;&#20301;&#32622;&#26041;&#24335;</span>
</pre>
</div>

<pre class="example">
================================= df.loc['A'] ==================================
one          -1.63689
bar          -1.78908
two         -0.152187
flag            False
five                5
one_trunc    -1.63689
Name: A, dtype: object
================================== df.iloc[0] ==================================
one          -1.63689
bar          -1.78908
two         -0.152187
flag            False
five                5
one_trunc    -1.63689
Name: A, dtype: object
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-7" class="outline-5">
<h5 id="sec-1-3-2-7"><span class="section-number-5">1.3.2.7</span> 行选择(DataFrame)</h5>
<div class="outline-text-5" id="text-1-3-2-7">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df[2:4]"</span>, df[2:4])
log(<span style="color: #ff4ea3;">"df['A':'C']"</span>, df[<span style="color: #ff4ea3;">'A'</span>:<span style="color: #ff4ea3;">'C'</span>])
log(<span style="color: #ff4ea3;">"df.iloc[2:4]"</span>, df.iloc[2:4])         <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#25928;&#29575;&#39640;</span>
log(<span style="color: #ff4ea3;">"df[df.one &gt; 0.5]"</span>, df[df.one &gt; 0.5])  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#24067;&#23572;&#26041;&#24335;</span>
log(<span style="color: #ff4ea3;">"df[df &gt; 0]"</span>, df[df &gt; 0])             <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#24067;&#23572;&#26041;&#24335;</span>
log(<span style="color: #ff4ea3;">"df[[False, True, True, False, True, False]]"</span>,
    df[[<span style="color: #5fafd7;">False</span>, <span style="color: #5fafd7;">True</span>, <span style="color: #5fafd7;">True</span>, <span style="color: #5fafd7;">False</span>, <span style="color: #5fafd7;">True</span>, <span style="color: #5fafd7;">False</span>]])  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#24067;&#23572;&#26041;&#24335;</span>
</pre>
</div>

<pre class="example">
=================================== df[2:4] ====================================
        one       bar       two   flag  five  one_trunc
C -0.393915 -0.903004 -0.509089  False     5        NaN
D  0.089809 -0.110472 -0.200281   True     5        NaN
================================= df['A':'C'] ==================================
        one       bar       two   flag  five  one_trunc
A -1.636889 -1.789076 -0.152187  False     5  -1.636889
B  0.706041 -0.209150 -0.915191   True     5   0.706041
C -0.393915 -0.903004 -0.509089  False     5        NaN
================================= df.iloc[2:4] =================================
        one       bar       two   flag  five  one_trunc
C -0.393915 -0.903004 -0.509089  False     5        NaN
D  0.089809 -0.110472 -0.200281   True     5        NaN
=============================== df[df.one &gt; 0.5] ===============================
        one       bar       two  flag  five  one_trunc
B  0.706041 -0.209150 -0.915191  True     5   0.706041
F  1.750935  1.345094 -0.405841  True     5        NaN
================================== df[df &gt; 0] ==================================
        one       bar  two  flag  five  one_trunc
A       NaN       NaN  NaN   NaN     5        NaN
B  0.706041       NaN  NaN   1.0     5   0.706041
C       NaN       NaN  NaN   NaN     5        NaN
D  0.089809       NaN  NaN   1.0     5        NaN
E  0.434580       NaN  NaN   1.0     5        NaN
F  1.750935  1.345094  NaN   1.0     5        NaN
================= df[[False, True, True, False, True, False]] ==================
        one       bar       two   flag  five  one_trunc
B  0.706041 -0.209150 -0.915191   True     5   0.706041
C -0.393915 -0.903004 -0.509089  False     5        NaN
E  0.434580 -1.397948 -1.832528   True     5        NaN
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-8" class="outline-5">
<h5 id="sec-1-3-2-8"><span class="section-number-5">1.3.2.8</span> 行删除</h5>
<div class="outline-text-5" id="text-1-3-2-8">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = df.drop(<span style="color: #ff4ea3;">'A'</span>)           <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">result &#26159;&#19968;&#20221;&#26032;&#30340;&#25968;&#25454;&#25335;&#36125;</span>
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
        one       bar       two   flag  five  one_trunc
B  0.706041 -0.209150 -0.915191   True     5   0.706041
C -0.393915 -0.903004 -0.509089  False     5        NaN
D  0.089809 -0.110472 -0.200281   True     5        NaN
E  0.434580 -1.397948 -1.832528   True     5        NaN
F  1.750935  1.345094 -0.405841   True     5        NaN
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-9" class="outline-5">
<h5 id="sec-1-3-2-9"><span class="section-number-5">1.3.2.9</span> 增加行</h5>
<div class="outline-text-5" id="text-1-3-2-9">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series([7, 7, 7, <span style="color: #5fafd7;">True</span>, 7, 7], index=<span style="color: #d18aff;">list</span>(df.columns))
<span style="color: #ff8700;">appended</span> = df.append(s, ignore_index=<span style="color: #5fafd7;">True</span>)
show_dataframe(appended)
</pre>
</div>


<div id="img/fig37020vuz.png" class="figure">
<p><img src="img/fig37020vuz.png" alt="fig37020vuz.png">
</p>
<p><span class="figure-number">Figure 1:</span> append</p>
</div>
</div>
</div>


<div id="outline-container-sec-1-3-2-10" class="outline-5">
<h5 id="sec-1-3-2-10"><span class="section-number-5">1.3.2.10</span> 行与列选择</h5>
<div class="outline-text-5" id="text-1-3-2-10">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.loc['A':'B', ['one', 'two']]"</span>, df.loc[<span style="color: #ff4ea3;">'A'</span>:<span style="color: #ff4ea3;">'B'</span>, [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>]])
log(<span style="color: #ff4ea3;">"df.iloc[0:2, 0:3]"</span>, df.iloc[0:2, 0:3])
</pre>
</div>

<pre class="example">
======================= df.loc['A':'B', ['one', 'two']] ========================
        one       two
A -1.636889 -0.152187
B  0.706041 -0.915191
============================== df.iloc[0:2, 0:3] ===============================
        one       bar       two
A -1.636889 -1.789076 -0.152187
B  0.706041 -0.209150 -0.915191
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-11" class="outline-5">
<h5 id="sec-1-3-2-11"><span class="section-number-5">1.3.2.11</span> 选择指定坐标</h5>
<div class="outline-text-5" id="text-1-3-2-11">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.loc['A', 'one']"</span>, df.loc[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'one'</span>])
log(<span style="color: #ff4ea3;">"df.at['A', 'one']"</span>, df.at[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'one'</span>])
log(<span style="color: #ff4ea3;">"df.iloc[1, 1]"</span>, df.iloc[1, 1])
log(<span style="color: #ff4ea3;">"df.iat[1, 1]"</span>, df.iat[1, 1])
</pre>
</div>

<pre class="example">
============================== df.loc['A', 'one'] ==============================
-1.6368894239377618
============================== df.at['A', 'one'] ===============================
-1.6368894239377618
================================ df.iloc[1, 1] =================================
-0.2091498547409707
================================= df.iat[1, 1] =================================
-0.2091498547409707
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-12" class="outline-5">
<h5 id="sec-1-3-2-12"><span class="section-number-5">1.3.2.12</span> 数据对齐</h5>
<div class="outline-text-5" id="text-1-3-2-12">
<p>
DataFrame 在进行数据计算时， <b>会自动按行和列进行数据对齐</b> 。
最终的计算结果会合并两个 DataFrame 。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df1</span> = pd.DataFrame(np.random.randn(10, 4),
                   index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcdefghij'</span>),
                   columns=[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>, <span style="color: #ff4ea3;">'C'</span>, <span style="color: #ff4ea3;">'D'</span>])

<span style="color: #ff8700;">df2</span> = pd.DataFrame(np.random.randn(7, 3),
                   index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'cdefghi'</span>),
                   columns=[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>, <span style="color: #ff4ea3;">'C'</span>])

log(<span style="color: #ff4ea3;">"df1"</span>, df1)
log(<span style="color: #ff4ea3;">"df2"</span>, df2)

log(<span style="color: #ff4ea3;">"df1 + df2"</span>, df1 + df2)
log(<span style="color: #ff4ea3;">"df1 - df1.iloc[0]"</span>, df1 - df1.iloc[0])
</pre>
</div>

<pre class="example">
===================================== df1 ======================================
          A         B         C         D
a  1.480326  1.211439  0.218118 -0.770381
b -0.508994  2.581124  0.094742 -0.953025
c  0.443589 -0.034922  0.454693 -0.738935
d  0.318092 -0.983982 -0.413371 -0.293665
e -2.490351 -0.495809 -0.839945 -0.380185
f  0.780186 -0.371966 -0.012839  0.145865
g  0.496157 -0.176080 -0.818538 -0.863185
h  0.033517  0.507102  0.690190  0.755936
i  1.081415  0.547456  0.915069 -0.224883
j  0.597341 -1.850760 -0.232199  0.564734
===================================== df2 ======================================
          A         B         C
c  0.574054  0.000849  1.114388
d  0.387788 -0.411143 -1.540139
e -2.158498  0.733346 -0.139783
f  1.257941  1.074924  0.517178
g -0.901503  0.728608  1.140950
h -0.724358 -0.663260  1.332317
i  1.350878  2.326458  0.650540
================================== df1 + df2 ===================================
          A         B         C   D
a       NaN       NaN       NaN NaN
b       NaN       NaN       NaN NaN
c  1.017643 -0.034073  1.569080 NaN
d  0.705881 -1.395125 -1.953510 NaN
e -4.648849  0.237537 -0.979728 NaN
f  2.038127  0.702958  0.504339 NaN
g -0.405347  0.552528  0.322412 NaN
h -0.690841 -0.156159  2.022507 NaN
i  2.432293  2.873914  1.565608 NaN
j       NaN       NaN       NaN NaN
============================== df1 - df1.iloc[0] ===============================
          A         B         C         D
a  0.000000  0.000000  0.000000  0.000000
b -1.989320  1.369685 -0.123376 -0.182644
c -1.036737 -1.246361  0.236574  0.031446
d -1.162234 -2.195421 -0.631490  0.476716
e -3.970677 -1.707248 -1.058063  0.390196
f -0.700140 -1.583405 -0.230957  0.916246
g -0.984169 -1.387519 -1.036656 -0.092804
h -1.446809 -0.704337  0.472072  1.526317
i -0.398911 -0.663983  0.696950  0.545498
j -0.882985 -3.062199 -0.450318  1.335115
</pre>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df3</span> = df2.loc[:, [<span style="color: #ff4ea3;">'B'</span>, <span style="color: #ff4ea3;">'C'</span>]].copy()
log(<span style="color: #ff4ea3;">"df3 (before)"</span>, df3)
<span style="color: #ff8700;">df3</span>[df3 &gt; 0] = -df3
log(<span style="color: #ff4ea3;">"df3 (after)"</span>, df3)
</pre>
</div>

<pre class="example">
================================= df3 (before) =================================
          B         C
c  0.000849  1.114388
d -0.411143 -1.540139
e  0.733346 -0.139783
f  1.074924  0.517178
g  0.728608  1.140950
h -0.663260  1.332317
i  2.326458  0.650540
================================= df3 (after) ==================================
          B         C
c -0.000849 -1.114388
d -0.411143 -1.540139
e -0.733346 -0.139783
f -1.074924 -0.517178
g -0.728608 -1.140950
h -0.663260 -1.332317
i -2.326458 -0.650540
</pre>
</div>
</div>


<div id="outline-container-sec-1-3-2-13" class="outline-5">
<h5 id="sec-1-3-2-13"><span class="section-number-5">1.3.2.13</span> 使用 numpy 函数</h5>
<div class="outline-text-5" id="text-1-3-2-13">
<p>
因为从本质上讲，DataFrame 内部用的数据结构就是 numpy 的 ndarray 。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(10, 4), columns=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>, <span style="color: #ff4ea3;">'four'</span>])
log(<span style="color: #ff4ea3;">"np.exp(df)"</span>, np.exp(df))
log(<span style="color: #ff4ea3;">"np.sin(df)"</span>, np.sin(df))
</pre>
</div>

<pre class="example">
================================== np.exp(df) ==================================
         one       two     three      four
0  37.839957  2.889058  1.268288  0.471015
1   1.022183  0.893121  0.834889  0.179431
2   0.447017  1.011534  0.248171  0.276827
3   0.160081  0.593694  0.371233  0.212197
4   1.438461  1.092762  0.449738  0.770772
5   0.708460  2.557864  3.761394  0.705796
6   0.583622  0.422800  2.535328  5.500162
7   0.673520  0.410252  0.764287  0.841493
8   1.228928  0.606946  0.455963  1.063897
9   1.769918  0.840479  1.093956  2.852000
================================== np.sin(df) ==================================
        one       two     three      four
0 -0.472189  0.872810  0.235437 -0.683733
1  0.021939 -0.112792 -0.179479 -0.989190
2 -0.720940  0.011467 -0.984349 -0.959258
3 -0.966060 -0.498087 -0.836533 -0.999789
4  0.355617  0.088592 -0.716721 -0.257431
5 -0.337878  0.807070  0.969893 -0.341422
6 -0.512851 -0.758401  0.801813  0.991038
7 -0.385028 -0.777691 -0.265586 -0.171723
8  0.204685 -0.478824 -0.707067  0.061899
9  0.540418 -0.172910  0.089680  0.866437
</pre>
</div>

<div id="outline-container-sec-1-3-2-13-1" class="outline-6">
<h6 id="sec-1-3-2-13-1"><span class="section-number-6">1.3.2.13.1</span> DataFrame 转换为 ndarray 对象</h6>
<div class="outline-text-6" id="text-1-3-2-13-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">ary</span> = np.asarray(df)
log(<span style="color: #ff4ea3;">"ary"</span>, ary)
log(<span style="color: #ff4ea3;">"ary == df.values"</span>, ary == df.values)
log(<span style="color: #ff4ea3;">"ary == df"</span>, ary == df)
</pre>
</div>

<pre class="example">
===================================== ary ======================================
[[ 3.63336561  1.06093052  0.23766779 -0.75286603]
 [ 0.02194029 -0.11303286 -0.1804565  -1.71796682]
 [-0.80515763  0.01146773 -1.39363831 -1.28436314]
 [-1.83207766 -0.5213907  -0.99092546 -1.55024237]
 [ 0.36357381  0.08870876 -0.79908923 -0.2603631 ]
 [-0.34466121  0.93917263  1.32478952 -0.34842961]
 [-0.53850232 -0.86085704  0.93032305  1.70477759]
 [-0.39523833 -0.89098369 -0.26881204 -0.17257797]
 [ 0.20614238 -0.49931463 -0.78534261  0.06193815]
 [ 0.57093342 -0.17378357  0.08980018  1.04802043]]
=============================== ary == df.values ===============================
[[ True  True  True  True]
 [ True  True  True  True]
 [ True  True  True  True]
 [ True  True  True  True]
 [ True  True  True  True]
 [ True  True  True  True]
 [ True  True  True  True]
 [ True  True  True  True]
 [ True  True  True  True]
 [ True  True  True  True]]
================================== ary == df ===================================
    one   two  three  four
0  True  True   True  True
1  True  True   True  True
2  True  True   True  True
3  True  True   True  True
4  True  True   True  True
5  True  True   True  True
6  True  True   True  True
7  True  True   True  True
8  True  True   True  True
9  True  True   True  True
</pre>
</div>
</div>
</div>
</div>
</div>
</div>




<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 函数应用</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> 将数据按行或列进行计算(apply)</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.arange(12).reshape(4, 3),
                  index=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>, <span style="color: #ff4ea3;">'four'</span>],
                  columns=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABC'</span>))

log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
       A   B   C
one    0   1   2
two    3   4   5
three  6   7   8
four   9  10  11
</pre>
</div>

<div id="outline-container-sec-2-1-0-1" class="outline-5">
<h5 id="sec-2-1-0-1"><span class="section-number-5">2.1.0.1</span> 按列进行运算</h5>
<div class="outline-text-5" id="text-2-1-0-1">
<p>
每一列作为一个 Series 作为参数传递给 lambda 函数
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = df.<span style="color: #d18aff;">apply</span>(<span style="color: #a1db00;">lambda</span> x: x.<span style="color: #d18aff;">max</span>() - x.<span style="color: #d18aff;">min</span>())
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
A    9
B    9
C    9
dtype: int64
</pre>
</div>
</div>

<div id="outline-container-sec-2-1-0-2" class="outline-5">
<h5 id="sec-2-1-0-2"><span class="section-number-5">2.1.0.2</span> 按行进行运算</h5>
<div class="outline-text-5" id="text-2-1-0-2">
<p>
每一行作为一个 Series 作为参数传递给 lambda 函数
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = df.<span style="color: #d18aff;">apply</span>(<span style="color: #a1db00;">lambda</span> x: x.<span style="color: #d18aff;">max</span>() - x.<span style="color: #d18aff;">min</span>(), axis=1)
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
one      2
two      2
three    2
four     2
dtype: int64
</pre>
</div>
</div>

<div id="outline-container-sec-2-1-0-3" class="outline-5">
<h5 id="sec-2-1-0-3"><span class="section-number-5">2.1.0.3</span> 返回多个值组成的 Series</h5>
<div class="outline-text-5" id="text-2-1-0-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">def</span> <span style="color: #ffd700;">min_max</span>(x):
    <span style="color: #a1db00;">return</span> pd.Series([x.<span style="color: #d18aff;">min</span>(), x.<span style="color: #d18aff;">max</span>()], index=[<span style="color: #ff4ea3;">'min'</span>, <span style="color: #ff4ea3;">'max'</span>])
<span style="color: #ff8700;">result</span> = df.<span style="color: #d18aff;">apply</span>(min_max, axis=1)
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
       min  max
one      0    2
two      3    5
three    6    8
four     9   11
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> 逐元素运算(applymap)</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(4, 3),
                  index=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>, <span style="color: #ff4ea3;">'four'</span>],
                  columns=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABC'</span>))

log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
              A         B         C
one    0.698294 -0.291641 -1.731819
two   -1.340392 -0.723294  0.608906
three -0.789759  1.077846  0.919049
four   2.080517  0.645500  0.451411
</pre>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">x &#34920;&#31034; dataframe &#20013;&#30340;&#27599;&#20010;&#20803;&#32032;</span>
<span style="color: #ff8700;">result</span> = df.applymap(<span style="color: #a1db00;">lambda</span> x: <span style="color: #ff4ea3;">'{0:.03f}'</span>.<span style="color: #d18aff;">format</span>(x))
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
            A       B       C
one     0.698  -0.292  -1.732
two    -1.340  -0.723   0.609
three  -0.790   1.078   0.919
four    2.081   0.645   0.451
</pre>
</div>
</div>


<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> 排序(sort_values)</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 10, (4, 3)),
                  index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCD'</span>),
                  columns=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>])

log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
   one  two  three
A    8    1      8
B    4    6      6
C    3    5      2
D    9    9      5
</pre>
</div>


<div id="outline-container-sec-2-3-1" class="outline-4">
<h4 id="sec-2-3-1"><span class="section-number-4">2.3.1</span> 按列排序</h4>
<div class="outline-text-4" id="text-2-3-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = df.sort_values(by=<span style="color: #ff4ea3;">'two'</span>, ascending=<span style="color: #5fafd7;">False</span>)
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
   one  two  three
D    9    9      5
B    4    6      6
C    3    5      2
A    8    1      8
</pre>
</div>
</div>

<div id="outline-container-sec-2-3-2" class="outline-4">
<h4 id="sec-2-3-2"><span class="section-number-4">2.3.2</span> 按行排序</h4>
<div class="outline-text-4" id="text-2-3-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = df.sort_values(by=<span style="color: #ff4ea3;">'C'</span>, axis=1, ascending=<span style="color: #5fafd7;">False</span>)
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
   two  one  three
A    1    8      8
B    6    4      6
C    5    3      2
D    9    9      5
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> 索引排序(sort_index)</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 10, (4, 3)),
                  index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCD'</span>),
                  columns=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>])

log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
   one  two  three
A    6    3      3
B    9    5      1
C    8    1      3
D    5    4      6
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">col_sort</span> = df.sort_index(axis=1, ascending=<span style="color: #5fafd7;">False</span>)
<span style="color: #ff8700;">row_sort</span> = df.sort_index(ascending=<span style="color: #5fafd7;">False</span>)

log(<span style="color: #ff4ea3;">"col_sort"</span>, col_sort)
log(<span style="color: #ff4ea3;">"row_sort"</span>, row_sort)
</pre>
</div>

<pre class="example">
=================================== col_sort ===================================
   two  three  one
A    3      3    6
B    5      1    9
C    1      3    8
D    4      6    5
=================================== row_sort ===================================
   one  two  three
D    5    4      6
C    8    1      3
B    9    5      1
A    6    3      3
</pre>
</div>
</div>


<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> 排名(rank)</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series([3, 6, 2, 6, 4])
<span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 10, (4, 3)),
                  index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCD'</span>),
                  columns=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>])

log(<span style="color: #ff4ea3;">"s"</span>, s)
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== s =======================================
0    3
1    6
2    2
3    6
4    4
dtype: int64
====================================== df ======================================
   one  two  three
A    3    3      5
B    4    4      4
C    3    9      3
D    7    7      9
</pre>



<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s_result</span> = s.rank(method=<span style="color: #ff4ea3;">'first'</span>, ascending=<span style="color: #5fafd7;">False</span>)
log(<span style="color: #ff4ea3;">"s_result"</span>, s_result)
</pre>
</div>

<pre class="example">
=================================== s_result ===================================
0    4.0
1    1.0
2    5.0
3    2.0
4    3.0
dtype: float64
</pre>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df_result</span> = df.rank(method=<span style="color: #ff4ea3;">'first'</span>)
log(<span style="color: #ff4ea3;">"df_result"</span>, df_result)
</pre>
</div>

<pre class="example">
================================== df_result ===================================
   one  two  three
A  1.0  1.0    3.0
B  3.0  2.0    2.0
C  2.0  4.0    1.0
D  4.0  3.0    4.0
</pre>
</div>
</div>


<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> Series 元素统计</h3>
<div class="outline-text-3" id="text-2-6">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abbcdabacad'</span>))
log(<span style="color: #ff4ea3;">"s"</span>, s)
</pre>
</div>

<pre class="example">
====================================== s =======================================
0     a
1     b
2     b
3     c
4     d
5     a
6     b
7     a
8     c
9     a
10    d
dtype: object
</pre>
</div>

<div id="outline-container-sec-2-6-1" class="outline-4">
<h4 id="sec-2-6-1"><span class="section-number-4">2.6.1</span> 个数统计(value_counts)</h4>
<div class="outline-text-4" id="text-2-6-1">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s.value_counts()"</span>, s.value_counts())
</pre>
</div>

<pre class="example">
=============================== s.value_counts() ===============================
a    4
b    3
d    2
c    2
dtype: int64
</pre>
</div>
</div>


<div id="outline-container-sec-2-6-2" class="outline-4">
<h4 id="sec-2-6-2"><span class="section-number-4">2.6.2</span> 唯一性统计(uniq)</h4>
<div class="outline-text-4" id="text-2-6-2">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s.unique()"</span>, s.unique())
</pre>
</div>

<pre class="example">
================================== s.unique() ==================================
['a' 'b' 'c' 'd']
</pre>
</div>
</div>


<div id="outline-container-sec-2-6-3" class="outline-4">
<h4 id="sec-2-6-3"><span class="section-number-4">2.6.3</span> 成员资格统计(isin)</h4>
<div class="outline-text-4" id="text-2-6-3">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s.isin(['a', 'b', 'c'])"</span>, s.isin([<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>]))
</pre>
</div>

<pre class="example">
=========================== s.isin(['a', 'b', 'c']) ============================
0      True
1      True
2      True
3      True
4     False
5      True
6      True
7      True
8      True
9      True
10    False
dtype: bool
</pre>
</div>
</div>
</div>






<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7"><span class="section-number-3">2.7</span> 出现最频繁值的统计(mode)</h3>
<div class="outline-text-3" id="text-2-7">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series([1, 1, 2, 3, 4, 5])
log(<span style="color: #ff4ea3;">"s.mode()"</span>, s.mode())
</pre>
</div>

<pre class="example">
=================================== s.mode() ===================================
0    1
dtype: int64
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">'data1'</span>: [<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>],
                   <span style="color: #ff4ea3;">'data2'</span>: [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'two'</span>],
                   <span style="color: #ff4ea3;">'data3'</span>: [1, 2, 3, 5, 5],
                   <span style="color: #ff4ea3;">'data4'</span>: [6, 7, 8, 8, 9]})
show_dataframe(df.mode())
</pre>
</div>


<div id="img/fig37020hxO.png" class="figure">
<p><img src="img/fig37020hxO.png" alt="fig37020hxO.png">
</p>
<p><span class="figure-number">Figure 2:</span> 频繁值统计</p>
</div>
</div>
</div>



<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8"><span class="section-number-3">2.8</span> 数据联结(concat)</h3>
<div class="outline-text-3" id="text-2-8">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(10, 4), columns=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCD'</span>))
<span style="color: #ff8700;">concatted</span> = pd.concat([df.iloc[:3], df.iloc[3:7], df.iloc[7:]])
show_dataframe(concatted)  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">(concatted == df).all().all(): True</span>
</pre>
</div>


<div id="img/fig370207Fb.png" class="figure">
<p><img src="img/fig370207Fb.png" alt="fig370207Fb.png">
</p>
<p><span class="figure-number">Figure 3:</span> cat</p>
</div>
</div>
</div>


<div id="outline-container-sec-2-9" class="outline-3">
<h3 id="sec-2-9"><span class="section-number-3">2.9</span> 数据合并(merge)</h3>
<div class="outline-text-3" id="text-2-9">
<p>
<b>相当于数据库操作中的外连接</b>
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">left</span> = pd.DataFrame({<span style="color: #ff4ea3;">'key'</span>: [<span style="color: #ff4ea3;">'foo'</span>, <span style="color: #ff4ea3;">'foo'</span>], <span style="color: #ff4ea3;">'lval'</span>: [1, 2]})
<span style="color: #ff8700;">right</span> = pd.DataFrame({<span style="color: #ff4ea3;">'key'</span>: [<span style="color: #ff4ea3;">'foo'</span>, <span style="color: #ff4ea3;">'foo'</span>], <span style="color: #ff4ea3;">'rval'</span>: [4, 5]})

<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">SELECT * FROM left INNER JOIN right ON left.key = right.key;</span>
<span style="color: #ff8700;">merged</span> = pd.merge(left, right, on=<span style="color: #ff4ea3;">'key'</span>)
show_dataframe(merged)
</pre>
</div>


<div id="img/fig37020Van.png" class="figure">
<p><img src="img/fig37020Van.png" alt="fig37020Van.png">
</p>
<p><span class="figure-number">Figure 4:</span> merge</p>
</div>
</div>
</div>


<div id="outline-container-sec-2-10" class="outline-3">
<h3 id="sec-2-10"><span class="section-number-3">2.10</span> 行列索引转换</h3>
<div class="outline-text-3" id="text-2-10">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">tuples</span> = <span style="color: #d18aff;">list</span>(<span style="color: #d18aff;">zip</span>(*[[<span style="color: #ff4ea3;">'bar'</span>, <span style="color: #ff4ea3;">'bar'</span>, <span style="color: #ff4ea3;">'baz'</span>, <span style="color: #ff4ea3;">'baz'</span>,
                     <span style="color: #ff4ea3;">'foo'</span>, <span style="color: #ff4ea3;">'foo'</span>, <span style="color: #ff4ea3;">'qux'</span>, <span style="color: #ff4ea3;">'qux'</span>],
                    [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>,
                     <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>]]))
<span style="color: #ff8700;">index</span> = pd.MultiIndex.from_tuples(tuples, names=[<span style="color: #ff4ea3;">'first'</span>, <span style="color: #ff4ea3;">'second'</span>])
<span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(8, 2), index=index, columns=[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>])
show_dataframe(df)
</pre>
</div>


<div id="img/fig37020uCJ.png" class="figure">
<p><img src="img/fig37020uCJ.png" alt="fig37020uCJ.png">
</p>
<p><span class="figure-number">Figure 5:</span> 示例数据</p>
</div>
</div>

<div id="outline-container-sec-2-10-1" class="outline-4">
<h4 id="sec-2-10-1"><span class="section-number-4">2.10.1</span> 将列索引变为行索引 (stack)</h4>
<div class="outline-text-4" id="text-2-10-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">stacked</span> = df.stack()
log(<span style="color: #ff4ea3;">"stacked"</span>, stacked)
log(<span style="color: #ff4ea3;">"type(stacked)"</span>, <span style="color: #d18aff;">type</span>(stacked))
log(<span style="color: #ff4ea3;">"stacked.index"</span>, stacked.index)
</pre>
</div>

<pre class="example">
=================================== stacked ====================================
first  second
bar    one     A   -0.818305
               B   -0.407198
       two     A   -0.930088
               B    0.219520
baz    one     A    0.686395
               B    2.094117
       two     A   -1.339537
               B    0.035431
foo    one     A   -0.171338
               B   -1.603817
       two     A   -0.505844
               B   -0.449625
qux    one     A    0.619817
               B    0.976513
       two     A    0.306621
               B   -0.505638
dtype: float64
================================ type(stacked) =================================
&lt;class 'pandas.core.series.Series'&gt;
================================ stacked.index =================================
MultiIndex(levels=[['bar', 'baz', 'foo', 'qux'], ['one', 'two'], ['A', 'B']],
           labels=[[0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3], [0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1], [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1]],
           names=['first', 'second', None])
</pre>
</div>
</div>


<div id="outline-container-sec-2-10-2" class="outline-4">
<h4 id="sec-2-10-2"><span class="section-number-4">2.10.2</span> 将行索引变为列索引 (unstack)</h4>
<div class="outline-text-4" id="text-2-10-2">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(stacked.unstack())
</pre>
</div>


<div id="img/fig37020IXV.png" class="figure">
<p><img src="img/fig37020IXV.png" alt="fig37020IXV.png">
</p>
<p><span class="figure-number">Figure 6:</span> unstack</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-2-11" class="outline-3">
<h3 id="sec-2-11"><span class="section-number-3">2.11</span> 透视图（pivot_table）</h3>
<div class="outline-text-3" id="text-2-11">
<p>
用于观察 data frame 中一部分数据
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">'A'</span> : [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>] * 3,
                   <span style="color: #ff4ea3;">'B'</span> : [<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>, <span style="color: #ff4ea3;">'C'</span>] * 4,
                   <span style="color: #ff4ea3;">'C'</span> : [<span style="color: #ff4ea3;">'foo'</span>, <span style="color: #ff4ea3;">'foo'</span>, <span style="color: #ff4ea3;">'foo'</span>, <span style="color: #ff4ea3;">'bar'</span>, <span style="color: #ff4ea3;">'bar'</span>, <span style="color: #ff4ea3;">'bar'</span>] * 2,
                   <span style="color: #ff4ea3;">'D'</span> : np.random.randn(12),
                   <span style="color: #ff4ea3;">'E'</span> : np.random.randn(12)})

show_dataframe(df)
</pre>
</div>


<div id="img/fig37020irh.png" class="figure">
<p><img src="img/fig37020irh.png" alt="fig37020irh.png">
</p>
<p><span class="figure-number">Figure 7:</span> 示例数据</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = pd.pivot_table(df, values=<span style="color: #ff4ea3;">'D'</span>, index=[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>], columns=[<span style="color: #ff4ea3;">'C'</span>])
show_dataframe(result)
</pre>
</div>


<div id="img/fig370208_t.png" class="figure">
<p><img src="img/fig370208_t.png" alt="fig370208_t.png">
</p>
<p><span class="figure-number">Figure 8:</span> 以 A ，B 为行索引，以 C 为列索引的，针对 D 的数据</p>
</div>


<p>
<b>当透视表结果为多个值的时候，默认返回平均值</b> ：
</p>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = pd.pivot_table(df, values=[<span style="color: #ff4ea3;">'E'</span>], index=[<span style="color: #ff4ea3;">'A'</span>], columns=[<span style="color: #ff4ea3;">'C'</span>])
show_dataframe(result)
</pre>
</div>


<div id="img/fig370207TD.png" class="figure">
<p><img src="img/fig370207TD.png" alt="fig370207TD.png">
</p>
<p><span class="figure-number">Figure 9:</span> 默认计算平均值</p>
</div>

<p>
针对 A 为 one 的那行数据，其计算过程相当于：
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">result</span> = df[df.A==<span style="color: #ff4ea3;">'one'</span>].groupby(<span style="color: #ff4ea3;">'C'</span>)[<span style="color: #ff4ea3;">'E'</span>].mean()
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
==================================== result ====================================
C
bar   -0.021053
foo    1.062916
Name: E, dtype: float64
</pre>
</div>
</div>


<div id="outline-container-sec-2-12" class="outline-3">
<h3 id="sec-2-12"><span class="section-number-3">2.12</span> 数据分类(astype('category'))</h3>
<div class="outline-text-3" id="text-2-12">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">"id"</span>:[1,2,3,4,5,6], <span style="color: #ff4ea3;">"raw_grade"</span>:[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'e'</span>]})
<span style="color: #ff8700;">df</span>[<span style="color: #ff4ea3;">"grade"</span>] = df[<span style="color: #ff4ea3;">"raw_grade"</span>].astype(<span style="color: #ff4ea3;">"category"</span>)
show_dataframe(df)
</pre>
</div>


<div id="img/fig37020v8b.png" class="figure">
<p><img src="img/fig37020v8b.png" alt="fig37020v8b.png">
</p>
<p><span class="figure-number">Figure 10:</span> 示例数据</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.grade"</span>, df.grade)
log(<span style="color: #ff4ea3;">"df.grade.cat.categories"</span>, df.grade.cat.categories)
</pre>
</div>

<pre class="example">
=================================== df.grade ===================================
0    a
1    b
2    b
3    a
4    a
5    e
Name: grade, dtype: category
Categories (3, object): [a, b, e]
=========================== df.grade.cat.categories ============================
Index(['a', 'b', 'e'], dtype='object')
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df.grade.cat.categories</span> = [<span style="color: #ff4ea3;">'very good'</span>, <span style="color: #ff4ea3;">'good'</span>, <span style="color: #ff4ea3;">'bad'</span>]
<span style="color: #ff8700;">sort_result</span> = df.sort_values(by=<span style="color: #ff4ea3;">'grade'</span>, ascending=<span style="color: #5fafd7;">False</span>)
show_dataframe(sort_result)
</pre>
</div>


<div id="img/fig37020JRo.png" class="figure">
<p><img src="img/fig37020JRo.png" alt="fig37020JRo.png">
</p>
<p><span class="figure-number">Figure 11:</span> 以 raw_grade 列为排序标准</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 索引</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> 重新索引</h3>
<div class="outline-text-3" id="text-3-1">
<p>
即把索引值进行重新赋值， <b>以增加一些行的数据</b> 。
</p>
</div>

<div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> Series</h4>
<div class="outline-text-4" id="text-3-1-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series([1, 3, 5, 6, 8], index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'acefh'</span>))
log(<span style="color: #ff4ea3;">"s"</span>, s)
</pre>
</div>

<pre class="example">
====================================== s =======================================
a    1
c    3
e    5
f    6
h    8
dtype: int64
</pre>

<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s.reindex(list('abcdefgh'))"</span>,
    s.reindex(<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcdefgh'</span>)))
</pre>
</div>

<pre class="example">
========================= s.reindex(list('abcdefgh')) ==========================
a    1.0
b    NaN
c    3.0
d    NaN
e    5.0
f    6.0
g    NaN
h    8.0
dtype: float64
</pre>
</div>


<div id="outline-container-sec-3-1-1-0-1" class="outline-6">
<h6 id="sec-3-1-1-0-1"><span class="section-number-6">3.1.1.0.1</span> 填充默认值</h6>
<div class="outline-text-6" id="text-3-1-1-0-1">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s.reindex(list('abcdefgh'), fill_value=0)"</span>,
    s.reindex(<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcdefgh'</span>), fill_value=0))
</pre>
</div>

<pre class="example">
================== s.reindex(list('abcdefgh'), fill_value=0) ===================
a    1
b    0
c    3
d    0
e    5
f    6
g    0
h    8
dtype: int64
</pre>
</div>
</div>

<div id="outline-container-sec-3-1-1-0-2" class="outline-6">
<h6 id="sec-3-1-1-0-2"><span class="section-number-6">3.1.1.0.2</span> 往前填充</h6>
<div class="outline-text-6" id="text-3-1-1-0-2">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s.reindex(list('abcdefgh'), method='ffill')"</span>,
    s.reindex(<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcdefgh'</span>), method=<span style="color: #ff4ea3;">'ffill'</span>))
</pre>
</div>

<pre class="example">
================= s.reindex(list('abcdefgh'), method='ffill') ==================
a    1
b    1
c    3
d    3
e    5
f    6
g    6
h    8
dtype: int64
</pre>
</div>
</div>


<div id="outline-container-sec-3-1-1-0-3" class="outline-6">
<h6 id="sec-3-1-1-0-3"><span class="section-number-6">3.1.1.0.3</span> 往后填充</h6>
<div class="outline-text-6" id="text-3-1-1-0-3">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s.reindex(list('abcdefgh'), method='bfill')"</span>,
    s.reindex(<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcdefgh'</span>), method=<span style="color: #ff4ea3;">'bfill'</span>))
</pre>
</div>

<pre class="example">
================= s.reindex(list('abcdefgh'), method='bfill') ==================
a    1
b    3
c    3
d    5
e    5
f    6
g    8
h    8
dtype: int64
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2"><span class="section-number-4">3.1.2</span> DataFrame</h4>
<div class="outline-text-4" id="text-3-1-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(4, 6),
                  index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ADFH'</span>),
                  columns=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>, <span style="color: #ff4ea3;">'four'</span>, <span style="color: #ff4ea3;">'five'</span>, <span style="color: #ff4ea3;">'six'</span>])
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== df ======================================
        one       two     three      four      five       six
A  0.132692  0.234315 -0.991630  1.230777  1.552560 -1.245982
D -1.378563  1.121745 -0.927618  0.168251 -0.534366 -0.610560
F  0.219192 -0.642972  0.004221  1.705394 -1.237325 -1.022091
H -2.090543 -0.504130  1.401524 -0.433258  1.652494 -1.948064
</pre>
</div>

<div id="outline-container-sec-3-1-2-0-1" class="outline-6">
<h6 id="sec-3-1-2-0-1"><span class="section-number-6">3.1.2.0.1</span> 对行重新索引</h6>
<div class="outline-text-6" id="text-3-1-2-0-1">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.reindex(index=list('ABCDEFGH'))"</span>,
    df.reindex(index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCDEFGH'</span>)))
</pre>
</div>

<pre class="example">
====================== df.reindex(index=list('ABCDEFGH')) ======================
        one       two     three      four      five       six
A  0.132692  0.234315 -0.991630  1.230777  1.552560 -1.245982
B       NaN       NaN       NaN       NaN       NaN       NaN
C       NaN       NaN       NaN       NaN       NaN       NaN
D -1.378563  1.121745 -0.927618  0.168251 -0.534366 -0.610560
E       NaN       NaN       NaN       NaN       NaN       NaN
F  0.219192 -0.642972  0.004221  1.705394 -1.237325 -1.022091
G       NaN       NaN       NaN       NaN       NaN       NaN
H -2.090543 -0.504130  1.401524 -0.433258  1.652494 -1.948064
</pre>
</div>

<div id="outline-container-sec-3-1-2-0-1-1" class="outline-7">
<h7 id="sec-3-1-2-0-1-1"><span class="section-number-7">3.1.2.0.1.1</span> 向前填充</h7>
<div class="outline-text-7" id="text-3-1-2-0-1-1">
<p>
<b>fill method 只对行重新索引有效，不适用列</b>
</p>

<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.reindex(index=list('ABCDEFGH'), method='ffill')"</span>,
    df.reindex(index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCDEFGH'</span>), method=<span style="color: #ff4ea3;">'ffill'</span>))
</pre>
</div>

<pre class="example">
============== df.reindex(index=list('ABCDEFGH'), method='ffill') ==============
        one       two     three      four      five       six
A  0.132692  0.234315 -0.991630  1.230777  1.552560 -1.245982
B  0.132692  0.234315 -0.991630  1.230777  1.552560 -1.245982
C  0.132692  0.234315 -0.991630  1.230777  1.552560 -1.245982
D -1.378563  1.121745 -0.927618  0.168251 -0.534366 -0.610560
E -1.378563  1.121745 -0.927618  0.168251 -0.534366 -0.610560
F  0.219192 -0.642972  0.004221  1.705394 -1.237325 -1.022091
G  0.219192 -0.642972  0.004221  1.705394 -1.237325 -1.022091
H -2.090543 -0.504130  1.401524 -0.433258  1.652494 -1.948064
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-1-2-0-2" class="outline-6">
<h6 id="sec-3-1-2-0-2"><span class="section-number-6">3.1.2.0.2</span> 对列重新索引</h6>
<div class="outline-text-6" id="text-3-1-2-0-2">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.reindex(columns=['one', 'three', 'five', 'seven'], fill_value=0)"</span>,
    df.reindex(columns=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'three'</span>, <span style="color: #ff4ea3;">'five'</span>, <span style="color: #ff4ea3;">'seven'</span>], fill_value=0))
</pre>
</div>

<pre class="example">
===== df.reindex(columns=['one', 'three', 'five', 'seven'], fill_value=0) ======
        one     three      five  seven
A  0.132692 -0.991630  1.552560      0
D -1.378563 -0.927618 -0.534366      0
F  0.219192  0.004221 -1.237325      0
H -2.090543  1.401524  1.652494      0
</pre>
</div>
</div>
</div>
</div>





<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> 索引命名</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(np.random.rand(5), index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcde'</span>))
<span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(4, 3), columns=[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'three'</span>])

log(<span style="color: #ff4ea3;">"s"</span>, s)
log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
====================================== s =======================================
a    0.238992
b    0.060047
c    0.705591
d    0.117159
e    0.796731
dtype: float64
====================================== df ======================================
        one       two     three
0  0.449905 -1.976822  1.146894
1  0.575061 -3.523687  0.736256
2 -0.660648 -0.454135  0.578583
3 -0.850605 -0.916484 -1.413908
</pre>

<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s.index"</span>, s.index)
<span style="color: #ff8700;">s.index.name</span> = <span style="color: #ff4ea3;">'alpha'</span>
log(<span style="color: #ff4ea3;">"s"</span>, s)
</pre>
</div>

<pre class="example">
=================================== s.index ====================================
Index(['a', 'b', 'c', 'd', 'e'], dtype='object')
====================================== s =======================================
alpha
a    0.238992
b    0.060047
c    0.705591
d    0.117159
e    0.796731
dtype: float64
</pre>

<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.index"</span>, df.index)
log(<span style="color: #ff4ea3;">"df.columns"</span>, df.columns)

<span style="color: #ff8700;">df.index.name</span> = <span style="color: #ff4ea3;">'row'</span>
<span style="color: #ff8700;">df.columns.name</span> = <span style="color: #ff4ea3;">'col'</span>

log(<span style="color: #ff4ea3;">"df"</span>, df)
</pre>
</div>

<pre class="example">
=================================== df.index ===================================
RangeIndex(start=0, stop=4, step=1)
================================== df.columns ==================================
Index(['one', 'two', 'three'], dtype='object')
====================================== df ======================================
col       one       two     three
row
0    0.449905 -1.976822  1.146894
1    0.575061 -3.523687  0.736256
2   -0.660648 -0.454135  0.578583
3   -0.850605 -0.916484 -1.413908
</pre>
</div>
</div>


<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> 重复索引</h3>
<div class="outline-text-3" id="text-3-3">
<p>
索引值有重复项的索引
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(np.arange(6), index=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'abcbda'</span>))
log(<span style="color: #ff4ea3;">"s"</span>, s)
</pre>
</div>

<pre class="example">
====================================== s =======================================
a    0
b    1
c    2
b    3
d    4
a    5
dtype: int64
</pre>

<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s['a']"</span>, s[<span style="color: #ff4ea3;">'a'</span>])
log(<span style="color: #ff4ea3;">"s.index.is_unique"</span>, s.index.is_unique)
</pre>
</div>

<pre class="example">
==================================== s['a'] ====================================
a    0
a    5
dtype: int64
============================== s.index.is_unique ===============================
False
</pre>
</div>


<div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> 对重复索引的处理（清洗）</h4>
<div class="outline-text-4" id="text-3-3-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">sum_result</span> = s.groupby(s.index).<span style="color: #d18aff;">sum</span>()  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#23545;&#37325;&#22797;&#32034;&#24341;&#20869;&#23481;&#36827;&#34892;&#27714;&#21644;</span>
log(<span style="color: #ff4ea3;">"sum_result"</span>, sum_result)

<span style="color: #ff8700;">first_result</span> = s.groupby(s.index).first()  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#23545;&#37325;&#22797;&#32034;&#24341;&#20869;&#23481;&#21482;&#21462;&#31532;&#19968;&#39033;</span>
log(<span style="color: #ff4ea3;">"first_result"</span>, first_result)

<span style="color: #ff8700;">avg_result</span> = s.groupby(s.index).mean()  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#23545;&#37325;&#22797;&#32034;&#24341;&#20869;&#23481;&#21462;&#24179;&#22343;&#20540;</span>
log(<span style="color: #ff4ea3;">"avg_result"</span>, avg_result)
</pre>
</div>

<pre class="example">
================================== sum_result ==================================
a    5
b    4
c    2
d    4
dtype: int64
================================= first_result =================================
a    0
b    1
c    2
d    4
dtype: int64
================================== avg_result ==================================
a    2.5
b    2.0
c    2.0
d    4.0
dtype: float64
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> 多级索引</h3>
<div class="outline-text-3" id="text-3-4">
<p>
<b>用二维的数据表达更高维度的数据</b> ，使数据组织方式更清晰，它使用 <code>pd.MultiIndex</code> 类来表示。
</p>
</div>

<div id="outline-container-sec-3-4-1" class="outline-4">
<h4 id="sec-3-4-1"><span class="section-number-4">3.4.1</span> 层次化索引的作用</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
比如在分析股票数据：
</p>
<ul class="org-ul">
<li>一级行索引可以是日期
</li>
<li>二级行索引可以是股票代码
</li>
<li>列索引可以是股票的交易量，开盘价，收盘价等等
</li>
</ul>

<p>
这样就可以把多个股票放在同一个时间维度下进行考察和分析。
</p>
</div>
</div>


<div id="outline-container-sec-3-4-2" class="outline-4">
<h4 id="sec-3-4-2"><span class="section-number-4">3.4.2</span> Series 多级索引</h4>
<div class="outline-text-4" id="text-3-4-2">
</div><div id="outline-container-sec-3-4-2-1" class="outline-5">
<h5 id="sec-3-4-2-1"><span class="section-number-5">3.4.2.1</span> 创建</h5>
<div class="outline-text-5" id="text-3-4-2-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">a</span> = [[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'c'</span>], [1, 2, 3, 1, 2, 2, 3]]
<span style="color: #ff8700;">tuples</span> = <span style="color: #d18aff;">list</span>(<span style="color: #d18aff;">zip</span>(*a))
log(<span style="color: #ff4ea3;">"tuples"</span>, tuples)
<span style="color: #ff8700;">index</span> = pd.MultiIndex.from_tuples(tuples, names=[<span style="color: #ff4ea3;">'first'</span>, <span style="color: #ff4ea3;">'second'</span>])
log(<span style="color: #ff4ea3;">"index"</span>, index)
<span style="color: #ff8700;">s</span> = pd.Series(np.random.randn(7), index=index)
log(<span style="color: #ff4ea3;">"s"</span>, s)
log(<span style="color: #ff4ea3;">"s.index"</span>, s.index)
log(<span style="color: #ff4ea3;">"s.index.levels[1]"</span>, s.index.levels[1])
</pre>
</div>

<pre class="example">
==================================== tuples ====================================
[('a', 1), ('a', 2), ('a', 3), ('b', 1), ('b', 2), ('c', 2), ('c', 3)]
==================================== index =====================================
MultiIndex(levels=[['a', 'b', 'c'], [1, 2, 3]],
           labels=[[0, 0, 0, 1, 1, 2, 2], [0, 1, 2, 0, 1, 1, 2]],
           names=['first', 'second'])
====================================== s =======================================
first  second
a      1        -0.456506
       2        -1.593649
       3        -0.911247
b      1         0.588854
       2        -1.332917
c      2        -0.314307
       3        -0.896183
dtype: float64
=================================== s.index ====================================
MultiIndex(levels=[['a', 'b', 'c'], [1, 2, 3]],
           labels=[[0, 0, 0, 1, 1, 2, 2], [0, 1, 2, 0, 1, 1, 2]],
           names=['first', 'second'])
============================== s.index.levels[1] ===============================
Int64Index([1, 2, 3], dtype='int64', name='second')
</pre>
</div>
</div>

<div id="outline-container-sec-3-4-2-2" class="outline-5">
<h5 id="sec-3-4-2-2"><span class="section-number-5">3.4.2.2</span> 选取</h5>
<div class="outline-text-5" id="text-3-4-2-2">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"s['b']"</span>, s[<span style="color: #ff4ea3;">'b'</span>])
log(<span style="color: #ff4ea3;">"s['b':'c']"</span>, s[<span style="color: #ff4ea3;">'b'</span>:<span style="color: #ff4ea3;">'c'</span>])
log(<span style="color: #ff4ea3;">"s[['b', 'a']]"</span>, s[[<span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>]])
log(<span style="color: #ff4ea3;">"s['b', 1]"</span>, s[<span style="color: #ff4ea3;">'b'</span>, 1])
log(<span style="color: #ff4ea3;">"s[:, 2]"</span>, s[:, 2])
</pre>
</div>

<pre class="example">
==================================== s['b'] ====================================
second
1    0.588854
2   -1.332917
dtype: float64
================================== s['b':'c'] ==================================
first  second
b      1         0.588854
       2        -1.332917
c      2        -0.314307
       3        -0.896183
dtype: float64
================================ s[['b', 'a']] =================================
first  second
a      1        -0.456506
       2        -1.593649
       3        -0.911247
b      1         0.588854
       2        -1.332917
dtype: float64
================================== s['b', 1] ===================================
0.5888538972164659
=================================== s[:, 2] ====================================
first
a   -1.593649
b   -1.332917
c   -0.314307
dtype: float64
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-4-3" class="outline-4">
<h4 id="sec-3-4-3"><span class="section-number-4">3.4.3</span> DataFrame 多级索引</h4>
<div class="outline-text-4" id="text-3-4-3">
</div><div id="outline-container-sec-3-4-3-1" class="outline-5">
<h5 id="sec-3-4-3-1"><span class="section-number-5">3.4.3.1</span> 创建</h5>
<div class="outline-text-5" id="text-3-4-3-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 10, (4, 3)),  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">1-10 &#20043;&#38388;&#30340;&#38543;&#26426;&#25968;&#65292;4 &#34892; 3 &#21015;</span>
                  index=[[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>], [1, 2, 1, 2]],
                  columns=[[<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>], [<span style="color: #ff4ea3;">'blue'</span>, <span style="color: #ff4ea3;">'red'</span>, <span style="color: #ff4ea3;">'blue'</span>]])
<span style="color: #ff8700;">df.index.names</span> = [<span style="color: #ff4ea3;">'row-1'</span>, <span style="color: #ff4ea3;">'row-2'</span>]
<span style="color: #ff8700;">df.columns.names</span> = [<span style="color: #ff4ea3;">'col-1'</span>, <span style="color: #ff4ea3;">'col-2'</span>]
show_dataframe(df)
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428gsV.png" alt="fig75428gsV.png">
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-4-3-2" class="outline-5">
<h5 id="sec-3-4-3-2"><span class="section-number-5">3.4.3.2</span> 选取</h5>
<div class="outline-text-5" id="text-3-4-3-2">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.loc[<span style="color: #ff4ea3;">'a'</span>])
</pre>
</div>


<div class="figure">
<p><img src="img/fig754286Ai.png" alt="fig754286Ai.png">
</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.loc['a', 1]"</span>, df.loc[<span style="color: #ff4ea3;">'a'</span>, 1])
</pre>
</div>

<pre class="example">
================================ df.loc['a', 1] ================================
col-1  col-2
one    blue     5
       red      9
two    blue     7
Name: (a, 1), dtype: int64
</pre>
</div>
</div>


<div id="outline-container-sec-3-4-3-3" class="outline-5">
<h5 id="sec-3-4-3-3"><span class="section-number-5">3.4.3.3</span> 多级索引交换</h5>
<div class="outline-text-5" id="text-3-4-3-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df2</span> = df.swaplevel(<span style="color: #ff4ea3;">'row-1'</span>, <span style="color: #ff4ea3;">'row-2'</span>)
show_dataframe(df2)
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428UVu.png" alt="fig75428UVu.png">
</p>
</div>
</div>
</div>


<div id="outline-container-sec-3-4-3-4" class="outline-5">
<h5 id="sec-3-4-3-4"><span class="section-number-5">3.4.3.4</span> 多级索引排序</h5>
<div class="outline-text-5" id="text-3-4-3-4">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df2.sortlevel(0))  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">0 &#34920;&#31034;&#26681;&#25454;&#19968;&#32423;&#32034;&#24341;&#36827;&#34892;&#25490;&#24207;</span>
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428TpD.png" alt="fig75428TpD.png">
</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df2.sortlevel(1))  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#26681;&#25454;&#20108;&#32423;&#32034;&#24341;&#36827;&#34892;&#25490;&#24207;</span>
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428t9P.png" alt="fig75428t9P.png">
</p>
</div>
</div>
</div>


<div id="outline-container-sec-3-4-3-5" class="outline-5">
<h5 id="sec-3-4-3-5"><span class="section-number-5">3.4.3.5</span> 多级索引统计</h5>
<div class="outline-text-5" id="text-3-4-3-5">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.<span style="color: #d18aff;">sum</span>(level=0))
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428HSc.png" alt="fig75428HSc.png">
</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.<span style="color: #d18aff;">sum</span>(level=1))
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428hmo.png" alt="fig75428hmo.png">
</p>
</div>
</div>
</div>


<div id="outline-container-sec-3-4-3-6" class="outline-5">
<h5 id="sec-3-4-3-6"><span class="section-number-5">3.4.3.6</span> 列与索引的转换</h5>
<div class="outline-text-5" id="text-3-4-3-6">
<p>
创建多级索引比较复杂，一般情况下会从文件中读取一个 DataFrame ，
然后将其中某个列转换为多级索引，最终得到一个基于多级索引的 DataFrame 。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({
    <span style="color: #ff4ea3;">'a'</span>: <span style="color: #d18aff;">range</span>(7),
    <span style="color: #ff4ea3;">'b'</span>: <span style="color: #d18aff;">range</span>(7, 0, -1),
    <span style="color: #ff4ea3;">'c'</span>: [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'two'</span>],
    <span style="color: #ff4ea3;">'d'</span>: [0, 1, 2, 0, 1, 2, 3]
})
show_dataframe(df)
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428760.png" alt="fig75428760.png">
</p>
</div>
</div>

<div id="outline-container-sec-3-4-3-6-1" class="outline-6">
<h6 id="sec-3-4-3-6-1"><span class="section-number-6">3.4.3.6.1</span> 列转换为索引</h6>
<div class="outline-text-6" id="text-3-4-3-6-1">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.set_index(<span style="color: #ff4ea3;">'c'</span>))
</pre>
</div>


<div class="figure">
<p><img src="img/fig754286OK.png" alt="fig754286OK.png">
</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df2</span> = df.set_index([<span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>])
show_dataframe(df2)
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428UjW.png" alt="fig75428UjW.png">
</p>
</div>
</div>
</div>



<div id="outline-container-sec-3-4-3-6-2" class="outline-6">
<h6 id="sec-3-4-3-6-2"><span class="section-number-6">3.4.3.6.2</span> 索引转换为列</h6>
<div class="outline-text-6" id="text-3-4-3-6-2">
<p>
将所有索引转换为列
</p>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df2.reset_index().sort_index(<span style="color: #ff4ea3;">'columns'</span>))
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428u3i.png" alt="fig75428u3i.png">
</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>





<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 分组与聚合</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">'key1'</span>: [<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>],
                   <span style="color: #ff4ea3;">'key2'</span>: [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>],
                   <span style="color: #ff4ea3;">'data1'</span>: np.random.randint(1, 10, 5),
                   <span style="color: #ff4ea3;">'data2'</span>: np.random.randint(1, 10, 5)})

show_dataframe(df)
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428IMv.png" alt="fig75428IMv.png">
</p>
</div>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> 原理</h3>
<div class="outline-text-3" id="text-4-1">
<p>
三步曲：
</p>

<ol class="org-ol">
<li>拆分：根据什么进行分组
</li>
<li>应用：每个分组进行什么样的计算（每个组应用一个 <b>计算规则</b> ，输出一个结果）
</li>
<li>聚合：把每个分组的计算结果合并起来，构成最终输出
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> 分组</h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> 对 Series 进行分组</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
通过索引对齐关联起来
</p>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">grouped</span> = df[<span style="color: #ff4ea3;">'data1'</span>].groupby(df[<span style="color: #ff4ea3;">'key1'</span>])
log(<span style="color: #ff4ea3;">"grouped"</span>, grouped)         <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">groupby &#23545;&#35937;</span>
log(<span style="color: #ff4ea3;">"grouped.mean()"</span>, grouped.mean())
<span style="color: #ff8700;">key</span> = [1, 2, 1, 2, 1]
log(<span style="color: #ff4ea3;">"df['data1'].groupby(key)"</span>, df[<span style="color: #ff4ea3;">'data1'</span>].groupby(key))
</pre>
</div>

<pre class="example">
=================================== grouped ====================================
&lt;pandas.core.groupby.SeriesGroupBy object at 0x11024f978&gt;
================================ grouped.mean() ================================
key1
a    4.0
b    4.5
Name: data1, dtype: float64
=========================== df['data1'].groupby(key) ===========================
&lt;pandas.core.groupby.SeriesGroupBy object at 0x1130f8518&gt;
</pre>


<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df['data1'].groupby([df['key1'], df['key2']]).mean()"</span>,
    df[<span style="color: #ff4ea3;">'data1'</span>].groupby([df[<span style="color: #ff4ea3;">'key1'</span>], df[<span style="color: #ff4ea3;">'key2'</span>]]).mean())
log(<span style="color: #ff4ea3;">"df['data1'].groupby([df['key1'], df['key2']]).size()"</span>,
    df[<span style="color: #ff4ea3;">'data1'</span>].groupby([df[<span style="color: #ff4ea3;">'key1'</span>], df[<span style="color: #ff4ea3;">'key2'</span>]]).size())
</pre>
</div>

<pre class="example">
============= df['data1'].groupby([df['key1'], df['key2']]).mean() =============
key1  key2
a     one     4
      two     4
b     one     8
      two     1
Name: data1, dtype: int64
============= df['data1'].groupby([df['key1'], df['key2']]).size() =============
key1  key2
a     one     2
      two     1
b     one     1
      two     1
Name: data1, dtype: int64
</pre>
</div>
</div>


<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> 对 DataFrame 进行分组（默认按行分组）</h4>
<div class="outline-text-4" id="text-4-2-2">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(<span style="color: #ff4ea3;">'key1'</span>).mean())
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428HgE.png" alt="fig75428HgE.png">
</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df1</span> = df.groupby([<span style="color: #ff4ea3;">'key1'</span>, <span style="color: #ff4ea3;">'key2'</span>]).mean()
show_dataframe(df1)
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428h0Q.png" alt="fig75428h0Q.png">
</p>
</div>
</div>
</div>


<div id="outline-container-sec-4-2-3" class="outline-4">
<h4 id="sec-4-2-3"><span class="section-number-4">4.2.3</span> 对分组对象进行迭代</h4>
<div class="outline-text-4" id="text-4-2-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">for</span> name, group <span style="color: #a1db00;">in</span> df.groupby(<span style="color: #ff4ea3;">'key1'</span>):
    <span style="color: #a1db00;">print</span>(name)
    <span style="color: #a1db00;">print</span>(group)

<span style="color: #a1db00;">print</span>(<span style="color: #ff4ea3;">'='</span>*80)

<span style="color: #a1db00;">for</span> name, group <span style="color: #a1db00;">in</span> df.groupby([<span style="color: #ff4ea3;">'key1'</span>, <span style="color: #ff4ea3;">'key2'</span>]):
    <span style="color: #a1db00;">print</span>(name)
    <span style="color: #a1db00;">print</span>(group)
</pre>
</div>

<pre class="example">
a
   data1  data2 key1 key2
0      1      8    a  one
1      4      4    a  two
4      7      4    a  one
b
   data1  data2 key1 key2
2      8      8    b  one
3      1      8    b  two
================================================================================
('a', 'one')
   data1  data2 key1 key2
0      1      8    a  one
4      7      4    a  one
('a', 'two')
   data1  data2 key1 key2
1      4      4    a  two
('b', 'one')
   data1  data2 key1 key2
2      8      8    b  one
('b', 'two')
   data1  data2 key1 key2
3      1      8    b  two
</pre>
</div>
</div>


<div id="outline-container-sec-4-2-4" class="outline-4">
<h4 id="sec-4-2-4"><span class="section-number-4">4.2.4</span> 通过字典进行分组</h4>
<div class="outline-text-4" id="text-4-2-4">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 10, (5, 5)),
                  columns=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'e'</span>],
                  index=[<span style="color: #ff4ea3;">'Alice'</span>, <span style="color: #ff4ea3;">'Bob'</span>, <span style="color: #ff4ea3;">'Candy'</span>, <span style="color: #ff4ea3;">'Dark'</span>, <span style="color: #ff4ea3;">'Emily'</span>])
<span style="color: #ff8700;">df.iloc</span>[1, 1:3] = np.NaN
show_dataframe(df)
</pre>
</div>


<div class="figure">
<p><img src="img/fig754287Id.png" alt="fig754287Id.png">
</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">mapping</span> = {<span style="color: #ff4ea3;">'a'</span>: <span style="color: #ff4ea3;">'red'</span>, <span style="color: #ff4ea3;">'b'</span>: <span style="color: #ff4ea3;">'red'</span>, <span style="color: #ff4ea3;">'c'</span>: <span style="color: #ff4ea3;">'blue'</span>, <span style="color: #ff4ea3;">'d'</span>: <span style="color: #ff4ea3;">'orange'</span>, <span style="color: #ff4ea3;">'e'</span>: <span style="color: #ff4ea3;">'blue'</span>}
<span style="color: #ff8700;">grouped</span> = df.groupby(mapping, axis=1)  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#25353;&#21015;&#20998;&#32452;</span>
show_dataframe(grouped.<span style="color: #d18aff;">sum</span>())
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428Vdp.png" alt="fig75428Vdp.png">
</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(grouped.count())
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428uFL.png" alt="fig75428uFL.png">
</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"grouped.size()"</span>, grouped.size())
</pre>
</div>

<pre class="example">
================================ grouped.size() ================================
blue      2
orange    1
red       2
dtype: int64
</pre>
</div>
</div>


<div id="outline-container-sec-4-2-5" class="outline-4">
<h4 id="sec-4-2-5"><span class="section-number-4">4.2.5</span> 通过函数分组</h4>
<div class="outline-text-4" id="text-4-2-5">
<p>
当函数作为分组依据时，数据表里的每个索引（可以是行索引，也可以是列索引）都会调用一次函数，
<b>函数的返回值作为分组的索引</b> ，即相同的返回值分在同一组。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 10, (5, 5)),
                  columns=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'e'</span>],
                  index=[<span style="color: #ff4ea3;">'Alice'</span>, <span style="color: #ff4ea3;">'Bob'</span>, <span style="color: #ff4ea3;">'Candy'</span>, <span style="color: #ff4ea3;">'Dark'</span>, <span style="color: #ff4ea3;">'Emily'</span>])
show_dataframe(df)
</pre>
</div>


<div id="img/fig75428iuj.png" class="figure">
<p><img src="img/fig75428iuj.png" alt="fig75428iuj.png">
</p>
<p><span class="figure-number">Figure 29:</span> 示例数据</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">def</span> <span style="color: #ffd700;">_dummy_group</span>(idx):
    <span style="color: #a1db00;">print</span>(<span style="color: #ff4ea3;">"idx:"</span>, idx)
    <span style="color: #a1db00;">return</span> idx

<span style="color: #a1db00;">print</span>(<span style="color: #ff4ea3;">"axis=0"</span>)
df.groupby(_dummy_group)
<span style="color: #a1db00;">print</span>(<span style="color: #ff4ea3;">"axis=1"</span>)
df.groupby(_dummy_group, axis=1)
</pre>
</div>

<pre class="example">
axis=0
idx: Alice
idx: Bob
idx: Candy
idx: Dark
idx: Emily
axis=1
idx: a
idx: b
idx: c
idx: d
idx: e
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">grouped</span> = df.groupby(<span style="color: #d18aff;">len</span>)
show_dataframe(grouped.<span style="color: #d18aff;">sum</span>())
</pre>
</div>


<div class="figure">
<p><img src="img/fig754288Cw.png" alt="fig754288Cw.png">
</p>
</div>
</div>
</div>


<div id="outline-container-sec-4-2-6" class="outline-4">
<h4 id="sec-4-2-6"><span class="section-number-4">4.2.6</span> 多级索引数据根据索引级别来分组</h4>
<div class="outline-text-4" id="text-4-2-6">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">columns</span> = pd.MultiIndex.from_arrays([[<span style="color: #ff4ea3;">'China'</span>, <span style="color: #ff4ea3;">'USA'</span>, <span style="color: #ff4ea3;">'China'</span>, <span style="color: #ff4ea3;">'USA'</span>, <span style="color: #ff4ea3;">'China'</span>],
                                     [<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>, <span style="color: #ff4ea3;">'C'</span>, <span style="color: #ff4ea3;">'B'</span>]], names=[<span style="color: #ff4ea3;">'country'</span>, <span style="color: #ff4ea3;">'index'</span>])
<span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 10, (5, 5)), columns=columns)
show_dataframe(df)
</pre>
</div>


<div id="img/fig754287WF.png" class="figure">
<p><img src="img/fig754287WF.png" alt="fig754287WF.png">
</p>
<p><span class="figure-number">Figure 31:</span> 示例数据</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(level=<span style="color: #ff4ea3;">'country'</span>, axis=1).count())
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428VrR.png" alt="fig75428VrR.png">
</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(level=<span style="color: #ff4ea3;">'country'</span>, axis=1).<span style="color: #d18aff;">sum</span>())
</pre>
</div>


<div class="figure">
<p><img src="img/fig3702047R.png" alt="fig3702047R.png">
</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(level=<span style="color: #ff4ea3;">'index'</span>, axis=1).count())
</pre>
</div>



<div class="figure">
<p><img src="img/fig37020FNM.png" alt="fig37020FNM.png">
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> 数据聚合</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">'key1'</span>: [<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>],
                   <span style="color: #ff4ea3;">'key2'</span>: [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>],
                   <span style="color: #ff4ea3;">'data1'</span>: np.random.randint(1, 10, 5),
                   <span style="color: #ff4ea3;">'data2'</span>: np.random.randint(1, 10, 5),
                   <span style="color: #ff4ea3;">'data3'</span>: np.random.randint(1, 10, 5)})
show_dataframe(df)
</pre>
</div>


<div id="img/fig37020fhY.png" class="figure">
<p><img src="img/fig37020fhY.png" alt="fig37020fhY.png">
</p>
<p><span class="figure-number">Figure 35:</span> 示例数据</p>
</div>
</div>

<div id="outline-container-sec-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> 内置聚合函数</h4>
<div class="outline-text-4" id="text-4-3-1">
</div><div id="outline-container-sec-4-3-1-1" class="outline-5">
<h5 id="sec-4-3-1-1"><span class="section-number-5">4.3.1.1</span> sum</h5>
<div class="outline-text-5" id="text-4-3-1-1">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(<span style="color: #ff4ea3;">'key1'</span>).<span style="color: #d18aff;">sum</span>())
</pre>
</div>


<div id="img/fig37020TKx.png" class="figure">
<p><img src="img/fig37020TKx.png" alt="fig37020TKx.png">
</p>
<p><span class="figure-number">Figure 36:</span> sum</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-3-1-2" class="outline-5">
<h5 id="sec-4-3-1-2"><span class="section-number-5">4.3.1.2</span> mean</h5>
<div class="outline-text-5" id="text-4-3-1-2">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(<span style="color: #ff4ea3;">'key1'</span>).mean())
</pre>
</div>


<div id="img/fig37020SeG.png" class="figure">
<p><img src="img/fig37020SeG.png" alt="fig37020SeG.png">
</p>
<p><span class="figure-number">Figure 37:</span> mean</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-3-1-3" class="outline-5">
<h5 id="sec-4-3-1-3"><span class="section-number-5">4.3.1.3</span> size</h5>
<div class="outline-text-5" id="text-4-3-1-3">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df.groupby('key1').size()"</span>, df.groupby(<span style="color: #ff4ea3;">'key1'</span>).size())
</pre>
</div>

<pre class="example">
========================== df.groupby('key1').size() ===========================
key1
a    3
b    2
dtype: int64
</pre>
</div>
</div>

<div id="outline-container-sec-4-3-1-4" class="outline-5">
<h5 id="sec-4-3-1-4"><span class="section-number-5">4.3.1.4</span> count</h5>
<div class="outline-text-5" id="text-4-3-1-4">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(<span style="color: #ff4ea3;">'key1'</span>).count())
</pre>
</div>


<div id="img/fig37020GHf.png" class="figure">
<p><img src="img/fig37020GHf.png" alt="fig37020GHf.png">
</p>
<p><span class="figure-number">Figure 38:</span> count</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-3-1-5" class="outline-5">
<h5 id="sec-4-3-1-5"><span class="section-number-5">4.3.1.5</span> min/max</h5>
<div class="outline-text-5" id="text-4-3-1-5">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(<span style="color: #ff4ea3;">'key1'</span>).<span style="color: #d18aff;">min</span>())
</pre>
</div>


<div id="img/fig37020gbr.png" class="figure">
<p><img src="img/fig37020gbr.png" alt="fig37020gbr.png">
</p>
<p><span class="figure-number">Figure 39:</span> min</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-3-1-6" class="outline-5">
<h5 id="sec-4-3-1-6"><span class="section-number-5">4.3.1.6</span> describe</h5>
<div class="outline-text-5" id="text-4-3-1-6">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(<span style="color: #ff4ea3;">'key1'</span>).describe())
</pre>
</div>


<div id="img/fig37020fvA.png" class="figure">
<p><img src="img/fig37020fvA.png" alt="fig37020fvA.png">
</p>
<p><span class="figure-number">Figure 40:</span> describe</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-2" class="outline-4">
<h4 id="sec-4-3-2"><span class="section-number-4">4.3.2</span> 自定义聚合函数</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
自定义聚合函数时，需使用 <code>agg()</code> 或 <code>aggregate()</code> 函数。
</p>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">def</span> <span style="color: #ffd700;">peak_range</span>(s):
    <span style="color: #a1db00;">print</span>(s)
    <span style="color: #a1db00;">print</span>(<span style="color: #d18aff;">type</span>(s))
    <span style="color: #a1db00;">print</span>(<span style="color: #ff4ea3;">'====='</span>)
    <span style="color: #a1db00;">return</span> s.<span style="color: #d18aff;">max</span>() - s.<span style="color: #d18aff;">min</span>()

<span style="color: #ff8700;">grouped</span> = df.groupby(<span style="color: #ff4ea3;">'key1'</span>)
<span style="color: #ff8700;">result</span> = grouped.agg(peak_range)
</pre>
</div>

<pre class="example">
0    7
1    1
4    5
Name: data1, dtype: int64
&lt;class 'pandas.core.series.Series'&gt;
=====
2    3
3    8
Name: data1, dtype: int64
&lt;class 'pandas.core.series.Series'&gt;
=====
0    5
1    8
4    3
Name: data2, dtype: int64
&lt;class 'pandas.core.series.Series'&gt;
=====
2    5
3    7
Name: data2, dtype: int64
&lt;class 'pandas.core.series.Series'&gt;
=====
0    3
1    5
4    4
Name: data3, dtype: int64
&lt;class 'pandas.core.series.Series'&gt;
=====
2    8
3    2
Name: data3, dtype: int64
&lt;class 'pandas.core.series.Series'&gt;
=====
0    one
1    two
4    one
Name: key2, dtype: object
&lt;class 'pandas.core.series.Series'&gt;
=====
0    one
1    two
4    one
Name: key2, dtype: object
&lt;class 'pandas.core.series.Series'&gt;
=====
0    one
1    two
4    one
Name: a, dtype: object
&lt;class 'pandas.core.series.Series'&gt;
=====
0    one
1    two
4    one
Name: a, dtype: object
&lt;class 'pandas.core.series.Series'&gt;
=====
</pre>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(result)
</pre>
</div>


<div class="figure">
<p><img src="img/fig3702051k.png" alt="fig3702051k.png">
</p>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-3" class="outline-4">
<h4 id="sec-4-3-3"><span class="section-number-4">4.3.3</span> 应用多个聚合函数</h4>
<div class="outline-text-4" id="text-4-3-3">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(grouped.agg([<span style="color: #ff4ea3;">'std'</span>, <span style="color: #ff4ea3;">'mean'</span>, peak_range]))
</pre>
</div>


<div id="img/fig370205DN.png" class="figure">
<p><img src="img/fig370205DN.png" alt="fig370205DN.png">
</p>
<p><span class="figure-number">Figure 42:</span> 多个聚合函数</p>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-4" class="outline-4">
<h4 id="sec-4-3-4"><span class="section-number-4">4.3.4</span> 给聚合后的列起别名</h4>
<div class="outline-text-4" id="text-4-3-4">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(grouped.agg([<span style="color: #ff4ea3;">'std'</span>, <span style="color: #ff4ea3;">'mean'</span>, (<span style="color: #ff4ea3;">'high-low'</span>, peak_range)]))
</pre>
</div>


<div id="img/fig37020TYZ.png" class="figure">
<p><img src="img/fig37020TYZ.png" alt="fig37020TYZ.png">
</p>
<p><span class="figure-number">Figure 43:</span> 别名</p>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-5" class="outline-4">
<h4 id="sec-4-3-5"><span class="section-number-4">4.3.5</span> 自定义需要显示的列</h4>
<div class="outline-text-4" id="text-4-3-5">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(grouped.<span style="color: #d18aff;">sum</span>())
</pre>
</div>


<div id="img/fig37020tsl.png" class="figure">
<p><img src="img/fig37020tsl.png" alt="fig37020tsl.png">
</p>
<p><span class="figure-number">Figure 44:</span> 所有列</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(grouped[<span style="color: #ff4ea3;">'data1'</span>, <span style="color: #ff4ea3;">'data3'</span>].<span style="color: #d18aff;">sum</span>())
</pre>
</div>


<div id="img/fig37020HBy.png" class="figure">
<p><img src="img/fig37020HBy.png" alt="fig37020HBy.png">
</p>
<p><span class="figure-number">Figure 45:</span> 自定义后的列</p>
</div>
</div>
</div>



<div id="outline-container-sec-4-3-6" class="outline-4">
<h4 id="sec-4-3-6"><span class="section-number-4">4.3.6</span> 给不同的列应用不同的聚合函数</h4>
<div class="outline-text-4" id="text-4-3-6">
<p>
使用 dict 作为参数来实现，此方法也能实现自定义需要显示的列。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">d</span> = {<span style="color: #ff4ea3;">'data1'</span>: [<span style="color: #ff4ea3;">'mean'</span>, peak_range, <span style="color: #ff4ea3;">'max'</span>, <span style="color: #ff4ea3;">'min'</span>],
     <span style="color: #ff4ea3;">'data2'</span>: <span style="color: #ff4ea3;">'sum'</span>}
show_dataframe(grouped.agg(d))
</pre>
</div>


<div id="img/fig37020GVH.png" class="figure">
<p><img src="img/fig37020GVH.png" alt="fig37020GVH.png">
</p>
<p><span class="figure-number">Figure 46:</span> 不同的聚合函数</p>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-7" class="outline-4">
<h4 id="sec-4-3-7"><span class="section-number-4">4.3.7</span> 索引重置</h4>
<div class="outline-text-4" id="text-4-3-7">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#31561;&#25928;&#20110; df.groupby('key1', as_index=False).agg(d)</span>
show_dataframe(grouped.agg(d).reset_index())
</pre>
</div>


<div id="img/fig37020gpT.png" class="figure">
<p><img src="img/fig37020gpT.png" alt="fig37020gpT.png">
</p>
<p><span class="figure-number">Figure 47:</span> reset_index 效果</p>
</div>
</div>
</div>





<div id="outline-container-sec-4-3-8" class="outline-4">
<h4 id="sec-4-3-8"><span class="section-number-4">4.3.8</span> transform</h4>
<div class="outline-text-4" id="text-4-3-8">
<p>
transform_func 作用的是分组后每个列上的数据（Series）， <b>运算结果是 Series</b> ，不是标量。
</p>


<div id="transform" class="figure">
<p><img src="img/pandas_transform.png" alt="pandas_transform.png">
</p>
<p><span class="figure-number">Figure 48:</span> transform 原理</p>
</div>
</div>

<div id="outline-container-sec-4-3-8-1" class="outline-5">
<h5 id="sec-4-3-8-1"><span class="section-number-5">4.3.8.1</span> 案例一（给每行都添加一个分组后的平均值）</h5>
<div class="outline-text-5" id="text-4-3-8-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">'key1'</span>: [<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>],
                   <span style="color: #ff4ea3;">'key2'</span>: [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>],
                   <span style="color: #ff4ea3;">'data1'</span>: np.random.randint(1, 10, 5),
                   <span style="color: #ff4ea3;">'data2'</span>: np.random.randint(1, 10, 5)})
show_dataframe(df)
</pre>
</div>


<div id="img/fig37020USs.png" class="figure">
<p><img src="img/fig37020USs.png" alt="fig37020USs.png">
</p>
<p><span class="figure-number">Figure 49:</span> 示例数据</p>
</div>
</div>

<div id="outline-container-sec-4-3-8-1-1" class="outline-6">
<h6 id="sec-4-3-8-1-1"><span class="section-number-6">4.3.8.1.1</span> 使用 merge 实现</h6>
<div class="outline-text-6" id="text-4-3-8-1-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">k1_mean</span> = df.groupby(<span style="color: #ff4ea3;">'key1'</span>).mean().add_prefix(<span style="color: #ff4ea3;">'mean_'</span>)
show_dataframe(k1_mean)
</pre>
</div>


<div id="img/fig37020TmB.png" class="figure">
<p><img src="img/fig37020TmB.png" alt="fig37020TmB.png">
</p>
<p><span class="figure-number">Figure 50:</span> 先求平均值</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.merge(df, k1_mean, left_on=<span style="color: #ff4ea3;">'key1'</span>, right_index=<span style="color: #5fafd7;">True</span>))
</pre>
</div>


<div id="img/fig37020t6N.png" class="figure">
<p><img src="img/fig37020t6N.png" alt="fig37020t6N.png">
</p>
<p><span class="figure-number">Figure 51:</span> 使用 merge</p>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-8-1-2" class="outline-6">
<h6 id="sec-4-3-8-1-2"><span class="section-number-6">4.3.8.1.2</span> 使用 transform 实现</h6>
<div class="outline-text-6" id="text-4-3-8-1-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">k1_mean</span> = df.groupby(<span style="color: #ff4ea3;">'key1'</span>).transform(np.mean).add_prefix(<span style="color: #ff4ea3;">'mean_'</span>)
show_dataframe(k1_mean)
</pre>
</div>


<div id="img/fig37020HPa.png" class="figure">
<p><img src="img/fig37020HPa.png" alt="fig37020HPa.png">
</p>
<p><span class="figure-number">Figure 52:</span> 使用 transform 计算平均值</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span>[k1_mean.columns] = k1_mean
show_dataframe(df)
</pre>
</div>


<div id="img/fig37020hjm.png" class="figure">
<p><img src="img/fig37020hjm.png" alt="fig37020hjm.png">
</p>
<p><span class="figure-number">Figure 53:</span> 将 k1_mean 附加到原 dataframe 中</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-8-2" class="outline-5">
<h5 id="sec-4-3-8-2"><span class="section-number-5">4.3.8.2</span> 案例二（计算分组后每个值与平均值的差异）</h5>
<div class="outline-text-5" id="text-4-3-8-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 10, (5, 5)),
                  columns=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'e'</span>],
                  index=[<span style="color: #ff4ea3;">'Alice'</span>, <span style="color: #ff4ea3;">'Bob'</span>, <span style="color: #ff4ea3;">'Candy'</span>, <span style="color: #ff4ea3;">'Dark'</span>, <span style="color: #ff4ea3;">'Emily'</span>])
show_dataframe(df)
</pre>
</div>


<div id="img/fig3702073y.png" class="figure">
<p><img src="img/fig3702073y.png" alt="fig3702073y.png">
</p>
<p><span class="figure-number">Figure 54:</span> 示例数据</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">def</span> <span style="color: #ffd700;">demean</span>(s):
    <span style="color: #a1db00;">return</span> s - s.mean()

<span style="color: #ff8700;">key</span> = [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>]
<span style="color: #ff8700;">demeaned</span> = df.groupby(key).transform(demean)
show_dataframe(demeaned)
</pre>
</div>


<div id="img/fig370206LI.png" class="figure">
<p><img src="img/fig370206LI.png" alt="fig370206LI.png">
</p>
<p><span class="figure-number">Figure 55:</span> 均值差</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-9" class="outline-4">
<h4 id="sec-4-3-9"><span class="section-number-4">4.3.9</span> apply</h4>
<div class="outline-text-4" id="text-4-3-9">
<p>
<b>DataFrame 的 apply 函数是逐行或逐列来处理数据。GroupBy 的 apply 函数对每个分组进行计算。</b>
</p>

<p>
<b>apply_func 作用的是分组后每个 group 对象。</b>
</p>


<div id="apply" class="figure">
<p><img src="img/pandas_apply.png" alt="pandas_apply.png">
</p>
<p><span class="figure-number">Figure 56:</span> apply 原理</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">'key1'</span>: [<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'a'</span>],
                  <span style="color: #ff4ea3;">'key2'</span>: [<span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>, <span style="color: #ff4ea3;">'two'</span>, <span style="color: #ff4ea3;">'one'</span>],
                  <span style="color: #ff4ea3;">'data1'</span>: np.random.randint(1, 10, 10),
                  <span style="color: #ff4ea3;">'data2'</span>: np.random.randint(1, 10, 10)})
show_dataframe(df)
</pre>
</div>


<div id="img/fig37020UgU.png" class="figure">
<p><img src="img/fig37020UgU.png" alt="fig37020UgU.png">
</p>
<p><span class="figure-number">Figure 57:</span> 示例数据</p>
</div>
</div>

<div id="outline-container-sec-4-3-9-1" class="outline-5">
<h5 id="sec-4-3-9-1"><span class="section-number-5">4.3.9.1</span> 案例一（根据 column 排序，输出其最大的 n 行数据）</h5>
<div class="outline-text-5" id="text-4-3-9-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">def</span> <span style="color: #ffd700;">top</span>(df, n=2, column=<span style="color: #ff4ea3;">'data1'</span>):
    <span style="color: #a1db00;">return</span> df.sort_values(by=column, ascending=<span style="color: #5fafd7;">False</span>)[:n]

show_dataframe(df.groupby(<span style="color: #ff4ea3;">'key1'</span>).<span style="color: #d18aff;">apply</span>(top))
<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#21487;&#20197;&#20256;&#36882;&#21442;&#25968;&#65306;df.groupby('key1').apply(top, n=3, column='data2')</span>
</pre>
</div>


<div id="img/fig37020u0g.png" class="figure">
<p><img src="img/fig37020u0g.png" alt="fig37020u0g.png">
</p>
<p><span class="figure-number">Figure 58:</span> 输出 n 行</p>
</div>


<p>
禁用分组键：
</p>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.groupby(<span style="color: #ff4ea3;">'key1'</span>, group_keys=<span style="color: #5fafd7;">False</span>).<span style="color: #d18aff;">apply</span>(top))
</pre>
</div>


<div id="img/fig37020IJt.png" class="figure">
<p><img src="img/fig37020IJt.png" alt="fig37020IJt.png">
</p>
<p><span class="figure-number">Figure 59:</span> 禁用分组键</p>
</div>
</div>
</div>



<div id="outline-container-sec-4-3-9-2" class="outline-5">
<h5 id="sec-4-3-9-2"><span class="section-number-5">4.3.9.2</span> 案例二（用不同的分组平均值填充空缺数据）</h5>
<div class="outline-text-5" id="text-4-3-9-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">states</span> = [<span style="color: #ff4ea3;">'Ohio'</span>, <span style="color: #ff4ea3;">'New York'</span>, <span style="color: #ff4ea3;">'Vermont'</span>, <span style="color: #ff4ea3;">'Florida'</span>,
          <span style="color: #ff4ea3;">'Oregon'</span>, <span style="color: #ff4ea3;">'Nevada'</span>, <span style="color: #ff4ea3;">'California'</span>, <span style="color: #ff4ea3;">'Idaho'</span>]
<span style="color: #ff8700;">group_key</span> = [<span style="color: #ff4ea3;">'East'</span>] * 4 + [<span style="color: #ff4ea3;">'West'</span>] * 4
<span style="color: #ff8700;">data</span> = pd.Series(np.random.randn(8), index=states)
data[[<span style="color: #ff4ea3;">'Vermont'</span>, <span style="color: #ff4ea3;">'Nevada'</span>, <span style="color: #ff4ea3;">'Idaho'</span>]] = np.nan
log(<span style="color: #ff4ea3;">"data"</span>, data)

<span style="color: #ff8700;">fill_mean</span> = <span style="color: #a1db00;">lambda</span> g: g.fillna(g.mean())
<span style="color: #ff8700;">result</span> = data.groupby(group_key).<span style="color: #d18aff;">apply</span>(fill_mean)
log(<span style="color: #ff4ea3;">"result"</span>, result)
</pre>
</div>

<pre class="example">
===================================== data =====================================
Ohio         -0.560060
New York     -1.523848
Vermont            NaN
Florida       0.167729
Oregon        1.136213
Nevada             NaN
California    1.016381
Idaho              NaN
dtype: float64
==================================== result ====================================
Ohio         -0.560060
New York     -1.523848
Vermont      -0.638726
Florida       0.167729
Oregon        1.136213
Nevada        1.076297
California    1.016381
Idaho         1.076297
dtype: float64
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 处理丢失数据</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">dates</span> = pd.date_range(<span style="color: #ff4ea3;">'20160301'</span>, periods=6)
<span style="color: #ff8700;">df</span> = pd.DataFrame(data=np.random.randn(6, 4), index=dates, columns=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCD'</span>))
<span style="color: #ff8700;">df1</span> = df.reindex(index=dates[0:4], columns=<span style="color: #d18aff;">list</span>(df.columns) + [<span style="color: #ff4ea3;">'E'</span>])
df1.loc[dates[1:3], <span style="color: #ff4ea3;">'E'</span>] = 1
log(<span style="color: #ff4ea3;">"df1"</span>, df1)
</pre>
</div>

<pre class="example">
===================================== df1 ======================================
                   A         B         C         D    E
2016-03-01  0.907432 -0.722445  1.483633 -0.632679  NaN
2016-03-02 -0.029204  1.139868  0.242871  1.381616  1.0
2016-03-03 -1.730010 -0.486562  1.604021 -0.168732  1.0
2016-03-04 -1.098692 -0.961688 -1.181290  0.631278  NaN
</pre>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> 丢弃 NaN 行</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df1.dropna(how='any')"</span>, df1.dropna(how=<span style="color: #ff4ea3;">'any'</span>))
</pre>
</div>

<pre class="example">
============================ df1.dropna(how='any') =============================
                   A         B         C         D    E
2016-03-02 -0.029204  1.139868  0.242871  1.381616  1.0
2016-03-03 -1.730010 -0.486562  1.604021 -0.168732  1.0
</pre>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> 用默认值替换 NaN</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df1.fillna(value=5)"</span>, df1.fillna(value=5))
</pre>
</div>

<pre class="example">
============================= df1.fillna(value=5) ==============================
                   A         B         C         D    E
2016-03-01  0.907432 -0.722445  1.483633 -0.632679  5.0
2016-03-02 -0.029204  1.139868  0.242871  1.381616  1.0
2016-03-03 -1.730010 -0.486562  1.604021 -0.168732  1.0
2016-03-04 -1.098692 -0.961688 -1.181290  0.631278  5.0
</pre>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> 判断数据集是否包含 NaN</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"pd.isnull(df1)"</span>, pd.isnull(df1))
log(<span style="color: #ff4ea3;">"pd.isnull(df1).any()"</span>, pd.isnull(df1).<span style="color: #d18aff;">any</span>())
log(<span style="color: #ff4ea3;">"pd.isnull(df1).any().any()"</span>, pd.isnull(df1).<span style="color: #d18aff;">any</span>().<span style="color: #d18aff;">any</span>())
</pre>
</div>

<pre class="example">
================================ pd.isnull(df1) ================================
                A      B      C      D      E
2016-03-01  False  False  False  False   True
2016-03-02  False  False  False  False  False
2016-03-03  False  False  False  False  False
2016-03-04  False  False  False  False   True
============================= pd.isnull(df1).any() =============================
A    False
B    False
C    False
D    False
E     True
dtype: bool
========================== pd.isnull(df1).any().any() ==========================
True
</pre>
</div>
</div>


<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> NaN 不参与运算</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df1.mean()"</span>, df1.mean())
log(<span style="color: #ff4ea3;">"df1.mean(axis=1)"</span>, df1.mean(axis=1))
</pre>
</div>

<pre class="example">
================================== df1.mean() ==================================
A   -0.487618
B   -0.257707
C    0.537309
D    0.302871
E    1.000000
dtype: float64
=============================== df1.mean(axis=1) ===============================
2016-03-01    0.258985
2016-03-02    0.747030
2016-03-03    0.043743
2016-03-04   -0.652598
Freq: D, dtype: float64
</pre>

<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"df1.sum()"</span>, df1.<span style="color: #d18aff;">sum</span>())
log(<span style="color: #ff4ea3;">"df1.sum(axis=1)"</span>, df1.<span style="color: #d18aff;">sum</span>(axis=1))
</pre>
</div>

<pre class="example">
================================== df1.sum() ===================================
A   -1.950474
B   -1.030827
C    2.149235
D    1.211483
E    2.000000
dtype: float64
=============================== df1.sum(axis=1) ================================
2016-03-01    1.035941
2016-03-02    3.735150
2016-03-03    0.218717
2016-03-04   -2.610392
Freq: D, dtype: float64
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series([1,3,5,np.nan,6,8], index=dates).shift(2)
log(<span style="color: #ff4ea3;">"s"</span>, s)
log(<span style="color: #ff4ea3;">"df"</span>, df)
log(<span style="color: #ff4ea3;">"df.sub(s, axis='index')"</span>, df.sub(s, axis=<span style="color: #ff4ea3;">'index'</span>))
</pre>
</div>

<pre class="example">
====================================== s =======================================
2016-03-01    NaN
2016-03-02    NaN
2016-03-03    1.0
2016-03-04    3.0
2016-03-05    5.0
2016-03-06    NaN
Freq: D, dtype: float64
====================================== df ======================================
                   A         B         C         D
2016-03-01  0.907432 -0.722445  1.483633 -0.632679
2016-03-02 -0.029204  1.139868  0.242871  1.381616
2016-03-03 -1.730010 -0.486562  1.604021 -0.168732
2016-03-04 -1.098692 -0.961688 -1.181290  0.631278
2016-03-05  0.122898 -0.399110 -0.873445  1.010379
2016-03-06 -0.922243 -0.233060 -2.345940 -1.140216
=========================== df.sub(s, axis='index') ============================
                   A         B         C         D
2016-03-01       NaN       NaN       NaN       NaN
2016-03-02       NaN       NaN       NaN       NaN
2016-03-03 -2.730010 -1.486562  0.604021 -1.168732
2016-03-04 -4.098692 -3.961688 -4.181290 -2.368722
2016-03-05 -4.877102 -5.399110 -5.873445 -3.989621
2016-03-06       NaN       NaN       NaN       NaN
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> 时间序列</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> 固定时刻(pd.Timestamp)</h3>
<div class="outline-text-3" id="text-6-1">
</div><div id="outline-container-sec-6-1-1" class="outline-4">
<h4 id="sec-6-1-1"><span class="section-number-4">6.1.1</span> 日期范围(data_range)</h4>
<div class="outline-text-4" id="text-6-1-1">
</div><div id="outline-container-sec-6-1-1-1" class="outline-5">
<h5 id="sec-6-1-1-1"><span class="section-number-5">6.1.1.1</span> 小时</h5>
<div class="outline-text-5" id="text-6-1-1-1">
<div class="org-src-container">

<pre class="src src-ipython">pd.date_range(start=<span style="color: #ff4ea3;">'20160320'</span>, periods=10, freq=<span style="color: #ff4ea3;">'4H'</span>)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-6-1-1-2" class="outline-5">
<h5 id="sec-6-1-1-2"><span class="section-number-5">6.1.1.2</span> 日</h5>
<div class="outline-text-5" id="text-6-1-1-2">
<div class="org-src-container">

<pre class="src src-ipython">pd.date_range(<span style="color: #ff4ea3;">'20160320'</span>, <span style="color: #ff4ea3;">'20160331'</span>)
pd.date_range(start=<span style="color: #ff4ea3;">'20160320'</span>, periods=10)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-1-1-3" class="outline-5">
<h5 id="sec-6-1-1-3"><span class="section-number-5">6.1.1.3</span> 星期</h5>
<div class="outline-text-5" id="text-6-1-1-3">
<div class="org-src-container">

<pre class="src src-ipython">pd.date_range(start=<span style="color: #ff4ea3;">'20160320'</span>, periods=10, freq=<span style="color: #ff4ea3;">'W'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-1-1-4" class="outline-5">
<h5 id="sec-6-1-1-4"><span class="section-number-5">6.1.1.4</span> 月</h5>
<div class="outline-text-5" id="text-6-1-1-4">
<div class="org-src-container">

<pre class="src src-ipython">pd.date_range(start=<span style="color: #ff4ea3;">'20160320'</span>, periods=10, freq=<span style="color: #ff4ea3;">'M'</span>)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-6-1-1-5" class="outline-5">
<h5 id="sec-6-1-1-5"><span class="section-number-5">6.1.1.5</span> 每个月最后一个工作日组成的索引</h5>
<div class="outline-text-5" id="text-6-1-1-5">
<div class="org-src-container">

<pre class="src src-ipython">pd.date_range(start=<span style="color: #ff4ea3;">'20160320'</span>, periods=10, freq=<span style="color: #ff4ea3;">'BM'</span>)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-6-1-1-6" class="outline-5">
<h5 id="sec-6-1-1-6"><span class="section-number-5">6.1.1.6</span> 规则化时间戳</h5>
<div class="outline-text-5" id="text-6-1-1-6">
<div class="org-src-container">

<pre class="src src-ipython">pd.date_range(start=<span style="color: #ff4ea3;">'2016-03-20 16:23:32'</span>, periods=10, normalize=<span style="color: #5fafd7;">True</span>)
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> 固定时期(pd.Period)</h3>
<div class="outline-text-3" id="text-6-2">
<p>
<code>pd.Period</code> 表示时期，比如几日，月或几个月等。比如用来统计每个月的销售额，就可以用时期作为单位。
</p>
</div>


<div id="outline-container-sec-6-2-1" class="outline-4">
<h4 id="sec-6-2-1"><span class="section-number-4">6.2.1</span> 运算</h4>
<div class="outline-text-4" id="text-6-2-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">p1</span> = pd.Period(2010)
<span style="color: #ff8700;">p2</span> = p1 + 2
<span style="color: #ff8700;">p3</span> = pd.Period(2016, freq=<span style="color: #ff4ea3;">'M'</span>)
log(<span style="color: #ff4ea3;">"p1"</span>, p1)
log(<span style="color: #ff4ea3;">"p2"</span>, p2)
log(<span style="color: #ff4ea3;">"p3"</span>, p3)
log(<span style="color: #ff4ea3;">"p2 - p1"</span>, p2 - p1)
log(<span style="color: #ff4ea3;">"p3 + 3"</span>, p3 + 3)
</pre>
</div>

<pre class="example">
====================================== p1 ======================================
2010
====================================== p2 ======================================
2012
====================================== p3 ======================================
2016-01
=================================== p2 - p1 ====================================
2
==================================== p3 + 3 ====================================
2016-04
</pre>
</div>
</div>



<div id="outline-container-sec-6-2-2" class="outline-4">
<h4 id="sec-6-2-2"><span class="section-number-4">6.2.2</span> 时期范围</h4>
<div class="outline-text-4" id="text-6-2-2">
</div><div id="outline-container-sec-6-2-2-1" class="outline-5">
<h5 id="sec-6-2-2-1"><span class="section-number-5">6.2.2.1</span> 月</h5>
<div class="outline-text-5" id="text-6-2-2-1">
<div class="org-src-container">

<pre class="src src-ipython">pd.period_range(start=<span style="color: #ff4ea3;">'2016-01'</span>, periods=12, freq=<span style="color: #ff4ea3;">'M'</span>)
pd.period_range(start=<span style="color: #ff4ea3;">'2016-01'</span>, end=<span style="color: #ff4ea3;">'2016-10'</span>, freq=<span style="color: #ff4ea3;">'M'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-2-2-2" class="outline-5">
<h5 id="sec-6-2-2-2"><span class="section-number-5">6.2.2.2</span> 季度</h5>
<div class="outline-text-5" id="text-6-2-2-2">
<div class="org-src-container">

<pre class="src src-ipython">pd.period_range(start=<span style="color: #ff4ea3;">'2016Q1'</span>, periods=10, freq=<span style="color: #ff4ea3;">'Q'</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6-2-3" class="outline-4">
<h4 id="sec-6-2-3"><span class="section-number-4">6.2.3</span> 频率转换</h4>
<div class="outline-text-4" id="text-6-2-3">
<dl class="org-dl">
<dt> A-DEC </dt><dd>以 12 月份作为结束的年时期
</dd>
<dt> A-NOV </dt><dd>以 11 月份作为结束的年时期
</dd>
<dt> Q-DEC </dt><dd>以 12 月份作为结束的季度时期
</dd>
</dl>
</div>

<div id="outline-container-sec-6-2-3-1" class="outline-5">
<h5 id="sec-6-2-3-1"><span class="section-number-5">6.2.3.1</span> 年转月</h5>
<div class="outline-text-5" id="text-6-2-3-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">p</span> = pd.Period(<span style="color: #ff4ea3;">'2016'</span>, freq=<span style="color: #ff4ea3;">'A-DEC'</span>)
log(<span style="color: #ff4ea3;">"p.asfreq('M', how='start')"</span>, p.asfreq(<span style="color: #ff4ea3;">'M'</span>, how=<span style="color: #ff4ea3;">'start'</span>))
log(<span style="color: #ff4ea3;">"p.asfreq('M', how='end')"</span>, p.asfreq(<span style="color: #ff4ea3;">'M'</span>, how=<span style="color: #ff4ea3;">'end'</span>))
</pre>
</div>

<pre class="example">
========================== p.asfreq('M', how='start') ==========================
2016-01
=========================== p.asfreq('M', how='end') ===========================
2016-12
</pre>
</div>
</div>

<div id="outline-container-sec-6-2-3-2" class="outline-5">
<h5 id="sec-6-2-3-2"><span class="section-number-5">6.2.3.2</span> 指定年的结束月份</h5>
<div class="outline-text-5" id="text-6-2-3-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">p</span> = pd.Period(<span style="color: #ff4ea3;">'2016-04'</span>, freq=<span style="color: #ff4ea3;">'M'</span>)
<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#20197;&#24180;&#20026;&#21608;&#26399;&#65292;&#20197;&#19968;&#24180;&#20013;&#30340; 3 &#26376;&#20221;&#20316;&#20026;&#24180;&#30340;&#32467;&#26463;&#65288;&#36130;&#24180;&#65289;</span>
log(<span style="color: #ff4ea3;">"p.asfreq('A-MAR')"</span>, p.asfreq(<span style="color: #ff4ea3;">'A-MAR'</span>))
</pre>
</div>

<pre class="example">
============================== p.asfreq('A-MAR') ===============================
2017
</pre>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">p</span> = pd.Period(<span style="color: #ff4ea3;">'2016Q4'</span>, <span style="color: #ff4ea3;">'Q-JAN'</span>)

<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#20197; 1 &#26376;&#20221;&#32467;&#26463;&#30340;&#36130;&#24180;&#20013;&#65292;2016Q4 &#30340;&#26102;&#26399;&#26159;&#25351; 2015-11-1 &#21040; 2016-1-31</span>
log(<span style="color: #ff4ea3;">"p.asfreq('D', how='start')"</span>, p.asfreq(<span style="color: #ff4ea3;">'D'</span>, how=<span style="color: #ff4ea3;">'start'</span>))
log(<span style="color: #ff4ea3;">"p.asfreq('D', how='end')"</span>, p.asfreq(<span style="color: #ff4ea3;">'D'</span>, how=<span style="color: #ff4ea3;">'end'</span>))

<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#33719;&#21462;&#35813;&#23395;&#24230;&#20498;&#25968;&#31532;&#20108;&#20010;&#24037;&#20316;&#26085;&#19979;&#21320;4&#28857;&#30340;&#26102;&#38388;&#25139;</span>
<span style="color: #ff8700;">p4pm</span> = (p.asfreq(<span style="color: #ff4ea3;">'B'</span>, how=<span style="color: #ff4ea3;">'end'</span>) - 1).asfreq(<span style="color: #ff4ea3;">'T'</span>, <span style="color: #ff4ea3;">'start'</span>) + 16 * 60
log(<span style="color: #ff4ea3;">"p4pm"</span>, p4pm)
log(<span style="color: #ff4ea3;">"p4pm.to_timestamp()"</span>, p4pm.to_timestamp())
</pre>
</div>

<pre class="example">
========================== p.asfreq('D', how='start') ==========================
2015-11-01
=========================== p.asfreq('D', how='end') ===========================
2016-01-31
===================================== p4pm =====================================
2016-01-28 16:00
============================= p4pm.to_timestamp() ==============================
2016-01-28 16:00:00
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> Timestamp 和 Period 相互转换</h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">ts</span> = pd.Series(np.random.randn(5),
               index = pd.date_range(<span style="color: #ff4ea3;">'2016-01-01'</span>,
                                     periods=5,
                                     freq=<span style="color: #ff4ea3;">'M'</span>))
log(<span style="color: #ff4ea3;">"ts"</span>, ts)
log(<span style="color: #ff4ea3;">"ts.to_period()"</span>, ts.to_period())
</pre>
</div>

<pre class="example">
====================================== ts ======================================
2016-01-31   -0.156601
2016-02-29    0.440694
2016-03-31    0.500862
2016-04-30    0.138647
2016-05-31   -0.374922
Freq: M, dtype: float64
================================ ts.to_period() ================================
2016-01   -0.156601
2016-02    0.440694
2016-03    0.500862
2016-04    0.138647
2016-05   -0.374922
Freq: M, dtype: float64
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">ts</span> = pd.Series(np.random.randn(5),
               index = pd.date_range(<span style="color: #ff4ea3;">'2016-12-29'</span>, periods=5, freq=<span style="color: #ff4ea3;">'D'</span>))
log(<span style="color: #ff4ea3;">"ts"</span>, ts)
<span style="color: #ff8700;">pts</span> = ts.to_period(freq=<span style="color: #ff4ea3;">'M'</span>)
log(<span style="color: #ff4ea3;">"pts"</span>, pts)
log(<span style="color: #ff4ea3;">"pts.groupby(level=0).sum()"</span>, pts.groupby(level=0).<span style="color: #d18aff;">sum</span>())
log(<span style="color: #ff4ea3;">"pts.to_timestamp(how='end')"</span>, pts.to_timestamp(how=<span style="color: #ff4ea3;">'end'</span>))
</pre>
</div>

<pre class="example">
====================================== ts ======================================
2016-12-29    1.628716
2016-12-30    1.209859
2016-12-31    1.938348
2017-01-01   -0.175764
2017-01-02   -1.265638
Freq: D, dtype: float64
===================================== pts ======================================
2016-12    1.628716
2016-12    1.209859
2016-12    1.938348
2017-01   -0.175764
2017-01   -1.265638
Freq: M, dtype: float64
========================== pts.groupby(level=0).sum() ==========================
2016-12    4.776922
2017-01   -1.441402
Freq: M, dtype: float64
========================= pts.to_timestamp(how='end') ==========================
2016-12-31    1.628716
2016-12-31    1.209859
2016-12-31    1.938348
2017-01-31   -0.175764
2017-01-31   -1.265638
dtype: float64
</pre>
</div>
</div>

<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> 重采样</h3>
<div class="outline-text-3" id="text-6-4">
</div><div id="outline-container-sec-6-4-1" class="outline-4">
<h4 id="sec-6-4-1"><span class="section-number-4">6.4.1</span> 降采样（高频率 -&gt; 低频率）</h4>
<div class="outline-text-4" id="text-6-4-1">
<p>
如 5 分钟股票交易数据转换为日交易数据
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">ts</span> = pd.Series(np.random.randint(0, 50, 60),
               index=pd.date_range(<span style="color: #ff4ea3;">'2016-04-25 09:30'</span>, periods=60, freq=<span style="color: #ff4ea3;">'T'</span>))
log(<span style="color: #ff4ea3;">"ts.head(10)"</span>, ts.head(10))
</pre>
</div>

<pre class="example">
================================= ts.head(10) ==================================
2016-04-25 09:30:00    10
2016-04-25 09:31:00    18
2016-04-25 09:32:00    20
2016-04-25 09:33:00    43
2016-04-25 09:34:00    17
2016-04-25 09:35:00    40
2016-04-25 09:36:00    10
2016-04-25 09:37:00    49
2016-04-25 09:38:00    29
2016-04-25 09:39:00     0
Freq: T, dtype: int64
</pre>
</div>

<div id="outline-container-sec-6-4-1-1" class="outline-5">
<h5 id="sec-6-4-1-1"><span class="section-number-5">6.4.1.1</span> 起始时间为行索引</h5>
<div class="outline-text-5" id="text-6-4-1-1">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"ts.resample('5min', how='sum')"</span>, ts.resample(<span style="color: #ff4ea3;">'5min'</span>, how=<span style="color: #ff4ea3;">'sum'</span>))
</pre>
</div>

<pre class="example">
======================== ts.resample('5min', how='sum') ========================
2016-04-25 09:30:00    108
2016-04-25 09:35:00    128
2016-04-25 09:40:00    113
2016-04-25 09:45:00     66
2016-04-25 09:50:00    136
2016-04-25 09:55:00    199
2016-04-25 10:00:00     51
2016-04-25 10:05:00    135
2016-04-25 10:10:00     91
2016-04-25 10:15:00    153
2016-04-25 10:20:00    147
2016-04-25 10:25:00    131
Freq: 5T, dtype: int64
/Users/haoruan/Desktop/workspace/py3.5.3_env/lib/python3.5/site-packages/ipykernel_launcher.py:1: FutureWarning: how in .resample() is deprecated
the new syntax is .resample(...).sum()
  """Entry point for launching an IPython kernel.
</pre>
</div>
</div>

<div id="outline-container-sec-6-4-1-2" class="outline-5">
<h5 id="sec-6-4-1-2"><span class="section-number-5">6.4.1.2</span> 结束时间为行索引</h5>
<div class="outline-text-5" id="text-6-4-1-2">
<div class="org-src-container">

<pre class="src src-ipython">log(<span style="color: #ff4ea3;">"ts.resample('5min', how='sum', label='right')"</span>,
    ts.resample(<span style="color: #ff4ea3;">'5min'</span>, how=<span style="color: #ff4ea3;">'sum'</span>, label=<span style="color: #ff4ea3;">'right'</span>))
</pre>
</div>

<pre class="example">
================ ts.resample('5min', how='sum', label='right') =================
2016-04-25 09:35:00    108
2016-04-25 09:40:00    128
2016-04-25 09:45:00    113
2016-04-25 09:50:00     66
2016-04-25 09:55:00    136
2016-04-25 10:00:00    199
2016-04-25 10:05:00     51
2016-04-25 10:10:00    135
2016-04-25 10:15:00     91
2016-04-25 10:20:00    153
2016-04-25 10:25:00    147
2016-04-25 10:30:00    131
Freq: 5T, dtype: int64
/Users/haoruan/Desktop/workspace/py3.5.3_env/lib/python3.5/site-packages/ipykernel_launcher.py:2: FutureWarning: how in .resample() is deprecated
the new syntax is .resample(...).sum()
</pre>
</div>
</div>


<div id="outline-container-sec-6-4-1-3" class="outline-5">
<h5 id="sec-6-4-1-3"><span class="section-number-5">6.4.1.3</span> OHLC 重采样</h5>
<div class="outline-text-5" id="text-6-4-1-3">
<p>
金融数据专用：Open/High/Low/Close
</p>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(ts.resample(<span style="color: #ff4ea3;">'5min'</span>, how=<span style="color: #ff4ea3;">'ohlc'</span>))
</pre>
</div>


<div id="img/fig37020WwK.png" class="figure">
<p><img src="img/fig37020WwK.png" alt="fig37020WwK.png">
</p>
<p><span class="figure-number">Figure 60:</span> ohlc</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-6-4-2" class="outline-4">
<h4 id="sec-6-4-2"><span class="section-number-4">6.4.2</span> 升采样/插值（低频率 -&gt; 高频率）</h4>
<div class="outline-text-4" id="text-6-4-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#20197;&#21608;&#20026;&#21333;&#20301;&#65292;&#27599;&#21608;&#20116;&#37319;&#26679;</span>
<span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(1, 50, 2),
                  index=pd.date_range(<span style="color: #ff4ea3;">'2016-04-22'</span>, periods=2, freq=<span style="color: #ff4ea3;">'W-FRI'</span>))
show_dataframe(df)
</pre>
</div>


<div id="img/fig37020wEX.png" class="figure">
<p><img src="img/fig37020wEX.png" alt="fig37020wEX.png">
</p>
<p><span class="figure-number">Figure 61:</span> 示例数据</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.resample(<span style="color: #ff4ea3;">'D'</span>))
</pre>
</div>


<div id="img/fig37020KZj.png" class="figure">
<p><img src="img/fig37020KZj.png" alt="fig37020KZj.png">
</p>
<p><span class="figure-number">Figure 62:</span> 周-&gt;天</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.resample(<span style="color: #ff4ea3;">'D'</span>, fill_method=<span style="color: #ff4ea3;">'ffill'</span>, limit=3))
</pre>
</div>


<div id="img/fig37020ktv.png" class="figure">
<p><img src="img/fig37020ktv.png" alt="fig37020ktv.png">
</p>
<p><span class="figure-number">Figure 63:</span> 向前插值</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.resample(<span style="color: #ff4ea3;">'W-MON'</span>, fill_method=<span style="color: #ff4ea3;">'ffill'</span>))
</pre>
</div>


<div id="img/fig37020jBF.png" class="figure">
<p><img src="img/fig37020jBF.png" alt="fig37020jBF.png">
</p>
<p><span class="figure-number">Figure 64:</span> 以周为单位，每周一采样</p>
</div>
</div>
</div>
</div>



<div id="outline-container-sec-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> 时期重采样</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randint(2, 30, (24, 4)),
                  index=pd.period_range(<span style="color: #ff4ea3;">'2015-01'</span>, <span style="color: #ff4ea3;">'2016-12'</span>, freq=<span style="color: #ff4ea3;">'M'</span>),
                  columns=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCD'</span>))
show_dataframe(df)
</pre>
</div>


<div id="img/fig370209VR.png" class="figure">
<p><img src="img/fig370209VR.png" alt="fig370209VR.png">
</p>
<p><span class="figure-number">Figure 65:</span> 示例数据</p>
</div>
</div>

<div id="outline-container-sec-6-5-1" class="outline-4">
<h4 id="sec-6-5-1"><span class="section-number-4">6.5.1</span> 降采样</h4>
<div class="outline-text-4" id="text-6-5-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">adf</span> = df.resample(<span style="color: #ff4ea3;">'A-DEC'</span>, how=<span style="color: #ff4ea3;">'mean'</span>)
show_dataframe(adf)
</pre>
</div>


<div id="img/fig37020Xqd.png" class="figure">
<p><img src="img/fig37020Xqd.png" alt="fig37020Xqd.png">
</p>
<p><span class="figure-number">Figure 66:</span> 年重采样 (a)</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(df.resample(<span style="color: #ff4ea3;">'A-MAY'</span>, how=<span style="color: #ff4ea3;">'mean'</span>))
</pre>
</div>


<div id="img/fig37020x-p.png" class="figure">
<p><img src="img/fig37020x-p.png" alt="fig37020x-p.png">
</p>
<p><span class="figure-number">Figure 67:</span> 年重采样 (b)</p>
</div>
</div>
</div>


<div id="outline-container-sec-6-5-2" class="outline-4">
<h4 id="sec-6-5-2"><span class="section-number-4">6.5.2</span> 升采样</h4>
<div class="outline-text-4" id="text-6-5-2">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(adf.resample(<span style="color: #ff4ea3;">'Q-DEC'</span>))
</pre>
</div>


<div id="img/fig37020LT2.png" class="figure">
<p><img src="img/fig37020LT2.png" alt="fig37020LT2.png">
</p>
<p><span class="figure-number">Figure 68:</span> 默认升采样行为</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(adf.resample(<span style="color: #ff4ea3;">'Q-DEC'</span>, fill_method=<span style="color: #ff4ea3;">'ffill'</span>))
</pre>
</div>


<div id="img/fig37020KnL.png" class="figure">
<p><img src="img/fig37020KnL.png" alt="fig37020KnL.png">
</p>
<p><span class="figure-number">Figure 69:</span> 向前插值</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6-6" class="outline-3">
<h3 id="sec-6-6"><span class="section-number-3">6.6</span> 从文件中读取日期序列</h3>
<div class="outline-text-3" id="text-6-6">
<div class="org-src-container">

<pre class="src src-ipython">pd.read_csv(<span style="color: #ff4ea3;">'xxx.csv'</span>, index_col=<span style="color: #ff4ea3;">'xxx'</span>, parse_dates=<span style="color: #5fafd7;">True</span>)
</pre>
</div>
</div>

<div id="outline-container-sec-6-6-1" class="outline-4">
<h4 id="sec-6-6-1"><span class="section-number-4">6.6.1</span> 自定义时间日期解析函数</h4>
<div class="outline-text-4" id="text-6-6-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">def</span> <span style="color: #ffd700;">date_parser</span>(s):
    <span style="color: #ff8700;">s</span> = <span style="color: #ff4ea3;">'2016/'</span> + s
    <span style="color: #ff8700;">d</span> = datetime.strptime(s, <span style="color: #ff4ea3;">'%Y/%m/%d'</span>)
    <span style="color: #a1db00;">return</span> d

pd.read_csv(<span style="color: #ff4ea3;">'xxx.csv'</span>, index_col=<span style="color: #ff4ea3;">'xxx'</span>,
            parse_dates=<span style="color: #5fafd7;">True</span>, date_parser=date_parser)
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> 可视化</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> 线形图</h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">ts</span> = pd.Series(np.random.randn(1000), index=pd.date_range(<span style="color: #ff4ea3;">'20000101'</span>, periods=1000))
<span style="color: #ff8700;">ts</span> = ts.cumsum()
ts.plot()
plot()
</pre>
</div>


<div id="img/fig75428HE0.png" class="figure">
<p><img src="img/fig75428HE0.png" alt="fig75428HE0.png">
</p>
<p><span class="figure-number">Figure 70:</span> 单个线形图</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">ts.plot(title=<span style="color: #ff4ea3;">'cumsum'</span>, style=<span style="color: #ff4ea3;">'r-'</span>, ylim=[-30, 50], figsize=(4, 3));
plot()
</pre>
</div>


<div id="img/fig37020k7X.png" class="figure">
<p><img src="img/fig37020k7X.png" alt="fig37020k7X.png">
</p>
<p><span class="figure-number">Figure 71:</span> 自定义线形图</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(1000, 4), index=ts.index, columns=<span style="color: #d18aff;">list</span>(<span style="color: #ff4ea3;">'ABCD'</span>))
<span style="color: #ff8700;">df</span> = df.cumsum()
df.plot()
plot()
</pre>
</div>


<div id="img/fig47069XEp.png" class="figure">
<p><img src="img/fig47069XEp.png" alt="fig47069XEp.png">
</p>
<p><span class="figure-number">Figure 72:</span> 多个线形图组合</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">df.plot(title=<span style="color: #ff4ea3;">'DataFrame cumsum'</span>,
        figsize=(6, 12),
        subplots=<span style="color: #5fafd7;">True</span>, sharex=<span style="color: #5fafd7;">True</span>, sharey=<span style="color: #5fafd7;">True</span>)
plot()
</pre>
</div>


<div id="img/fig47069xY1.png" class="figure">
<p><img src="img/fig47069xY1.png" alt="fig47069xY1.png">
</p>
<p><span class="figure-number">Figure 73:</span> subplot</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span>[<span style="color: #ff4ea3;">'I'</span>] = np.arange(<span style="color: #d18aff;">len</span>(df))
df.plot(x=<span style="color: #ff4ea3;">'I'</span>, y=[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'C'</span>])
plot()
</pre>
</div>


<div id="img/fig47069wsK.png" class="figure">
<p><img src="img/fig47069wsK.png" alt="fig47069wsK.png">
</p>
<p><span class="figure-number">Figure 74:</span> 自定义坐标</p>
</div>
</div>
</div>


<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> 柱状图</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.rand(10, 4), columns=[<span style="color: #ff4ea3;">'A'</span>, <span style="color: #ff4ea3;">'B'</span>, <span style="color: #ff4ea3;">'C'</span>, <span style="color: #ff4ea3;">'D'</span>])
show_dataframe(df)
</pre>
</div>


<div id="img/fig6529276K.png" class="figure">
<p><img src="img/fig6529276K.png" alt="fig6529276K.png">
</p>
<p><span class="figure-number">Figure 75:</span> 示例数据</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">df.iloc[1].plot(kind=<span style="color: #ff4ea3;">'bar'</span>)
plot()
</pre>
</div>


<div id="img/fig65292iSp.png" class="figure">
<p><img src="img/fig65292iSp.png" alt="fig65292iSp.png">
</p>
<p><span class="figure-number">Figure 76:</span> 单个柱状图</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">df.plot.bar()
plot()
</pre>
</div>


<div id="img/fig652928m1.png" class="figure">
<p><img src="img/fig652928m1.png" alt="fig652928m1.png">
</p>
<p><span class="figure-number">Figure 77:</span> 多个柱状图组合</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">df.plot.bar(stacked=<span style="color: #5fafd7;">True</span>)
plot()
</pre>
</div>


<div id="img/fig65292VPX.png" class="figure">
<p><img src="img/fig65292VPX.png" alt="fig65292VPX.png">
</p>
<p><span class="figure-number">Figure 78:</span> stacked</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">df.plot.barh(stacked=<span style="color: #5fafd7;">True</span>)
plot()
</pre>
</div>


<div id="img/fig65292vjj.png" class="figure">
<p><img src="img/fig65292vjj.png" alt="fig65292vjj.png">
</p>
<p><span class="figure-number">Figure 79:</span> 水平柱状图</p>
</div>
</div>
</div>


<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> 直方图</h3>
<div class="outline-text-3" id="text-7-3">
<p>
直方图是一种对值频率进行离散化的柱状图。
数据点被分到离散的，间隔均匀的区间中，绘制各个区间中数据点的数据。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">'a'</span>: np.random.randn(1000) + 1, <span style="color: #ff4ea3;">'b'</span>: np.random.randn(1000),
                   <span style="color: #ff4ea3;">'c'</span>: np.random.randn(1000) - 1}, columns=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>])
show_dataframe(df.head())
</pre>
</div>


<div id="img/fig65292J4v.png" class="figure">
<p><img src="img/fig65292J4v.png" alt="fig65292J4v.png">
</p>
<p><span class="figure-number">Figure 80:</span> 示例数据</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">df[<span style="color: #ff4ea3;">'a'</span>].plot.hist(bins=20)
plot()
</pre>
</div>


<div id="img/fig65292IMF.png" class="figure">
<p><img src="img/fig65292IMF.png" alt="fig65292IMF.png">
</p>
<p><span class="figure-number">Figure 81:</span> 单个直方图</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">df.plot.hist(subplots=<span style="color: #5fafd7;">True</span>, sharex=<span style="color: #5fafd7;">True</span>, sharey=<span style="color: #5fafd7;">True</span>, bins=20)
plot()
</pre>
</div>


<div id="img/fig65292igR.png" class="figure">
<p><img src="img/fig65292igR.png" alt="fig65292igR.png">
</p>
<p><span class="figure-number">Figure 82:</span> subplot</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">df.plot.hist(alpha=0.5)
plot()
</pre>
</div>


<div id="img/fig6529280d.png" class="figure">
<p><img src="img/fig6529280d.png" alt="fig6529280d.png">
</p>
<p><span class="figure-number">Figure 83:</span> 透明度</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">df.plot.hist(stacked=<span style="color: #5fafd7;">True</span>, bins=20, grid=<span style="color: #5fafd7;">True</span>)
plot()
</pre>
</div>


<div id="img/fig65292WJq.png" class="figure">
<p><img src="img/fig65292WJq.png" alt="fig65292WJq.png">
</p>
<p><span class="figure-number">Figure 84:</span> stack</p>
</div>
</div>

<div id="outline-container-sec-7-3-1" class="outline-4">
<h4 id="sec-7-3-1"><span class="section-number-4">7.3.1</span> 密度图</h4>
<div class="outline-text-4" id="text-7-3-1">
<p>
正态分布（高斯分布）就是一种自然界中广泛存在密度图。
</p>

<div class="org-src-container">

<pre class="src src-ipython">df[<span style="color: #ff4ea3;">'a'</span>].plot.kde()
plot()
</pre>
</div>


<div id="img/fig92800jqp.png" class="figure">
<p><img src="img/fig92800jqp.png" alt="fig92800jqp.png">
</p>
<p><span class="figure-number">Figure 85:</span> 单个密度图</p>
</div>


<div class="org-src-container">

<pre class="src src-ipython">df.plot.kde()
plot()
</pre>
</div>


<div id="img/fig928009-1.png" class="figure">
<p><img src="img/fig928009-1.png" alt="fig928009-1.png">
</p>
<p><span class="figure-number">Figure 86:</span> 多个密度图组合</p>
</div>
</div>
</div>


<div id="outline-container-sec-7-3-2" class="outline-4">
<h4 id="sec-7-3-2"><span class="section-number-4">7.3.2</span> 带密度估计的直方图</h4>
<div class="outline-text-4" id="text-7-3-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">n1</span> = np.random.normal(0, 1, size=200) <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">N(0, 1)</span>
<span style="color: #ff8700;">n2</span> = np.random.normal(10, 2, size=200) <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">N(10, 4)</span>
<span style="color: #ff8700;">s</span> = pd.Series(np.concatenate([n1, n2]))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-ipython">s.plot.hist(bins=100, alpha=0.5, normed=<span style="color: #5fafd7;">True</span>)
s.plot.kde(style=<span style="color: #ff4ea3;">'r-'</span>)
plot()
</pre>
</div>


<div id="img/fig928008SL.png" class="figure">
<p><img src="img/fig928008SL.png" alt="fig928008SL.png">
</p>
<p><span class="figure-number">Figure 87:</span> 密度估计&amp;直方图</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> 散布图</h3>
<div class="outline-text-3" id="text-7-4">
<p>
散布图是把所有的点画在同一个坐标轴上的图像。是观察两个一维数据之间关系的有效的手段。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame({<span style="color: #ff4ea3;">'a'</span>: np.concatenate([np.random.normal(0, 1, 200),
                                        np.random.normal(6, 1, 200)]),
                   <span style="color: #ff4ea3;">'b'</span>: np.concatenate([np.random.normal(10, 2, 200),
                                        np.random.normal(0, 2, 200)]),
                   <span style="color: #ff4ea3;">'c'</span>: np.concatenate([np.random.normal(10, 4, 200),
                                        np.random.normal(0, 4, 200)])})
df.plot.scatter(x=<span style="color: #ff4ea3;">'a'</span>, y=<span style="color: #ff4ea3;">'b'</span>)
plot()
</pre>
</div>


<div id="img/fig92800w7j.png" class="figure">
<p><img src="img/fig92800w7j.png" alt="fig92800w7j.png">
</p>
<p><span class="figure-number">Figure 88:</span> 散布图</p>
</div>
</div>
</div>


<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> 饼图</h3>
<div class="outline-text-3" id="text-7-5">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">s</span> = pd.Series(3 * np.random.rand(4), index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>], name=<span style="color: #ff4ea3;">'series'</span>)
s.plot.pie(figsize=(6,6))
plot()
</pre>
</div>


<div id="img/fig92800WnX.png" class="figure">
<p><img src="img/fig92800WnX.png" alt="fig92800WnX.png">
</p>
<p><span class="figure-number">Figure 89:</span> 饼图</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">s.plot.pie(labels=[<span style="color: #ff4ea3;">'AA'</span>, <span style="color: #ff4ea3;">'BB'</span>, <span style="color: #ff4ea3;">'CC'</span>, <span style="color: #ff4ea3;">'DD'</span>],
           colors=[<span style="color: #ff4ea3;">'r'</span>, <span style="color: #ff4ea3;">'g'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>],
           autopct=<span style="color: #ff4ea3;">'%.2f'</span>, fontsize=20, figsize=(6, 6))
plot()
</pre>
</div>


<div id="img/fig92800KQw.png" class="figure">
<p><img src="img/fig92800KQw.png" alt="fig92800KQw.png">
</p>
<p><span class="figure-number">Figure 90:</span> 自定义</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.DataFrame(3 * np.random.rand(4, 2),
                  index=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>],
                  columns=[<span style="color: #ff4ea3;">'x'</span>, <span style="color: #ff4ea3;">'y'</span>])
df.plot.pie(subplots=<span style="color: #5fafd7;">True</span>, figsize=(9, 4))
plot()
</pre>
</div>


<div id="img/fig92800JkF.png" class="figure">
<p><img src="img/fig92800JkF.png" alt="fig92800JkF.png">
</p>
<p><span class="figure-number">Figure 91:</span> 多个饼图组合</p>
</div>
</div>
</div>


<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6"><span class="section-number-3">7.6</span> 高级绘图函数</h3>
<div class="outline-text-3" id="text-7-6">
<p>
各种高级绘图函数在 <code>pandas.tools.plotting</code> 包里
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">from</span> pandas.tools.plotting <span style="color: #a1db00;">import</span> scatter_matrix
<span style="color: #ff8700;">df</span> = pd.DataFrame(np.random.randn(1000, 4), columns=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>])
scatter_matrix(df, alpha=0.2, figsize=(6, 6), diagonal=<span style="color: #ff4ea3;">'kde'</span>)
plot()
</pre>
</div>


<div id="img/fig92800j4R.png" class="figure">
<p><img src="img/fig92800j4R.png" alt="fig92800j4R.png">
</p>
<p><span class="figure-number">Figure 92:</span> scatter matrix</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">from</span> pandas.tools.plotting <span style="color: #a1db00;">import</span> lag_plot
<span style="color: #ff8700;">s</span> = pd.Series(0.1 * np.random.rand(1000) +
              0.9 * np.sin(np.linspace(-99 * np.pi, 99 * np.pi, num=1000)))
lag_plot(s)
plot()
</pre>
</div>


<div id="img/fig928009Me.png" class="figure">
<p><img src="img/fig928009Me.png" alt="fig928009Me.png">
</p>
<p><span class="figure-number">Figure 93:</span> lag</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #a1db00;">from</span> pandas.tools.plotting <span style="color: #a1db00;">import</span> autocorrelation_plot
<span style="color: #ff8700;">s</span> = pd.Series(0.7 * np.random.rand(1000) +
              0.3 * np.sin(np.linspace(-9 * np.pi, 9 * np.pi, num=1000)))
autocorrelation_plot(s)
plot()
</pre>
</div>


<div id="img/fig92800Xhq.png" class="figure">
<p><img src="img/fig92800Xhq.png" alt="fig92800Xhq.png">
</p>
<p><span class="figure-number">Figure 94:</span> auto correlation</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> 导入导出</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> 读入 csv</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.read_csv(<span style="color: #ff4ea3;">'data/ex1.csv'</span>))
</pre>
</div>


<div id="img/fig37020jl0.png" class="figure">
<p><img src="img/fig37020jl0.png" alt="fig37020jl0.png">
</p>
<p><span class="figure-number">Figure 95:</span> 读入 csv</p>
</div>
</div>

<div id="outline-container-sec-8-1-1" class="outline-4">
<h4 id="sec-8-1-1"><span class="section-number-4">8.1.1</span> 处理列名缺失</h4>
<div class="outline-text-4" id="text-8-1-1">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.read_csv(<span style="color: #ff4ea3;">'data/ex2.csv'</span>,
                           header=<span style="color: #5fafd7;">None</span>,
                           names=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'msg'</span>]))
</pre>
</div>


<div id="img/fig370208NW.png" class="figure">
<p><img src="img/fig370208NW.png" alt="fig370208NW.png">
</p>
<p><span class="figure-number">Figure 96:</span> 列名缺失</p>
</div>
</div>
</div>


<div id="outline-container-sec-8-1-2" class="outline-4">
<h4 id="sec-8-1-2"><span class="section-number-4">8.1.2</span> 指定某一列作为行索引</h4>
<div class="outline-text-4" id="text-8-1-2">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.read_csv(<span style="color: #ff4ea3;">'data/ex2.csv'</span>,
                           header=<span style="color: #5fafd7;">None</span>,
                           names=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'c'</span>, <span style="color: #ff4ea3;">'d'</span>, <span style="color: #ff4ea3;">'msg'</span>],
                           index_col=<span style="color: #ff4ea3;">'msg'</span>))  <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#22810;&#32423;&#34892;&#32034;&#24341;&#65306;index_col=['msg', 'a']</span>
</pre>
</div>


<div id="img/fig37020Wii.png" class="figure">
<p><img src="img/fig37020Wii.png" alt="fig37020Wii.png">
</p>
<p><span class="figure-number">Figure 97:</span> 指定行索引</p>
</div>
</div>
</div>

<div id="outline-container-sec-8-1-3" class="outline-4">
<h4 id="sec-8-1-3"><span class="section-number-4">8.1.3</span> 处理不规则分隔符</h4>
<div class="outline-text-4" id="text-8-1-3">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.read_table(<span style="color: #ff4ea3;">'data/ex3.csv'</span>, sep=<span style="color: #ff4ea3;">'\s+'</span>))
</pre>
</div>


<div id="img/fig37020w2u.png" class="figure">
<p><img src="img/fig37020w2u.png" alt="fig37020w2u.png">
</p>
<p><span class="figure-number">Figure 98:</span> 处理不规则分隔符</p>
</div>
</div>
</div>


<div id="outline-container-sec-8-1-4" class="outline-4">
<h4 id="sec-8-1-4"><span class="section-number-4">8.1.4</span> 处理缺失值</h4>
<div class="outline-text-4" id="text-8-1-4">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.read_csv(<span style="color: #ff4ea3;">'data/ex5.csv'</span>))
</pre>
</div>


<div id="img/fig37020vKE.png" class="figure">
<p><img src="img/fig37020vKE.png" alt="fig37020vKE.png">
</p>
<p><span class="figure-number">Figure 99:</span> 缺失值默认处理</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.read_csv(<span style="color: #ff4ea3;">'data/ex5.csv'</span>, na_values=[<span style="color: #ff4ea3;">'NA'</span>, <span style="color: #ff4ea3;">'NULL'</span>, <span style="color: #ff4ea3;">'foo'</span>]))
</pre>
</div>


<div id="img/fig37020JfQ.png" class="figure">
<p><img src="img/fig37020JfQ.png" alt="fig37020JfQ.png">
</p>
<p><span class="figure-number">Figure 100:</span> 指定缺失值</p>
</div>

<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.read_csv(<span style="color: #ff4ea3;">'data/ex5.csv'</span>,
                           na_values={<span style="color: #ff4ea3;">'message'</span>: [<span style="color: #ff4ea3;">'foo'</span>, <span style="color: #ff4ea3;">'NA'</span>],
                                      <span style="color: #ff4ea3;">'something'</span>: [<span style="color: #ff4ea3;">'two'</span>]}))
</pre>
</div>


<div id="img/fig37020jzc.png" class="figure">
<p><img src="img/fig37020jzc.png" alt="fig37020jzc.png">
</p>
<p><span class="figure-number">Figure 101:</span> 根据列指定缺失值</p>
</div>
</div>
</div>


<div id="outline-container-sec-8-1-5" class="outline-4">
<h4 id="sec-8-1-5"><span class="section-number-4">8.1.5</span> 逐块读取</h4>
<div class="outline-text-4" id="text-8-1-5">
</div><div id="outline-container-sec-8-1-5-1" class="outline-5">
<h5 id="sec-8-1-5-1"><span class="section-number-5">8.1.5.1</span> 按行读取</h5>
<div class="outline-text-5" id="text-8-1-5-1">
<div class="org-src-container">

<pre class="src src-ipython">show_dataframe(pd.read_csv(<span style="color: #ff4ea3;">'data/ex6.csv'</span>, skiprows=10, nrows=10))
</pre>
</div>


<div id="img/fig370209Hp.png" class="figure">
<p><img src="img/fig370209Hp.png" alt="fig370209Hp.png">
</p>
<p><span class="figure-number">Figure 102:</span> 指定读取几行</p>
</div>
</div>
</div>


<div id="outline-container-sec-8-1-5-2" class="outline-5">
<h5 id="sec-8-1-5-2"><span class="section-number-5">8.1.5.2</span> 按 chunk 读取</h5>
<div class="outline-text-5" id="text-8-1-5-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">dfs</span> = pd.read_csv(<span style="color: #ff4ea3;">'data/ex6.csv'</span>, chunksize=1000)
<span style="color: #ff8700;">key_count</span> = pd.Series([])
<span style="color: #a1db00;">for</span> df <span style="color: #a1db00;">in</span> dfs:
    <span style="color: #ff8700;">key_count</span> = key_count.add(df[<span style="color: #ff4ea3;">'key'</span>].value_counts(), fill_value=0)

<span style="color: #ff8700;">key_count</span> = key_count.sort_values(ascending=<span style="color: #5fafd7;">False</span>)
log(<span style="color: #ff4ea3;">"key_count[:3]"</span>, key_count[:3])
</pre>
</div>

<pre class="example">
================================ key_count[:3] =================================
E    368.0
X    364.0
L    346.0
dtype: float64
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> 导出 csv</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = pd.read_csv(<span style="color: #ff4ea3;">'data/ex5.csv'</span>)
</pre>
</div>
</div>

<div id="outline-container-sec-8-2-1" class="outline-4">
<h4 id="sec-8-2-1"><span class="section-number-4">8.2.1</span> 不导出索引（推荐）</h4>
<div class="outline-text-4" id="text-8-2-1">
<div class="org-src-container">

<pre class="src src-ipython">df.to_csv(<span style="color: #ff4ea3;">'/tmp/ex5_out.csv'</span>, index=<span style="color: #5fafd7;">False</span>)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-8-2-2" class="outline-4">
<h4 id="sec-8-2-2"><span class="section-number-4">8.2.2</span> 不导出列名</h4>
<div class="outline-text-4" id="text-8-2-2">
<div class="org-src-container">

<pre class="src src-ipython">df.to_csv(<span style="color: #ff4ea3;">'/tmp/ex5_out_noheader.csv'</span>, index=<span style="color: #5fafd7;">False</span>, header=<span style="color: #5fafd7;">None</span>)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-8-2-3" class="outline-4">
<h4 id="sec-8-2-3"><span class="section-number-4">8.2.3</span> 指定分隔符</h4>
<div class="outline-text-4" id="text-8-2-3">
<div class="org-src-container">

<pre class="src src-ipython">df.to_csv(<span style="color: #ff4ea3;">'/tmp/ex5_out_sep.csv'</span>, index=<span style="color: #5fafd7;">False</span>, sep=<span style="color: #ff4ea3;">'|'</span>)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-8-2-4" class="outline-4">
<h4 id="sec-8-2-4"><span class="section-number-4">8.2.4</span> 导出部分列</h4>
<div class="outline-text-4" id="text-8-2-4">
<div class="org-src-container">

<pre class="src src-ipython">df.to_csv(<span style="color: #ff4ea3;">'/tmp/ex5_out_col.csv'</span>, index=<span style="color: #5fafd7;">False</span>, columns=[<span style="color: #ff4ea3;">'a'</span>, <span style="color: #ff4ea3;">'b'</span>, <span style="color: #ff4ea3;">'message'</span>])
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> 其他格式</h3>
<div class="outline-text-3" id="text-8-3">
<dl class="org-dl">
<dt> HDF5 </dt><dd>  HDF5 是个 C 语言实现的库，可以高效地读取磁盘上的二进制存储的科学数据
</dd>
<dt> Excel </dt><dd>  <code>pd.read_excel</code>, <code>pd.ExcelFile</code>, <code>pd.ExcelWriter</code>
</dd>
<dt> JSON </dt><dd>  通过 json 模块转换为字典，再转换为 DataFrame
</dd>
<dt> SQL 数据库 </dt><dd>  通过 <code>pd.io.sql</code> 模块来从数据库读取数据
</dd>
<dt> NoSQL 数据库 </dt><dd>  需要结合相应的数据库模块，如 pymongo 。通过游标把数据读出来，再转换为 DataFrame
</dd>
</dl>
</div>
</div>
</div>


<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> 示例工程</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> 电影数据分析</h3>
<div class="outline-text-3" id="text-9-1">
</div><div id="outline-container-sec-9-1-1" class="outline-4">
<h4 id="sec-9-1-1"><span class="section-number-4">9.1.1</span> 数据读取</h4>
<div class="outline-text-4" id="text-9-1-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">user_names</span> = [<span style="color: #ff4ea3;">'user_id'</span>, <span style="color: #ff4ea3;">'gender'</span>, <span style="color: #ff4ea3;">'age'</span>, <span style="color: #ff4ea3;">'occupation'</span>, <span style="color: #ff4ea3;">'zip'</span>]
<span style="color: #ff8700;">users</span> = pd.read_table(<span style="color: #ff4ea3;">'data/ml-1m/users.dat'</span>, sep=<span style="color: #ff4ea3;">'::'</span>,
                      header=<span style="color: #5fafd7;">None</span>, names=user_names, engine=<span style="color: #ff4ea3;">'python'</span>)

<span style="color: #ff8700;">rating_names</span> = [<span style="color: #ff4ea3;">'user_id'</span>, <span style="color: #ff4ea3;">'movie_id'</span>, <span style="color: #ff4ea3;">'rating'</span>, <span style="color: #ff4ea3;">'timestamp'</span>]
<span style="color: #ff8700;">ratings</span> = pd.read_table(<span style="color: #ff4ea3;">'data/ml-1m/ratings.dat'</span>, sep=<span style="color: #ff4ea3;">'::'</span>,
                        header=<span style="color: #5fafd7;">None</span>, names=rating_names, engine=<span style="color: #ff4ea3;">'python'</span>)

<span style="color: #ff8700;">movie_names</span> = [<span style="color: #ff4ea3;">'movie_id'</span>, <span style="color: #ff4ea3;">'title'</span>, <span style="color: #ff4ea3;">'genres'</span>]
<span style="color: #ff8700;">movies</span> = pd.read_table(<span style="color: #ff4ea3;">'data/ml-1m/movies.dat'</span>, sep=<span style="color: #ff4ea3;">'::'</span>,
                       header=<span style="color: #5fafd7;">None</span>, names=movie_names, engine=<span style="color: #ff4ea3;">'python'</span>)

log(<span style="color: #ff4ea3;">"users.head()"</span>, users.head())
log(<span style="color: #ff4ea3;">"ratings.head()"</span>, ratings.head())
log(<span style="color: #ff4ea3;">"movies.head()"</span>, movies.head())
</pre>
</div>

<pre class="example">
================================= users.head() =================================
   user_id gender  age  occupation    zip
0        1      F    1          10  48067
1        2      M   56          16  70072
2        3      M   25          15  55117
3        4      M   45           7  02460
4        5      M   25          20  55455
================================ ratings.head() ================================
   user_id  movie_id  rating  timestamp
0        1      1193       5  978300760
1        1       661       3  978302109
2        1       914       3  978301968
3        1      3408       4  978300275
4        1      2355       5  978824291
================================ movies.head() =================================
   movie_id                               title                        genres
0         1                    Toy Story (1995)   Animation|Children's|Comedy
1         2                      Jumanji (1995)  Adventure|Children's|Fantasy
2         3             Grumpier Old Men (1995)                Comedy|Romance
3         4            Waiting to Exhale (1995)                  Comedy|Drama
4         5  Father of the Bride Part II (1995)                        Comedy
</pre>
</div>
</div>

<div id="outline-container-sec-9-1-2" class="outline-4">
<h4 id="sec-9-1-2"><span class="section-number-4">9.1.2</span> 数据合并 (merge)</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
在 pandas 中，数据只有合并后才能进行分析
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">data</span> = pd.merge(pd.merge(users, ratings), movies)
show_dataframe(data.head())
</pre>
</div>


<div class="figure">
<p><img src="img/fig75428GYJ.png" alt="fig75428GYJ.png">
</p>
</div>
</div>
</div>

<div id="outline-container-sec-9-1-3" class="outline-4">
<h4 id="sec-9-1-3"><span class="section-number-4">9.1.3</span> 按性别查看各个电影的平均评分 (pivot_table)</h4>
<div class="outline-text-4" id="text-9-1-3">
<p>
<b>关心的值</b> 是 rating ，以 title 作为 <b>行索引</b> ，gender 作为 <b>列索引</b>
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">mean_ratings_gender</span> = data.pivot_table(values=<span style="color: #ff4ea3;">'rating'</span>, index=<span style="color: #ff4ea3;">'title'</span>,
                                       columns=<span style="color: #ff4ea3;">'gender'</span>, aggfunc=<span style="color: #ff4ea3;">'mean'</span>)
log(<span style="color: #ff4ea3;">"mean_ratings_gender.head()"</span>, mean_ratings_gender.head())
</pre>
</div>

<pre class="example">
========================== mean_ratings_gender.head() ==========================
gender                                F         M
title
$1,000,000 Duck (1971)         3.375000  2.761905
'Night Mother (1986)           3.388889  3.352941
'Til There Was You (1997)      2.675676  2.733333
'burbs, The (1989)             2.793478  2.962085
...And Justice for All (1979)  3.828571  3.689024
</pre>
</div>
</div>

<div id="outline-container-sec-9-1-4" class="outline-4">
<h4 id="sec-9-1-4"><span class="section-number-4">9.1.4</span> 男女意见想差最大的电影 (sort_values)</h4>
<div class="outline-text-4" id="text-9-1-4">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">mean_ratings_gender</span>[<span style="color: #ff4ea3;">'diff'</span>] = mean_ratings_gender.F - mean_ratings_gender.M
<span style="color: #ff8700;">result</span> = mean_ratings_gender.sort_values(by=<span style="color: #ff4ea3;">'diff'</span>, ascending=<span style="color: #5fafd7;">True</span>)
log(<span style="color: #ff4ea3;">"result.head()"</span>, result.head())
</pre>
</div>

<pre class="example">
================================ result.head() =================================
gender                                        F         M      diff
title
Tigrero: A Film That Was Never Made (1994)  1.0  4.333333 -3.333333
Neon Bible, The (1995)                      1.0  4.000000 -3.000000
Enfer, L' (1994)                            1.0  3.750000 -2.750000
Stalingrad (1993)                           1.0  3.593750 -2.593750
Killer: A Journal of Murder (1995)          1.0  3.428571 -2.428571
</pre>
</div>
</div>

<div id="outline-container-sec-9-1-5" class="outline-4">
<h4 id="sec-9-1-5"><span class="section-number-4">9.1.5</span> 参与评分人数最多 (group_by)</h4>
<div class="outline-text-4" id="text-9-1-5">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">ratings_by_movie_title</span> = data.groupby(<span style="color: #ff4ea3;">'title'</span>).size()
<span style="color: #ff8700;">top_ratings</span> = ratings_by_movie_title[ratings_by_movie_title &gt; 1000]
<span style="color: #ff8700;">top_10_ratings</span> = top_ratings.sort_values(ascending=<span style="color: #5fafd7;">False</span>).head()
log(<span style="color: #ff4ea3;">"top_10_ratings"</span>, top_10_ratings)
</pre>
</div>

<pre class="example">
================================ top_10_ratings ================================
title
American Beauty (1999)                                   3428
Star Wars: Episode IV - A New Hope (1977)                2991
Star Wars: Episode V - The Empire Strikes Back (1980)    2990
Star Wars: Episode VI - Return of the Jedi (1983)        2883
Jurassic Park (1993)                                     2672
dtype: int64
</pre>
</div>
</div>


<div id="outline-container-sec-9-1-6" class="outline-4">
<h4 id="sec-9-1-6"><span class="section-number-4">9.1.6</span> 活跃度超过 1000 的高分电影</h4>
<div class="outline-text-4" id="text-9-1-6">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">mean_ratings</span> = data.pivot_table(values=<span style="color: #ff4ea3;">'rating'</span>, index=<span style="color: #ff4ea3;">'title'</span>, aggfunc=<span style="color: #ff4ea3;">'mean'</span>)
<span style="color: #ff8700;">top_10_movies</span> = mean_ratings.loc[top_ratings.index].sort_values(by=<span style="color: #ff4ea3;">'rating'</span>,
                                                                ascending=<span style="color: #5fafd7;">False</span>).head(10)
<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#25226;&#24179;&#22343;&#35780;&#20998;&#21644;&#28909;&#24230;&#32508;&#21512;&#36215;&#26469;</span>
<span style="color: #ff8700;">df_top_10_movies</span> = pd.DataFrame(top_10_movies)
<span style="color: #ff8700;">df_top_10_movies</span>[<span style="color: #ff4ea3;">'hot'</span>] = top_ratings.loc[top_10_movies.index]
log(<span style="color: #ff4ea3;">"df_top_10_movies"</span>, df_top_10_movies)
</pre>
</div>

<pre class="example">
=============================== df_top_10_movies ===============================
                                                      rating   hot
title
Shawshank Redemption, The (1994)                    4.554558  2227
Godfather, The (1972)                               4.524966  2223
Usual Suspects, The (1995)                          4.517106  1783
Schindler's List (1993)                             4.510417  2304
Raiders of the Lost Ark (1981)                      4.477725  2514
Rear Window (1954)                                  4.476190  1050
Star Wars: Episode IV - A New Hope (1977)           4.453694  2991
Dr. Strangelove or: How I Learned to Stop Worry...  4.449890  1367
Casablanca (1942)                                   4.412822  1669
Sixth Sense, The (1999)                             4.406263  2459
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2"><span class="section-number-3">9.2</span> 股票数据分析</h3>
<div class="outline-text-3" id="text-9-2">
</div><div id="outline-container-sec-9-2-1" class="outline-4">
<h4 id="sec-9-2-1"><span class="section-number-4">9.2.1</span> 导入数据</h4>
<div class="outline-text-4" id="text-9-2-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">data</span> = pd.read_csv(<span style="color: #ff4ea3;">'data/600690.csv'</span>, index_col=<span style="color: #ff4ea3;">'Date'</span>, parse_dates=<span style="color: #5fafd7;">True</span>)
show_dataframe(data.head())
</pre>
</div>


<div id="img/fig92800x12.png" class="figure">
<p><img src="img/fig92800x12.png" alt="fig92800x12.png">
</p>
<p><span class="figure-number">Figure 104:</span> 股票数据</p>
</div>
</div>
</div>


<div id="outline-container-sec-9-2-2" class="outline-4">
<h4 id="sec-9-2-2"><span class="section-number-4">9.2.2</span> 分析波动幅度</h4>
<div class="outline-text-4" id="text-9-2-2">
</div><div id="outline-container-sec-9-2-2-1" class="outline-5">
<h5 id="sec-9-2-2-1"><span class="section-number-5">9.2.2.1</span> 针对复权收盘价进行重采样</h5>
<div class="outline-text-5" id="text-9-2-2-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">adj_price</span> = data[<span style="color: #ff4ea3;">'Adj Close'</span>]
log(<span style="color: #ff4ea3;">"adj_price.head()"</span>, adj_price.head())
</pre>
</div>

<pre class="example">
=============================== adj_price.head() ===============================
Date
2016-05-20    9.14
2016-05-19    8.84
2016-05-18    8.88
2016-05-17    8.83
2016-05-16    9.07
Name: Adj Close, dtype: float64
</pre>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">resampled</span> = adj_price.resample(<span style="color: #ff4ea3;">'m'</span>, how=<span style="color: #ff4ea3;">'ohlc'</span>)
show_dataframe(resampled.head())
</pre>
</div>


<div id="img/fig92800wJM.png" class="figure">
<p><img src="img/fig92800wJM.png" alt="fig92800wJM.png">
</p>
<p><span class="figure-number">Figure 105:</span> 按月份进行重采样</p>
</div>
</div>
</div>

<div id="outline-container-sec-9-2-2-2" class="outline-5">
<h5 id="sec-9-2-2-2"><span class="section-number-5">9.2.2.2</span> 计算平均波动幅度</h5>
<div class="outline-text-5" id="text-9-2-2-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">ripple</span> = (resampled.high - resampled.low) / resampled.low
log(<span style="color: #ff4ea3;">"&#24179;&#22343;&#27874;&#21160;&#24133;&#24230;(%)"</span>, ripple.mean()*100)
</pre>
</div>

<pre class="example">
================================== 平均波动幅度(%) ===================================
17.656426389381963
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-2-3" class="outline-4">
<h4 id="sec-9-2-3"><span class="section-number-4">9.2.3</span> 分析价格变化</h4>
<div class="outline-text-4" id="text-9-2-3">
<div class="org-src-container">

<pre class="src src-ipython">adj_price.plot(figsize=(8, 6))
plot()
</pre>
</div>


<div id="img/fig92800KeY.png" class="figure">
<p><img src="img/fig92800KeY.png" alt="fig92800KeY.png">
</p>
<p><span class="figure-number">Figure 106:</span> 价格变化曲线</p>
</div>
</div>
</div>


<div id="outline-container-sec-9-2-4" class="outline-4">
<h4 id="sec-9-2-4"><span class="section-number-4">9.2.4</span> 最大年均复合增长率</h4>
<div class="outline-text-4" id="text-9-2-4">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">total_max_growth</span> = adj_price.<span style="color: #d18aff;">max</span>() / adj_price.<span style="color: #d18aff;">min</span>()
<span style="color: #ff8700;">old_date</span> = adj_price.index[-1]
<span style="color: #ff8700;">today</span> = adj_price.index[0]
<span style="color: #ff8700;">years</span> = (today.year - old_date.year)
<span style="color: #ff8700;">years</span> = years <span style="color: #a1db00;">if</span> years &gt; 0 <span style="color: #a1db00;">else</span> 1
<span style="color: #ff8700;">max_growth_per_year</span> = total_max_growth ** (1.0 / years)
log(<span style="color: #ff4ea3;">"&#26368;&#22823;&#24180;&#22343;&#22797;&#21512;&#22686;&#38271;&#29575;(%)"</span>, (max_growth_per_year-1)*100)
</pre>
</div>

<pre class="example">
================================= 最大年均复合增长率(%) =================================
35.66298316279286
</pre>
</div>
</div>

<div id="outline-container-sec-9-2-5" class="outline-4">
<h4 id="sec-9-2-5"><span class="section-number-4">9.2.5</span> 当前年均复合增长率</h4>
<div class="outline-text-4" id="text-9-2-5">
<p>
一开始就买，现在还没卖的情况
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">total_growth</span> = adj_price.iloc[0] / adj_price.iloc[-1]
<span style="color: #ff8700;">old_date</span> = adj_price.index[-1]
<span style="color: #ff8700;">today</span> = adj_price.index[0]
<span style="color: #ff8700;">years</span> = (today.year - old_date.year)
<span style="color: #ff8700;">years</span> = years <span style="color: #a1db00;">if</span> years &gt; 0 <span style="color: #a1db00;">else</span> 1
<span style="color: #ff8700;">growth_per_year</span> = total_growth ** (1.0 / years)
log(<span style="color: #ff4ea3;">"&#24180;&#22343;&#22797;&#21512;&#22686;&#38271;&#29575;(%)"</span>, (growth_per_year-1)*100)
</pre>
</div>

<pre class="example">
================================== 年均复合增长率(%) ==================================
25.336286730667148
</pre>
</div>
</div>


<div id="outline-container-sec-9-2-6" class="outline-4">
<h4 id="sec-9-2-6"><span class="section-number-4">9.2.6</span> 平均年化增长率</h4>
<div class="outline-text-4" id="text-9-2-6">
<p>
计算每年的增长率，然后再求平均值。
</p>

<p>
也可以计算每月的增长率，再求平均值，可以看到更短的一些周期变化。
</p>

<p>
这里的关键点在于：计算年化收益率时，应该要除以前一年的价格，
即在前一年的价格的基础上上涨了多少，而不是在当前年的价格。
</p>

<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">first &#34920;&#31034;&#37027;&#24180;&#31532;&#19968;&#22825;&#30340;&#25968;&#25454;</span>
<span style="color: #ff8700;">price_in_years</span> = adj_price.to_period(freq=<span style="color: #ff4ea3;">'A'</span>).groupby(level=0).first()
log(<span style="color: #ff4ea3;">"price_in_years.head()"</span>, price_in_years.head())
<span style="color: #ff8700;">diff</span> = price_in_years.diff()
log(<span style="color: #ff4ea3;">"diff.head()"</span>, diff.head())
<span style="color: #ff8700;">rate_in_years</span> =  diff / (price_in_years - diff)
log(<span style="color: #ff4ea3;">"rate_in_years.head()"</span>, rate_in_years.head())
log(<span style="color: #ff4ea3;">"&#24179;&#22343;&#24180;&#21270;(%)"</span>, rate_in_years.mean()*100)
</pre>
</div>

<pre class="example">
============================ price_in_years.head() =============================
Date
1993    0.03573
1994    0.02459
1995    0.07254
1996    0.27879
1997    0.69135
Freq: A-DEC, Name: Adj Close, dtype: float64
================================= diff.head() ==================================
Date
1993        NaN
1994   -0.01114
1995    0.04795
1996    0.20625
1997    0.41256
Freq: A-DEC, Name: Adj Close, dtype: float64
============================= rate_in_years.head() =============================
Date
1993         NaN
1994   -0.311783
1995    1.949980
1996    2.843259
1997    1.479824
Freq: A-DEC, Name: Adj Close, dtype: float64
=================================== 平均年化(%) ====================================
49.622003984599324
</pre>

<div class="org-src-container">

<pre class="src src-ipython">(rate_in_years*100).plot(kind=<span style="color: #ff4ea3;">'bar'</span>, figsize=(8,6))
<span style="color: #ff8700;">X</span> = [0, <span style="color: #d18aff;">len</span>(rate_in_years)]
<span style="color: #ff8700;">Y</span> = [0, 0]
plt.plot(X, Y, color=<span style="color: #ff4ea3;">'red'</span>, linestyle=<span style="color: #ff4ea3;">'-'</span>)
plot()
</pre>
</div>


<div id="img/fig92800kyk.png" class="figure">
<p><img src="img/fig92800kyk.png" alt="fig92800kyk.png">
</p>
<p><span class="figure-number">Figure 107:</span> 增长率图</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3"><span class="section-number-3">9.3</span> 小市值策略分析</h3>
<div class="outline-text-3" id="text-9-3">
</div><div id="outline-container-sec-9-3-1" class="outline-4">
<h4 id="sec-9-3-1"><span class="section-number-4">9.3.1</span> 导入数据</h4>
<div class="outline-text-4" id="text-9-3-1">
<table>


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">交易日期</th>
<th scope="col" class="left">股票代码</th>
<th scope="col" class="left">总市值</th>
<th scope="col" class="left">是否交易</th>
<th scope="col" class="left">最后一天涨跌幅</th>
<th scope="col" class="left">交易天数</th>
<th scope="col" class="left">下月涨幅</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">date</td>
<td class="left">code</td>
<td class="left">mktcap</td>
<td class="left">tradable</td>
<td class="left">ld_pchange</td>
<td class="left">trade_days</td>
<td class="left">nm_pchange</td>
</tr>
</tbody>
</table>


<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">cols</span> = [<span style="color: #ff4ea3;">'date'</span>, <span style="color: #ff4ea3;">'code'</span>, <span style="color: #ff4ea3;">'mktcap'</span>, <span style="color: #ff4ea3;">'tradable'</span>, <span style="color: #ff4ea3;">'ld_pchange'</span>,
        <span style="color: #ff4ea3;">'trade_days'</span>, <span style="color: #ff4ea3;">'nm_pchange'</span>]
<span style="color: #ff8700;">df</span> = pd.read_csv(<span style="color: #ff4ea3;">'data/stock_data.csv'</span>,
                 parse_dates=[<span style="color: #ff4ea3;">'&#20132;&#26131;&#26085;&#26399;'</span>],
                 encoding=<span style="color: #ff4ea3;">'gbk'</span>)
<span style="color: #ff8700;">df.columns</span> = cols
show_dataframe(df.head())
</pre>
</div>


<div id="img/fig73568kg2.png" class="figure">
<p><img src="img/fig73568kg2.png" alt="fig73568kg2.png">
</p>
<p><span class="figure-number">Figure 108:</span> 原始数据</p>
</div>
</div>
</div>

<div id="outline-container-sec-9-3-2" class="outline-4">
<h4 id="sec-9-3-2"><span class="section-number-4">9.3.2</span> 按照交易日期，股票代码排序</h4>
<div class="outline-text-4" id="text-9-3-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = df.sort_values(by=[<span style="color: #ff4ea3;">'date'</span>, <span style="color: #ff4ea3;">'code'</span>])
show_dataframe(df.head())
</pre>
</div>


<div id="img/fig73568j0L.png" class="figure">
<p><img src="img/fig73568j0L.png" alt="fig73568j0L.png">
</p>
<p><span class="figure-number">Figure 109:</span> 按交易日期，股票代码排序</p>
</div>
</div>
</div>


<div id="outline-container-sec-9-3-3" class="outline-4">
<h4 id="sec-9-3-3"><span class="section-number-4">9.3.3</span> 设定分析起始日期</h4>
<div class="outline-text-4" id="text-9-3-3">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">date_filter</span> = df.date &gt; pd.to_datetime(<span style="color: #ff4ea3;">'20060101'</span>)
<span style="color: #ff8700;">df</span> = df[date_filter]
show_dataframe(df.head())
</pre>
</div>


<div id="img/fig735689IY.png" class="figure">
<p><img src="img/fig735689IY.png" alt="fig735689IY.png">
</p>
<p><span class="figure-number">Figure 110:</span> 设定开始时间</p>
</div>
</div>
</div>

<div id="outline-container-sec-9-3-4" class="outline-4">
<h4 id="sec-9-3-4"><span class="section-number-4">9.3.4</span> 过滤不符合分析要求的股票</h4>
<div class="outline-text-4" id="text-9-3-4">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#36807;&#28388;&#26080;&#27861;&#20132;&#26131;&#30340;&#32929;&#31080;</span>
<span style="color: #ff8700;">tradable_filter</span> = df.tradable == 1
<span style="color: #ff8700;">df</span> = df[tradable_filter]

<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#36807;&#28388;&#20132;&#26131;&#26102;&#38388;&#36807;&#30701;&#30340;&#32929;&#31080;</span>
<span style="color: #ff8700;">trade_days_filter</span> = df.trade_days &gt; 10
<span style="color: #ff8700;">df</span> = df[trade_days_filter]

<span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">&#36807;&#28388;&#28072;&#20572;&#32929;</span>
<span style="color: #ff8700;">ld_pchange_filter</span> = df.ld_pchange &lt;= 0.097
<span style="color: #ff8700;">df</span> = df[ld_pchange_filter]

show_dataframe(df.head())
</pre>
</div>


<div id="img/fig73568Xdk.png" class="figure">
<p><img src="img/fig73568Xdk.png" alt="fig73568Xdk.png">
</p>
<p><span class="figure-number">Figure 111:</span> 过滤无用数据</p>
</div>
</div>
</div>

<div id="outline-container-sec-9-3-5" class="outline-4">
<h4 id="sec-9-3-5"><span class="section-number-4">9.3.5</span> 计算所有股票平均涨幅</h4>
<div class="outline-text-4" id="text-9-3-5">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">all_mean</span> = df.groupby(<span style="color: #ff4ea3;">'date'</span>)[<span style="color: #ff4ea3;">'nm_pchange'</span>].mean()
log(<span style="color: #ff4ea3;">"all_mean.head()"</span>, all_mean.head())
</pre>
</div>

<pre class="example">
=============================== all_mean.head() ================================
date
2006-01-31    0.033031
2006-02-28    0.005858
2006-03-31    0.069946
2006-04-30    0.252240
2006-05-31    0.056737
Name: nm_pchange, dtype: float64
</pre>
</div>
</div>

<div id="outline-container-sec-9-3-6" class="outline-4">
<h4 id="sec-9-3-6"><span class="section-number-4">9.3.6</span> 选取低市值股票</h4>
<div class="outline-text-4" id="text-9-3-6">
</div><div id="outline-container-sec-9-3-6-1" class="outline-5">
<h5 id="sec-9-3-6-1"><span class="section-number-5">9.3.6.1</span> 计算每月市值排名</h5>
<div class="outline-text-5" id="text-9-3-6-1">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">r</span> = df.groupby(<span style="color: #ff4ea3;">'date'</span>)[<span style="color: #ff4ea3;">'mktcap'</span>].rank()
<span style="color: #ff8700;">df</span>[<span style="color: #ff4ea3;">'m_rank'</span>] = r
show_dataframe(df.head(10))
</pre>
</div>


<div id="img/fig73568xxw.png" class="figure">
<p><img src="img/fig73568xxw.png" alt="fig73568xxw.png">
</p>
<p><span class="figure-number">Figure 112:</span> 每月排名</p>
</div>
</div>
</div>

<div id="outline-container-sec-9-3-6-2" class="outline-5">
<h5 id="sec-9-3-6-2"><span class="section-number-5">9.3.6.2</span> 选取市值排名前十低的股票</h5>
<div class="outline-text-5" id="text-9-3-6-2">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">df</span> = df[df.m_rank &lt;= 10]
show_dataframe(df.head(20))
</pre>
</div>


<div id="img/fig73568wFG.png" class="figure">
<p><img src="img/fig73568wFG.png" alt="fig73568wFG.png">
</p>
<p><span class="figure-number">Figure 113:</span> 市值前十低</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9-3-7" class="outline-4">
<h4 id="sec-9-3-7"><span class="section-number-4">9.3.7</span> 计算低市值股票平均涨幅</h4>
<div class="outline-text-4" id="text-9-3-7">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">select_mean</span> = df.groupby(<span style="color: #ff4ea3;">'date'</span>)[<span style="color: #ff4ea3;">'nm_pchange'</span>].mean()
log(<span style="color: #ff4ea3;">"select_mean.head()"</span>, select_mean.head())
</pre>
</div>

<pre class="example">
============================== select_mean.head() ==============================
date
2006-01-31    0.146760
2006-02-28   -0.048156
2006-03-31   -0.087006
2006-04-30    0.167668
2006-05-31    0.112699
Name: nm_pchange, dtype: float64
</pre>
</div>
</div>

<div id="outline-container-sec-9-3-8" class="outline-4">
<h4 id="sec-9-3-8"><span class="section-number-4">9.3.8</span> 统计绘图</h4>
<div class="outline-text-4" id="text-9-3-8">
<div class="org-src-container">

<pre class="src src-ipython"><span style="color: #ff8700;">all_cum</span> = (all_mean + 1).cumprod()
<span style="color: #ff8700;">select_cum</span> = (select_mean + 1).cumprod()

<span style="color: #ff8700;">result</span> = pd.DataFrame()
<span style="color: #ff8700;">result</span>[<span style="color: #ff4ea3;">'overall'</span>] = all_cum
<span style="color: #ff8700;">result</span>[<span style="color: #ff4ea3;">'selected'</span>] = select_cum
result.plot()
plot()
</pre>
</div>


<div id="img/fig73568KaS.png" class="figure">
<p><img src="img/fig73568KaS.png" alt="fig73568KaS.png">
</p>
<p><span class="figure-number">Figure 114:</span> 对比</p>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> 参考资料</h2>
</div>
</div>
</body>
</html>