#+TITLE:     TCP/IP
#+AUTHOR:    Hao Ruan
#+EMAIL:     ruanhao1116@gmail.com
#+LANGUAGE:  en
#+LINK_HOME: http://www.github.com/ruanhao
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="../css/style.css" />
#+OPTIONS:   H:2 num:nil \n:nil @:t ::t |:t ^:{} _:{} *:t TeX:t LaTeX:t
#+STARTUP:   showall

* 1, IP

** 1.1, 报文格式

#+BEGIN_SRC

0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

#+END_SRC


* 2, TCP

** 2.1, 报文格式

#+BEGIN_SRC

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |          Source Port          |       Destination Port        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sequence Number                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Acknowledgment Number                      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  Data |       |C|E|U|A|P|R|S|F|                               |
 | Offset|  Res. |W|C|R|C|S|S|Y|I|            Window             |
 |       |       |R|E|G|K|H|T|N|N|                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |           Checksum            |         Urgent Pointer        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Options                    |    Padding    |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                             data                              |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

#+END_SRC


** 2.2, 三次握手

#+BEGIN_EXAMPLE

高帅富:

1. 源发送SYN           ==>       1. MM，你的手有空吗？-_-
2. 目标回答SYN, ACK    ==>       2. 有空，你呢？\~_~
3. 源发送ACK           ==>       3. 我也有空 \*_*

屌丝:

1. 源发送SYN           ==>       1. MM，这是你掉的板砖吗？(SYN) ￣▽￣
2. 目标回答RST-ACK     ==>       2. 不是，找拍啊？(RST-ACK) ˋ﹏ˊ

#+END_EXAMPLE

*** 2.2.1, 握手特征码

#+BEGIN_SRC
SYN=1, FIN=0, RST=0, ACK=0 # 第一次握手
SYN=1, FIN=0, RST=0, ACK=1 # 第二次握手
SYN=0, FIN=0, RST=0, ACK=1 # ESTABLISHED
#+END_SRC


*** 2.2.2, 内核中的处理

#+ATTR_HTML: :width 80%
#+CAPTION: 内核中处理三次握手的数据结构
[[./images/tcp_kernel_hs.png]]


**** 2.2.2.1, syncookies

#+ATTR_HTML: :width 80%
#+CAPTION: 使用 tcp syncookies 功能
[[./images/tcp_syncookies.png]]


**** 2.2.2.2, fast open

#+ATTR_HTML: :width 80%
#+CAPTION: tcp fast open 原理
[[./images/tcp_fast_open.png]]


#+BEGIN_EXAMPLE
  net.ipv4.tcp_fastopen

  - 0: 关闭
  - 1: 作为客户端使用 TFO
  - 2: 作为服务端使用 TFO
  - 3: 使用 TFO （无论服务端或是客户端）
#+END_EXAMPLE


**** 2.2.2.3, 发送 TCP 消息

#+ATTR_HTML: :width 80%
#+CAPTION: 发送 TCP 消息过程
[[./images/tcp_kernel_send.png]]


**** 2.2.2.4, 接收 TCP 消息

#+ATTR_HTML: :width 80%
#+CAPTION: 接收 TCP 消息过程
[[./images/tcp_kernel_recv.png]]


**** 2.2.2.5, 接收 TCP 消息 （发生上下文切换）

#+ATTR_HTML: :width 80%
#+CAPTION: 接收 TCP 消息过程 （发生了上下文切换）
[[./images/tcp_kernel_recv_cs.png]]


**** 2.2.2.6, 接收 TCP 消息 （又有新报文到达）

#+ATTR_HTML: :width 80%
#+CAPTION: 接收 TCP 消息过程 （又有新报文到达）
[[./images/tcp_kernel_recv_new.png]]







** 2.3, 状态图

[[./images/tcp_state_machine2.png]]

[[./images/tcp_state_machine3.jpg]]

** 2.4, 状态信息统计

#+BEGIN_SRC sh
  netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
#+END_SRC
