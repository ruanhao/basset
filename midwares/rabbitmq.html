<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2019-05-04 Sat 21:54 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RabbitMQ</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Hao Ruan">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link href="http://fonts.googleapis.com/css?family=Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet" type="text/css" />
<link href="../org-html-themes/solarized/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">RabbitMQ</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4e1032e">1. 消息标签</a></li>
<li><a href="#org74fae61">2. AMQP Protocol</a>
<ul>
<li><a href="#orgee40a8c">2.1. AMQP Frame</a>
<ul>
<li><a href="#org2de29ee">2.1.1. Frame Types</a>
<ul>
<li><a href="#orgc3314da">2.1.1.1. Method frame</a></li>
<li><a href="#org52a1866">2.1.1.2. Content header frame</a></li>
<li><a href="#orge5447e8">2.1.1.3. Body frame</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org717c2ff">2.2. AMQP Model</a></li>
<li><a href="#orgd8e3505">2.3. Protocol Implement</a>
<ul>
<li><a href="#org7bbf648">2.3.1. Declaring exchange</a></li>
<li><a href="#org1150a02">2.3.2. Declaring queue</a></li>
<li><a href="#orga2fe0c7">2.3.3. Binding queue to exchange</a></li>
<li><a href="#org3d6a31a">2.3.4. Publishing message</a></li>
<li><a href="#org7264aea">2.3.5. Consuming message</a>
<ul>
<li><a href="#org52d96b9">2.3.5.1. <code>no_ack</code> argument for the <code>Basic.Consume</code> command</a></li>
</ul>
</li>
<li><a href="#org1360330">2.3.6. 获取消息</a></li>
<li><a href="#org0347cd8">2.3.7. 拒绝消息</a></li>
</ul>
</li>
<li><a href="#org4a67e16">2.4. <code>Basic.Properties</code></a></li>
</ul>
</li>
<li><a href="#org90a5b70">3. 交换器</a>
<ul>
<li><a href="#orgd0eb296">3.1. 属性</a></li>
<li><a href="#orga32379f">3.2. direct</a></li>
<li><a href="#org80e4b68">3.3. fanout</a></li>
<li><a href="#orge07808e">3.4. topic</a></li>
<li><a href="#org48e93c3">3.5. 路由</a></li>
</ul>
</li>
<li><a href="#orga4f8d80">4. RabbitMQ 管理</a>
<ul>
<li><a href="#orgbd8d163">4.1. 启动停止</a>
<ul>
<li><a href="#org3f912e8">4.1.1. 停止节点</a></li>
<li><a href="#org54b63d2">4.1.2. 停止应用</a></li>
</ul>
</li>
<li><a href="#org8bd0bf8">4.2. 配置文件</a></li>
<li><a href="#org124d600">4.3. 管理用户</a>
<ul>
<li><a href="#org1aa8e34">4.3.1. 创建</a></li>
<li><a href="#org3f72d0e">4.3.2. 删除</a></li>
<li><a href="#org43d1ec1">4.3.3. 修改密码</a></li>
<li><a href="#org9fdbe68">4.3.4. 查看</a></li>
</ul>
</li>
<li><a href="#org82bff4b">4.4. 管理权限</a>
<ul>
<li><a href="#org66a8d7b">4.4.1. 创建</a></li>
<li><a href="#org3b05721">4.4.2. 删除</a></li>
<li><a href="#orgefbd64b">4.4.3. 查看</a></li>
</ul>
</li>
<li><a href="#org0c9c4a9">4.5. 管理 vhost</a></li>
<li><a href="#org14f2117">4.6. 信息查询</a>
<ul>
<li><a href="#org2dd01ac">4.6.1. 查看队列</a></li>
<li><a href="#orga1856fd">4.6.2. 查看交换器</a></li>
<li><a href="#org9d72eb6">4.6.3. 查看绑定信息</a></li>
<li><a href="#orgeab8fcb">4.6.4. 查看集群状态</a></li>
<li><a href="#org8c5542e">4.6.5. 接入 Eshell</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd9eaffb">5. 代码示例</a>
<ul>
<li><a href="#org8e81c9b">5.1. 基本用法</a>
<ul>
<li><a href="#org7cccd1e">5.1.1. 生产者</a></li>
<li><a href="#orgc3a2d42">5.1.2. 消费者</a></li>
</ul>
</li>
<li><a href="#org85c7969">5.2. 发送方确认模式</a>
<ul>
<li><a href="#orgd932e34">5.2.1. 生产者</a></li>
</ul>
</li>
<li><a href="#orga50934a">5.3. 通过 AMQP 实时访问日志</a></li>
</ul>
</li>
<li><a href="#orgc271f84">6. 集群</a>
<ul>
<li><a href="#org1533561">6.1. 集群管理</a>
<ul>
<li><a href="#orgb487896">6.1.1. 清空节点元数据（重设）</a></li>
<li><a href="#org0bd0252">6.1.2. 加入集群</a></li>
<li><a href="#orgf8fca20">6.1.3. 查看集群信息</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org139448c">7. 持久性</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="meta">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Author</td>
<td class="org-left">Hao Ruan (haoru@cisco.com)</td>
</tr>

<tr>
<td class="org-left">Date</td>
<td class="org-left">2019-05-04 21:54:21</td>
</tr>
</tbody>
</table>
</div>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4e1032e">1. 消息标签</a></li>
<li><a href="#org74fae61">2. AMQP Protocol</a>
<ul>
<li><a href="#orgee40a8c">2.1. AMQP Frame</a>
<ul>
<li><a href="#org2de29ee">2.1.1. Frame Types</a>
<ul>
<li><a href="#orgc3314da">2.1.1.1. Method frame</a></li>
<li><a href="#org52a1866">2.1.1.2. Content header frame</a></li>
<li><a href="#orge5447e8">2.1.1.3. Body frame</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org717c2ff">2.2. AMQP Model</a></li>
<li><a href="#orgd8e3505">2.3. Protocol Implement</a>
<ul>
<li><a href="#org7bbf648">2.3.1. Declaring exchange</a></li>
<li><a href="#org1150a02">2.3.2. Declaring queue</a></li>
<li><a href="#orga2fe0c7">2.3.3. Binding queue to exchange</a></li>
<li><a href="#org3d6a31a">2.3.4. Publishing message</a></li>
<li><a href="#org7264aea">2.3.5. Consuming message</a>
<ul>
<li><a href="#org52d96b9">2.3.5.1. <code>no_ack</code> argument for the <code>Basic.Consume</code> command</a></li>
</ul>
</li>
<li><a href="#org1360330">2.3.6. 获取消息</a></li>
<li><a href="#org0347cd8">2.3.7. 拒绝消息</a></li>
</ul>
</li>
<li><a href="#org4a67e16">2.4. <code>Basic.Properties</code></a></li>
</ul>
</li>
<li><a href="#org90a5b70">3. 交换器</a>
<ul>
<li><a href="#orgd0eb296">3.1. 属性</a></li>
<li><a href="#orga32379f">3.2. direct</a></li>
<li><a href="#org80e4b68">3.3. fanout</a></li>
<li><a href="#orge07808e">3.4. topic</a></li>
<li><a href="#org48e93c3">3.5. 路由</a></li>
</ul>
</li>
<li><a href="#orga4f8d80">4. RabbitMQ 管理</a>
<ul>
<li><a href="#orgbd8d163">4.1. 启动停止</a>
<ul>
<li><a href="#org3f912e8">4.1.1. 停止节点</a></li>
<li><a href="#org54b63d2">4.1.2. 停止应用</a></li>
</ul>
</li>
<li><a href="#org8bd0bf8">4.2. 配置文件</a></li>
<li><a href="#org124d600">4.3. 管理用户</a>
<ul>
<li><a href="#org1aa8e34">4.3.1. 创建</a></li>
<li><a href="#org3f72d0e">4.3.2. 删除</a></li>
<li><a href="#org43d1ec1">4.3.3. 修改密码</a></li>
<li><a href="#org9fdbe68">4.3.4. 查看</a></li>
</ul>
</li>
<li><a href="#org82bff4b">4.4. 管理权限</a>
<ul>
<li><a href="#org66a8d7b">4.4.1. 创建</a></li>
<li><a href="#org3b05721">4.4.2. 删除</a></li>
<li><a href="#orgefbd64b">4.4.3. 查看</a></li>
</ul>
</li>
<li><a href="#org0c9c4a9">4.5. 管理 vhost</a></li>
<li><a href="#org14f2117">4.6. 信息查询</a>
<ul>
<li><a href="#org2dd01ac">4.6.1. 查看队列</a></li>
<li><a href="#orga1856fd">4.6.2. 查看交换器</a></li>
<li><a href="#org9d72eb6">4.6.3. 查看绑定信息</a></li>
<li><a href="#orgeab8fcb">4.6.4. 查看集群状态</a></li>
<li><a href="#org8c5542e">4.6.5. 接入 Eshell</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd9eaffb">5. 代码示例</a>
<ul>
<li><a href="#org8e81c9b">5.1. 基本用法</a>
<ul>
<li><a href="#org7cccd1e">5.1.1. 生产者</a></li>
<li><a href="#orgc3a2d42">5.1.2. 消费者</a></li>
</ul>
</li>
<li><a href="#org85c7969">5.2. 发送方确认模式</a>
<ul>
<li><a href="#orgd932e34">5.2.1. 生产者</a></li>
</ul>
</li>
<li><a href="#orga50934a">5.3. 通过 AMQP 实时访问日志</a></li>
</ul>
</li>
<li><a href="#orgc271f84">6. 集群</a>
<ul>
<li><a href="#org1533561">6.1. 集群管理</a>
<ul>
<li><a href="#orgb487896">6.1.1. 清空节点元数据（重设）</a></li>
<li><a href="#org0bd0252">6.1.2. 加入集群</a></li>
<li><a href="#orgf8fca20">6.1.3. 查看集群信息</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org139448c">7. 持久性</a></li>
</ul>
</div>
</div>


<div id="outline-container-org4e1032e" class="outline-2">
<h2 id="org4e1032e"><span class="section-number-2">1</span> 消息标签</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>AMQP 用标签表述消息，由一个交换器名称和可选的主题标记组成。</li>
<li>在消息的路由过程中，消息的标签并没有随 payload 一起传递，如果需要明确知道是谁生产的 AMQP 消息的话，就要看生产者是否把发送方信息放入 payload 中。</li>
</ul>
</div>
</div>


<div id="outline-container-org74fae61" class="outline-2">
<h2 id="org74fae61"><span class="section-number-2">2</span> AMQP Protocol</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>当队列拥有多个消费者，队列收到的消息将以循环的方式发送给消费者，每条消息只会发送给一个订阅的消费者。</li>
<li>消费者接收到的每条消息都必须进行确认。</li>
<li>在上一条消息确认之前，RabbitMQ 会认为这个消费者并没有准备好接收下一条消息，因此不会再给该消费者发送更多消息。</li>
<li>如果消费者收到一条消息，在确认之前断开了连接（或者从队列上取消订阅），RabbitMQ 会认为这条消息没有分发，然后重新分发给下一个订阅的消费者。</li>
<li>一个信道上可以创建多个订阅，使用 <code>consumer_tag</code> 来标识。</li>
</ul>
</div>

<div id="outline-container-orgee40a8c" class="outline-3">
<h3 id="orgee40a8c"><span class="section-number-3">2.1</span> AMQP Frame</h3>
<div class="outline-text-3" id="text-2-1">
<p>
AMQP uses <span class="underline">classes</span> and <span class="underline">methods</span>, referred to as <b>AMQP commands</b>, to create a common language between clients and servers.
</p>


<div class="figure">
<p><img src="img/rabbit_frame.png" alt="rabbit_frame.png">
</p>
</div>


<div class="figure">
<p><img src="img/rabbit_frame2.png" alt="rabbit_frame2.png">
</p>
</div>
</div>

<div id="outline-container-org2de29ee" class="outline-4">
<h4 id="org2de29ee"><span class="section-number-4">2.1.1</span> Frame Types</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
The AMQP specification defines five types of frames:
</p>

<ul class="org-ul">
<li>Protocol header frame
Only used once, when connecting to RabbitMQ.</li>
<li>Method frame
Carries with it the RPC request or response that's being sent to or received from RabbitMQ.</li>
<li>Content header frame
Contains the size and properties for a message.</li>
<li>Body frames
Contain the content of messages.</li>
<li>Heartbeat frame
Sent to and from RabbitMQ as a check to ensure that both sides of the connection are available and working properly.</li>
</ul>
</div>

<div id="outline-container-orgc3314da" class="outline-5">
<h5 id="orgc3314da"><span class="section-number-5">2.1.1.1</span> Method frame</h5>
<div class="outline-text-5" id="text-2-1-1-1">

<div class="figure">
<p><img src="img/rabbit_method_frame.png" alt="rabbit_method_frame.png">
</p>
</div>
</div>
</div>


<div id="outline-container-org52a1866" class="outline-5">
<h5 id="org52a1866"><span class="section-number-5">2.1.1.2</span> Content header frame</h5>
<div class="outline-text-5" id="text-2-1-1-2">

<div class="figure">
<p><img src="img/rabbit_content_header_frame.png" alt="rabbit_content_header_frame.png">
</p>
</div>
</div>
</div>


<div id="outline-container-orge5447e8" class="outline-5">
<h5 id="orge5447e8"><span class="section-number-5">2.1.1.3</span> Body frame</h5>
<div class="outline-text-5" id="text-2-1-1-3">

<div class="figure">
<p><img src="img/rabbit_body_frame.png" alt="rabbit_body_frame.png">
</p>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org717c2ff" class="outline-3">
<h3 id="org717c2ff"><span class="section-number-3">2.2</span> AMQP Model</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The AMQ model logically defines three abstract components in broker software that define the routing behavior of messages:
</p>

<ul class="org-ul">
<li>Exchange
The component of the message broker that routes messages to queues</li>
<li>Queue
A data structure on disk or in memory that stores messages</li>
<li>Binding
A rule that tells the exchange which queue the messages should be stored in</li>
</ul>
</div>
</div>


<div id="outline-container-orgd8e3505" class="outline-3">
<h3 id="orgd8e3505"><span class="section-number-3">2.3</span> Protocol Implement</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-org7bbf648" class="outline-4">
<h4 id="org7bbf648"><span class="section-number-4">2.3.1</span> Declaring exchange</h4>
<div class="outline-text-4" id="text-2-3-1">

<div class="figure">
<p><img src="img/rabbit_declare_exchange.png" alt="rabbit_declare_exchange.png">
</p>
</div>


<p>
If, for whatever reason, the command should fail, RabbitMQ will close the channel by sending a <code>Channel.Close</code> command. <br>
This response will include a numeric reply code and text value indicating why the <code>Exchange.Declare</code> failed and the channel was closed.
</p>
</div>
</div>

<div id="outline-container-org1150a02" class="outline-4">
<h4 id="org1150a02"><span class="section-number-4">2.3.2</span> Declaring queue</h4>
<div class="outline-text-4" id="text-2-3-2">

<div class="figure">
<p><img src="img/rabbitmq_create.png" alt="rabbitmq_create.png">
</p>
</div>


<ul class="org-ul">
<li>消费者和生产者都能使用 <code>Queue.Delare</code> 命令来创建队列。</li>
<li>如果消费者在同一信道上已订阅了另一个信道的话，则无法再声明队列了，必须先取消订阅。</li>
<li>当创建队列时，可以指定队列名称，如果不指定的话，RabbitMQ 会分配一个随机名称并在 <code>Queue.Declare</code> 命令的响应中返回。</li>
<li>如果需要临时队列只为一个消费者服务的话，可以结合使用 <code>auto-delete</code> 和 <code>exclusive</code> ，当消费者断开连接时，队列就被移除了。</li>
<li>发出去的消息如果路由到了不存在的队列的话，RabbitMQ 会忽略它们。因此，一般情况下，生产者和消费者都应该尝试创建队列。</li>
<li>Should the <code>Queue.Declare</code> command fail, the channel will be <span class="underline">closed</span>.</li>
</ul>

<pre class="example">
When declaring a queue, there's no harm in issuing the same Queue.Declare command more than once.
RabbitMQ will consider subsequent queue declares to be PASSIVE and will return useful information about the queue,
such as the number of pending messages in the queue and the number of consumers subscribed to it.
</pre>
</div>
</div>


<div id="outline-container-orga2fe0c7" class="outline-4">
<h4 id="orga2fe0c7"><span class="section-number-4">2.3.3</span> Binding queue to exchange</h4>
<div class="outline-text-4" id="text-2-3-3">

<div class="figure">
<p><img src="img/rabbit_bind_queue.png" alt="rabbit_bind_queue.png">
</p>
</div>
</div>
</div>


<div id="outline-container-org3d6a31a" class="outline-4">
<h4 id="org3d6a31a"><span class="section-number-4">2.3.4</span> Publishing message</h4>
<div class="outline-text-4" id="text-2-3-4">

<div class="figure">
<p><img src="img/rabbit_publish_msg.png" alt="rabbit_publish_msg.png">
</p>
</div>
</div>
</div>

<div id="outline-container-org7264aea" class="outline-4">
<h4 id="org7264aea"><span class="section-number-4">2.3.5</span> Consuming message</h4>
<div class="outline-text-4" id="text-2-3-5">

<div class="figure">
<p><img src="img/rabbit_comsume_msg.png" alt="rabbit_comsume_msg.png">
</p>
</div>
</div>


<div id="outline-container-org52d96b9" class="outline-5">
<h5 id="org52d96b9"><span class="section-number-5">2.3.5.1</span> <code>no_ack</code> argument for the <code>Basic.Consume</code> command</h5>
<div class="outline-text-5" id="text-2-3-5-1">
<p>
When set to true, RabbitMQ will send messages continuously until the consumer sends a <code>Basic.Cancel</code> command or the consumer is disconnected. <br>
If the <code>no_ack</code> flag is set to false, a consumer must acknowledge each message that it receives by sending a <code>Basic.Ack</code> RPC request:
</p>


<div class="figure">
<p><img src="img/rabbit_consume_ack.png" alt="rabbit_consume_ack.png">
</p>
</div>


<p>
When the <code>Basic.Ack</code> response frame is sent, the consumer must pass with it an argument from the <code>Basic.Deliver</code> method frame
called the <b>delivery tag</b>. <br>
RabbitMQ uses the <b>delivery tag</b> along with the channel as a unique identifier to communicate message acknowledgement, rejection,
and negative acknowledgement.
</p>
</div>
</div>
</div>

<div id="outline-container-org1360330" class="outline-4">
<h4 id="org1360330"><span class="section-number-4">2.3.6</span> 获取消息</h4>
<div class="outline-text-4" id="text-2-3-6">

<div class="figure">
<p><img src="img/rabbitmq_get.png" alt="rabbitmq_get.png">
</p>
</div>

<p>
<code>Basic.Get</code> 命令会订阅消息，获得单条消息，然后取消订阅，因此效率不高。
</p>
</div>
</div>


<div id="outline-container-org0347cd8" class="outline-4">
<h4 id="org0347cd8"><span class="section-number-4">2.3.7</span> 拒绝消息</h4>
<div class="outline-text-4" id="text-2-3-7">

<div class="figure">
<p><img src="img/rabbitmq_reject.png" alt="rabbitmq_reject.png">
</p>
</div>


<p>
<code>requeue=false</code> 的意义在于：RabbitMQ 会支持一个特殊的队列（dead letter）用来存放那些被拒绝而不重入队列的消息。
dead letter 队列可以让管理者通过检测拒绝或未送达的消息来发现问题所在。
因此，如果想使用 dead letter 队列功能的话，需要使用 <code>reject</code> 命令，并将其设为 false 。
</p>
</div>
</div>
</div>




<div id="outline-container-org4a67e16" class="outline-3">
<h3 id="org4a67e16"><span class="section-number-3">2.4</span> <code>Basic.Properties</code></h3>
<div class="outline-text-3" id="text-2-4">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Property</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">For use by</th>
<th scope="col" class="org-left">Suggested or specified use</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">app-id</td>
<td class="org-left">short-string</td>
<td class="org-left">Application</td>
<td class="org-left">Useful for defining the application publishing the messages.</td>
</tr>

<tr>
<td class="org-left">content-encoding</td>
<td class="org-left">short-string</td>
<td class="org-left">Application</td>
<td class="org-left">Specify whether your message body is encoded in some special way, such as zlib, deflate, or Base64.</td>
</tr>

<tr>
<td class="org-left">content-type</td>
<td class="org-left">short-string</td>
<td class="org-left">Application</td>
<td class="org-left">If the message is in reference to some other message or uniquely identifiable item, the correlation-id is a good way to indicate what the message is referencing.</td>
</tr>

<tr>
<td class="org-left">delivery-mode</td>
<td class="org-left">octet</td>
<td class="org-left">RabbitMQ</td>
<td class="org-left">A value of 1 tells RabbitMQ it can keep the message in memory; 2 indicates it should also write it to disk.</td>
</tr>

<tr>
<td class="org-left">expiration</td>
<td class="org-left">short-string</td>
<td class="org-left">RabbitMQ</td>
<td class="org-left">An epoch or Unix timestamp value as a text string that indicates when the message should expire.</td>
</tr>

<tr>
<td class="org-left">headers</td>
<td class="org-left">table</td>
<td class="org-left">Both</td>
<td class="org-left">A free-form key/value table that you can use to add additional metadata about your mes- sage; RabbitMQ can route based upon this if desired.</td>
</tr>

<tr>
<td class="org-left">message-id</td>
<td class="org-left">short-string</td>
<td class="org-left">Application</td>
<td class="org-left">A unique identifier such as a UUID that your application can use to identify the message.</td>
</tr>

<tr>
<td class="org-left">priority</td>
<td class="org-left">octet</td>
<td class="org-left">RabbitMQ</td>
<td class="org-left">A property for priority ordering in queues.</td>
</tr>

<tr>
<td class="org-left">timestamp</td>
<td class="org-left">timestamp</td>
<td class="org-left">Application</td>
<td class="org-left">An epoch or Unix timestamp value that can be used to indicate when the message was created.</td>
</tr>

<tr>
<td class="org-left">type</td>
<td class="org-left">short-string</td>
<td class="org-left">Application</td>
<td class="org-left">A text string your application can use to describe the message type or payload.</td>
</tr>

<tr>
<td class="org-left">user-id</td>
<td class="org-left">short-string</td>
<td class="org-left">Both</td>
<td class="org-left">A free-form string that, if used, RabbitMQ will validate against the connected user and drop messages if they don't match.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>





<div id="outline-container-org90a5b70" class="outline-2">
<h2 id="org90a5b70"><span class="section-number-2">3</span> 交换器</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgd0eb296" class="outline-3">
<h3 id="orgd0eb296"><span class="section-number-3">3.1</span> 属性</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Name</li>
<li>Durability (exchanges survive broker restart)</li>
<li>Auto-delete (exchange is deleted when last queue is unbound from it)</li>
<li>Arguments (optional, used by plugins and broker-specific features)</li>
</ul>
</div>
</div>

<div id="outline-container-orga32379f" class="outline-3">
<h3 id="orga32379f"><span class="section-number-3">3.2</span> direct</h3>
<div class="outline-text-3" id="text-3-2">
<p>
如果路由键匹配的话，消息就被投递到对应的队列。
</p>

<p>
RabbitMq 会默认实现一个类型为 direct 的，名称为空白字符串的交换器。
当声明一个队列时，一开始该队列会自动绑定到默认交换器， <b>并以队列名称作为路由键</b> 。
之后可以发送 <code>exchange.declare</code> 命令并设置合适的参数，就可以升级成具体类型交换器。
</p>


<div id="org7000d36" class="figure">
<p><img src="img/direct-router.png" alt="direct-router.png">
</p>
<p><span class="figure-number">Figure 14: </span>direct router</p>
</div>
</div>
</div>


<div id="outline-container-org80e4b68" class="outline-3">
<h3 id="org80e4b68"><span class="section-number-3">3.3</span> fanout</h3>
<div class="outline-text-3" id="text-3-3">
<p>
将收到的消息广播的绑定的队列上。
</p>


<div id="org2be9e53" class="figure">
<p><img src="img/fanout-router.png" alt="fanout-router.png">
</p>
<p><span class="figure-number">Figure 15: </span>fanout router</p>
</div>
</div>
</div>


<div id="outline-container-orge07808e" class="outline-3">
<h3 id="orge07808e"><span class="section-number-3">3.4</span> topic</h3>
<div class="outline-text-3" id="text-3-4">

<div id="orgd480802" class="figure">
<p><img src="img/topic-router.png" alt="topic-router.png">
</p>
<p><span class="figure-number">Figure 16: </span>topic router</p>
</div>

<ul class="org-ul">
<li><code>.</code> 把路由键分为了几部分</li>
<li><code>*</code> 匹配特定位置的任意文本</li>
<li><code>#</code> 匹配所有规则</li>
</ul>
</div>
</div>


<div id="outline-container-org48e93c3" class="outline-3">
<h3 id="org48e93c3"><span class="section-number-3">3.5</span> 路由</h3>
<div class="outline-text-3" id="text-3-5">
<img src="http://javasampleapproach.com/wp-content/uploads/2017/10/springboot-rabbitmq-exchange-to-exchange-architecture.png"/>
</div>
</div>
</div>

<div id="outline-container-orga4f8d80" class="outline-2">
<h2 id="orga4f8d80"><span class="section-number-2">4</span> RabbitMQ 管理</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgbd8d163" class="outline-3">
<h3 id="orgbd8d163"><span class="section-number-3">4.1</span> 启动停止</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-org3f912e8" class="outline-4">
<h4 id="org3f912e8"><span class="section-number-4">4.1.1</span> 停止节点</h4>
<div class="outline-text-4" id="text-4-1-1">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl stop
rabbitmqctl stop -n rabbit@&lt;nodename&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org54b63d2" class="outline-4">
<h4 id="org54b63d2"><span class="section-number-4">4.1.2</span> 停止应用</h4>
<div class="outline-text-4" id="text-4-1-2">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl stop_app
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org8bd0bf8" class="outline-3">
<h3 id="org8bd0bf8"><span class="section-number-3">4.2</span> 配置文件</h3>
<div class="outline-text-3" id="text-4-2">
<p>
<code>/etc/rabbitmq/rabbitmq.config</code>
</p>
</div>
</div>


<div id="outline-container-org124d600" class="outline-3">
<h3 id="org124d600"><span class="section-number-3">4.3</span> 管理用户</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-org1aa8e34" class="outline-4">
<h4 id="org1aa8e34"><span class="section-number-4">4.3.1</span> 创建</h4>
<div class="outline-text-4" id="text-4-3-1">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl add_user &lt;username&gt; &lt;password&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f72d0e" class="outline-4">
<h4 id="org3f72d0e"><span class="section-number-4">4.3.2</span> 删除</h4>
<div class="outline-text-4" id="text-4-3-2">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl delete_user &lt;username&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org43d1ec1" class="outline-4">
<h4 id="org43d1ec1"><span class="section-number-4">4.3.3</span> 修改密码</h4>
<div class="outline-text-4" id="text-4-3-3">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl change_password &lt;username&gt; &lt;new-password&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9fdbe68" class="outline-4">
<h4 id="org9fdbe68"><span class="section-number-4">4.3.4</span> 查看</h4>
<div class="outline-text-4" id="text-4-3-4">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl list_users
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org82bff4b" class="outline-3">
<h3 id="org82bff4b"><span class="section-number-3">4.4</span> 管理权限</h3>
<div class="outline-text-3" id="text-4-4">
<p>
每条访问控制条目由四部分组成：
</p>

<ul class="org-ul">
<li>用户</li>
<li>vhost</li>
<li>需要授予的读/写/配置权限组合</li>
<li>权限范围</li>
</ul>
</div>

<div id="outline-container-org66a8d7b" class="outline-4">
<h4 id="org66a8d7b"><span class="section-number-4">4.4.1</span> 创建</h4>
<div class="outline-text-4" id="text-4-4-1">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl set_permission -p &lt;vhost_name&gt; <span style="color: #e6db74;">\</span>
&lt;username&gt; <span style="color: #e6db74;">".*"</span> <span style="color: #e6db74;">".*"</span> <span style="color: #e6db74;">".*"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3b05721" class="outline-4">
<h4 id="org3b05721"><span class="section-number-4">4.4.2</span> 删除</h4>
<div class="outline-text-4" id="text-4-4-2">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl clear_permissions -p &lt;vhost_name&gt; &lt;username&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgefbd64b" class="outline-4">
<h4 id="orgefbd64b"><span class="section-number-4">4.4.3</span> 查看</h4>
<div class="outline-text-4" id="text-4-4-3">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl list_permissions -p &lt;vhost_name&gt;
rabbitmqctl list_user_permissions &lt;username&gt;  <span style="color: #465457;"># </span><span style="color: #465457;">&#26597;&#30475;&#26576;&#20010;&#29992;&#25143;&#22312;&#25152;&#26377; vhost &#19978;&#30340;&#26435;&#38480;</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org0c9c4a9" class="outline-3">
<h3 id="org0c9c4a9"><span class="section-number-3">4.5</span> 管理 vhost</h3>
<div class="outline-text-3" id="text-4-5">
<ul class="org-ul">
<li><p>
查看
</p>
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl list_vhosts
</pre>
</div></li>
<li><p>
创建
</p>
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl add_vhost &lt;vhost_name&gt;
</pre>
</div></li>
<li><p>
删除
</p>
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl delete_vhost &lt;vhost_name&gt;
</pre>
</div></li>
</ul>
</div>
</div>



<div id="outline-container-org14f2117" class="outline-3">
<h3 id="org14f2117"><span class="section-number-3">4.6</span> 信息查询</h3>
<div class="outline-text-3" id="text-4-6">
</div>
<div id="outline-container-org2dd01ac" class="outline-4">
<h4 id="org2dd01ac"><span class="section-number-4">4.6.1</span> 查看队列</h4>
<div class="outline-text-4" id="text-4-6-1">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl list_queues
rabbitmqctl list_queues name messages consumers memory <span style="color: #465457;"># </span><span style="color: #465457;">memory &#21333;&#20301;&#20026;&#23383;&#33410;</span>
</pre>
</div>

<p>
信息参数包括：
</p>

<ul class="org-ul">
<li>name</li>
<li>durable</li>
<li>auto_delete</li>
<li>arguments</li>
<li>pid</li>
<li>owner_pid</li>
<li>exclusive_consumer_pid</li>
<li>exclusive_consumer_tag</li>
<li>messages_ready</li>
<li>messages_unacknowledged</li>
<li>messages_uncommitted</li>
<li>messages</li>
<li>acks_uncommitted</li>
<li>consumers</li>
<li>transactions</li>
<li>memory</li>
</ul>
</div>
</div>


<div id="outline-container-orga1856fd" class="outline-4">
<h4 id="orga1856fd"><span class="section-number-4">4.6.2</span> 查看交换器</h4>
<div class="outline-text-4" id="text-4-6-2">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl list_exchanges
</pre>
</div>

<p>
信息参数包括：
</p>

<ul class="org-ul">
<li>name</li>
<li>type</li>
<li>durable</li>
<li>auto_delete</li>
<li>arguments</li>
</ul>
</div>
</div>


<div id="outline-container-org9d72eb6" class="outline-4">
<h4 id="org9d72eb6"><span class="section-number-4">4.6.3</span> 查看绑定信息</h4>
<div class="outline-text-4" id="text-4-6-3">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl list_bindings
</pre>
</div>

<p>
参数信息包括：
</p>

<ul class="org-ul">
<li>source_name</li>
<li>source_kind</li>
<li>destination_name</li>
<li>destination_kind</li>
<li>routing_key</li>
<li>arguments</li>
</ul>
</div>
</div>


<div id="outline-container-orgeab8fcb" class="outline-4">
<h4 id="orgeab8fcb"><span class="section-number-4">4.6.4</span> 查看集群状态</h4>
<div class="outline-text-4" id="text-4-6-4">
<p>
包括各个节点MQ状态、镜像队列状态等
</p>

<p>
<code>rabbitmqctl report</code>
</p>
</div>
</div>

<div id="outline-container-org8c5542e" class="outline-4">
<h4 id="org8c5542e"><span class="section-number-4">4.6.5</span> 接入 Eshell</h4>
<div class="outline-text-4" id="text-4-6-5">
<p>
<code>erl -setcookie abc -name test@&lt;node-name&gt; -remsh rabbit@&lt;node-name&gt; -hidden</code>
</p>

<p>
退出时要用 <code>Ctrl+G</code> 然后执行 <b>q</b> 命令退出。
</p>

<div class="org-src-container">
<pre class="src src-erlang">spawn(fun() -&gt; etop:start([{output, text}, {interval, 5}, {lines, 10}, {sort, msg_q}]) end).

spawn(fun() -&gt; etop:start([{output, text}, {interval, 5}, {lines, 10}, {sort, reductions}]) end).
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-orgd9eaffb" class="outline-2">
<h2 id="orgd9eaffb"><span class="section-number-2">5</span> 代码示例</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org8e81c9b" class="outline-3">
<h3 id="org8e81c9b"><span class="section-number-3">5.1</span> 基本用法</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-org7cccd1e" class="outline-4">
<h4 id="org7cccd1e"><span class="section-number-4">5.1.1</span> 生产者</h4>
<div class="outline-text-4" id="text-5-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #f92672; font-weight: bold;">import</span> pika

<span style="color: #fd971f;">EXCHANGE</span> = <span style="color: #e6db74;">'hello-exchange'</span>

<span style="color: #fd971f;">conn_params</span> = pika.ConnectionParameters(host=<span style="color: #e6db74;">'10.74.68.89'</span>, port=45672, socket_timeout=3.0)
<span style="color: #fd971f;">conn_broker</span> = pika.BlockingConnection(conn_params)  <span style="color: #465457;"># </span><span style="color: #465457;">&#20351;&#29992;&#40664;&#35748; vhost /</span>
<span style="color: #fd971f;">channel</span> = conn_broker.channel()

channel.exchange_declare(exchange=EXCHANGE,
                         exchange_type=<span style="color: #e6db74;">'direct'</span>,
                         passive=<span style="color: #ae81ff;">False</span>,
                         durable=<span style="color: #ae81ff;">True</span>,
                         auto_delete=<span style="color: #ae81ff;">False</span>)

<span style="color: #fd971f;">msg_props</span> = pika.BasicProperties()
<span style="color: #fd971f;">msg_props.content_type</span> = <span style="color: #e6db74;">'text/plain'</span>

channel.basic_publish(exchange=EXCHANGE,
                      properties=msg_props,
                      body=<span style="color: #e6db74;">'Hello World'</span>,
                      routing_key=<span style="color: #e6db74;">'hola'</span>)

conn_broker.close()
</pre>
</div>
</div>
</div>


<div id="outline-container-orgc3a2d42" class="outline-4">
<h4 id="orgc3a2d42"><span class="section-number-4">5.1.2</span> 消费者</h4>
<div class="outline-text-4" id="text-5-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #f92672; font-weight: bold;">import</span> pika

<span style="color: #fd971f;">EXCHANGE</span> = <span style="color: #e6db74;">'hello-exchange'</span>
<span style="color: #fd971f;">QUEUE</span> = <span style="color: #e6db74;">'hello-exchange'</span>
<span style="color: #fd971f;">TAG</span> = <span style="color: #e6db74;">'hello-consumer'</span>

<span style="color: #fd971f;">conn_params</span> = pika.ConnectionParameters(host=<span style="color: #e6db74;">'10.74.68.89'</span>, port=45672, socket_timeout=3.0)
<span style="color: #fd971f;">conn_broker</span> = pika.BlockingConnection(conn_params)
<span style="color: #fd971f;">channel</span> = conn_broker.channel()

channel.exchange_declare(exchange=EXCHANGE,  <span style="color: #465457;"># </span><span style="color: #465457;">&#22914;&#26524;&#27809;&#26377;&#23601;&#21019;&#24314;&#65292;&#21542;&#21017;&#32487;&#32493;</span>
                         exchange_type=<span style="color: #e6db74;">'direct'</span>,
                         passive=<span style="color: #ae81ff;">False</span>,
                         durable=<span style="color: #ae81ff;">True</span>,
                         auto_delete=<span style="color: #ae81ff;">False</span>)

channel.queue_declare(queue=QUEUE)

channel.queue_bind(queue=QUEUE,
                   exchange=EXCHANGE,
                   routing_key=<span style="color: #e6db74;">'hola'</span>)

<span style="color: #f92672; font-weight: bold;">def</span> <span style="color: #a6e22e;">msg_consumer</span>(channel, method, header, body):
    channel.basic_ack(delivery_tag=method.delivery_tag)
    <span style="color: #f92672; font-weight: bold;">print</span>(<span style="color: #e6db74;">"receive: {}"</span>.<span style="color: #a6e22e;">format</span>(body))
    channel.basic_cancel(consumer_tag=TAG)
    channel.stop_consuming()


channel.basic_consume(msg_consumer,
                      queue=QUEUE,
                      consumer_tag=TAG) <span style="color: #465457;"># </span><span style="color: #465457;">&#19968;&#20010; channel &#21487;&#20197;&#26377;&#22810;&#20010;&#35746;&#38405;&#65292;&#20351;&#29992; consumer_tag &#26469;&#26631;&#35782;&#35746;&#38405;</span>


<span style="color: #f92672; font-weight: bold;">print</span>(<span style="color: #e6db74;">' [*] Waiting for messages. To exit press CTRL+C'</span>)
channel.start_consuming()
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-org85c7969" class="outline-3">
<h3 id="org85c7969"><span class="section-number-3">5.2</span> 发送方确认模式</h3>
<div class="outline-text-3" id="text-5-2">
<p>
信道进入 confirm 模式，所有在信道上发布的消息都会被指派一个唯一的 ID 号（从 1 开始）。
一旦消息被投递给所有匹配队列后，信道会发送一个发送方确认模式给生产者应用程序（包含消息的唯一 ID ）。
这使得生产者知晓信息已经安全到达目的队列了。
</p>
</div>


<div id="outline-container-orgd932e34" class="outline-4">
<h4 id="orgd932e34"><span class="section-number-4">5.2.1</span> 生产者</h4>
<div class="outline-text-4" id="text-5-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #465457;">#</span><span style="color: #465457;">! /usr/bin/env python3</span>
<span style="color: #465457;"># </span><span style="color: #465457;">-*- coding: utf-8 -*-</span>

<span style="color: #f92672; font-weight: bold;">import</span> pika

<span style="color: #fd971f;">EXCHANGE</span> = <span style="color: #e6db74;">'hello-exchange'</span>

<span style="color: #fd971f;">conn_params</span> = pika.ConnectionParameters(host=<span style="color: #e6db74;">'10.74.68.89'</span>, port=45672, socket_timeout=3.0)
<span style="color: #fd971f;">conn_broker</span> = pika.BlockingConnection(conn_params)  <span style="color: #465457;"># </span><span style="color: #465457;">&#20351;&#29992;&#40664;&#35748; vhost /</span>
<span style="color: #fd971f;">channel</span> = conn_broker.channel()
channel.confirm_delivery()
channel.exchange_declare(exchange=EXCHANGE,
                         exchange_type=<span style="color: #e6db74;">'direct'</span>,
                         passive=<span style="color: #ae81ff;">False</span>,
                         durable=<span style="color: #ae81ff;">True</span>,
                         auto_delete=<span style="color: #ae81ff;">False</span>)

<span style="color: #fd971f;">msg_props</span> = pika.BasicProperties()
<span style="color: #fd971f;">msg_props.content_type</span> = <span style="color: #e6db74;">'text/plain'</span>

<span style="color: #fd971f;">ack</span> = channel.basic_publish(exchange=EXCHANGE,
                            properties=msg_props,
                            body=<span style="color: #e6db74;">'Hello World'</span>,
                            routing_key=<span style="color: #e6db74;">'hola'</span>)

<span style="color: #f92672; font-weight: bold;">if</span> ack:
    <span style="color: #f92672; font-weight: bold;">print</span>(<span style="color: #e6db74;">"confirm received"</span>)
<span style="color: #f92672; font-weight: bold;">else</span>:
    <span style="color: #f92672; font-weight: bold;">print</span>(<span style="color: #e6db74;">"msg lost"</span>)

conn_broker.close()
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orga50934a" class="outline-3">
<h3 id="orga50934a"><span class="section-number-3">5.3</span> 通过 AMQP 实时访问日志</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #465457;">#</span><span style="color: #465457;">! /usr/bin/env python3</span>
<span style="color: #465457;"># </span><span style="color: #465457;">-*- coding: utf-8 -*-</span>

<span style="color: #f92672; font-weight: bold;">import</span> pika

<span style="color: #fd971f;">EXCHANGE</span> = <span style="color: #e6db74;">'amq.rabbitmq.log'</span>

<span style="color: #fd971f;">conn_params</span> = pika.ConnectionParameters(host=<span style="color: #e6db74;">'10.74.68.89'</span>, port=45672, socket_timeout=3.0)
<span style="color: #fd971f;">conn_broker</span> = pika.BlockingConnection(conn_params)
<span style="color: #fd971f;">channel</span> = conn_broker.channel()

<span style="color: #fd971f;">result</span> = channel.queue_declare(exclusive=<span style="color: #ae81ff;">True</span>, auto_delete=<span style="color: #ae81ff;">True</span>)
<span style="color: #fd971f;">queue_name</span> = result.method.queue

<span style="color: #465457;"># </span><span style="color: #465457;">binding_keys = ['info', 'warning', 'error']</span>
<span style="color: #fd971f;">binding_keys</span> = [<span style="color: #e6db74;">'#'</span>]

<span style="color: #f92672; font-weight: bold;">for</span> binding_key <span style="color: #f92672; font-weight: bold;">in</span> binding_keys:
    channel.queue_bind(queue=queue_name,
                       exchange=EXCHANGE,
                       routing_key=binding_key)

<span style="color: #f92672; font-weight: bold;">def</span> <span style="color: #a6e22e;">msg_consumer</span>(channel, method, header, body):
    <span style="color: #f92672; font-weight: bold;">print</span>(<span style="color: #e6db74;">"[{}]: {}"</span>.<span style="color: #a6e22e;">format</span>(method.routing_key, body.decode(<span style="color: #e6db74;">'utf-8'</span>)), end=<span style="color: #e6db74;">''</span>)


channel.basic_consume(msg_consumer,
                      queue=queue_name,
                      no_ack=<span style="color: #ae81ff;">True</span>)

channel.start_consuming()

</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgc271f84" class="outline-2">
<h2 id="orgc271f84"><span class="section-number-2">6</span> 集群</h2>
<div class="outline-text-2" id="text-6">
<p>
RabbitMQ 默认不会将队列的内容复制到整个集群上。
如果不进行特别的配置，这些信息仅存在于队列所属的那个节点上。
非所有者节点 <b>只知道队列的元数据</b> 和指向该队列存在的那个节点的指针。
</p>


<div id="org89eb36c" class="figure">
<p><img src="img/rabbit_cluster.png" alt="rabbit_cluster.png">
</p>
<p><span class="figure-number">Figure 17: </span>只有队列的元信息在节点间共享</p>
</div>


<div id="org4f74981" class="figure">
<p><img src="img/rabbit_cluster_exchange.png" alt="rabbit_cluster_exchange.png">
</p>
<p><span class="figure-number">Figure 18: </span>交换器中的路由信息在节点间共享</p>
</div>
</div>

<div id="outline-container-org1533561" class="outline-3">
<h3 id="org1533561"><span class="section-number-3">6.1</span> 集群管理</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-orgb487896" class="outline-4">
<h4 id="orgb487896"><span class="section-number-4">6.1.1</span> 清空节点元数据（重设）</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
当重设的节点是集群的一部分时，该命令也会和集群中的磁盘节点进行通信。
</p>

<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl -n &lt;node&gt; reset
</pre>
</div>
</div>
</div>

<div id="outline-container-org0bd0252" class="outline-4">
<h4 id="org0bd0252"><span class="section-number-4">6.1.2</span> 加入集群</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
将新节点加入到集群时，必须列出在集群中的所有磁盘节点，并作为集群命令的参数。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #465457;"># </span><span style="color: #465457;">&#23558; my_node &#21152;&#20837;&#38598;&#32676;&#65292;&#24182;&#20351;&#20854;&#33258;&#24049;&#20063;&#31216;&#20026;&#30913;&#30424;&#33410;&#28857;</span>
rabbitmqctl -n &lt;my_node&gt; cluster &lt;other_node&gt; &lt;my_node&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8fca20" class="outline-4">
<h4 id="orgf8fca20"><span class="section-number-4">6.1.3</span> 查看集群信息</h4>
<div class="outline-text-4" id="text-6-1-3">
<div class="org-src-container">
<pre class="src src-sh">rabbitmqctl cluster_status
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org139448c" class="outline-2">
<h2 id="org139448c"><span class="section-number-2">7</span> 持久性</h2>
<div class="outline-text-2" id="text-7">
<p>
RabbitMQ 支持消息的持久化，也就是数据写在磁盘上。消息队列持久化包括 3 个部分：
</p>

<ul class="org-ul">
<li>exchange 持久化，在声明时指定 <code>durable=1</code></li>
<li>queue 持久化，在声明时指定 <code>durable=1</code></li>
<li>消息持久化，在投递时指定 <code>delivery_mode=2</code> （1 是非持久化）</li>
</ul>


<p>
如果 exchange 和 queue 都是持久化的， <b>那么它们之间的 binding 也是持久化的</b> 。
</p>

<p>
如果 exchange 和 queue 两者之间有一个持久化，一个非持久化，其对应的 binding 就无法得到恢复。
</p>

<p>
但是，即使设置了持久化，也不能百分百保证消息不会丢失。有很小的概率在 RabbitMQ 接受到消息后，还没来得及写到磁盘，就发生重启了。
另外，RabbitMQ 也不会对每一个消息执行 <code>fsync(2)</code> ，消息可能仅仅写入到缓存，还没来得及 flush 到硬件存储。
因此 RabbitMQ 的持久性设置并非足够安全，对于普通的工作队列也许够用了。
如果需要加强的安全保证，可以把发布消息的代码封装在 <b>事务</b> 里。
</p>
</div>
</div>
</div>
</body>
</html>