<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2019-06-23 Sun 16:23 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MongoDB</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Hao Ruan">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link href="http://fonts.googleapis.com/css?family=Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../org-html-themes/readtheorg/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">MongoDB</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4d2a22b">1. CRUD 概念</a>
<ul>
<li><a href="#org241ff84">1.1. SQL to MongoDB Mapping</a></li>
<li><a href="#org3b93e5f">1.2. Write Concern</a></li>
<li><a href="#org4b1a9b9">1.3. Read Concern</a>
<ul>
<li><a href="#org8eee0a3">1.3.1. local</a></li>
<li><a href="#orgc410289">1.3.2. majority</a></li>
<li><a href="#orgc7701b9">1.3.3. available</a></li>
<li><a href="#orga54f09b">1.3.4. linearizable</a></li>
</ul>
</li>
<li><a href="#org48ab9fc">1.4. 原子性</a></li>
<li><a href="#org18d5947">1.5. 并发控制</a></li>
<li><a href="#org9a74ba7">1.6. Causal Consistency</a>
<ul>
<li><a href="#org02d9033">1.6.1. Network partition example</a>
<ul>
<li><a href="#orgb07a389">1.6.1.1. 场景分析</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org91c393f">2. Replica Set</a>
<ul>
<li><a href="#orgf10a7e1">2.1. Automatic Failover</a></li>
<li><a href="#org47cd747">2.2. 选举</a>
<ul>
<li><a href="#org4528767">2.2.1. Member Priority</a></li>
<li><a href="#orge4154db">2.2.2. 网络分区</a></li>
</ul>
</li>
<li><a href="#org4873024">2.3. Rollback</a></li>
<li><a href="#org4a03178">2.4. Write Concern</a>
<ul>
<li><a href="#orgae98b86">2.4.1. w: majority</a></li>
</ul>
</li>
<li><a href="#org143b3f2">2.5. Read Preference</a></li>
</ul>
</li>
<li><a href="#org596f410">3. Sharding</a>
<ul>
<li><a href="#orgbd9ce6e">3.1. Components</a>
<ul>
<li><a href="#org0dae790">3.1.1. Shard</a></li>
<li><a href="#org33f89a4">3.1.2. Config Servers</a></li>
<li><a href="#org16c4511">3.1.3. mongos</a></li>
</ul>
</li>
<li><a href="#org5fc5291">3.2. Shard Key</a>
<ul>
<li><a href="#org9b3279b">3.2.1. Chunk</a></li>
</ul>
</li>
<li><a href="#org75efac2">3.3. Sharded Cluster</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4d2a22b">1. CRUD 概念</a>
<ul>
<li><a href="#org241ff84">1.1. SQL to MongoDB Mapping</a></li>
<li><a href="#org3b93e5f">1.2. Write Concern</a></li>
<li><a href="#org4b1a9b9">1.3. Read Concern</a>
<ul>
<li><a href="#org8eee0a3">1.3.1. local</a></li>
<li><a href="#orgc410289">1.3.2. majority</a></li>
<li><a href="#orgc7701b9">1.3.3. available</a></li>
<li><a href="#orga54f09b">1.3.4. linearizable</a></li>
</ul>
</li>
<li><a href="#org48ab9fc">1.4. 原子性</a></li>
<li><a href="#org18d5947">1.5. 并发控制</a></li>
<li><a href="#org9a74ba7">1.6. Causal Consistency</a>
<ul>
<li><a href="#org02d9033">1.6.1. Network partition example</a>
<ul>
<li><a href="#orgb07a389">1.6.1.1. 场景分析</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org91c393f">2. Replica Set</a>
<ul>
<li><a href="#orgf10a7e1">2.1. Automatic Failover</a></li>
<li><a href="#org47cd747">2.2. 选举</a>
<ul>
<li><a href="#org4528767">2.2.1. Member Priority</a></li>
<li><a href="#orge4154db">2.2.2. 网络分区</a></li>
</ul>
</li>
<li><a href="#org4873024">2.3. Rollback</a></li>
<li><a href="#org4a03178">2.4. Write Concern</a>
<ul>
<li><a href="#orgae98b86">2.4.1. w: majority</a></li>
</ul>
</li>
<li><a href="#org143b3f2">2.5. Read Preference</a></li>
</ul>
</li>
<li><a href="#org596f410">3. Sharding</a>
<ul>
<li><a href="#orgbd9ce6e">3.1. Components</a>
<ul>
<li><a href="#org0dae790">3.1.1. Shard</a></li>
<li><a href="#org33f89a4">3.1.2. Config Servers</a></li>
<li><a href="#org16c4511">3.1.3. mongos</a></li>
</ul>
</li>
<li><a href="#org5fc5291">3.2. Shard Key</a>
<ul>
<li><a href="#org9b3279b">3.2.1. Chunk</a></li>
</ul>
</li>
<li><a href="#org75efac2">3.3. Sharded Cluster</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="meta">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Author</td>
<td class="org-left">Hao Ruan (haoru@cisco.com)</td>
</tr>

<tr>
<td class="org-left">Date</td>
<td class="org-left">2019-06-23 16:23:09</td>
</tr>
</tbody>
</table>
</div>



<div id="outline-container-org4d2a22b" class="outline-2">
<h2 id="org4d2a22b"><span class="section-number-2">1</span> CRUD 概念</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org241ff84" class="outline-3">
<h3 id="org241ff84"><span class="section-number-3">1.1</span> <a href="https://docs.mongodb.com/manual/reference/sql-comparison/">SQL to MongoDB Mapping</a></h3>
</div>


<div id="outline-container-org3b93e5f" class="outline-3">
<h3 id="org3b93e5f"><span class="section-number-3">1.2</span> <a href="https://docs.mongodb.com/manual/reference/write-concern/">Write Concern</a></h3>
<div class="outline-text-3" id="text-1-2">
<p>
Write concern (Write Acknowledgement) describes the <b>level of acknowledgment</b>.
</p>
</div>
</div>

<div id="outline-container-org4b1a9b9" class="outline-3">
<h3 id="org4b1a9b9"><span class="section-number-3">1.3</span> Read Concern</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Read concern (Read Isolation) controls the consistency and isolation of the data read from replica sets and replica set shards.
</p>

<img src="https://docs.mongodb.com/manual/_images/read-concern-write-timeline.svg"/>


<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Time</th>
<th scope="col" class="org-left">Event</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">t<sub>0</sub></td>
<td class="org-left">Primary applies write<sub>0</sub></td>
</tr>

<tr>
<td class="org-left">t<sub>1</sub></td>
<td class="org-left">Secondary1 applies write<sub>0</sub></td>
</tr>

<tr>
<td class="org-left">t<sub>2</sub></td>
<td class="org-left">Secondary2 applies write<sub>0</sub></td>
</tr>

<tr>
<td class="org-left">t<sub>3</sub></td>
<td class="org-left">Primary is aware of successful replication to Secondary1 and sends acknowledgement to client</td>
</tr>

<tr>
<td class="org-left">t<sub>4</sub></td>
<td class="org-left">Primary is aware of successful replication to Secondary2</td>
</tr>

<tr>
<td class="org-left">t<sub>5</sub></td>
<td class="org-left">Secondary1 receives notice (through regular replication mechanism) to update its snapshot of its most recent <code>w: majority</code> write</td>
</tr>

<tr>
<td class="org-left">t<sub>6</sub></td>
<td class="org-left">Secondary2 receives notice (through regular replication mechanism) to update its snapshot of its most recent <code>w: majority</code> write</td>
</tr>
</tbody>
</table>
</div>


<div id="outline-container-org8eee0a3" class="outline-4">
<h4 id="org8eee0a3"><span class="section-number-4">1.3.1</span> local</h4>
<div class="outline-text-4" id="text-1-3-1">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Target</td>
<td class="org-left">Time</td>
<td class="org-left">State of Data</td>
</tr>

<tr>
<td class="org-left">Primary</td>
<td class="org-left">After t<sub>0</sub></td>
<td class="org-left">Data reflects Write<sub>0</sub></td>
</tr>

<tr>
<td class="org-left">Secondary<sub>1</sub></td>
<td class="org-left">Before t<sub>1</sub></td>
<td class="org-left">Data reflects Write<sub>prev</sub></td>
</tr>

<tr>
<td class="org-left">Secondary<sub>1</sub></td>
<td class="org-left">After t<sub>1</sub></td>
<td class="org-left">Data reflects Write<sub>0</sub></td>
</tr>

<tr>
<td class="org-left">Secondary<sub>2</sub></td>
<td class="org-left">Before t<sub>2</sub></td>
<td class="org-left">Data reflects Write<sub>prev</sub></td>
</tr>

<tr>
<td class="org-left">Secondary<sub>2</sub></td>
<td class="org-left">After t<sub>2</sub></td>
<td class="org-left">Data reflects Write<sub>0</sub></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgc410289" class="outline-4">
<h4 id="orgc410289"><span class="section-number-4">1.3.2</span> majority</h4>
<div class="outline-text-4" id="text-1-3-2">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Target</td>
<td class="org-left">Time</td>
<td class="org-left">State of Data</td>
</tr>

<tr>
<td class="org-left">Primary</td>
<td class="org-left">Begore t<sub>3</sub></td>
<td class="org-left">Data reflects Write<sub>prev</sub></td>
</tr>

<tr>
<td class="org-left">Primary</td>
<td class="org-left">After t<sub>3</sub></td>
<td class="org-left">Data reflects Write<sub>0</sub></td>
</tr>

<tr>
<td class="org-left">Secondary<sub>1</sub></td>
<td class="org-left">Before t<sub>5</sub></td>
<td class="org-left">Data reflects Write<sub>prev</sub></td>
</tr>

<tr>
<td class="org-left">Secondary<sub>1</sub></td>
<td class="org-left">After t<sub>5</sub></td>
<td class="org-left">Data reflects Write<sub>0</sub></td>
</tr>

<tr>
<td class="org-left">Secondary<sub>2</sub></td>
<td class="org-left">Before t<sub>6</sub></td>
<td class="org-left">Data reflects Write<sub>prev</sub></td>
</tr>

<tr>
<td class="org-left">Secondary<sub>2</sub></td>
<td class="org-left">After t<sub>6</sub></td>
<td class="org-left">Data reflects Write<sub>0</sub></td>
</tr>
</tbody>
</table>
</div>
</div>



<div id="outline-container-orgc7701b9" class="outline-4">
<h4 id="orgc7701b9"><span class="section-number-4">1.3.3</span> available</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
For unsharded collections (including collections in a standalone deployment or a replica set deployment),
<code>local</code> and <code>available</code> read concerns behave <b>identically</b>.
</p>
</div>
</div>




<div id="outline-container-orga54f09b" class="outline-4">
<h4 id="orga54f09b"><span class="section-number-4">1.3.4</span> linearizable</h4>
<div class="outline-text-4" id="text-1-3-4">
<p>
"Linearizable" read concern was introduced in MongoDb 3.4 to solve a possible issue with "majority" Read concern.
</p>

<p>
See <a href="https://stackoverflow.com/questions/42615319/the-difference-between-majority-and-linearizable">The difference between "majority" and "linearizable"</a>
</p>
</div>
</div>
</div>




<div id="outline-container-org48ab9fc" class="outline-3">
<h3 id="org48ab9fc"><span class="section-number-3">1.4</span> 原子性</h3>
<div class="outline-text-3" id="text-1-4">
<p>
In MongoDB, a write operation is atomic <b>on the level of a single document.</b>
</p>

<p>
When a single write operation (e.g. db.collection.updateMany()) modifies multiple documents, <br>
the modification of each document is atomic, but the operation <b>as a whole is not atomic.</b>
</p>

<pre class="example">
For many scenarios, modeling your data appropriately will minimize the need for multi-document transactions.
</pre>
</div>
</div>

<div id="outline-container-org18d5947" class="outline-3">
<h3 id="org18d5947"><span class="section-number-3">1.5</span> 并发控制</h3>
<div class="outline-text-3" id="text-1-5">
<p>
Concurrency control allows multiple applications to run concurrently without causing data inconsistency or conflicts.
</p>

<ol class="org-ol">
<li>One approach is to create a <span class="underline">unique index</span>.</li>
<li>Another approach is to specify the expected current value of a field in the query predicate for the write operations. (乐观锁)</li>
</ol>
</div>
</div>



<div id="outline-container-org9a74ba7" class="outline-3">
<h3 id="org9a74ba7"><span class="section-number-3">1.6</span> <a href="https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/">Causal Consistency</a></h3>
<div class="outline-text-3" id="text-1-6">
<p>
Four causal consistency guarantees:
</p>

<ol class="org-ol">
<li>Read own writes</li>
<li>Monotonic reads</li>
<li>monotonic writes</li>
<li>Writes follow reads</li>
</ol>
</div>



<div id="outline-container-org02d9033" class="outline-4">
<h4 id="org02d9033"><span class="section-number-4">1.6.1</span> Network partition example</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
The read concern "majority" and write concern "majority" ensure that the four causal consistency guarantees hold even in network partition circumstances
where two members in a replica set transiently believe that they are the primary:
</p>

<img src="https://docs.mongodb.com/manual/_images/network-partition-two-primaries.svg"/>

<ul class="org-ul">
<li>Writes with "majority" write concern can complete on P<sub>new</sub> but cannot complete on P<sub>old</sub>.</li>
<li>Writes with <code>{ w: 1 }</code> write concern can complete on either P<sub>old</sub> or P<sub>new</sub>. <br>
However, the writes to P<sub>old</sub> (as well as the writes replicated to S<sub>1</sub>) <b>roll back once these members regain communication with the rest of the replica set</b>.</li>
<li>After a successful write with "majority" write concern on P<sub>new</sub>, causally consistent reads with "majority" read concern can observe the write on P<sub>new</sub>, S<sub>2</sub>, and S<sub>3</sub>. <br>
The reads can also observe the write on P<sub>old</sub> and S<sub>1</sub> <span class="underline">once they can communicate with the rest of the replica set and sync from the other members of the replica set</span>. <br>
Any writes made to P<sub>old</sub> and/or replicated to S<sub>1</sub> during the partition are rolled back.</li>
</ul>
</div>

<div id="outline-container-orgb07a389" class="outline-5">
<h5 id="orgb07a389"><span class="section-number-5">1.6.1.1</span> 场景分析</h5>
<div class="outline-text-5" id="text-1-6-1-1">
<ul class="org-ul">
<li><a href="https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/#causal-rc-majority-wc-majority">Read Concern "majority" and Write concern "majority"</a></li>
<li><a href="https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/#causal-rc-majority-wc-1">Read Concern "majority" and Write concern {w: 1}</a></li>
<li><a href="https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/#causal-rc-local-wc-majority">Read Concern "local" and Write concern "majority"</a></li>
<li><a href="https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/#causal-rc-local-wc-1">Read Concern "local" and Write concern {w: 1}</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>









<div id="outline-container-org91c393f" class="outline-2">
<h2 id="org91c393f"><span class="section-number-2">2</span> Replica Set</h2>
<div class="outline-text-2" id="text-2">
<p>
A replica set contains several <span class="underline">data bearing nodes</span> and optionally one <span class="underline">arbiter node</span> (only used to vote). <br>
Of the data bearing nodes, <b>one and only one member is deemed the primary node, while the other nodes are deemed secondary nodes.</b>
</p>

<p>
MongoDB applies write operations on the primary and then records the operations on the primary’s <span class="underline">oplog</span>. <br>
Secondary members <b>replicate this log</b> and apply the operations to their data sets.
</p>

<img src="https://docs.mongodb.com/manual/_images/replica-set-read-write-operations-primary.bakedsvg.svg"/>
</div>


<div id="outline-container-orgf10a7e1" class="outline-3">
<h3 id="orgf10a7e1"><span class="section-number-3">2.1</span> Automatic Failover</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>The replica set <b>cannot process write operations</b> until the election completes successfully.</li>

<li>The replica set can <b>continue to serve read queries</b> while the primary is offline.</li>

<li>Application connection logic should include tolerance for automatic failovers and the subsequent elections.</li>
</ul>
</div>
</div>


<div id="outline-container-org47cd747" class="outline-3">
<h3 id="org47cd747"><span class="section-number-3">2.2</span> 选举</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Replica sets can trigger an election in response to a variety of events, such as:
</p>

<ul class="org-ul">
<li>Adding a new node to the replica set.</li>
<li>Initiating a replica set.</li>
<li>Performing replica set maintenance using methods such as <code>rs.stepDown()</code> or <code>rs.reconfig()</code>.</li>
<li>Secondary members losing connectivity to the primary for more than the configured timeout (10 seconds by default).</li>
</ul>
</div>


<div id="outline-container-org4528767" class="outline-4">
<h4 id="org4528767"><span class="section-number-4">2.2.1</span> Member Priority</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
Secondaries with higher priority call elections relatively <b>sooner</b> than secondaries with lower priority, and are also <b>more likely to win</b>.
</p>

<p>
Members with a priority value of <code>0</code> cannot become primary and do not seek election.
</p>
</div>
</div>


<div id="outline-container-orge4154db" class="outline-4">
<h4 id="orge4154db"><span class="section-number-4">2.2.2</span> 网络分区</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
When the primary detects that it can only see a <b>minority</b> of nodes in the replica set, the primary steps down and <span class="underline">becomes a secondary</span>. <br>
A member in the partition that can communicate with a <b>majority</b> of the nodes (including itself) <span class="underline">holds an election to become the new primary</span>.
</p>
</div>
</div>
</div>



<div id="outline-container-org4873024" class="outline-3">
<h3 id="org4873024"><span class="section-number-3">2.3</span> Rollback</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>A rollback is necessary <b>only if</b> the primary had accepted write operations that the secondaries had not successfully replicated before the primary stepped down.</li>
<li>MongoDB attempts to avoid rollbacks.</li>
<li>A rollback does not occur if the write operations replicate to another member of the replica set before the primary steps down.</li>
<li>To prevent rollbacks of data that have been acknowledged to the client, run all voting members <b>with journaling enabled</b> and use <code>w: majority</code> write concern.</li>
</ul>
</div>
</div>

<div id="outline-container-org4a03178" class="outline-3">
<h3 id="org4a03178"><span class="section-number-3">2.4</span> <a href="https://docs.mongodb.com/manual/core/replica-set-write-concern/">Write Concern</a></h3>
<div class="outline-text-3" id="text-2-4">
<p>
Write concern for replica sets describe the <b>number</b> of data-bearing members that must acknowledge a write operation before the operation returns as successful. <br>
A member can only acknowledge a write operation after it has received and applied the write successfully.
</p>

<p>
For replica sets, the default write concern of <code>w: 1</code> requires that only the primary replica set member acknowledge the write before returning write concern acknowledgment.
</p>
</div>


<div id="outline-container-orgae98b86" class="outline-4">
<h4 id="orgae98b86"><span class="section-number-4">2.4.1</span> w: majority</h4>
<div class="outline-text-4" id="text-2-4-1">
<img src="https://docs.mongodb.com/manual/_images/crud-write-concern-w-majority.bakedsvg.svg"/>

<p>
With <code>writeConcernMajorityJournalDefault</code> set to false, MongoDB does not wait for <code>w: majority</code> writes to be written to the on-disk journal before acknowledging the writes. <br>
As such, majority write operations could possibly roll back in the event of a transient loss (e.g. crash and restart) of a majority of nodes in a given replica set.
</p>
</div>
</div>
</div>

<div id="outline-container-org143b3f2" class="outline-3">
<h3 id="org143b3f2"><span class="section-number-3">2.5</span> Read Preference</h3>
<div class="outline-text-3" id="text-2-5">
<p>
Read preference describes how MongoDB clients <b>route</b> read operations to the members of a replica set.
</p>

<pre class="example">
By default, an application directs its read operations to the primary member in a replica set.
</pre>

<img src="https://docs.mongodb.com/manual/_images/replica-set-read-preference.bakedsvg.svg"/>
</div>
</div>
</div>


<div id="outline-container-org596f410" class="outline-2">
<h2 id="org596f410"><span class="section-number-2">3</span> Sharding</h2>
<div class="outline-text-2" id="text-3">
<p>
MongoDB uses sharding to support deployments with <span class="underline">very large data sets</span> and <span class="underline">high throughput operations</span>.
</p>

<p>
MongoDB shards data at the collection level, distributing the collection data across the shards in the cluster.
</p>
</div>

<div id="outline-container-orgbd9ce6e" class="outline-3">
<h3 id="orgbd9ce6e"><span class="section-number-3">3.1</span> Components</h3>
<div class="outline-text-3" id="text-3-1">
<img src="https://docs.mongodb.com/manual/_images/sharded-cluster-production-architecture.bakedsvg.svg"/>

<pre class="example">
Production Configuration:
  - Deploy Config Servers as a 3 member replica set
  - Deploy *each Shard* as a 3 member replica set
  - Deploy one or more mongos routers
</pre>
</div>


<div id="outline-container-org0dae790" class="outline-4">
<h4 id="org0dae790"><span class="section-number-4">3.1.1</span> Shard</h4>
<div class="outline-text-4" id="text-3-1-1">
<ul class="org-ul">
<li>A shard contains a <b>subset</b> of sharded data for a sharded cluster.</li>
<li>Performing queries on a single shard only returns a subset of data. <br>
Connect to the mongos to perform cluster level operations, including read or write operations.</li>
</ul>
</div>
</div>

<div id="outline-container-org33f89a4" class="outline-4">
<h4 id="org33f89a4"><span class="section-number-4">3.1.2</span> Config Servers</h4>
<div class="outline-text-4" id="text-3-1-2">
<ul class="org-ul">
<li>Config servers store <b>metadata</b> and configuration settings for the cluster.</li>
<li>Users should avoid writing directly to the config database in the course of normal operation or maintenance.</li>
<li>If the config server replica set loses its primary and cannot elect a primary, the cluster's metadata becomes <b>read only</b>. <br>
You can still read and write data from the shards, but no chunk migration or chunk splits will occur <br>
until the replica set can elect a primary.</li>
</ul>
</div>
</div>

<div id="outline-container-org16c4511" class="outline-4">
<h4 id="org16c4511"><span class="section-number-4">3.1.3</span> mongos</h4>
<div class="outline-text-4" id="text-3-1-3">
<ul class="org-ul">
<li><code>mongos</code> acts as a query <b>router</b>, providing an interface between client applications and the sharded cluster.</li>
<li><code>mongos</code> provide the only interface to a sharded cluster from the perspective of applications.</li>
<li><code>mongos</code> tracks what data is on which shard by caching the metadata from the config servers.</li>
<li><code>mongos</code> has no persistent state and consumes minimal system resources.</li>
</ul>

<pre class="example">
mongos can route queries that include the shard key or the prefix of a compound shard key a specific shard or set of shards.
mongos uses the shard key value to locate the chunk whose range includes the shard key value and
directs the query at the shard containing that chunk.
</pre>
</div>
</div>
</div>

<div id="outline-container-org5fc5291" class="outline-3">
<h3 id="org5fc5291"><span class="section-number-3">3.2</span> Shard Key</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>The shard key consists of an immutable field or fields that exist in every document in the target collection.</li>
<li>A sharded collection can have <b>only one</b> shard key.</li>
<li>To shard a non-empty collection, the collection must have an index that starts with the shard key.</li>
<li>If queries do not include the shard key or the prefix of a compound shard key, mongos performs a broadcast operation, <br>
querying all shards in the sharded cluster.</li>
</ul>
</div>

<div id="outline-container-org9b3279b" class="outline-4">
<h4 id="org9b3279b"><span class="section-number-4">3.2.1</span> Chunk</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
MongoDB <b>partitions</b> data in the collection using ranges of shard key values. <br>
Each range defines a non-overlapping range of shard key values and is associated with a chunk.
</p>

<p>
MongoDB attempts to distribute chunks evenly among the shards in the cluster. <br>
The shard key has a direct relationship to the effectiveness of chunk distribution.
</p>

<img src="https://docs.mongodb.com/manual/_images/sharding-range-based.bakedsvg.svg"/>
</div>
</div>
</div>


<div id="outline-container-org75efac2" class="outline-3">
<h3 id="org75efac2"><span class="section-number-3">3.3</span> Sharded Cluster</h3>
<div class="outline-text-3" id="text-3-3">
<p>
You must connect to a mongos router to interact with any collection in the sharded cluster.
This includes sharded and unsharded collections.
<b>Clients should never connect to a single shard in order to perform read or write operations.</b>
</p>

<img src="https://docs.mongodb.com/manual/_images/sharded-cluster-mixed.bakedsvg.svg"/>
</div>
</div>
</div>
</div>
</body>
</html>