#+TITLE:     crontab
#+AUTHOR:    Hao Ruan
#+EMAIL:     ruanhao1116@gmail.com
#+LANGUAGE:  en
#+LINK_HOME: http://www.github.com/ruanhao
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="../css/style.css" />
#+OPTIONS:   H:2 num:nil \n:nil @:t ::t |:t ^:{} _:{} *:t TeX:t LaTeX:t
#+STARTUP:   showall


* 基本原理

[[file:./images/cron-roles.png]]

#+BEGIN_EXAMPLE
  SHELL=/bin/bash
  PATH=/sbin:/bin:/usr/sbin:/usr/bin
  MAILTO=root
  HOME=/  # home path
  # For details see man 4 crontabs
  # Example of job definition:
  # .---------------- minute (0 - 59)
  # | .------------- hour (0 - 23)
  # | | .---------- day of month (1 - 31)
  # | | | .------- month (1 - 12) OR jan,feb,mar,apr ...
  # | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
  # | | | | |
  # * * * * * <user-name> <command to be executed>
#+END_EXAMPLE


** 特殊字符

- =*=

  代表所有的取值范围内的数字，如月份字段为 * ，则表示 1 到 12 个月

- =/=

  代表每一定时间间隔，如分钟字段为 =*/10= ，表示每 10 分钟执行 1 次

- =-=

  代表从某个区间范围，是闭区间。如 =2-5= 表示 =2,3,4,5= ，小时字段中 =0-23/2= 表示在 =0~23= 点范围内每 2 个小时执行一次

- =,=

  分散的数字（不一定连续），如 =1,2,3,4,7,9=

** 注意事项

crontab有 2 种编辑方式：直接编辑 =/etc/crontab= 文件与 =crontab –e= ，\\
其中 =/etc/crontab= 里的计划任务是系统中的计划任务，而用户的计划任务需要通过 =crontab –e= 来编辑。

每次编辑完某个用户的 cron 设置后，cron 自动在 =/var/spool/cron= 下生成一个与此用户同名的文件，
此用户的 cron 信息都记录在这个文件中，这个文件是不可以直接编辑的，只可以用 =crontab -e= 来编辑。

crontab 中的 command 尽量使用绝对路径，否则会经常因为路径错误导致任务无法执行。

新创建的 cron job 不会马上执行，至少要等2分钟才能执行，可从重起 cron 来立即执行。

=%= 在 crontab 文件中表示“换行”，因此假如脚本或命令含有 =%= ,需要使用 =\%= 来进行转义。



* 配置实例

- 每一分钟执行一次（因 cron 默认每 1 分钟扫描一次，因此全为 * 即可）

  =* * * * * command=

- 每小时的第 3 和第 15 分钟执行

  =3,15 * * * * command=

- 每天上午 8-11 点的第 3 和 15 分钟执行

  =3,15 8-11 * * * command=

- 每隔 2 天的上午 8-11 点的第 3 和 15 分钟执行

  =3,15 8-11 */2 * * command=

- 每个星期一的上午 8 点到 11 点的第 3 和第 15 分钟执行

  =3,15 8-11 * * 1 command=

- 每晚的 21:30 重启 smb

  =30 21 * * * /etc/init.d/smb restart=

- 每月 1, 10, 22 日的 4:45 重启 smb

  =45 4 1,10,22 * * /etc/init.d/smb restart=

- 每周六，周日的 1:10 重启 smb

  =10 1 * * 6,0 /etc/init.d/smb restart=

- 每天 18:00 至 23:00 之间每隔 30 分钟重启 smb

  =0,30 18-23 * * * /etc/init.d/smb restart=

- 每一小时重启 smb

  =* */1 * * * /etc/init.d/smb restart=

- 晚上 11 点到早上 7 点之间，每隔一小时重启 smb

  =* 23-7/1 * * * /etc/init.d/smb restart=

- 每月的 4 号与每周一到周三的 11 点重启 smb

  =0 11 4 * mon-wed /etc/init.d/smb restart=

- 每小时执行 =/etc/cron.hourly= 目录内的脚本

  =0 1 * * * root run-parts /etc/cron.hourly=
