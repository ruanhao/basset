<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2019-12-20 Fri 10:27 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ansible</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Hao Ruan">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link href="http://fonts.googleapis.com/css?family=Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet" type="text/css" />
<link href="../org-html-themes/solarized/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Ansible</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1717536">1. 工作架构与原理</a>
<ul>
<li><a href="#org9544672">1.1. 相关配置文件</a>
<ul>
<li><a href="#org5a792c1">1.1.1. 主配置文件 (<code>/etc/ansible/ansible.cfg</code>)</a></li>
<li><a href="#org4d3349e">1.1.2. 主机清单配置文件 (<code>/etc/ansible/hosts</code>)</a>
<ul>
<li><a href="#orge1fb0be">1.1.2.1. 对主机进行分组</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org238f6d9">1.2. 相关命令</a>
<ul>
<li><a href="#org82e9652">1.2.1. 临时命令执行工具 (<code>/usr/bin/ansible</code>)</a>
<ul>
<li><a href="#orge99c4cd">1.2.1.1. 执行过程</a></li>
<li><a href="#orgc20c884">1.2.1.2. 执行状态</a></li>
<li><a href="#org30230f8">1.2.1.3. 显示所有主机</a></li>
</ul>
</li>
<li><a href="#orgbc95f40">1.2.2. 模块查看工具 (<code>/usr/bin/ansible-doc</code>)</a>
<ul>
<li><a href="#orgdae9158">1.2.2.1. 显示所有模块</a></li>
<li><a href="#org187692d">1.2.2.2. 查看模块用法</a></li>
</ul>
</li>
<li><a href="#orga59dfdc">1.2.3. 模块下载工具 (<code>/usr/bin/ansible-galaxy</code>)</a></li>
<li><a href="#orgcce5bab">1.2.4. 编排剧本工具 (<code>/usr/bin/ansible-playbook</code>)</a></li>
<li><a href="#orgb521f12">1.2.5. 文件加密工具 (<code>/usr/bin/ansible-vault</code>)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org72f6ab4">2. 模块 (Module)</a>
<ul>
<li><a href="#orgac0af5a">2.1. 远程执行</a>
<ul>
<li><a href="#org8c67e42">2.1.1. command (默认模块)</a></li>
<li><a href="#orgc77ef4c">2.1.2. shell</a></li>
<li><a href="#orga416e34">2.1.3. script</a></li>
</ul>
</li>
<li><a href="#orga101516">2.2. 文件管理</a>
<ul>
<li><a href="#org587819a">2.2.1. copy</a></li>
<li><a href="#org424975b">2.2.2. fetch</a></li>
<li><a href="#org98f841a">2.2.3. file</a></li>
<li><a href="#org1caa2e4">2.2.4. synchronize</a></li>
<li><a href="#org59fbc4a">2.2.5. get_url</a></li>
</ul>
</li>
<li><a href="#orgb60096d">2.3. 网络管理</a>
<ul>
<li><a href="#orgb0de75f">2.3.1. ping</a></li>
</ul>
</li>
<li><a href="#orge71c006">2.4. 服务管理</a>
<ul>
<li><a href="#orga3ab2e0">2.4.1. service</a></li>
<li><a href="#org5beabfc">2.4.2. cron</a></li>
</ul>
</li>
<li><a href="#org148b4b9">2.5. 用户（组）管理</a>
<ul>
<li><a href="#org3a25008">2.5.1. user</a></li>
<li><a href="#org363d527">2.5.2. group</a></li>
</ul>
</li>
<li><a href="#orgb4342dc">2.6. 主机信息</a>
<ul>
<li><a href="#org984c87f">2.6.1. setup</a></li>
</ul>
</li>
<li><a href="#orgbf98be2">2.7. 主要用于 Playbook 的模块</a>
<ul>
<li><a href="#org99fa183">2.7.1. pause</a></li>
<li><a href="#org1aa954e">2.7.2. wait_for</a></li>
<li><a href="#orgeac7d9d">2.7.3. add_host</a></li>
<li><a href="#org24d5036">2.7.4. group_by</a></li>
<li><a href="#orgfb94a3c">2.7.5. debug</a></li>
<li><a href="#org5698e05">2.7.6. fail</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga4f4cb7">3. Playbook</a>
<ul>
<li><a href="#org73b4729">3.1. Variable</a>
<ul>
<li><a href="#orgcd87161">3.1.1. 在 Inventory 中定义变量</a></li>
<li><a href="#orgd0ab7c7">3.1.2. 在 Playbook 中定义变量</a>
<ul>
<li><a href="#org772becd">3.1.2.1. vars, vars_files 关键字</a></li>
<li><a href="#orgd028672">3.1.2.2. vars_prompt 实现人机交互</a></li>
<li><a href="#org4608cf7">3.1.2.3. 通过 roles 带入变量</a></li>
</ul>
</li>
<li><a href="#org533e5e9">3.1.3. 注册变量</a></li>
<li><a href="#org1993a28">3.1.4. 通过 fact 获取/设置变量</a></li>
<li><a href="#org0a2aa4d">3.1.5. 内置变量</a>
<ul>
<li><a href="#org1670064">3.1.5.1. hostvars</a></li>
<li><a href="#orgb0acf16">3.1.5.2. inventory_hostname</a></li>
<li><a href="#org5d2b237">3.1.5.3. inventory_hostname_short</a></li>
<li><a href="#org0dc6f73">3.1.5.4. group_names</a></li>
<li><a href="#org06f9d7b">3.1.5.5. groups</a></li>
<li><a href="#org6c8a199">3.1.5.6. play_hosts</a></li>
<li><a href="#org5710f2f">3.1.5.7. ansible_version</a></li>
<li><a href="#orgac8e5c9">3.1.5.8. inventory_dir</a></li>
<li><a href="#org083457b">3.1.5.9. inventory_file</a></li>
</ul>
</li>
<li><a href="#orge38dcf5">3.1.6. 通过命令行设置变量</a></li>
</ul>
</li>
<li><a href="#org3e89ad2">3.2. Tasks</a></li>
<li><a href="#orgec4b1b6">3.3. Handlers</a></li>
<li><a href="#org9f2bacf">3.4. Template</a></li>
<li><a href="#org51aeea3">3.5. When</a>
<ul>
<li><a href="#orgfa9c442">3.5.1. 变量不存在</a></li>
<li><a href="#orgc8ecc2c">3.5.2. 用于循环</a></li>
<li><a href="#org5cafb5c">3.5.3. 用于 include</a></li>
<li><a href="#org9ca9083">3.5.4. 用于 roles</a></li>
</ul>
</li>
<li><a href="#org4459237">3.6. 循环</a>
<ul>
<li><a href="#org1eb9795">3.6.1. with_items</a></li>
<li><a href="#org61b60ea">3.6.2. with_nested</a></li>
<li><a href="#org24ae568">3.6.3. with_dict</a></li>
<li><a href="#orge408bf8">3.6.4. with_subelement</a></li>
<li><a href="#orgdf0e200">3.6.5. with_sequence</a></li>
<li><a href="#org4733e6b">3.6.6. with_random_choice</a></li>
<li><a href="#org9b8be23">3.6.7. do_util</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc824413">4. Role</a>
<ul>
<li><a href="#org5e0f7e2">4.1. 创建</a>
<ul>
<li><a href="#org135d432">4.1.1. roles 各目录的作用</a></li>
</ul>
</li>
<li><a href="#org1ce6760">4.2. pre_tasks 和 post_tasks</a></li>
<li><a href="#orgf77d0f6">4.3. 依赖</a></li>
<li><a href="#orgee23451">4.4. 项目结构</a>
<ul>
<li><a href="#org0b8648e">4.4.1. 入口文件 (site.xml)</a></li>
<li><a href="#org530f0f5">4.4.2. 执行</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="meta">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Author</td>
<td class="org-left">Hao Ruan (ruanhao1116@gmail.com)</td>
</tr>

<tr>
<td class="org-left">Date</td>
<td class="org-left">2019-12-20 10:27:37</td>
</tr>
</tbody>
</table>

<pre class="example">
<p>
Ansible is used to:
  -&gt; execute <i>tasks</i> for an <i>inventory</i>,
  -&gt; utilizing some <i>modules</i>,
  -&gt; using or populating some <i>variables</i>,
  -&gt; processing some file <i>templates</i>,
  -&gt; in a <i>playbook</i>, which can be organized in <i>roles</i>.
</p>
</pre>

</div>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1717536">1. 工作架构与原理</a>
<ul>
<li><a href="#org9544672">1.1. 相关配置文件</a>
<ul>
<li><a href="#org5a792c1">1.1.1. 主配置文件 (<code>/etc/ansible/ansible.cfg</code>)</a></li>
<li><a href="#org4d3349e">1.1.2. 主机清单配置文件 (<code>/etc/ansible/hosts</code>)</a>
<ul>
<li><a href="#orge1fb0be">1.1.2.1. 对主机进行分组</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org238f6d9">1.2. 相关命令</a>
<ul>
<li><a href="#org82e9652">1.2.1. 临时命令执行工具 (<code>/usr/bin/ansible</code>)</a>
<ul>
<li><a href="#orge99c4cd">1.2.1.1. 执行过程</a></li>
<li><a href="#orgc20c884">1.2.1.2. 执行状态</a></li>
<li><a href="#org30230f8">1.2.1.3. 显示所有主机</a></li>
</ul>
</li>
<li><a href="#orgbc95f40">1.2.2. 模块查看工具 (<code>/usr/bin/ansible-doc</code>)</a>
<ul>
<li><a href="#orgdae9158">1.2.2.1. 显示所有模块</a></li>
<li><a href="#org187692d">1.2.2.2. 查看模块用法</a></li>
</ul>
</li>
<li><a href="#orga59dfdc">1.2.3. 模块下载工具 (<code>/usr/bin/ansible-galaxy</code>)</a></li>
<li><a href="#orgcce5bab">1.2.4. 编排剧本工具 (<code>/usr/bin/ansible-playbook</code>)</a></li>
<li><a href="#orgb521f12">1.2.5. 文件加密工具 (<code>/usr/bin/ansible-vault</code>)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org72f6ab4">2. 模块 (Module)</a>
<ul>
<li><a href="#orgac0af5a">2.1. 远程执行</a>
<ul>
<li><a href="#org8c67e42">2.1.1. command (默认模块)</a></li>
<li><a href="#orgc77ef4c">2.1.2. shell</a></li>
<li><a href="#orga416e34">2.1.3. script</a></li>
</ul>
</li>
<li><a href="#orga101516">2.2. 文件管理</a>
<ul>
<li><a href="#org587819a">2.2.1. copy</a></li>
<li><a href="#org424975b">2.2.2. fetch</a></li>
<li><a href="#org98f841a">2.2.3. file</a></li>
<li><a href="#org1caa2e4">2.2.4. synchronize</a></li>
<li><a href="#org59fbc4a">2.2.5. get_url</a></li>
</ul>
</li>
<li><a href="#orgb60096d">2.3. 网络管理</a>
<ul>
<li><a href="#orgb0de75f">2.3.1. ping</a></li>
</ul>
</li>
<li><a href="#orge71c006">2.4. 服务管理</a>
<ul>
<li><a href="#orga3ab2e0">2.4.1. service</a></li>
<li><a href="#org5beabfc">2.4.2. cron</a></li>
</ul>
</li>
<li><a href="#org148b4b9">2.5. 用户（组）管理</a>
<ul>
<li><a href="#org3a25008">2.5.1. user</a></li>
<li><a href="#org363d527">2.5.2. group</a></li>
</ul>
</li>
<li><a href="#orgb4342dc">2.6. 主机信息</a>
<ul>
<li><a href="#org984c87f">2.6.1. setup</a></li>
</ul>
</li>
<li><a href="#orgbf98be2">2.7. 主要用于 Playbook 的模块</a>
<ul>
<li><a href="#org99fa183">2.7.1. pause</a></li>
<li><a href="#org1aa954e">2.7.2. wait_for</a></li>
<li><a href="#orgeac7d9d">2.7.3. add_host</a></li>
<li><a href="#org24d5036">2.7.4. group_by</a></li>
<li><a href="#orgfb94a3c">2.7.5. debug</a></li>
<li><a href="#org5698e05">2.7.6. fail</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga4f4cb7">3. Playbook</a>
<ul>
<li><a href="#org73b4729">3.1. Variable</a>
<ul>
<li><a href="#orgcd87161">3.1.1. 在 Inventory 中定义变量</a></li>
<li><a href="#orgd0ab7c7">3.1.2. 在 Playbook 中定义变量</a>
<ul>
<li><a href="#org772becd">3.1.2.1. vars, vars_files 关键字</a></li>
<li><a href="#orgd028672">3.1.2.2. vars_prompt 实现人机交互</a></li>
<li><a href="#org4608cf7">3.1.2.3. 通过 roles 带入变量</a></li>
</ul>
</li>
<li><a href="#org533e5e9">3.1.3. 注册变量</a></li>
<li><a href="#org1993a28">3.1.4. 通过 fact 获取/设置变量</a></li>
<li><a href="#org0a2aa4d">3.1.5. 内置变量</a>
<ul>
<li><a href="#org1670064">3.1.5.1. hostvars</a></li>
<li><a href="#orgb0acf16">3.1.5.2. inventory_hostname</a></li>
<li><a href="#org5d2b237">3.1.5.3. inventory_hostname_short</a></li>
<li><a href="#org0dc6f73">3.1.5.4. group_names</a></li>
<li><a href="#org06f9d7b">3.1.5.5. groups</a></li>
<li><a href="#org6c8a199">3.1.5.6. play_hosts</a></li>
<li><a href="#org5710f2f">3.1.5.7. ansible_version</a></li>
<li><a href="#orgac8e5c9">3.1.5.8. inventory_dir</a></li>
<li><a href="#org083457b">3.1.5.9. inventory_file</a></li>
</ul>
</li>
<li><a href="#orge38dcf5">3.1.6. 通过命令行设置变量</a></li>
</ul>
</li>
<li><a href="#org3e89ad2">3.2. Tasks</a></li>
<li><a href="#orgec4b1b6">3.3. Handlers</a></li>
<li><a href="#org9f2bacf">3.4. Template</a></li>
<li><a href="#org51aeea3">3.5. When</a>
<ul>
<li><a href="#orgfa9c442">3.5.1. 变量不存在</a></li>
<li><a href="#orgc8ecc2c">3.5.2. 用于循环</a></li>
<li><a href="#org5cafb5c">3.5.3. 用于 include</a></li>
<li><a href="#org9ca9083">3.5.4. 用于 roles</a></li>
</ul>
</li>
<li><a href="#org4459237">3.6. 循环</a>
<ul>
<li><a href="#org1eb9795">3.6.1. with_items</a></li>
<li><a href="#org61b60ea">3.6.2. with_nested</a></li>
<li><a href="#org24ae568">3.6.3. with_dict</a></li>
<li><a href="#orge408bf8">3.6.4. with_subelement</a></li>
<li><a href="#orgdf0e200">3.6.5. with_sequence</a></li>
<li><a href="#org4733e6b">3.6.6. with_random_choice</a></li>
<li><a href="#org9b8be23">3.6.7. do_util</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc824413">4. Role</a>
<ul>
<li><a href="#org5e0f7e2">4.1. 创建</a>
<ul>
<li><a href="#org135d432">4.1.1. roles 各目录的作用</a></li>
</ul>
</li>
<li><a href="#org1ce6760">4.2. pre_tasks 和 post_tasks</a></li>
<li><a href="#orgf77d0f6">4.3. 依赖</a></li>
<li><a href="#orgee23451">4.4. 项目结构</a>
<ul>
<li><a href="#org0b8648e">4.4.1. 入口文件 (site.xml)</a></li>
<li><a href="#org530f0f5">4.4.2. 执行</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org1717536" class="outline-2">
<h2 id="org1717536"><span class="section-number-2">1</span> 工作架构与原理</h2>
<div class="outline-text-2" id="text-1">
<img src="https://qiankunli.github.io/public/upload/tool/ansible_framework.png"/>
</div>

<div id="outline-container-org9544672" class="outline-3">
<h3 id="org9544672"><span class="section-number-3">1.1</span> 相关配置文件</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org5a792c1" class="outline-4">
<h4 id="org5a792c1"><span class="section-number-4">1.1.1</span> 主配置文件 (<code>/etc/ansible/ansible.cfg</code>)</h4>
<div class="outline-text-4" id="text-1-1-1">
<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #465457;"># </span><span style="color: #465457;">config file for ansible -- https://ansible.com/</span>
<span style="color: #465457;"># </span><span style="color: #465457;">===============================================</span>

<span style="color: #465457;"># </span><span style="color: #465457;">nearly all parameters can be overridden in ansible-playbook</span>
<span style="color: #465457;"># </span><span style="color: #465457;">or with command line flags. ansible will read ANSIBLE_CONFIG,</span>
<span style="color: #465457;"># </span><span style="color: #465457;">ansible.cfg in the current working directory, .ansible.cfg in</span>
<span style="color: #465457;"># </span><span style="color: #465457;">the home directory or /etc/ansible/ansible.cfg, whichever it</span>
<span style="color: #465457;"># </span><span style="color: #465457;">finds first</span>

[defaults]

<span style="color: #465457;"># </span><span style="color: #465457;">some basic default values...</span>

<span style="color: #465457;">#</span><span style="color: #465457;">inventory      = /etc/ansible/hosts</span>
<span style="color: #465457;">#</span><span style="color: #465457;">library        = /usr/share/my_modules/</span>
<span style="color: #465457;">#</span><span style="color: #465457;">module_utils   = /usr/share/my_module_utils/</span>
<span style="color: #465457;">#</span><span style="color: #465457;">remote_tmp     = ~/.ansible/tmp</span>
<span style="color: #465457;">#</span><span style="color: #465457;">local_tmp      = ~/.ansible/tmp</span>
<span style="color: #465457;">#</span><span style="color: #465457;">plugin_filters_cfg = /etc/ansible/plugin_filters.yml</span>
<span style="color: #465457;">#</span><span style="color: #465457;">forks          = 5</span>
<span style="color: #465457;">#</span><span style="color: #465457;">poll_interval  = 15</span>
<span style="color: #465457;">#</span><span style="color: #465457;">sudo_user      = root</span>
<span style="color: #465457;">#</span><span style="color: #465457;">ask_sudo_pass = True</span>
<span style="color: #465457;">#</span><span style="color: #465457;">ask_pass      = True</span>
<span style="color: #465457;">#</span><span style="color: #465457;">transport      = smart</span>
<span style="color: #465457;">#</span><span style="color: #465457;">remote_port    = 22</span>
<span style="color: #465457;">#</span><span style="color: #465457;">module_lang    = C</span>
<span style="color: #465457;">#</span><span style="color: #465457;">module_set_locale = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">plays will gather facts by default, which contain information about</span>
<span style="color: #465457;"># </span><span style="color: #465457;">the remote system.</span>
<span style="color: #465457;">#</span>
<span style="color: #465457;"># </span><span style="color: #465457;">smart - gather by default, but don't regather if already gathered</span>
<span style="color: #465457;"># </span><span style="color: #465457;">implicit - gather by default, turn off with gather_facts: False</span>
<span style="color: #465457;"># </span><span style="color: #465457;">explicit - do not gather by default, must say gather_facts: True</span>
<span style="color: #465457;">#</span><span style="color: #465457;">gathering = implicit</span>

<span style="color: #465457;"># </span><span style="color: #465457;">This only affects the gathering done by a play's gather_facts directive,</span>
<span style="color: #465457;"># </span><span style="color: #465457;">by default gathering retrieves all facts subsets</span>
<span style="color: #465457;"># </span><span style="color: #465457;">all - gather all subsets</span>
<span style="color: #465457;"># </span><span style="color: #465457;">network - gather min and network facts</span>
<span style="color: #465457;"># </span><span style="color: #465457;">hardware - gather hardware facts (longest facts to retrieve)</span>
<span style="color: #465457;"># </span><span style="color: #465457;">virtual - gather min and virtual facts</span>
<span style="color: #465457;"># </span><span style="color: #465457;">facter - import facts from facter</span>
<span style="color: #465457;"># </span><span style="color: #465457;">ohai - import facts from ohai</span>
<span style="color: #465457;"># </span><span style="color: #465457;">You can combine them using comma (ex: network,virtual)</span>
<span style="color: #465457;"># </span><span style="color: #465457;">You can negate them using ! (ex: !hardware,!facter,!ohai)</span>
<span style="color: #465457;"># </span><span style="color: #465457;">A minimal set of facts is always gathered.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">gather_subset = all</span>

<span style="color: #465457;"># </span><span style="color: #465457;">some hardware related facts are collected</span>
<span style="color: #465457;"># </span><span style="color: #465457;">with a maximum timeout of 10 seconds. This</span>
<span style="color: #465457;"># </span><span style="color: #465457;">option lets you increase or decrease that</span>
<span style="color: #465457;"># </span><span style="color: #465457;">timeout to something more suitable for the</span>
<span style="color: #465457;"># </span><span style="color: #465457;">environment.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">gather_timeout = 10</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Ansible facts are available inside the ansible_facts.* dictionary</span>
<span style="color: #465457;"># </span><span style="color: #465457;">namespace. This setting maintains the behaviour which was the default prior</span>
<span style="color: #465457;"># </span><span style="color: #465457;">to 2.5, duplicating these variables into the main namespace, each with a</span>
<span style="color: #465457;"># </span><span style="color: #465457;">prefix of 'ansible_'.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">This variable is set to True by default for backwards compatibility. It</span>
<span style="color: #465457;"># </span><span style="color: #465457;">will be changed to a default of 'False' in a future release.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">ansible_facts.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">inject_facts_as_vars = True</span>

<span style="color: #465457;"># </span><span style="color: #465457;">additional paths to search for roles in, colon separated</span>
<span style="color: #465457;">#</span><span style="color: #465457;">roles_path    = /etc/ansible/roles</span>

<span style="color: #465457;"># </span><span style="color: #465457;">uncomment this to disable SSH key host checking</span>
host_key_checking = False <span style="color: #465457;"># </span><span style="color: #465457;">&#26816;&#26597;&#23545;&#24212;&#26381;&#21153;&#22120;&#30340; host_key &#65292;&#24314;&#35758;&#21462;&#28040;&#27880;&#37322;</span>

<span style="color: #465457;"># </span><span style="color: #465457;">change the default callback, you can only have one 'stdout' type  enabled at a time.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">stdout_callback = skippy</span>


<span style="color: #465457;">## </span><span style="color: #465457;">Ansible ships with some plugins that require whitelisting,</span>
<span style="color: #465457;">## </span><span style="color: #465457;">this is done to avoid running all of a type by default.</span>
<span style="color: #465457;">## </span><span style="color: #465457;">These setting lists those that you want enabled for your system.</span>
<span style="color: #465457;">## </span><span style="color: #465457;">Custom plugins should not need this unless plugin author specifies it.</span>

<span style="color: #465457;"># </span><span style="color: #465457;">enable callback plugins, they can output to stdout but cannot be 'stdout' type.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">callback_whitelist = timer, mail</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Determine whether includes in tasks and handlers are "static" by</span>
<span style="color: #465457;"># </span><span style="color: #465457;">default. As of 2.0, includes are dynamic by default. Setting these</span>
<span style="color: #465457;"># </span><span style="color: #465457;">values to True will make includes behave more like they did in the</span>
<span style="color: #465457;"># </span><span style="color: #465457;">1.x versions.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">task_includes_static = False</span>
<span style="color: #465457;">#</span><span style="color: #465457;">handler_includes_static = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Controls if a missing handler for a notification event is an error or a warning</span>
<span style="color: #465457;">#</span><span style="color: #465457;">error_on_missing_handler = True</span>

<span style="color: #465457;"># </span><span style="color: #465457;">change this for alternative sudo implementations</span>
<span style="color: #465457;">#</span><span style="color: #465457;">sudo_exe = sudo</span>

<span style="color: #465457;"># </span><span style="color: #465457;">What flags to pass to sudo</span>
<span style="color: #465457;"># </span><span style="color: #465457;">WARNING: leaving out the defaults might create unexpected behaviours</span>
<span style="color: #465457;">#</span><span style="color: #465457;">sudo_flags = -H -S -n</span>

<span style="color: #465457;"># </span><span style="color: #465457;">SSH timeout</span>
<span style="color: #465457;">#</span><span style="color: #465457;">timeout = 10</span>

<span style="color: #465457;"># </span><span style="color: #465457;">default user to use for playbooks if user is not specified</span>
<span style="color: #465457;"># </span><span style="color: #465457;">(/usr/bin/ansible will use current user as default)</span>
<span style="color: #465457;">#</span><span style="color: #465457;">remote_user = root</span>

<span style="color: #465457;"># </span><span style="color: #465457;">logging is off by default unless this path is defined</span>
<span style="color: #465457;"># </span><span style="color: #465457;">if so defined, consider logrotate</span>
log_path = /var/log/ansible.log <span style="color: #465457;"># </span><span style="color: #465457;">&#26085;&#24535;&#25991;&#20214;&#20301;&#32622;</span>

<span style="color: #465457;"># </span><span style="color: #465457;">default module name for /usr/bin/ansible</span>
<span style="color: #465457;">#</span><span style="color: #465457;">module_name = command</span>

<span style="color: #465457;"># </span><span style="color: #465457;">use this shell for commands executed under sudo</span>
<span style="color: #465457;"># </span><span style="color: #465457;">you may need to change this to bin/bash in rare instances</span>
<span style="color: #465457;"># </span><span style="color: #465457;">if sudo is constrained</span>
<span style="color: #465457;">#</span><span style="color: #465457;">executable = /bin/sh</span>

<span style="color: #465457;"># </span><span style="color: #465457;">if inventory variables overlap, does the higher precedence one win</span>
<span style="color: #465457;"># </span><span style="color: #465457;">or are hash values merged together?  The default is 'replace' but</span>
<span style="color: #465457;"># </span><span style="color: #465457;">this can also be set to 'merge'.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">hash_behaviour = replace</span>

<span style="color: #465457;"># </span><span style="color: #465457;">by default, variables from roles will be visible in the global variable</span>
<span style="color: #465457;"># </span><span style="color: #465457;">scope. To prevent this, the following option can be enabled, and only</span>
<span style="color: #465457;"># </span><span style="color: #465457;">tasks and handlers within the role will see the variables there</span>
<span style="color: #465457;">#</span><span style="color: #465457;">private_role_vars = yes</span>

<span style="color: #465457;"># </span><span style="color: #465457;">list any Jinja2 extensions to enable here:</span>
<span style="color: #465457;">#</span><span style="color: #465457;">jinja2_extensions = jinja2.ext.do,jinja2.ext.i18n</span>

<span style="color: #465457;"># </span><span style="color: #465457;">if set, always use this private key file for authentication, same as</span>
<span style="color: #465457;"># </span><span style="color: #465457;">if passing --private-key to ansible or ansible-playbook</span>
<span style="color: #465457;">#</span><span style="color: #465457;">private_key_file = /path/to/file</span>

<span style="color: #465457;"># </span><span style="color: #465457;">If set, configures the path to the Vault password file as an alternative to</span>
<span style="color: #465457;"># </span><span style="color: #465457;">specifying --vault-password-file on the command line.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">vault_password_file = /path/to/vault_password_file</span>

<span style="color: #465457;"># </span><span style="color: #465457;">format of string {{ ansible_managed }} available within Jinja2</span>
<span style="color: #465457;"># </span><span style="color: #465457;">templates indicates to users editing templates files will be replaced.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">replacing {file}, {host} and {uid} and strftime codes with proper values.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">ansible_managed = Ansible managed: {file} modified on %Y-%m-%d %H:%M:%S by {uid} on {host}</span>
<span style="color: #465457;"># </span><span style="color: #465457;">{file}, {host}, {uid}, and the timestamp can all interfere with idempotence</span>
<span style="color: #465457;"># </span><span style="color: #465457;">in some situations so the default is a static string:</span>
<span style="color: #465457;">#</span><span style="color: #465457;">ansible_managed = Ansible managed</span>

<span style="color: #465457;"># </span><span style="color: #465457;">by default, ansible-playbook will display "Skipping [host]" if it determines a task</span>
<span style="color: #465457;"># </span><span style="color: #465457;">should not be run on a host.  Set this to "False" if you don't want to see these "Skipping"</span>
<span style="color: #465457;"># </span><span style="color: #465457;">messages. NOTE: the task header will still be shown regardless of whether or not the</span>
<span style="color: #465457;"># </span><span style="color: #465457;">task is skipped.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">display_skipped_hosts = True</span>

<span style="color: #465457;"># </span><span style="color: #465457;">by default, if a task in a playbook does not include a name: field then</span>
<span style="color: #465457;"># </span><span style="color: #465457;">ansible-playbook will construct a header that includes the task's action but</span>
<span style="color: #465457;"># </span><span style="color: #465457;">not the task's args.  This is a security feature because ansible cannot know</span>
<span style="color: #465457;"># </span><span style="color: #465457;">if the *module* considers an argument to be no_log at the time that the</span>
<span style="color: #465457;"># </span><span style="color: #465457;">header is printed.  If your environment doesn't have a problem securing</span>
<span style="color: #465457;"># </span><span style="color: #465457;">stdout from ansible-playbook (or you have manually specified no_log in your</span>
<span style="color: #465457;"># </span><span style="color: #465457;">playbook on all of the tasks where you have secret information) then you can</span>
<span style="color: #465457;"># </span><span style="color: #465457;">safely set this to True to get more informative messages.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">display_args_to_stdout = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">by default (as of 1.3), Ansible will raise errors when attempting to dereference</span>
<span style="color: #465457;"># </span><span style="color: #465457;">Jinja2 variables that are not set in templates or action lines. Uncomment this line</span>
<span style="color: #465457;"># </span><span style="color: #465457;">to revert the behavior to pre-1.3.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">error_on_undefined_vars = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">by default (as of 1.6), Ansible may display warnings based on the configuration of the</span>
<span style="color: #465457;"># </span><span style="color: #465457;">system running ansible itself. This may include warnings about 3rd party packages or</span>
<span style="color: #465457;"># </span><span style="color: #465457;">other conditions that should be resolved if possible.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">to disable these warnings, set the following value to False:</span>
<span style="color: #465457;">#</span><span style="color: #465457;">system_warnings = True</span>

<span style="color: #465457;"># </span><span style="color: #465457;">by default (as of 1.4), Ansible may display deprecation warnings for language</span>
<span style="color: #465457;"># </span><span style="color: #465457;">features that should no longer be used and will be removed in future versions.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">to disable these warnings, set the following value to False:</span>
<span style="color: #465457;">#</span><span style="color: #465457;">deprecation_warnings = True</span>

<span style="color: #465457;"># </span><span style="color: #465457;">(as of 1.8), Ansible can optionally warn when usage of the shell and</span>
<span style="color: #465457;"># </span><span style="color: #465457;">command module appear to be simplified by using a default Ansible module</span>
<span style="color: #465457;"># </span><span style="color: #465457;">instead.  These warnings can be silenced by adjusting the following</span>
<span style="color: #465457;"># </span><span style="color: #465457;">setting or adding warn=yes or warn=no to the end of the command line</span>
<span style="color: #465457;"># </span><span style="color: #465457;">parameter string.  This will for example suggest using the git module</span>
<span style="color: #465457;"># </span><span style="color: #465457;">instead of shelling out to the git command.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">command_warnings = False</span>


<span style="color: #465457;"># </span><span style="color: #465457;">set plugin path directories here, separate with colons</span>
<span style="color: #465457;">#</span><span style="color: #465457;">action_plugins     = /usr/share/ansible/plugins/action</span>
<span style="color: #465457;">#</span><span style="color: #465457;">become_plugins     = /usr/share/ansible/plugins/become</span>
<span style="color: #465457;">#</span><span style="color: #465457;">cache_plugins      = /usr/share/ansible/plugins/cache</span>
<span style="color: #465457;">#</span><span style="color: #465457;">callback_plugins   = /usr/share/ansible/plugins/callback</span>
<span style="color: #465457;">#</span><span style="color: #465457;">connection_plugins = /usr/share/ansible/plugins/connection</span>
<span style="color: #465457;">#</span><span style="color: #465457;">lookup_plugins     = /usr/share/ansible/plugins/lookup</span>
<span style="color: #465457;">#</span><span style="color: #465457;">inventory_plugins  = /usr/share/ansible/plugins/inventory</span>
<span style="color: #465457;">#</span><span style="color: #465457;">vars_plugins       = /usr/share/ansible/plugins/vars</span>
<span style="color: #465457;">#</span><span style="color: #465457;">filter_plugins     = /usr/share/ansible/plugins/filter</span>
<span style="color: #465457;">#</span><span style="color: #465457;">test_plugins       = /usr/share/ansible/plugins/test</span>
<span style="color: #465457;">#</span><span style="color: #465457;">terminal_plugins   = /usr/share/ansible/plugins/terminal</span>
<span style="color: #465457;">#</span><span style="color: #465457;">strategy_plugins   = /usr/share/ansible/plugins/strategy</span>


<span style="color: #465457;"># </span><span style="color: #465457;">by default, ansible will use the 'linear' strategy but you may want to try</span>
<span style="color: #465457;"># </span><span style="color: #465457;">another one</span>
<span style="color: #465457;">#</span><span style="color: #465457;">strategy = free</span>

<span style="color: #465457;"># </span><span style="color: #465457;">by default callbacks are not loaded for /bin/ansible, enable this if you</span>
<span style="color: #465457;"># </span><span style="color: #465457;">want, for example, a notification or logging callback to also apply to</span>
<span style="color: #465457;"># </span><span style="color: #465457;">/bin/ansible runs</span>
<span style="color: #465457;">#</span><span style="color: #465457;">bin_ansible_callbacks = False</span>


<span style="color: #465457;"># </span><span style="color: #465457;">don't like cows?  that's unfortunate.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">set to 1 if you don't want cowsay support or export ANSIBLE_NOCOWS=1</span>
<span style="color: #465457;">#</span><span style="color: #465457;">nocows = 1</span>

<span style="color: #465457;"># </span><span style="color: #465457;">set which cowsay stencil you'd like to use by default. When set to 'random',</span>
<span style="color: #465457;"># </span><span style="color: #465457;">a random stencil will be selected for each task. The selection will be filtered</span>
<span style="color: #465457;"># </span><span style="color: #465457;">against the `cow_whitelist` option below.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">cow_selection = default</span>
<span style="color: #465457;">#</span><span style="color: #465457;">cow_selection = random</span>

<span style="color: #465457;"># </span><span style="color: #465457;">when using the 'random' option for cowsay, stencils will be restricted to this list.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">it should be formatted as a comma-separated list with no spaces between names.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">NOTE: line continuations here are for formatting purposes only, as the INI parser</span>
<span style="color: #465457;">#       </span><span style="color: #465457;">in python does not support them.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">cow_whitelist=bud-frogs,bunny,cheese,daemon,default,dragon,elephant-in-snake,elephant,eyes,\</span>
<span style="color: #465457;">#              </span><span style="color: #465457;">hellokitty,kitty,luke-koala,meow,milk,moofasa,moose,ren,sheep,small,stegosaurus,\</span>
<span style="color: #465457;">#              </span><span style="color: #465457;">stimpy,supermilker,three-eyes,turkey,turtle,tux,udder,vader-koala,vader,www</span>

<span style="color: #465457;"># </span><span style="color: #465457;">don't like colors either?</span>
<span style="color: #465457;"># </span><span style="color: #465457;">set to 1 if you don't want colors, or export ANSIBLE_NOCOLOR=1</span>
<span style="color: #465457;">#</span><span style="color: #465457;">nocolor = 1</span>

<span style="color: #465457;"># </span><span style="color: #465457;">if set to a persistent type (not 'memory', for example 'redis') fact values</span>
<span style="color: #465457;"># </span><span style="color: #465457;">from previous runs in Ansible will be stored.  This may be useful when</span>
<span style="color: #465457;"># </span><span style="color: #465457;">wanting to use, for example, IP information from one group of servers</span>
<span style="color: #465457;"># </span><span style="color: #465457;">without having to talk to them in the same playbook run to get their</span>
<span style="color: #465457;"># </span><span style="color: #465457;">current IP information.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">fact_caching = memory</span>

<span style="color: #465457;">#</span><span style="color: #465457;">This option tells Ansible where to cache facts. The value is plugin dependent.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">For the jsonfile plugin, it should be a path to a local directory.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">For the redis plugin, the value is a host:port:database triplet: fact_caching_connection = localhost:6379:0</span>

<span style="color: #465457;">#</span><span style="color: #465457;">fact_caching_connection=/tmp</span>



<span style="color: #465457;"># </span><span style="color: #465457;">retry files</span>
<span style="color: #465457;"># </span><span style="color: #465457;">When a playbook fails a .retry file can be created that will be placed in ~/</span>
<span style="color: #465457;"># </span><span style="color: #465457;">You can enable this feature by setting retry_files_enabled to True</span>
<span style="color: #465457;"># </span><span style="color: #465457;">and you can change the location of the files by setting retry_files_save_path</span>

<span style="color: #465457;">#</span><span style="color: #465457;">retry_files_enabled = False</span>
<span style="color: #465457;">#</span><span style="color: #465457;">retry_files_save_path = ~/.ansible-retry</span>

<span style="color: #465457;"># </span><span style="color: #465457;">squash actions</span>
<span style="color: #465457;"># </span><span style="color: #465457;">Ansible can optimise actions that call modules with list parameters</span>
<span style="color: #465457;"># </span><span style="color: #465457;">when looping. Instead of calling the module once per with_ item, the</span>
<span style="color: #465457;"># </span><span style="color: #465457;">module is called once with all items at once. Currently this only works</span>
<span style="color: #465457;"># </span><span style="color: #465457;">under limited circumstances, and only with parameters named 'name'.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">squash_actions = apk,apt,dnf,homebrew,pacman,pkgng,yum,zypper</span>

<span style="color: #465457;"># </span><span style="color: #465457;">prevents logging of task data, off by default</span>
<span style="color: #465457;">#</span><span style="color: #465457;">no_log = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">prevents logging of tasks, but only on the targets, data is still logged on the master/controller</span>
<span style="color: #465457;">#</span><span style="color: #465457;">no_target_syslog = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">controls whether Ansible will raise an error or warning if a task has no</span>
<span style="color: #465457;"># </span><span style="color: #465457;">choice but to create world readable temporary files to execute a module on</span>
<span style="color: #465457;"># </span><span style="color: #465457;">the remote machine.  This option is False by default for security.  Users may</span>
<span style="color: #465457;"># </span><span style="color: #465457;">turn this on to have behaviour more like Ansible prior to 2.1.x.  See</span>
<span style="color: #465457;"># </span><span style="color: #465457;">https://docs.ansible.com/ansible/become.html#becoming-an-unprivileged-user</span>
<span style="color: #465457;"># </span><span style="color: #465457;">for more secure ways to fix this than enabling this option.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">allow_world_readable_tmpfiles = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">controls the compression level of variables sent to</span>
<span style="color: #465457;"># </span><span style="color: #465457;">worker processes. At the default of 0, no compression</span>
<span style="color: #465457;"># </span><span style="color: #465457;">is used. This value must be an integer from 0 to 9.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">var_compression_level = 9</span>

<span style="color: #465457;"># </span><span style="color: #465457;">controls what compression method is used for new-style ansible modules when</span>
<span style="color: #465457;"># </span><span style="color: #465457;">they are sent to the remote system.  The compression types depend on having</span>
<span style="color: #465457;"># </span><span style="color: #465457;">support compiled into both the controller's python and the client's python.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">The names should match with the python Zipfile compression types:</span>
<span style="color: #465457;"># </span><span style="color: #465457;">* ZIP_STORED (no compression. available everywhere)</span>
<span style="color: #465457;"># </span><span style="color: #465457;">* ZIP_DEFLATED (uses zlib, the default)</span>
<span style="color: #465457;"># </span><span style="color: #465457;">These values may be set per host via the ansible_module_compression inventory</span>
<span style="color: #465457;"># </span><span style="color: #465457;">variable</span>
<span style="color: #465457;">#</span><span style="color: #465457;">module_compression = 'ZIP_DEFLATED'</span>

<span style="color: #465457;"># </span><span style="color: #465457;">This controls the cutoff point (in bytes) on --diff for files</span>
<span style="color: #465457;"># </span><span style="color: #465457;">set to 0 for unlimited (RAM may suffer!).</span>
<span style="color: #465457;">#</span><span style="color: #465457;">max_diff_size = 1048576</span>

<span style="color: #465457;"># </span><span style="color: #465457;">This controls how ansible handles multiple --tags and --skip-tags arguments</span>
<span style="color: #465457;"># </span><span style="color: #465457;">on the CLI.  If this is True then multiple arguments are merged together.  If</span>
<span style="color: #465457;"># </span><span style="color: #465457;">it is False, then the last specified argument is used and the others are ignored.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">This option will be removed in 2.8.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">merge_multiple_cli_flags = True</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Controls showing custom stats at the end, off by default</span>
<span style="color: #465457;">#</span><span style="color: #465457;">show_custom_stats = True</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Controls which files to ignore when using a directory as inventory with</span>
<span style="color: #465457;"># </span><span style="color: #465457;">possibly multiple sources (both static and dynamic)</span>
<span style="color: #465457;">#</span><span style="color: #465457;">inventory_ignore_extensions = ~, .orig, .bak, .ini, .cfg, .retry, .pyc, .pyo</span>

<span style="color: #465457;"># </span><span style="color: #465457;">This family of modules use an alternative execution path optimized for network appliances</span>
<span style="color: #465457;"># </span><span style="color: #465457;">only update this setting if you know how this works, otherwise it can break module execution</span>
<span style="color: #465457;">#</span><span style="color: #465457;">network_group_modules=eos, nxos, ios, iosxr, junos, vyos</span>

<span style="color: #465457;"># </span><span style="color: #465457;">When enabled, this option allows lookups (via variables like {{lookup('foo')}} or when used as</span>
<span style="color: #465457;"># </span><span style="color: #465457;">a loop with `with_foo`) to return data that is not marked "unsafe". This means the data may contain</span>
<span style="color: #465457;"># </span><span style="color: #465457;">jinja2 templating language which will be run through the templating engine.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">ENABLING THIS COULD BE A SECURITY RISK</span>
<span style="color: #465457;">#</span><span style="color: #465457;">allow_unsafe_lookups = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">set default errors for all plays</span>
<span style="color: #465457;">#</span><span style="color: #465457;">any_errors_fatal = False</span>

[inventory]
<span style="color: #465457;"># </span><span style="color: #465457;">enable inventory plugins, default: 'host_list', 'script', 'auto', 'yaml', 'ini', 'toml'</span>
<span style="color: #465457;">#</span><span style="color: #465457;">enable_plugins = host_list, virtualbox, yaml, constructed</span>

<span style="color: #465457;"># </span><span style="color: #465457;">ignore these extensions when parsing a directory as inventory source</span>
<span style="color: #465457;">#</span><span style="color: #465457;">ignore_extensions = .pyc, .pyo, .swp, .bak, ~, .rpm, .md, .txt, ~, .orig, .ini, .cfg, .retry</span>

<span style="color: #465457;"># </span><span style="color: #465457;">ignore files matching these patterns when parsing a directory as inventory source</span>
<span style="color: #465457;">#</span><span style="color: #465457;">ignore_patterns=</span>

<span style="color: #465457;"># </span><span style="color: #465457;">If 'true' unparsed inventory sources become fatal errors, they are warnings otherwise.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">unparsed_is_failed=False</span>

[privilege_escalation]
<span style="color: #465457;">#</span><span style="color: #465457;">become=True</span>
<span style="color: #465457;">#</span><span style="color: #465457;">become_method=sudo</span>
<span style="color: #465457;">#</span><span style="color: #465457;">become_user=root</span>
<span style="color: #465457;">#</span><span style="color: #465457;">become_ask_pass=False</span>

[paramiko_connection]

<span style="color: #465457;"># </span><span style="color: #465457;">uncomment this line to cause the paramiko connection plugin to not record new host</span>
<span style="color: #465457;"># </span><span style="color: #465457;">keys encountered.  Increases performance on new host additions.  Setting works independently of the</span>
<span style="color: #465457;"># </span><span style="color: #465457;">host key checking setting above.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">record_host_keys=False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">by default, Ansible requests a pseudo-terminal for commands executed under sudo. Uncomment this</span>
<span style="color: #465457;"># </span><span style="color: #465457;">line to disable this behaviour.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">pty=False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">paramiko will default to looking for SSH keys initially when trying to</span>
<span style="color: #465457;"># </span><span style="color: #465457;">authenticate to remote devices.  This is a problem for some network devices</span>
<span style="color: #465457;"># </span><span style="color: #465457;">that close the connection after a key failure.  Uncomment this line to</span>
<span style="color: #465457;"># </span><span style="color: #465457;">disable the Paramiko look for keys function</span>
<span style="color: #465457;">#</span><span style="color: #465457;">look_for_keys = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">When using persistent connections with Paramiko, the connection runs in a</span>
<span style="color: #465457;"># </span><span style="color: #465457;">background process.  If the host doesn't already have a valid SSH key, by</span>
<span style="color: #465457;"># </span><span style="color: #465457;">default Ansible will prompt to add the host key.  This will cause connections</span>
<span style="color: #465457;"># </span><span style="color: #465457;">running in background processes to fail.  Uncomment this line to have</span>
<span style="color: #465457;"># </span><span style="color: #465457;">Paramiko automatically add host keys.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">host_key_auto_add = True</span>

[ssh_connection]

<span style="color: #465457;"># </span><span style="color: #465457;">ssh arguments to use</span>
<span style="color: #465457;"># </span><span style="color: #465457;">Leaving off ControlPersist will result in poor performance, so use</span>
<span style="color: #465457;"># </span><span style="color: #465457;">paramiko on older platforms rather than removing it, -C controls compression use</span>
<span style="color: #465457;">#</span><span style="color: #465457;">ssh_args = -C -o ControlMaster=auto -o ControlPersist=60s</span>

<span style="color: #465457;"># </span><span style="color: #465457;">The base directory for the ControlPath sockets.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">This is the "%(directory)s" in the control_path option</span>
<span style="color: #465457;">#</span>
<span style="color: #465457;"># </span><span style="color: #465457;">Example:</span>
<span style="color: #465457;"># </span><span style="color: #465457;">control_path_dir = /tmp/.ansible/cp</span>
<span style="color: #465457;">#</span><span style="color: #465457;">control_path_dir = ~/.ansible/cp</span>

<span style="color: #465457;"># </span><span style="color: #465457;">The path to use for the ControlPath sockets. This defaults to a hashed string of the hostname,</span>
<span style="color: #465457;"># </span><span style="color: #465457;">port and username (empty string in the config). The hash mitigates a common problem users</span>
<span style="color: #465457;"># </span><span style="color: #465457;">found with long hostnames and the conventional %(directory)s/ansible-ssh-%%h-%%p-%%r format.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">In those cases, a "too long for Unix domain socket" ssh error would occur.</span>
<span style="color: #465457;">#</span>
<span style="color: #465457;"># </span><span style="color: #465457;">Example:</span>
<span style="color: #465457;"># </span><span style="color: #465457;">control_path = %(directory)s/%%h-%%r</span>
<span style="color: #465457;">#</span><span style="color: #465457;">control_path =</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Enabling pipelining reduces the number of SSH operations required to</span>
<span style="color: #465457;"># </span><span style="color: #465457;">execute a module on the remote server. This can result in a significant</span>
<span style="color: #465457;"># </span><span style="color: #465457;">performance improvement when enabled, however when using "sudo:" you must</span>
<span style="color: #465457;"># </span><span style="color: #465457;">first disable 'requiretty' in /etc/sudoers</span>
<span style="color: #465457;">#</span>
<span style="color: #465457;"># </span><span style="color: #465457;">By default, this option is disabled to preserve compatibility with</span>
<span style="color: #465457;"># </span><span style="color: #465457;">sudoers configurations that have requiretty (the default on many distros).</span>
<span style="color: #465457;">#</span>
<span style="color: #465457;">#</span><span style="color: #465457;">pipelining = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Control the mechanism for transferring files (old)</span>
<span style="color: #465457;">#   </span><span style="color: #465457;">* smart = try sftp and then try scp [default]</span>
<span style="color: #465457;">#   </span><span style="color: #465457;">* True = use scp only</span>
<span style="color: #465457;">#   </span><span style="color: #465457;">* False = use sftp only</span>
<span style="color: #465457;">#</span><span style="color: #465457;">scp_if_ssh = smart</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Control the mechanism for transferring files (new)</span>
<span style="color: #465457;"># </span><span style="color: #465457;">If set, this will override the scp_if_ssh option</span>
<span style="color: #465457;">#   </span><span style="color: #465457;">* sftp  = use sftp to transfer files</span>
<span style="color: #465457;">#   </span><span style="color: #465457;">* scp   = use scp to transfer files</span>
<span style="color: #465457;">#   </span><span style="color: #465457;">* piped = use 'dd' over SSH to transfer files</span>
<span style="color: #465457;">#   </span><span style="color: #465457;">* smart = try sftp, scp, and piped, in that order [default]</span>
<span style="color: #465457;">#</span><span style="color: #465457;">transfer_method = smart</span>

<span style="color: #465457;"># </span><span style="color: #465457;">if False, sftp will not use batch mode to transfer files. This may cause some</span>
<span style="color: #465457;"># </span><span style="color: #465457;">types of file transfer failures impossible to catch however, and should</span>
<span style="color: #465457;"># </span><span style="color: #465457;">only be disabled if your sftp version has problems with batch mode</span>
<span style="color: #465457;">#</span><span style="color: #465457;">sftp_batch_mode = False</span>

<span style="color: #465457;"># </span><span style="color: #465457;">The -tt argument is passed to ssh when pipelining is not enabled because sudo</span>
<span style="color: #465457;"># </span><span style="color: #465457;">requires a tty by default.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">usetty = True</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Number of times to retry an SSH connection to a host, in case of UNREACHABLE.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">For each retry attempt, there is an exponential backoff,</span>
<span style="color: #465457;"># </span><span style="color: #465457;">so after the first attempt there is 1s wait, then 2s, 4s etc. up to 30s (max).</span>
<span style="color: #465457;">#</span><span style="color: #465457;">retries = 3</span>

[persistent_connection]

<span style="color: #465457;"># </span><span style="color: #465457;">Configures the persistent connection timeout value in seconds.  This value is</span>
<span style="color: #465457;"># </span><span style="color: #465457;">how long the persistent connection will remain idle before it is destroyed.</span>
<span style="color: #465457;"># </span><span style="color: #465457;">If the connection doesn't receive a request before the timeout value</span>
<span style="color: #465457;"># </span><span style="color: #465457;">expires, the connection is shutdown. The default value is 30 seconds.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">connect_timeout = 30</span>

<span style="color: #465457;"># </span><span style="color: #465457;">The command timeout value defines the amount of time to wait for a command</span>
<span style="color: #465457;"># </span><span style="color: #465457;">or RPC call before timing out. The value for the command timeout must</span>
<span style="color: #465457;"># </span><span style="color: #465457;">be less than the value of the persistent connection idle timeout (connect_timeout)</span>
<span style="color: #465457;"># </span><span style="color: #465457;">The default value is 30 second.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">command_timeout = 30</span>

[accelerate]
<span style="color: #465457;">#</span><span style="color: #465457;">accelerate_port = 5099</span>
<span style="color: #465457;">#</span><span style="color: #465457;">accelerate_timeout = 30</span>
<span style="color: #465457;">#</span><span style="color: #465457;">accelerate_connect_timeout = 5.0</span>

<span style="color: #465457;"># </span><span style="color: #465457;">The daemon timeout is measured in minutes. This time is measured</span>
<span style="color: #465457;"># </span><span style="color: #465457;">from the last activity to the accelerate daemon.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">accelerate_daemon_timeout = 30</span>

<span style="color: #465457;"># </span><span style="color: #465457;">If set to yes, accelerate_multi_key will allow multiple</span>
<span style="color: #465457;"># </span><span style="color: #465457;">private keys to be uploaded to it, though each user must</span>
<span style="color: #465457;"># </span><span style="color: #465457;">have access to the system via SSH to add a new key. The default</span>
<span style="color: #465457;"># </span><span style="color: #465457;">is "no".</span>
<span style="color: #465457;">#</span><span style="color: #465457;">accelerate_multi_key = yes</span>

[selinux]
<span style="color: #465457;"># </span><span style="color: #465457;">file systems that require special treatment when dealing with security context</span>
<span style="color: #465457;"># </span><span style="color: #465457;">the default behaviour that copies the existing context or uses the user default</span>
<span style="color: #465457;"># </span><span style="color: #465457;">needs to be changed to use the file system dependent context.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">special_context_filesystems=nfs,vboxsf,fuse,ramfs,9p,vfat</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Set this to yes to allow libvirt_lxc connections to work without SELinux.</span>
<span style="color: #465457;">#</span><span style="color: #465457;">libvirt_lxc_noseclabel = yes</span>

[colors]
<span style="color: #465457;">#</span><span style="color: #465457;">highlight = white</span>
<span style="color: #465457;">#</span><span style="color: #465457;">verbose = blue</span>
<span style="color: #465457;">#</span><span style="color: #465457;">warn = bright purple</span>
<span style="color: #465457;">#</span><span style="color: #465457;">error = red</span>
<span style="color: #465457;">#</span><span style="color: #465457;">debug = dark gray</span>
<span style="color: #465457;">#</span><span style="color: #465457;">deprecate = purple</span>
<span style="color: #465457;">#</span><span style="color: #465457;">skip = cyan</span>
<span style="color: #465457;">#</span><span style="color: #465457;">unreachable = red</span>
<span style="color: #465457;">#</span><span style="color: #465457;">ok = green</span>
<span style="color: #465457;">#</span><span style="color: #465457;">changed = yellow</span>
<span style="color: #465457;">#</span><span style="color: #465457;">diff_add = green</span>
<span style="color: #465457;">#</span><span style="color: #465457;">diff_remove = red</span>
<span style="color: #465457;">#</span><span style="color: #465457;">diff_lines = cyan</span>


[diff]
<span style="color: #465457;"># </span><span style="color: #465457;">Always print diff when running ( same as always running with -D/--diff )</span>
<span style="color: #465457;"># </span><span style="color: #465457;">always = no</span>

<span style="color: #465457;"># </span><span style="color: #465457;">Set how many context lines to show in diff</span>
<span style="color: #465457;"># </span><span style="color: #465457;">context = 3</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4d3349e" class="outline-4">
<h4 id="org4d3349e"><span class="section-number-4">1.1.2</span> 主机清单配置文件 (<code>/etc/ansible/hosts</code>)</h4>
<div class="outline-text-4" id="text-1-1-2">
</div>
<div id="outline-container-orge1fb0be" class="outline-5">
<h5 id="orge1fb0be"><span class="section-number-5">1.1.2.1</span> 对主机进行分组</h5>
<div class="outline-text-5" id="text-1-1-2-1">
<div class="org-src-container">
<pre class="src src-sh">[master]
server-master        <span style="color: #fd971f;">ansible_ssh_host</span>=10.0.0.5    <span style="color: #fd971f;">ansible_ssh_user</span>=ubuntu <span style="color: #fd971f;">ansible_sudo_pass</span>=!qaz2wsx

[standbys]
server-standby-01    <span style="color: #fd971f;">ansible_ssh_host</span>=10.0.0.6    <span style="color: #fd971f;">ansible_ssh_user</span>=ubuntu
server-standby-02    <span style="color: #fd971f;">ansible_ssh_host</span>=10.0.0.7    <span style="color: #fd971f;">ansible_ssh_user</span>=ubuntu

[replication]
master
standbys
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org238f6d9" class="outline-3">
<h3 id="org238f6d9"><span class="section-number-3">1.2</span> 相关命令</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org82e9652" class="outline-4">
<h4 id="org82e9652"><span class="section-number-4">1.2.1</span> 临时命令执行工具 (<code>/usr/bin/ansible</code>)</h4>
<div class="outline-text-4" id="text-1-2-1">
</div>
<div id="outline-container-orge99c4cd" class="outline-5">
<h5 id="orge99c4cd"><span class="section-number-5">1.2.1.1</span> 执行过程</h5>
<div class="outline-text-5" id="text-1-2-1-1">
<ol class="org-ol">
<li>加载配置文件 <code>ansible.cfg</code></li>
<li>加载模块文件</li>
<li>将模块生成的临时 python 文件传输至服务器</li>
<li>执行并返回结果</li>
<li>删除临时 python 文件</li>
<li>退出</li>
</ol>
</div>
</div>

<div id="outline-container-orgc20c884" class="outline-5">
<h5 id="orgc20c884"><span class="section-number-5">1.2.1.2</span> 执行状态</h5>
<div class="outline-text-5" id="text-1-2-1-2">
<ul class="org-ul">
<li>绿色
执行成功且无改变的操作</li>
<li>黄色
执行成功且对目标主机做出改变的操作</li>
<li>红色
执行失败</li>
</ul>
</div>
</div>

<div id="outline-container-org30230f8" class="outline-5">
<h5 id="org30230f8"><span class="section-number-5">1.2.1.3</span> 显示所有主机</h5>
<div class="outline-text-5" id="text-1-2-1-3">
<p>
<code>ansible all --list</code>
</p>
</div>
</div>
</div>


<div id="outline-container-orgbc95f40" class="outline-4">
<h4 id="orgbc95f40"><span class="section-number-4">1.2.2</span> 模块查看工具 (<code>/usr/bin/ansible-doc</code>)</h4>
<div class="outline-text-4" id="text-1-2-2">
</div>
<div id="outline-container-orgdae9158" class="outline-5">
<h5 id="orgdae9158"><span class="section-number-5">1.2.2.1</span> 显示所有模块</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<p>
<code>ansible-doc -l</code>
</p>
</div>
</div>


<div id="outline-container-org187692d" class="outline-5">
<h5 id="org187692d"><span class="section-number-5">1.2.2.2</span> 查看模块用法</h5>
<div class="outline-text-5" id="text-1-2-2-2">
<p>
<code>ansible-doc [-s] &lt;module_name&gt;</code>
</p>
</div>
</div>
</div>


<div id="outline-container-orga59dfdc" class="outline-4">
<h4 id="orga59dfdc"><span class="section-number-4">1.2.3</span> 模块下载工具 (<code>/usr/bin/ansible-galaxy</code>)</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
用于从 galaxy 服务器上下载相应的 Role 。
</p>

<p>
使用 <code>ansible-galaxy list</code> 列出已安装的 galaxy 。
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; ansible-galaxy install geerlingguy.nginx
&gt; tree ~/.ansible/roles/geerlingguy.nginx
~/.ansible/roles/geerlingguy.nginx
&#9500;&#9472;&#9472; LICENSE
&#9500;&#9472;&#9472; README.md
&#9500;&#9472;&#9472; defaults
&#9474;   &#9492;&#9472;&#9472; main.yml
&#9500;&#9472;&#9472; handlers
&#9474;   &#9492;&#9472;&#9472; main.yml
&#9500;&#9472;&#9472; meta
&#9474;   &#9492;&#9472;&#9472; main.yml
&#9500;&#9472;&#9472; molecule
&#9474;   &#9492;&#9472;&#9472; default
&#9474;       &#9500;&#9472;&#9472; molecule.yml
&#9474;       &#9500;&#9472;&#9472; playbook.yml
&#9474;       &#9492;&#9472;&#9472; yaml-lint.yml
&#9500;&#9472;&#9472; tasks
&#9474;   &#9500;&#9472;&#9472; main.yml
&#9474;   &#9500;&#9472;&#9472; setup-Archlinux.yml
&#9474;   &#9500;&#9472;&#9472; setup-Debian.yml
&#9474;   &#9500;&#9472;&#9472; setup-FreeBSD.yml
&#9474;   &#9500;&#9472;&#9472; setup-OpenBSD.yml
&#9474;   &#9500;&#9472;&#9472; setup-RedHat.yml
&#9474;   &#9500;&#9472;&#9472; setup-Ubuntu.yml
&#9474;   &#9492;&#9472;&#9472; vhosts.yml
&#9500;&#9472;&#9472; templates
&#9474;   &#9500;&#9472;&#9472; nginx.conf.j2
&#9474;   &#9500;&#9472;&#9472; nginx.repo.j2
&#9474;   &#9492;&#9472;&#9472; vhost.j2
&#9492;&#9472;&#9472; vars
    &#9500;&#9472;&#9472; Archlinux.yml
    &#9500;&#9472;&#9472; Debian.yml
    &#9500;&#9472;&#9472; FreeBSD.yml
    &#9500;&#9472;&#9472; OpenBSD.yml
    &#9492;&#9472;&#9472; RedHat.yml
</pre>
</div>
</div>
</div>


<div id="outline-container-orgcce5bab" class="outline-4">
<h4 id="orgcce5bab"><span class="section-number-4">1.2.4</span> 编排剧本工具 (<code>/usr/bin/ansible-playbook</code>)</h4>
</div>


<div id="outline-container-orgb521f12" class="outline-4">
<h4 id="orgb521f12"><span class="section-number-4">1.2.5</span> 文件加密工具 (<code>/usr/bin/ansible-vault</code>)</h4>
</div>
</div>
</div>



<div id="outline-container-org72f6ab4" class="outline-2">
<h2 id="org72f6ab4"><span class="section-number-2">2</span> 模块 (Module)</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgac0af5a" class="outline-3">
<h3 id="orgac0af5a"><span class="section-number-3">2.1</span> 远程执行</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org8c67e42" class="outline-4">
<h4 id="org8c67e42"><span class="section-number-4">2.1.1</span> command (默认模块)</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
<b>对管道和特殊字符的支持有限，可以选择使用 shell 模块</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all -a <span style="color: #e6db74;">'df -h'</span>
ansible all -a <span style="color: #e6db74;">'chdir=/tmp ls'</span> <span style="color: #465457;"># </span><span style="color: #465457;">&#20999;&#25442;&#30446;&#24405;</span>

</pre>
</div>

<dl class="org-dl">
<dt>creates</dt><dd>指定一个文件名，如果给文件存在，则不执行。</dd>

<dt>removes</dt><dd>指定一个文件名，如果给文件不存在，则不执行。</dd>

<dt>chdir</dt><dd>执行命令前，切换到指定目录。</dd>
</dl>
</div>
</div>


<div id="outline-container-orgc77ef4c" class="outline-4">
<h4 id="orgc77ef4c"><span class="section-number-4">2.1.2</span> shell</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
和 <code>command</code> 类似， <b>但支持管道与特殊字符</b> 。
</p>


<div class="org-src-container">
<pre class="src src-sh">ansible all -m shell -b -a <span style="color: #e6db74;">'useradd haoru'</span>
ansible all -m shell -b -a <span style="color: #e6db74;">'echo haoru:mypassword | chpasswd'</span> <span style="color: #465457;"># </span><span style="color: #465457;">&#20462;&#25913;&#23494;&#30721;</span>
ansible all -m shell -a <span style="color: #e6db74;">'getent passwd haoru'</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orga416e34" class="outline-4">
<h4 id="orga416e34"><span class="section-number-4">2.1.3</span> script</h4>
<div class="outline-text-4" id="text-2-1-3">
<div class="org-src-container">
<pre class="src src-sh">ansible all -m script -a <span style="color: #e6db74;">'/path/to/local/script.sh'</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orga101516" class="outline-3">
<h3 id="orga101516"><span class="section-number-3">2.2</span> 文件管理</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org587819a" class="outline-4">
<h4 id="org587819a"><span class="section-number-4">2.2.1</span> copy</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">
<pre class="src src-sh">ansible all -m copy -a <span style="color: #e6db74;">'src=/path/to/local/file dest=/path/to/remote/file backup=yes mode=777 owner=root'</span>
ansible all -m copy -a <span style="color: #e6db74;">'content="hello\nworld" dest=/path/to/remote/file'</span>

</pre>
</div>

<ul class="org-ul">
<li><p>
src
</p>

<p>
本地文件地址，可以是绝对路径，也可以是相对路径。 如果路径是一个目录，它将递归复制。
</p>

<p>
如果路径使用 <code>/</code> 来结尾，则只复制目录里的内容；<br>
如果没有使用 <code>/</code> 来结尾，则包含目录在内的整个内容全部复制，类似于 <code>rsync</code> 。
</p></li>
<li><p>
dest
</p>

<p>
远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录。
</p></li>
</ul>
</div>
</div>



<div id="outline-container-org424975b" class="outline-4">
<h4 id="org424975b"><span class="section-number-4">2.2.2</span> fetch</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
从服务器下载文件，和 <code>copy</code> 作用相反。（ <span class="underline">当前不支持下载目录</span> ）
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all -m fetch -a <span style="color: #e6db74;">'src=~/test.txt dest=/tmp'</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org98f841a" class="outline-4">
<h4 id="org98f841a"><span class="section-number-4">2.2.3</span> file</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
设置文件属性
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all -m file -a <span style="color: #e6db74;">'dest=/tmp/test.txt state=touch'</span> <span style="color: #465457;"># </span><span style="color: #465457;">&#21019;&#24314;&#25991;&#20214;</span>
ansible all -m file -a <span style="color: #e6db74;">'dest=/tmp/test.txt state=absent'</span> <span style="color: #465457;"># </span><span style="color: #465457;">&#21024;&#38500;&#25991;&#20214;</span>
ansible all -m file -a <span style="color: #e6db74;">'dest=/tmp/testdir state=directory'</span> <span style="color: #465457;"># </span><span style="color: #465457;">&#21019;&#24314;&#25991;&#20214;&#22841;</span>
ansible all -m file -a <span style="color: #e6db74;">'src=/etc/fstab dest=/tmp/fstab.link state=link'</span> <span style="color: #465457;"># </span><span style="color: #465457;">&#21019;&#24314;&#36719;&#38142;&#25509;</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org1caa2e4" class="outline-4">
<h4 id="org1caa2e4"><span class="section-number-4">2.2.4</span> synchronize</h4>
<div class="outline-text-4" id="text-2-2-4">
<div class="org-src-container">
<pre class="src src-sh">synchronize: <span style="color: #fd971f;">src</span>=some/relative/path <span style="color: #fd971f;">dest</span>=/some/absolute/path <span style="color: #fd971f;">rsync_path</span>=<span style="color: #e6db74;">"sudo rsync"</span>
synchronize: <span style="color: #fd971f;">src</span>=some/relative/path <span style="color: #fd971f;">dest</span>=/some/absolute/path <span style="color: #fd971f;">archive</span>=no   <span style="color: #fd971f;">links</span>=yes
synchronize: <span style="color: #fd971f;">src</span>=some/relative/path <span style="color: #fd971f;">dest</span>=/some/absolute/path <span style="color: #fd971f;">checksum</span>=yes <span style="color: #fd971f;">times</span>=no
synchronize: <span style="color: #fd971f;">src</span>=some/relative/path <span style="color: #fd971f;">dest</span>=/some/absolute/path <span style="color: #fd971f;">rsync_opts</span>=--no-motd,--exclude=.git <span style="color: #fd971f;">mode</span>=pull
</pre>
</div>
</div>
</div>



<div id="outline-container-org59fbc4a" class="outline-4">
<h4 id="org59fbc4a"><span class="section-number-4">2.2.5</span> get_url</h4>
<div class="outline-text-4" id="text-2-2-5">
<div class="org-src-container">
<pre class="src src-sh">get_url: <span style="color: #fd971f;">url</span>=http://example.com/path/file.conf <span style="color: #fd971f;">dest</span>=/etc/foo.conf <span style="color: #fd971f;">mode</span>=0440
</pre>
</div>
</div>
</div>
</div>





<div id="outline-container-orgb60096d" class="outline-3">
<h3 id="orgb60096d"><span class="section-number-3">2.3</span> 网络管理</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-orgb0de75f" class="outline-4">
<h4 id="orgb0de75f"><span class="section-number-4">2.3.1</span> ping</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
<code>ansible &lt;pattern&gt; -m ping</code>
</p>
</div>
</div>
</div>


<div id="outline-container-orge71c006" class="outline-3">
<h3 id="orge71c006"><span class="section-number-3">2.4</span> 服务管理</h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-orga3ab2e0" class="outline-4">
<h4 id="orga3ab2e0"><span class="section-number-4">2.4.1</span> service</h4>
<div class="outline-text-4" id="text-2-4-1">
<ul class="org-ul">
<li><p>
enabled
</p>

<p>
是否开机启动
</p></li>
<li><p>
name
</p>

<p>
服务名称
</p></li>
<li><p>
pattern
</p>

<p>
就会通过 <code>ps</code> 命令在进程中根据该模式进行查找，如果找到，则认为该服务依然在运行。
</p></li>
<li><p>
sleep
</p>

<p>
如果执行了 <code>restarted</code> ，在则 stop 和 start 之间等待几秒。
</p></li>
<li><p>
state
</p>

<p>
<code>started</code> , <code>stopped</code> , <code>restarted</code> , <code>reloaded</code>
</p></li>
</ul>


<div class="org-src-container">
<pre class="src src-sh">service: <span style="color: #fd971f;">name</span>=httpd <span style="color: #fd971f;">state</span>=started <span style="color: #fd971f;">enabled</span>=yes
service: <span style="color: #fd971f;">name</span>=foo <span style="color: #fd971f;">pattern</span>=/usr/bin/foo <span style="color: #fd971f;">state</span>=started <span style="color: #465457;"># </span><span style="color: #465457;">&#33509;&#21551;&#21160;&#21518;&#21457;&#29616; /usr/bin/foo &#36825;&#20010;&#36827;&#31243;&#23384;&#22312;&#65292;&#21017;&#35748;&#20026;&#21551;&#21160;&#25104;&#21151;</span>

ansible all -m service -a <span style="color: #e6db74;">'name=vsftpd state=started enabled=true'</span>
ansible all -a <span style="color: #e6db74;">'systemctl is-enabled vsftpd'</span>
ansible all -a <span style="color: #e6db74;">'systemctl status vsftpd'</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org5beabfc" class="outline-4">
<h4 id="org5beabfc"><span class="section-number-4">2.4.2</span> cron</h4>
<div class="outline-text-4" id="text-2-4-2">
<dl class="org-dl">
<dt>backup</dt><dd>先备份原任务计划内容</dd>
</dl>


<dl class="org-dl">
<dt>job</dt><dd>执行的任务（命令）</dd>

<dt>name</dt><dd>任务的描述</dd>
</dl>


<dl class="org-dl">
<dt>special_time</dt><dd><code>reboot</code> , <code>yearly</code> , <code>annually</code> , <code>monthly</code> , <code>weekly</code> , <code>daily</code> , <code>hourly</code></dd>
</dl>


<dl class="org-dl">
<dt>state</dt><dd>创建 (<code>present</code>) / 删除(<code>absent</code>)</dd>

<dt>user</dt><dd>执行用户身份</dd>
</dl>


<div class="org-src-container">
<pre class="src src-sh">cron: <span style="color: #fd971f;">name</span>=do_something_when_reboot <span style="color: #fd971f;">special_time</span>=reboot <span style="color: #fd971f;">job</span>=<span style="color: #e6db74;">"/some/job.sh"</span>
cron: <span style="color: #fd971f;">name</span>=do_something_when_reboot <span style="color: #fd971f;">state</span>=absent

ansible all -m cron -a <span style="color: #e6db74;">'minute=* weekday=1,3,5 job="/usr/bin/wall hello" name=warningcron'</span>
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-org148b4b9" class="outline-3">
<h3 id="org148b4b9"><span class="section-number-3">2.5</span> 用户（组）管理</h3>
<div class="outline-text-3" id="text-2-5">
</div>
<div id="outline-container-org3a25008" class="outline-4">
<h4 id="org3a25008"><span class="section-number-4">2.5.1</span> user</h4>
<div class="outline-text-4" id="text-2-5-1">
<div class="org-src-container">
<pre class="src src-sh">ansible all -m user -a <span style="color: #e6db74;">'name=nginx shell=/sbin/nologin system=yes home=/var/nginx groups=root,bin comment="nginx service"'</span>
ansible all -m user -a <span style="color: #e6db74;">'name=nginx state=absent remove=yes'</span> <span style="color: #465457;"># </span><span style="color: #465457;">&#21024;&#38500;&#29992;&#25143;&#65292;&#21253;&#25324;&#23478;&#30446;&#24405;</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
system
</p>

<p>
是否是系统账号
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org363d527" class="outline-4">
<h4 id="org363d527"><span class="section-number-4">2.5.2</span> group</h4>
<div class="outline-text-4" id="text-2-5-2">
<div class="org-src-container">
<pre class="src src-sh">ansible all -m group -a <span style="color: #e6db74;">'name=nginx system=yes'</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgb4342dc" class="outline-3">
<h3 id="orgb4342dc"><span class="section-number-3">2.6</span> 主机信息</h3>
<div class="outline-text-3" id="text-2-6">
</div>
<div id="outline-container-org984c87f" class="outline-4">
<h4 id="org984c87f"><span class="section-number-4">2.6.1</span> setup</h4>
<div class="outline-text-4" id="text-2-6-1">
<div class="org-src-container">
<pre class="src src-sh">ansible &lt;pattern&gt; -m setup -a <span style="color: #e6db74;">'filter=ansible_*_mb'</span>     <span style="color: #465457;"># </span><span style="color: #465457;">&#26597;&#30475;&#20027;&#26426;&#20869;&#23384;&#20449;&#24687;</span>
ansible &lt;pattern&gt; -m setup -a <span style="color: #e6db74;">'filter=ansible_eth[0-2]'</span> <span style="color: #465457;"># </span><span style="color: #465457;">&#26597;&#30475;&#22320;&#25509;&#21475;&#20026;eth0-2&#30340;&#32593;&#21345;&#20449;&#24687;</span>
ansible &lt;pattern&gt; -m setup --tree /tmp/facts            <span style="color: #465457;"># </span><span style="color: #465457;">&#23558;&#25152;&#26377;&#20027;&#26426;&#30340;&#20449;&#24687;&#36755;&#20837;&#21040; /tmp/facts &#30446;&#24405;&#19979;</span>
</pre>
</div>
</div>
</div>
</div>




<div id="outline-container-orgbf98be2" class="outline-3">
<h3 id="orgbf98be2"><span class="section-number-3">2.7</span> 主要用于 Playbook 的模块</h3>
<div class="outline-text-3" id="text-2-7">
</div>
<div id="outline-container-org99fa183" class="outline-4">
<h4 id="org99fa183"><span class="section-number-4">2.7.1</span> pause</h4>
<div class="outline-text-4" id="text-2-7-1">
<p>
执行的过程中暂停一定时间或者提示用户进行某些操作。
</p>

<div class="org-src-container">
<pre class="src src-sh">pause: <span style="color: #fd971f;">prompt</span>=<span style="color: #e6db74;">"ENTER to continue CTRL-C a to quit"</span>
pause: <span style="color: #fd971f;">seconds</span>=30
</pre>
</div>
</div>
</div>


<div id="outline-container-org1aa954e" class="outline-4">
<h4 id="org1aa954e"><span class="section-number-4">2.7.2</span> wait_for</h4>
<div class="outline-text-4" id="text-2-7-2">
<p>
执行过程中等待某些操作完成以后再进行后续操作。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #465457;"># </span><span style="color: #465457;">&#31561;&#24453; 8080 &#31471;&#21475;&#24050;&#27491;&#24120;&#30417;&#21548;&#65292;&#25165;&#24320;&#22987;&#19979;&#19968;&#20010;&#20219;&#21153;</span>
wait_for: <span style="color: #fd971f;">port</span>=8080 <span style="color: #fd971f;">state</span>=started

<span style="color: #465457;"># </span><span style="color: #465457;">&#31561;&#24453; 8000 &#31471;&#21475;&#27491;&#24120;&#30417;&#21548;&#65292;&#27599;&#38548; 10s &#26816;&#26597;&#19968;&#27425;&#65292;&#30452;&#33267;&#31561;&#24453;&#36229;&#26102;</span>
wait_for: <span style="color: #fd971f;">port</span>=8000 <span style="color: #fd971f;">delay</span>=10

<span style="color: #465457;"># </span><span style="color: #465457;">&#31561;&#24453; 8000 &#31471;&#21475;&#30452;&#33267;&#26377;&#36830;&#25509;&#24314;&#31435;</span>
wait_for: <span style="color: #fd971f;">host</span>=0.0.0.0 <span style="color: #fd971f;">port</span>=8000 <span style="color: #fd971f;">delay</span>=10 <span style="color: #fd971f;">state</span>=drained

<span style="color: #465457;"># </span><span style="color: #465457;">&#31561;&#24453; 8000 &#31471;&#21475;&#26377;&#36830;&#25509;&#24314;&#31435;&#65292;&#22914;&#26524;&#36830;&#25509;&#26469;&#33258;10.2.1.2&#25110;&#32773;10.2.1.3&#65292;&#21017;&#24573;&#30053;</span>
wait_for: <span style="color: #fd971f;">host</span>=0.0.0.0 <span style="color: #fd971f;">port</span>=8000 <span style="color: #fd971f;">state</span>=drained <span style="color: #fd971f;">exclude_hosts</span>=10.2.1.2,10.2.1.3

<span style="color: #465457;"># </span><span style="color: #465457;">&#31561;&#24453; /tmp/foo &#25991;&#20214;&#24050;&#21019;&#24314;</span>
wait_for: <span style="color: #fd971f;">path</span>=/tmp/foo

<span style="color: #465457;"># </span><span style="color: #465457;">&#31561;&#24453; /tmp/foo &#25991;&#20214;&#24050;&#21019;&#24314;&#65292;&#32780;&#19988;&#35813;&#25991;&#20214;&#20013;&#38656;&#35201;&#21253;&#21547; completed &#23383;&#31526;&#20018;</span>
wait_for: <span style="color: #fd971f;">path</span>=/tmp/foo <span style="color: #fd971f;">search_regex</span>=completed

<span style="color: #465457;"># </span><span style="color: #465457;">&#31561;&#24453; /var/lock/file.lock &#34987;&#21024;&#38500;</span>
wait_for: <span style="color: #fd971f;">path</span>=/var/lock/file.lock <span style="color: #fd971f;">state</span>=absent

<span style="color: #465457;"># </span><span style="color: #465457;">&#31561;&#24453;&#25351;&#23450;&#30340;&#36827;&#31243;&#34987;&#38144;&#27585;</span>
wait_for: <span style="color: #fd971f;">path</span>=/proc/3466/status <span style="color: #fd971f;">state</span>=absent



</pre>
</div>
</div>
</div>



<div id="outline-container-orgeac7d9d" class="outline-4">
<h4 id="orgeac7d9d"><span class="section-number-4">2.7.3</span> add_host</h4>
<div class="outline-text-4" id="text-2-7-3">
<p>
执行的过程中动态的添加主机到指定的主机组中。
</p>
</div>
</div>


<div id="outline-container-org24d5036" class="outline-4">
<h4 id="org24d5036"><span class="section-number-4">2.7.4</span> group_by</h4>
<div class="outline-text-4" id="text-2-7-4">
<p>
执行的过程中动态的创建主机组。
</p>

<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">name</span>: Create operating system group
  <span style="color: #fd971f;">hosts</span>: all
  <span style="color: #fd971f;">tasks</span>:
    - <span style="color: #fd971f;">group_by</span>: key=os_{{ ansible_distribution }}

- <span style="color: #fd971f;">name</span>: Run on CentOS hosts only
  <span style="color: #fd971f;">hosts</span>: os_CentOS
  <span style="color: #fd971f;">tasks</span>:
    - <span style="color: #fd971f;">name</span>: Install Apache
      <span style="color: #fd971f;">yum</span>: name=httpd state=latest

- <span style="color: #fd971f;">name</span>: Run on Ubuntu hosts only
  <span style="color: #fd971f;">hosts</span>: os_Ubuntu
  <span style="color: #fd971f;">tasks</span>:
    - <span style="color: #fd971f;">name</span>: Install Apache
      <span style="color: #fd971f;">apt</span>: pkg=apache2 state=latest
</pre>
</div>
</div>
</div>


<div id="outline-container-orgfb94a3c" class="outline-4">
<h4 id="orgfb94a3c"><span class="section-number-4">2.7.5</span> debug</h4>
<div class="outline-text-4" id="text-2-7-5">
<p>
用于在调试中输出信息。
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #fd971f;">debug</span>: msg=<span style="color: #e6db74;">"System {{ inventory_hostname }} has gateway {{ ansible_default_ipv4.gateway }}"</span>
<span style="color: #fd971f;">debug</span>: var=result verbosity=2

</pre>
</div>
</div>
</div>


<div id="outline-container-org5698e05" class="outline-4">
<h4 id="org5698e05"><span class="section-number-4">2.7.6</span> fail</h4>
<div class="outline-text-4" id="text-2-7-6">
<p>
通常与条件语句组合使用，当满足条件时，终止当前 play 的运行。
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #fd971f;">fail</span>: msg=<span style="color: #e6db74;">"..."</span>
</pre>
</div>
</div>
</div>
</div>
</div>







<div id="outline-container-orga4f4cb7" class="outline-2">
<h2 id="orga4f4cb7"><span class="section-number-2">3</span> Playbook</h2>
<div class="outline-text-2" id="text-3">
<p>
ansbile-playbook 是一系列 ansible 命令的集合，使用 yaml 语言编写。
playbook 命令根据自上而下的顺序依次执行。
</p>

<p>
playbook 允许你传输某个命令的状态到后面的指令, 如可以从一台机器的文件中抓取内容并附为变量,
然后在另一台机器中使用, 这使得可以实现一些复杂的部署机制, 这是 adhoc 方式无法实现的。
</p>


<div id="orgca0a781" class="figure">
<p><img src="img/ansible-playbook.png" alt="ansible-playbook.png">
</p>
<p><span class="figure-number">Figure 1: </span>Playbook 组织结构</p>
</div>
</div>

<div id="outline-container-org73b4729" class="outline-3">
<h3 id="org73b4729"><span class="section-number-3">3.1</span> Variable</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-orgcd87161" class="outline-4">
<h4 id="orgcd87161"><span class="section-number-4">3.1.1</span> 在 Inventory 中定义变量</h4>
<div class="outline-text-4" id="text-3-1-1">
<div class="org-src-container">
<pre class="src src-ini">[mygroup]
host1
host2

[mygroup:vars]
proxy=1.2.3.4
</pre>
</div>
</div>
</div>


<div id="outline-container-orgd0ab7c7" class="outline-4">
<h4 id="orgd0ab7c7"><span class="section-number-4">3.1.2</span> 在 Playbook 中定义变量</h4>
<div class="outline-text-4" id="text-3-1-2">
</div>
<div id="outline-container-org772becd" class="outline-5">
<h5 id="org772becd"><span class="section-number-5">3.1.2.1</span> vars, vars_files 关键字</h5>
<div class="outline-text-5" id="text-3-1-2-1">
<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">hosts</span>: all
  <span style="color: #fd971f;">user</span>: root
  <span style="color: #fd971f;">vars</span>:
    <span style="color: #fd971f;">var1</span>: a
    <span style="color: #fd971f;">var2</span>: b
  <span style="color: #fd971f;">vars_files</span>:
    - /vars/nginx_vars.yml
</pre>
</div>

<p>
<code>/vars/nginx_vars.yml</code>:
</p>

<pre class="example">
http_port: 80
server_name: localhost
cert_file: /etc/nginx/ssl/nginx.crt
key_file: /etc/nginx/ssh/nginx.key
conf_file: /etc/nginx/conf/default.conf
</pre>
</div>
</div>

<div id="outline-container-orgd028672" class="outline-5">
<h5 id="orgd028672"><span class="section-number-5">3.1.2.2</span> vars_prompt 实现人机交互</h5>
<div class="outline-text-5" id="text-3-1-2-2">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #fd971f;">hosts</span>: all
<span style="color: #fd971f;">user</span>: root
<span style="color: #fd971f;">vars_prompt</span>:
  - <span style="color: #fd971f;">name</span>: <span style="color: #e6db74;">'https_passphrase'</span>          <span style="color: #465457;"># </span><span style="color: #465457;">&#21464;&#37327;&#21517;</span>
    <span style="color: #fd971f;">prompt</span>: <span style="color: #e6db74;">'Please input:'</span>
    <span style="color: #fd971f;">private</span>: yes                      <span style="color: #465457;"># </span><span style="color: #465457;">&#36755;&#20837;&#20869;&#23481;&#19981;&#20250;&#22312;&#32456;&#31471;&#26174;&#31034;</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org4608cf7" class="outline-5">
<h5 id="org4608cf7"><span class="section-number-5">3.1.2.3</span> 通过 roles 带入变量</h5>
</div>
</div>


<div id="outline-container-org533e5e9" class="outline-4">
<h4 id="org533e5e9"><span class="section-number-4">3.1.3</span> 注册变量</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
使用 <code>register</code> 将任务的执行结果保存到变量中
</p>

<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">hosts</span>: all
    <span style="color: #fd971f;">tasks</span>:
        - <span style="color: #fd971f;">shell</span>: cat /etc/hosts
          <span style="color: #fd971f;">register</span>: result
        - <span style="color: #fd971f;">shell</span>: echo <span style="color: #e6db74;">"/etc/hosts contains localhost"</span>
          <span style="color: #fd971f;">when</span>: result.stdout.find(<span style="color: #e6db74;">'localhost'</span>) <span style="color: #66d9ef; font-weight: bold;">!=</span> -1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">hosts</span>: all
    <span style="color: #fd971f;">tasks</span>:
      - <span style="color: #fd971f;">command</span>: ls /home
        <span style="color: #fd971f;">register</span>: result
      - <span style="color: #fd971f;">file</span>: path=/mnt/home/{{ item }} src=/home/{{ item }} state=link
        <span style="color: #fd971f;">with_items</span>: result.stdout_lines <span style="color: #465457;"># </span><span style="color: #465457;">same as with_items: result.stdout.split()</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-org1993a28" class="outline-4">
<h4 id="org1993a28"><span class="section-number-4">3.1.4</span> 通过 fact 获取/设置变量</h4>
<div class="outline-text-4" id="text-3-1-4">
<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">name</span>: Configure MySql
  <span style="color: #fd971f;">hosts</span>: sqlservers
  <span style="color: #fd971f;">tasks</span>:
    - <span style="color: #fd971f;">name</span>: Install MySql
      <span style="color: #fd971f;">yum</span>: name=mysql-server state=installed

    - <span style="color: #fd971f;">name</span>: Calculate InnoDB buffer pool size
      <span style="color: #fd971f;">set_fact</span>: innodb_buffer_pool_size_mb=<span style="color: #e6db74;">"{{ ansible_memtotal_mb / 2 }}"</span>

    - <span style="color: #fd971f;">name</span>: Configure MySql
      <span style="color: #fd971f;">template</span>: src=templates/mysql.cnf dest=/etc/mysql.cnf owner=root group=root mode=0644
      <span style="color: #fd971f;">notify</span>: restart mysql

    - <span style="color: #fd971f;">name</span>: Start MySql
      <span style="color: #fd971f;">service</span>: name=mysqld state=started enabled=yes

  <span style="color: #fd971f;">handlers</span>:
    - <span style="color: #fd971f;">name</span>: Restart MySql
      <span style="color: #fd971f;">service</span>: name=mysqld state=restarted
</pre>
</div>
</div>
</div>


<div id="outline-container-org0a2aa4d" class="outline-4">
<h4 id="org0a2aa4d"><span class="section-number-4">3.1.5</span> 内置变量</h4>
<div class="outline-text-4" id="text-3-1-5">
</div>
<div id="outline-container-org1670064" class="outline-5">
<h5 id="org1670064"><span class="section-number-5">3.1.5.1</span> hostvars</h5>
<div class="outline-text-5" id="text-3-1-5-1">
<p>
用于获取某台指定的主机的相关变量。
</p>

<p>
<code>{{ hostvars['db.example.com'].ansible_eth0.ipv4.address }}</code>
</p>

<p>
需要注意的是 <code>db.example.com</code> 不能使用 ip 地址来取代， <b>只能使用主机名或别名</b> 。
</p>
</div>
</div>


<div id="outline-container-orgb0acf16" class="outline-5">
<h5 id="orgb0acf16"><span class="section-number-5">3.1.5.2</span> inventory_hostname</h5>
<div class="outline-text-5" id="text-3-1-5-2">
<p>
利用 hostvars 和 inventory_hostname 变量，可以输出与当前主机相关联的所有变量：
</p>

<p>
<code>- debug: var=hostvars[inventory_hostname]</code>
</p>
</div>
</div>


<div id="outline-container-org5d2b237" class="outline-5">
<h5 id="org5d2b237"><span class="section-number-5">3.1.5.3</span> inventory_hostname_short</h5>
<div class="outline-text-5" id="text-3-1-5-3">
<p>
如果一台主机的 inventory_hostname 为 <code>server1.exmaple.com</code> ，则 inventory_hostname_short 的值为 server1 。
</p>
</div>
</div>


<div id="outline-container-org0dc6f73" class="outline-5">
<h5 id="org0dc6f73"><span class="section-number-5">3.1.5.4</span> group_names</h5>
<div class="outline-text-5" id="text-3-1-5-4">
<p>
用于标识当前正在执行 task 的目标主机位于的主机组。
</p>
</div>
</div>


<div id="outline-container-org06f9d7b" class="outline-5">
<h5 id="org06f9d7b"><span class="section-number-5">3.1.5.5</span> groups</h5>
<div class="outline-text-5" id="text-3-1-5-5">
<p>
当需要访问一组主机的变量时，groups 变量会很有用。
</p>

<p>
在所有的 dbservers 组的服务器上创建一个数据库用户 test ：
</p>

<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">name</span>: Create a user for all db servers
  <span style="color: #fd971f;">mysql_user</span>: name=test password=test host={{ hostvars.[item].ansible_eth0.ipv4.address }} state=present
  <span style="color: #fd971f;">with_items</span>: groups[<span style="color: #e6db74;">'dbservers'</span>]
</pre>
</div>
</div>
</div>


<div id="outline-container-org6c8a199" class="outline-5">
<h5 id="org6c8a199"><span class="section-number-5">3.1.5.6</span> play_hosts</h5>
<div class="outline-text-5" id="text-3-1-5-6">
<p>
当前 playbook 会在哪些 hosts 上运行。
</p>
</div>
</div>


<div id="outline-container-org5710f2f" class="outline-5">
<h5 id="org5710f2f"><span class="section-number-5">3.1.5.7</span> ansible_version</h5>
<div class="outline-text-5" id="text-3-1-5-7">
<p>
当前 ansible 的版本。
</p>
</div>
</div>


<div id="outline-container-orgac8e5c9" class="outline-5">
<h5 id="orgac8e5c9"><span class="section-number-5">3.1.5.8</span> inventory_dir</h5>
<div class="outline-text-5" id="text-3-1-5-8">
<p>
主机清单所在目录。
</p>
</div>
</div>


<div id="outline-container-org083457b" class="outline-5">
<h5 id="org083457b"><span class="section-number-5">3.1.5.9</span> inventory_file</h5>
<div class="outline-text-5" id="text-3-1-5-9">
<p>
主机清单文件。
</p>
</div>
</div>
</div>


<div id="outline-container-orge38dcf5" class="outline-4">
<h4 id="orge38dcf5"><span class="section-number-4">3.1.6</span> 通过命令行设置变量</h4>
<div class="outline-text-4" id="text-3-1-6">
<div class="org-src-container">
<pre class="src src-sh">--extra-vars <span style="color: #e6db74;">'user=starbucks'</span>
--extra-vars <span style="color: #e6db74;">'{"pacman":"mrs","ghosts":["inky","pinky","clyde","sue"]}'</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org3e89ad2" class="outline-3">
<h3 id="org3e89ad2"><span class="section-number-3">3.2</span> Tasks</h3>
<div class="outline-text-3" id="text-3-2">
<p>
每个任务需要包含的信息：
</p>

<ul class="org-ul">
<li>用到的模块</li>
<li>模块参数</li>
<li>用于描述的名称 [可选]</li>
<li>执行条件 [可选]</li>
</ul>

<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">name</span>: Example
  <span style="color: #fd971f;">hosts</span>: all
  <span style="color: #fd971f;">remote_user</span>: root
  <span style="color: #fd971f;">gather_facts</span>: <span style="color: #ae81ff;">True</span>
  <span style="color: #fd971f;">vars</span>:
    <span style="color: #fd971f;">user</span>: test
  <span style="color: #fd971f;">tasks</span>:
    - <span style="color: #fd971f;">name</span>: Create User
      <span style="color: #fd971f;">user</span>: name=<span style="color: #e6db74;">"{{ user }}"</span>
    - <span style="color: #fd971f;">name</span>: Install Apache on CentOS
        <span style="color: #fd971f;">yum</span>: name=httpd state=present
        <span style="color: #fd971f;">when</span>: ansible_os_family ==<span style="color: #e6db74;">"CentOS"</span>

</pre>
</div>
</div>
</div>



<div id="outline-container-orgec4b1b6" class="outline-3">
<h3 id="orgec4b1b6"><span class="section-number-3">3.3</span> Handlers</h3>
<div class="outline-text-3" id="text-3-3">
<p>
用于当关注的资源发生变化时采取一定的操作。
</p>

<p>
notify 这个 action 可用于在每个 play 的最后被触发，这样可以避免多次有改变发生时每次都执行指定的操作，
而仅在所有的变化发生完成后 <b>一次性</b> 地执行指定操作。
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #465457;">---</span>
- <span style="color: #fd971f;">hosts</span>: 10.74.68.55
  <span style="color: #fd971f;">remote_user</span>: cisco

  <span style="color: #fd971f;">tasks</span>:
    - <span style="color: #fd971f;">name</span>: create a file       <span style="color: #465457;"># </span><span style="color: #465457;">&#25551;&#36848;</span>
      <span style="color: #fd971f;">file</span>: name=/tmp/newfile state=touch <span style="color: #465457;"># </span><span style="color: #465457;">&#20351;&#29992;&#27169;&#22359;</span>
      <span style="color: #fd971f;">notify</span>: restart ssh service
    - <span style="color: #fd971f;">name</span>: run this command and ignore error
      <span style="color: #fd971f;">shell</span>: /usr/bin/nocommand
      <span style="color: #fd971f;">ignore_errors</span>: <span style="color: #ae81ff;">true</span>
    - <span style="color: #fd971f;">name</span>: start ssh service
      <span style="color: #fd971f;">service</span>: name=ssh state=started enabled=yes
      <span style="color: #fd971f;">become</span>: <span style="color: #ae81ff;">true</span>

  <span style="color: #fd971f;">handlers</span>:
    - <span style="color: #fd971f;">name</span>: restart ssh service
      <span style="color: #fd971f;">service</span>: name=ssh state=restarted
      <span style="color: #fd971f;">become</span>: <span style="color: #ae81ff;">true</span>
</pre>
</div>
</div>
</div>




<div id="outline-container-org9f2bacf" class="outline-3">
<h3 id="org9f2bacf"><span class="section-number-3">3.4</span> Template</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-sh">options {
    listen-on port 53 {
        127.0.0.1;
        {% for ip<span style="color: #f92672; font-weight: bold;"> in</span> ansible_all_ipv4_addresses %}
        {{ ip }};
        {% endfor %}
    };
};

{# Variables for zone config <span style="color: #465457;">#</span><span style="color: #465457;">}</span>

{% if <span style="color: #e6db74;">'authorativenames'</span><span style="color: #f92672; font-weight: bold;"> in</span> group_names %}
    {% set zone_type = <span style="color: #e6db74;">'master'</span> %}
{% else %}
    {% set zone_type = <span style="color: #e6db74;">'slave'</span> %}
{% endif %}

<span style="color: #a6e22e;">type</span> {{ zone_type }};

{% if <span style="color: #e6db74;">'authorativenames'</span> not<span style="color: #f92672; font-weight: bold;"> in</span> group_names %}
masters { 192.168.2.2; };
{% endif %}
</pre>
</div>
</div>
</div>



<div id="outline-container-org51aeea3" class="outline-3">
<h3 id="org51aeea3"><span class="section-number-3">3.5</span> When</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-orgfa9c442" class="outline-4">
<h4 id="orgfa9c442"><span class="section-number-4">3.5.1</span> 变量不存在</h4>
<div class="outline-text-4" id="text-3-5-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #fd971f;">tasks</span>:
  - <span style="color: #fd971f;">shell</span>: echo <span style="color: #e6db74;">"I've got '{{ foo }}' and am not afraid to use it!"</span>
    <span style="color: #fd971f;">when</span>: foo is defined
  - <span style="color: #fd971f;">fail</span>: msg=<span style="color: #e6db74;">"Bailing out. this play requires 'bar'"</span>
    <span style="color: #fd971f;">when</span>: bar is not defined
</pre>
</div>
</div>
</div>


<div id="outline-container-orgc8ecc2c" class="outline-4">
<h4 id="orgc8ecc2c"><span class="section-number-4">3.5.2</span> 用于循环</h4>
<div class="outline-text-4" id="text-3-5-2">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #fd971f;">tasks</span>:
  - <span style="color: #fd971f;">command</span>: echo {{ item }}
    <span style="color: #fd971f;">with_items</span>: [ 0, 2, 4, 6, 8, 10 ]
    <span style="color: #fd971f;">when</span>: item &gt; 56
</pre>
</div>
</div>
</div>


<div id="outline-container-org5cafb5c" class="outline-4">
<h4 id="org5cafb5c"><span class="section-number-4">3.5.3</span> 用于 include</h4>
<div class="outline-text-4" id="text-3-5-3">
<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">include</span>: tasks/sometasks.yml
  <span style="color: #fd971f;">when</span>: <span style="color: #e6db74;">"'reticulating splines' in output"</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org9ca9083" class="outline-4">
<h4 id="org9ca9083"><span class="section-number-4">3.5.4</span> 用于 roles</h4>
<div class="outline-text-4" id="text-3-5-4">
<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #fd971f;">hosts</span>: webservers
  <span style="color: #fd971f;">roles</span>:
     - { <span style="color: #fd971f;">role</span>: debian_stock_config, <span style="color: #fd971f;">when</span>: ansible_os_family == <span style="color: #e6db74;">'Debian'</span> }
</pre>
</div>
</div>
</div>
</div>




<div id="outline-container-org4459237" class="outline-3">
<h3 id="org4459237"><span class="section-number-3">3.6</span> 循环</h3>
<div class="outline-text-3" id="text-3-6">
</div>
<div id="outline-container-org1eb9795" class="outline-4">
<h4 id="org1eb9795"><span class="section-number-4">3.6.1</span> with_items</h4>
<div class="outline-text-4" id="text-3-6-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #465457;">---</span>
- <span style="color: #fd971f;">hosts</span>: 10.74.68.55
  <span style="color: #fd971f;">remote_user</span>: cisco

  <span style="color: #fd971f;">tasks</span>:
    - <span style="color: #fd971f;">name</span>: create files
      <span style="color: #fd971f;">file</span>: name=/tmp/{{item}} state=touch
      <span style="color: #fd971f;">with_items</span>:
        - a
        - b
        - c
</pre>
</div>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #465457;">---</span>
- <span style="color: #fd971f;">hosts</span>: 10.74.68.55
  <span style="color: #fd971f;">remote_user</span>: cisco

  <span style="color: #fd971f;">tasks</span>:
    - <span style="color: #fd971f;">name</span>: create users
      <span style="color: #fd971f;">user</span>: name={{item.name}} group={{item.group}}
      <span style="color: #fd971f;">with_items</span>:
        - {<span style="color: #fd971f;">name</span>: <span style="color: #e6db74;">'user1'</span>, <span style="color: #fd971f;">group</span>: <span style="color: #e6db74;">'g1'</span>}
        - {<span style="color: #fd971f;">name</span>: <span style="color: #e6db74;">'user2'</span>, <span style="color: #fd971f;">group</span>: <span style="color: #e6db74;">'g2'</span>}
        - {<span style="color: #fd971f;">name</span>: <span style="color: #e6db74;">'user3'</span>, <span style="color: #fd971f;">group</span>: <span style="color: #e6db74;">'g3'</span>}

</pre>
</div>
</div>
</div>


<div id="outline-container-org61b60ea" class="outline-4">
<h4 id="org61b60ea"><span class="section-number-4">3.6.2</span> with_nested</h4>
</div>

<div id="outline-container-org24ae568" class="outline-4">
<h4 id="org24ae568"><span class="section-number-4">3.6.3</span> with_dict</h4>
</div>

<div id="outline-container-orge408bf8" class="outline-4">
<h4 id="orge408bf8"><span class="section-number-4">3.6.4</span> with_subelement</h4>
</div>

<div id="outline-container-orgdf0e200" class="outline-4">
<h4 id="orgdf0e200"><span class="section-number-4">3.6.5</span> with_sequence</h4>
</div>

<div id="outline-container-org4733e6b" class="outline-4">
<h4 id="org4733e6b"><span class="section-number-4">3.6.6</span> with_random_choice</h4>
</div>

<div id="outline-container-org9b8be23" class="outline-4">
<h4 id="org9b8be23"><span class="section-number-4">3.6.7</span> do_util</h4>
</div>
</div>
</div>




<div id="outline-container-orgc824413" class="outline-2">
<h2 id="orgc824413"><span class="section-number-2">4</span> Role</h2>
<div class="outline-text-2" id="text-4">
<p>
在 Ansible 中，Playbook 组织 Task ，Role 组织 Playbook 。
</p>

<p>
用于层次性，结构化地组织 playbook 。Roles 能够根据层次型结构自动装载变量文件，tasks 以及 handlers 。<br>
要使用 roles 只需在 palybook 中使用 <code>include</code> 指令即可。
</p>

<p>
简单来讲，Roles 就是通过分别将变量，文件，任务，模板及处理器放置于单独的目录中，并可以便捷地 <code>include</code> 它们的一种机制。
</p>
</div>



<div id="outline-container-org5e0f7e2" class="outline-3">
<h3 id="org5e0f7e2"><span class="section-number-3">4.1</span> 创建</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-sh">ansible-galaxy init &lt;role&gt;
</pre>
</div>
</div>

<div id="outline-container-org135d432" class="outline-4">
<h4 id="org135d432"><span class="section-number-4">4.1.1</span> roles 各目录的作用</h4>
<div class="outline-text-4" id="text-4-1-1">
<dl class="org-dl">
<dt>files</dt><dd>存放由 copy 或 script 等模块调用的文件</dd>

<dt>tempaltes</dt><dd>Jinja2 模板文件</dd>

<dt>tasks</dt><dd><p>
  定义了角色的任务列表。
</p>

<p>
可以使用 include 包含其他的位于此目录中的 task 文件。
</p></dd>
</dl>


<dl class="org-dl">
<dt>handlers</dt><dd><p>
  用于定义角色用到的各 handler 。
</p>

<p>
在 handler 中可以使用 include 包含的其他位于此目录中 的 handler 文件。
</p></dd>

<dt>vars</dt><dd>用于定义角色用到的变量</dd>

<dt>meta</dt><dd>定义角色的特殊设定及依赖关系等</dd>

<dt>default</dt><dd>设定默认变量</dd>
</dl>
</div>
</div>
</div>


<div id="outline-container-org1ce6760" class="outline-3">
<h3 id="org1ce6760"><span class="section-number-3">4.2</span> pre_tasks 和 post_tasks</h3>
<div class="outline-text-3" id="text-4-2">
<p>
在执行 roles 时，需要在其前或其后执行某些任务，可以使用 pre_tasks 及 post_tasks 来声明。
</p>
</div>
</div>


<div id="outline-container-orgf77d0f6" class="outline-3">
<h3 id="orgf77d0f6"><span class="section-number-3">4.3</span> 依赖</h3>
<div class="outline-text-3" id="text-4-3">
<p>
如果当前 role 在执行前需要依赖另一个 role ，可以在 meta 目录中的 main.yml 文件中定义依赖关系。
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #fd971f;">dependencies</span>:
  - { <span style="color: #fd971f;">role</span>: common, <span style="color: #fd971f;">some_parameter</span>: 3 }
  - { <span style="color: #fd971f;">role</span>: postgres, <span style="color: #fd971f;">dbname</span>: blarg, <span style="color: #fd971f;">other_parameter</span>: 12 }

</pre>
</div>
</div>
</div>


<div id="outline-container-orgee23451" class="outline-3">
<h3 id="orgee23451"><span class="section-number-3">4.4</span> 项目结构</h3>
<div class="outline-text-3" id="text-4-4">
<pre class="example">
site.yml
ancible.cfg
hosts
group_vars/
   all
   group-1
   group-2
host_var/
   all
   host-1
   host-2
roles/
   common/
     files/
     templates/
     tasks/
     handlers/
     vars/
     defaults/
     meta/
   web/
     files/
     templates/
     tasks/
     handlers/
     vars/
     defaults/
     meta/
</pre>
</div>

<div id="outline-container-org0b8648e" class="outline-4">
<h4 id="org0b8648e"><span class="section-number-4">4.4.1</span> 入口文件 (site.xml)</h4>
<div class="outline-text-4" id="text-4-4-1">
<pre class="example">
---
- hosts: webservers
  user: root
  roles:
     - common
     - web
</pre>
</div>
</div>

<div id="outline-container-org530f0f5" class="outline-4">
<h4 id="org530f0f5"><span class="section-number-4">4.4.2</span> 执行</h4>
<div class="outline-text-4" id="text-4-4-2">
<div class="org-src-container">
<pre class="src src-sh">ansible-playbook site.yml -vvv
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>