<!DOCTYPE html>
<html>
<head>
<title>Ansible</title>
<!-- 2018-02-01 Thu 22:30 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="Hao Ruan">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link href="http://fonts.googleapis.com/css?family=Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet" type="text/css" />
<link href="../org-spec/css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Ansible</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Inventory</a>
<ul>
<li><a href="#sec-1-1">1.1. 静态</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Module</a>
<ul>
<li><a href="#sec-2-1">2.1. 文件处理</a>
<ul>
<li><a href="#sec-2-1-1">2.1.1. synchronize</a></li>
<li><a href="#sec-2-1-2">2.1.2. copy</a></li>
<li><a href="#sec-2-1-3">2.1.3. get_url</a></li>
<li><a href="#sec-2-1-4">2.1.4. template</a></li>
</ul>
</li>
<li><a href="#sec-2-2">2.2. 网络管理</a>
<ul>
<li><a href="#sec-2-2-1">2.2.1. ping</a></li>
</ul>
</li>
<li><a href="#sec-2-3">2.3. 服务管理</a>
<ul>
<li><a href="#sec-2-3-1">2.3.1. service</a></li>
<li><a href="#sec-2-3-2">2.3.2. cron</a></li>
</ul>
</li>
<li><a href="#sec-2-4">2.4. 远程执行</a>
<ul>
<li><a href="#sec-2-4-1">2.4.1. command</a></li>
<li><a href="#sec-2-4-2">2.4.2. shell</a></li>
</ul>
</li>
<li><a href="#sec-2-5">2.5. 资产管理</a>
<ul>
<li><a href="#sec-2-5-1">2.5.1. setup</a></li>
</ul>
</li>
<li><a href="#sec-2-6">2.6. 包管理</a>
<ul>
<li><a href="#sec-2-6-1">2.6.1. apt</a></li>
<li><a href="#sec-2-6-2">2.6.2. yum</a></li>
</ul>
</li>
<li><a href="#sec-2-7">2.7. 主要用于 Playbook 的模块</a>
<ul>
<li><a href="#sec-2-7-1">2.7.1. pause</a></li>
<li><a href="#sec-2-7-2">2.7.2. wait_for</a></li>
<li><a href="#sec-2-7-3">2.7.3. add_host</a></li>
<li><a href="#sec-2-7-4">2.7.4. group_by</a></li>
<li><a href="#sec-2-7-5">2.7.5. debug</a></li>
<li><a href="#sec-2-7-6">2.7.6. fail</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-3">3. Task</a></li>
<li><a href="#sec-4">4. Variable</a>
<ul>
<li><a href="#sec-4-1">4.1. 在 Inventory 中定义变量</a></li>
<li><a href="#sec-4-2">4.2. 在 Playbook 中定义变量</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. vars, vars_files 关键字</a></li>
<li><a href="#sec-4-2-2">4.2.2. vars_prompt 实现人机交互</a></li>
<li><a href="#sec-4-2-3">4.2.3. 通过 roles 带入变量</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. 注册变量</a></li>
<li><a href="#sec-4-4">4.4. 通过 fact 获取/设置变量</a></li>
<li><a href="#sec-4-5">4.5. 内置变量</a>
<ul>
<li><a href="#sec-4-5-1">4.5.1. hostvars</a></li>
<li><a href="#sec-4-5-2">4.5.2. inventory_hostname</a></li>
<li><a href="#sec-4-5-3">4.5.3. inventory_hostname_short</a></li>
<li><a href="#sec-4-5-4">4.5.4. group_names</a></li>
<li><a href="#sec-4-5-5">4.5.5. groups</a></li>
<li><a href="#sec-4-5-6">4.5.6. play_hosts</a></li>
<li><a href="#sec-4-5-7">4.5.7. ansible_version</a></li>
<li><a href="#sec-4-5-8">4.5.8. inventory_dir</a></li>
<li><a href="#sec-4-5-9">4.5.9. inventory_file</a></li>
</ul>
</li>
<li><a href="#sec-4-6">4.6. 通过命令行设置变量</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Template</a>
<ul>
<li><a href="#sec-5-1">5.1. 示例</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Playbook</a>
<ul>
<li><a href="#sec-6-1">6.1. 示例</a></li>
<li><a href="#sec-6-2">6.2. 循环</a>
<ul>
<li><a href="#sec-6-2-1">6.2.1. with_items</a></li>
<li><a href="#sec-6-2-2">6.2.2. with_nested</a></li>
<li><a href="#sec-6-2-3">6.2.3. with_dict</a></li>
<li><a href="#sec-6-2-4">6.2.4. with_subelement</a></li>
<li><a href="#sec-6-2-5">6.2.5. with_sequence</a></li>
<li><a href="#sec-6-2-6">6.2.6. with_random_choice</a></li>
<li><a href="#sec-6-2-7">6.2.7. do_util</a></li>
</ul>
</li>
<li><a href="#sec-6-3">6.3. 条件</a>
<ul>
<li><a href="#sec-6-3-1">6.3.1. when</a>
<ul>
<li><a href="#sec-6-3-1-1">6.3.1.1. jinja2 语法</a></li>
<li><a href="#sec-6-3-1-2">6.3.1.2. 变量不存在</a></li>
<li><a href="#sec-6-3-1-3">6.3.1.3. 用于循环</a></li>
<li><a href="#sec-6-3-1-4">6.3.1.4. 用于 include</a></li>
<li><a href="#sec-6-3-1-5">6.3.1.5. 用于 roles</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-6-4">6.4. handlers</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Role</a>
<ul>
<li><a href="#sec-7-1">7.1. 创建</a>
<ul>
<li><a href="#sec-7-1-1">7.1.1. roles 各目录的作用</a></li>
</ul>
</li>
<li><a href="#sec-7-2">7.2. pre_tasks 和 post_tasks</a></li>
<li><a href="#sec-7-3">7.3. 依赖</a></li>
<li><a href="#sec-7-4">7.4. 项目结构</a>
<ul>
<li><a href="#sec-7-4-1">7.4.1. 入口文件 (site.xml)</a></li>
<li><a href="#sec-7-4-2">7.4.2. 执行</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="meta">
<table>


<colgroup>
<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="left">Author</td>
<td class="left">Hao Ruan (ruanhao1116@gmail.com)</td>
</tr>

<tr>
<td class="left">Date</td>
<td class="left">2018-02-01 22:30:26</td>
</tr>
</tbody>
</table>

<pre class="example">
<p>
Ansible is used to:
  -&gt; execute <b>tasks</b> for an <b>inventory</b>,
  -&gt; utilizing some <b>modules</b>,
  -&gt; using or populating some <b>variables</b>,
  -&gt; processing some file <b>templates</b>,
  -&gt; in a <b>playbook</b>, which can be organized in <b>roles</b>.
</p>
</pre>

</div>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Inventory</a>
<ul>
<li><a href="#sec-1-1">1.1. 静态</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Module</a>
<ul>
<li><a href="#sec-2-1">2.1. 文件处理</a>
<ul>
<li><a href="#sec-2-1-1">2.1.1. synchronize</a></li>
<li><a href="#sec-2-1-2">2.1.2. copy</a></li>
<li><a href="#sec-2-1-3">2.1.3. get_url</a></li>
<li><a href="#sec-2-1-4">2.1.4. template</a></li>
</ul>
</li>
<li><a href="#sec-2-2">2.2. 网络管理</a>
<ul>
<li><a href="#sec-2-2-1">2.2.1. ping</a></li>
</ul>
</li>
<li><a href="#sec-2-3">2.3. 服务管理</a>
<ul>
<li><a href="#sec-2-3-1">2.3.1. service</a></li>
<li><a href="#sec-2-3-2">2.3.2. cron</a></li>
</ul>
</li>
<li><a href="#sec-2-4">2.4. 远程执行</a>
<ul>
<li><a href="#sec-2-4-1">2.4.1. command</a></li>
<li><a href="#sec-2-4-2">2.4.2. shell</a></li>
</ul>
</li>
<li><a href="#sec-2-5">2.5. 资产管理</a>
<ul>
<li><a href="#sec-2-5-1">2.5.1. setup</a></li>
</ul>
</li>
<li><a href="#sec-2-6">2.6. 包管理</a>
<ul>
<li><a href="#sec-2-6-1">2.6.1. apt</a></li>
<li><a href="#sec-2-6-2">2.6.2. yum</a></li>
</ul>
</li>
<li><a href="#sec-2-7">2.7. 主要用于 Playbook 的模块</a>
<ul>
<li><a href="#sec-2-7-1">2.7.1. pause</a></li>
<li><a href="#sec-2-7-2">2.7.2. wait_for</a></li>
<li><a href="#sec-2-7-3">2.7.3. add_host</a></li>
<li><a href="#sec-2-7-4">2.7.4. group_by</a></li>
<li><a href="#sec-2-7-5">2.7.5. debug</a></li>
<li><a href="#sec-2-7-6">2.7.6. fail</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-3">3. Task</a></li>
<li><a href="#sec-4">4. Variable</a>
<ul>
<li><a href="#sec-4-1">4.1. 在 Inventory 中定义变量</a></li>
<li><a href="#sec-4-2">4.2. 在 Playbook 中定义变量</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. vars, vars_files 关键字</a></li>
<li><a href="#sec-4-2-2">4.2.2. vars_prompt 实现人机交互</a></li>
<li><a href="#sec-4-2-3">4.2.3. 通过 roles 带入变量</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. 注册变量</a></li>
<li><a href="#sec-4-4">4.4. 通过 fact 获取/设置变量</a></li>
<li><a href="#sec-4-5">4.5. 内置变量</a>
<ul>
<li><a href="#sec-4-5-1">4.5.1. hostvars</a></li>
<li><a href="#sec-4-5-2">4.5.2. inventory_hostname</a></li>
<li><a href="#sec-4-5-3">4.5.3. inventory_hostname_short</a></li>
<li><a href="#sec-4-5-4">4.5.4. group_names</a></li>
<li><a href="#sec-4-5-5">4.5.5. groups</a></li>
<li><a href="#sec-4-5-6">4.5.6. play_hosts</a></li>
<li><a href="#sec-4-5-7">4.5.7. ansible_version</a></li>
<li><a href="#sec-4-5-8">4.5.8. inventory_dir</a></li>
<li><a href="#sec-4-5-9">4.5.9. inventory_file</a></li>
</ul>
</li>
<li><a href="#sec-4-6">4.6. 通过命令行设置变量</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Template</a>
<ul>
<li><a href="#sec-5-1">5.1. 示例</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Playbook</a>
<ul>
<li><a href="#sec-6-1">6.1. 示例</a></li>
<li><a href="#sec-6-2">6.2. 循环</a>
<ul>
<li><a href="#sec-6-2-1">6.2.1. with_items</a></li>
<li><a href="#sec-6-2-2">6.2.2. with_nested</a></li>
<li><a href="#sec-6-2-3">6.2.3. with_dict</a></li>
<li><a href="#sec-6-2-4">6.2.4. with_subelement</a></li>
<li><a href="#sec-6-2-5">6.2.5. with_sequence</a></li>
<li><a href="#sec-6-2-6">6.2.6. with_random_choice</a></li>
<li><a href="#sec-6-2-7">6.2.7. do_util</a></li>
</ul>
</li>
<li><a href="#sec-6-3">6.3. 条件</a>
<ul>
<li><a href="#sec-6-3-1">6.3.1. when</a></li>
</ul>
</li>
<li><a href="#sec-6-4">6.4. handlers</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Role</a>
<ul>
<li><a href="#sec-7-1">7.1. 创建</a>
<ul>
<li><a href="#sec-7-1-1">7.1.1. roles 各目录的作用</a></li>
</ul>
</li>
<li><a href="#sec-7-2">7.2. pre_tasks 和 post_tasks</a></li>
<li><a href="#sec-7-3">7.3. 依赖</a></li>
<li><a href="#sec-7-4">7.4. 项目结构</a>
<ul>
<li><a href="#sec-7-4-1">7.4.1. 入口文件 (site.xml)</a></li>
<li><a href="#sec-7-4-2">7.4.2. 执行</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Inventory</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> 静态</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-ini">[<span style="color: #0087ff;">master</span>]
server-master        ansible_ssh_host=10.0.0.5    ansible_ssh_user=ubuntu

[<span style="color: #0087ff;">standbys</span>]
server-standby-01    ansible_ssh_host=10.0.0.6    ansible_ssh_user=ubuntu
server-standby-02    ansible_ssh_host=10.0.0.7    ansible_ssh_user=ubuntu

[<span style="color: #0087ff;">replication:children</span>]
master
standbys
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Module</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> 文件处理</h3>
<div class="outline-text-3" id="text-2-1">
</div><div id="outline-container-sec-2-1-1" class="outline-4">
<h4 id="sec-2-1-1"><span class="section-number-4">2.1.1</span> synchronize</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">

<pre class="src src-sh">synchronize: <span style="color: #0087ff;">src</span>=some/relative/path <span style="color: #0087ff;">dest</span>=/some/absolute/path <span style="color: #0087ff;">rsync_path</span>=<span style="color: #00afaf;">"sudo rsync"</span>
synchronize: <span style="color: #0087ff;">src</span>=some/relative/path <span style="color: #0087ff;">dest</span>=/some/absolute/path <span style="color: #0087ff;">archive</span>=no   <span style="color: #0087ff;">links</span>=yes
synchronize: <span style="color: #0087ff;">src</span>=some/relative/path <span style="color: #0087ff;">dest</span>=/some/absolute/path <span style="color: #0087ff;">checksum</span>=yes <span style="color: #0087ff;">times</span>=no
synchronize: <span style="color: #0087ff;">src</span>=some/relative/path <span style="color: #0087ff;">dest</span>=/some/absolute/path <span style="color: #0087ff;">rsync_opts</span>=--no-motd,--exclude=.git <span style="color: #0087ff;">mode</span>=pull
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-2-1-2" class="outline-4">
<h4 id="sec-2-1-2"><span class="section-number-4">2.1.2</span> copy</h4>
<div class="outline-text-4" id="text-2-1-2">
<dl class="org-dl">
<dt> src </dt><dd>  本地文件地址，可以是绝对路径，也可以是相对路径。 如果路径是一个目录，它将递归复制。

<p>
如果路径使用 <code>/</code> 来结尾，则只复制目录里的内容；如果没有使用 <code>/</code> 来结尾，则包含目录在内的整个内容全部复制，类似于 <code>rsync</code> 。
</p>
</dd>

<dt> dest </dt><dd>  远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录。
</dd>

<dt> force </dt><dd>  如果设置为 <code>yes</code> （默认），则强制覆盖。
</dd>
</dl>
</div>
</div>


<div id="outline-container-sec-2-1-3" class="outline-4">
<h4 id="sec-2-1-3"><span class="section-number-4">2.1.3</span> get_url</h4>
<div class="outline-text-4" id="text-2-1-3">
<div class="org-src-container">

<pre class="src src-sh">get_url: <span style="color: #0087ff;">url</span>=http://example.com/path/file.conf <span style="color: #0087ff;">dest</span>=/etc/foo.conf <span style="color: #0087ff;">mode</span>=0440
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-4" class="outline-4">
<h4 id="sec-2-1-4"><span class="section-number-4">2.1.4</span> template</h4>
</div>
</div>



<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> 网络管理</h3>
<div class="outline-text-3" id="text-2-2">
</div><div id="outline-container-sec-2-2-1" class="outline-4">
<h4 id="sec-2-2-1"><span class="section-number-4">2.2.1</span> ping</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
<code>ansible &lt;pattern&gt; -m ping</code>
</p>
</div>
</div>
</div>


<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> 服务管理</h3>
<div class="outline-text-3" id="text-2-3">
</div><div id="outline-container-sec-2-3-1" class="outline-4">
<h4 id="sec-2-3-1"><span class="section-number-4">2.3.1</span> service</h4>
<div class="outline-text-4" id="text-2-3-1">
<dl class="org-dl">
<dt> enabled </dt><dd>  是否开机启动
</dd>

<dt> name </dt><dd>  服务名称
</dd>

<dt> pattern </dt><dd>  就会通过 <code>ps</code> 命令在进程中根据该模式进行查找，如果找到，则认为该服务依然在运行。
</dd>

<dt> sleep </dt><dd>  如果执行了 <code>restarted</code> ，在则 stop 和 start 之间等待几秒。
</dd>

<dt> state </dt><dd>  <code>started</code> , <code>stopped</code> , <code>restarted</code> , <code>reloaded</code>
</dd>
</dl>


<div class="org-src-container">

<pre class="src src-sh">service: <span style="color: #0087ff;">name</span>=httpd <span style="color: #0087ff;">state</span>=started <span style="color: #0087ff;">enabled</span>=yes
service: <span style="color: #0087ff;">name</span>=foo <span style="color: #0087ff;">pattern</span>=/usr/bin/foo <span style="color: #0087ff;">state</span>=started <span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#33509;&#21551;&#21160;&#21518;&#21457;&#29616; /usr/bin/foo &#36825;&#20010;&#36827;&#31243;&#23384;&#22312;&#65292;&#21017;&#35748;&#20026;&#21551;&#21160;&#25104;&#21151;</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-2-3-2" class="outline-4">
<h4 id="sec-2-3-2"><span class="section-number-4">2.3.2</span> cron</h4>
<div class="outline-text-4" id="text-2-3-2">
<dl class="org-dl">
<dt> backup </dt><dd>  先备份原任务计划内容
</dd>
</dl>


<dl class="org-dl">
<dt> job </dt><dd>  执行的任务（命令）
</dd>

<dt> name </dt><dd>  任务的描述
</dd>
</dl>


<dl class="org-dl">
<dt> special_time </dt><dd>  <code>reboot</code> , <code>yearly</code> , <code>annually</code> , <code>monthly</code> , <code>weekly</code> , <code>daily</code> , <code>hourly</code>
</dd>
</dl>


<dl class="org-dl">
<dt> state </dt><dd>  创建 (<code>present</code>) / 删除(<code>absent</code>)
</dd>

<dt> user </dt><dd>  执行用户身份
</dd>
</dl>


<div class="org-src-container">

<pre class="src src-sh">cron: <span style="color: #0087ff;">name</span>=do_something_when_reboot <span style="color: #0087ff;">special_time</span>=reboot <span style="color: #0087ff;">job</span>=<span style="color: #00afaf;">"/some/job.sh"</span>
cron: <span style="color: #0087ff;">name</span>=do_something_when_reboot <span style="color: #0087ff;">state</span>=absent
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> 远程执行</h3>
<div class="outline-text-3" id="text-2-4">
</div><div id="outline-container-sec-2-4-1" class="outline-4">
<h4 id="sec-2-4-1"><span class="section-number-4">2.4.1</span> command</h4>
<div class="outline-text-4" id="text-2-4-1">
<dl class="org-dl">
<dt> creates </dt><dd>  指定一个文件名，如果给文件存在，则不执行。
</dd>

<dt> removes </dt><dd>  指定一个文件名，如果给文件不存在，则不执行。
</dd>

<dt> chdir </dt><dd>  执行命令前，切换到指定目录。
</dd>
</dl>
</div>
</div>


<div id="outline-container-sec-2-4-2" class="outline-4">
<h4 id="sec-2-4-2"><span class="section-number-4">2.4.2</span> shell</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
和 <code>command</code> 类似， <b>但支持管道</b> 。
</p>
</div>
</div>
</div>


<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> 资产管理</h3>
<div class="outline-text-3" id="text-2-5">
</div><div id="outline-container-sec-2-5-1" class="outline-4">
<h4 id="sec-2-5-1"><span class="section-number-4">2.5.1</span> setup</h4>
<div class="outline-text-4" id="text-2-5-1">
<div class="org-src-container">

<pre class="src src-sh">ansible &lt;pattern&gt; -m setup -a <span style="color: #00afaf;">'filter=ansible_*_mb'</span>     <span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#26597;&#30475;&#20027;&#26426;&#20869;&#23384;&#20449;&#24687;</span>
ansible &lt;pattern&gt; -m setup -a <span style="color: #00afaf;">'filter=ansible_eth[0-2]'</span> <span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#26597;&#30475;&#22320;&#25509;&#21475;&#20026;eth0-2&#30340;&#32593;&#21345;&#20449;&#24687;</span>
ansible &lt;pattern&gt; -m setup --tree /tmp/facts            <span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#23558;&#25152;&#26377;&#20027;&#26426;&#30340;&#20449;&#24687;&#36755;&#20837;&#21040; /tmp/facts &#30446;&#24405;&#19979;</span>
</pre>
</div>
</div>
</div>
</div>





<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> 包管理</h3>
<div class="outline-text-3" id="text-2-6">
</div><div id="outline-container-sec-2-6-1" class="outline-4">
<h4 id="sec-2-6-1"><span class="section-number-4">2.6.1</span> apt</h4>
</div>

<div id="outline-container-sec-2-6-2" class="outline-4">
<h4 id="sec-2-6-2"><span class="section-number-4">2.6.2</span> yum</h4>
</div>
</div>


<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7"><span class="section-number-3">2.7</span> 主要用于 Playbook 的模块</h3>
<div class="outline-text-3" id="text-2-7">
</div><div id="outline-container-sec-2-7-1" class="outline-4">
<h4 id="sec-2-7-1"><span class="section-number-4">2.7.1</span> pause</h4>
<div class="outline-text-4" id="text-2-7-1">
<p>
执行的过程中暂停一定时间或者提示用户进行某些操作。
</p>

<div class="org-src-container">

<pre class="src src-sh">pause: <span style="color: #0087ff;">prompt</span>=<span style="color: #00afaf;">"ENTER to continue CTRL-C a to quit"</span>
pause: <span style="color: #0087ff;">seconds</span>=30
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-2-7-2" class="outline-4">
<h4 id="sec-2-7-2"><span class="section-number-4">2.7.2</span> wait_for</h4>
<div class="outline-text-4" id="text-2-7-2">
<p>
执行过程中等待某些操作完成以后再进行后续操作。
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#31561;&#24453; 8080 &#31471;&#21475;&#24050;&#27491;&#24120;&#30417;&#21548;&#65292;&#25165;&#24320;&#22987;&#19979;&#19968;&#20010;&#20219;&#21153;</span>
wait_for: <span style="color: #0087ff;">port</span>=8080 <span style="color: #0087ff;">state</span>=started

<span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#31561;&#24453; 8000 &#31471;&#21475;&#27491;&#24120;&#30417;&#21548;&#65292;&#27599;&#38548; 10s &#26816;&#26597;&#19968;&#27425;&#65292;&#30452;&#33267;&#31561;&#24453;&#36229;&#26102;</span>
wait_for: <span style="color: #0087ff;">port</span>=8000 <span style="color: #0087ff;">delay</span>=10

<span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#31561;&#24453; 8000 &#31471;&#21475;&#30452;&#33267;&#26377;&#36830;&#25509;&#24314;&#31435;</span>
wait_for: <span style="color: #0087ff;">host</span>=0.0.0.0 <span style="color: #0087ff;">port</span>=8000 <span style="color: #0087ff;">delay</span>=10 <span style="color: #0087ff;">state</span>=drained

<span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#31561;&#24453; 8000 &#31471;&#21475;&#26377;&#36830;&#25509;&#24314;&#31435;&#65292;&#22914;&#26524;&#36830;&#25509;&#26469;&#33258;10.2.1.2&#25110;&#32773;10.2.1.3&#65292;&#21017;&#24573;&#30053;</span>
wait_for: <span style="color: #0087ff;">host</span>=0.0.0.0 <span style="color: #0087ff;">port</span>=8000 <span style="color: #0087ff;">state</span>=drained <span style="color: #0087ff;">exclude_hosts</span>=10.2.1.2,10.2.1.3

<span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#31561;&#24453; /tmp/foo &#25991;&#20214;&#24050;&#21019;&#24314;</span>
wait_for: <span style="color: #0087ff;">path</span>=/tmp/foo

<span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#31561;&#24453; /tmp/foo &#25991;&#20214;&#24050;&#21019;&#24314;&#65292;&#32780;&#19988;&#35813;&#25991;&#20214;&#20013;&#38656;&#35201;&#21253;&#21547; completed &#23383;&#31526;&#20018;</span>
wait_for: <span style="color: #0087ff;">path</span>=/tmp/foo <span style="color: #0087ff;">search_regex</span>=completed

<span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#31561;&#24453; /var/lock/file.lock &#34987;&#21024;&#38500;</span>
wait_for: <span style="color: #0087ff;">path</span>=/var/lock/file.lock <span style="color: #0087ff;">state</span>=absent

<span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#31561;&#24453;&#25351;&#23450;&#30340;&#36827;&#31243;&#34987;&#38144;&#27585;</span>
wait_for: <span style="color: #0087ff;">path</span>=/proc/3466/status <span style="color: #0087ff;">state</span>=absent
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-2-7-3" class="outline-4">
<h4 id="sec-2-7-3"><span class="section-number-4">2.7.3</span> add_host</h4>
<div class="outline-text-4" id="text-2-7-3">
<p>
执行的过程中动态的添加主机到指定的主机组中。
</p>
</div>
</div>


<div id="outline-container-sec-2-7-4" class="outline-4">
<h4 id="sec-2-7-4"><span class="section-number-4">2.7.4</span> group_by</h4>
<div class="outline-text-4" id="text-2-7-4">
<p>
执行的过程中动态的创建主机组。
</p>

<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">name</span>: Create operating system group
  <span style="color: #0087ff;">hosts</span>: all
  <span style="color: #0087ff;">tasks</span>:
    - <span style="color: #0087ff;">group_by</span>: key=os_{{ ansible_distribution }}

- <span style="color: #0087ff;">name</span>: Run on CentOS hosts only
  <span style="color: #0087ff;">hosts</span>: os_CentOS
  <span style="color: #0087ff;">tasks</span>:
    - <span style="color: #0087ff;">name</span>: Install Apache
      <span style="color: #0087ff;">yum</span>: name=httpd state=latest

- <span style="color: #0087ff;">name</span>: Run on Ubuntu hosts only
  <span style="color: #0087ff;">hosts</span>: os_Ubuntu
  <span style="color: #0087ff;">tasks</span>:
    - <span style="color: #0087ff;">name</span>: Install Apache
      <span style="color: #0087ff;">apt</span>: pkg=apache2 state=latest
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-7-5" class="outline-4">
<h4 id="sec-2-7-5"><span class="section-number-4">2.7.5</span> debug</h4>
<div class="outline-text-4" id="text-2-7-5">
<p>
用于在调试中输出信息。
</p>

<div class="org-src-container">

<pre class="src src-yaml"><span style="color: #0087ff;">debug</span>: msg=<span style="color: #00afaf;">"System {{ inventory_hostname }} has gateway {{ ansible_default_ipv4.gateway }}"</span>
<span style="color: #0087ff;">debug</span>: var=result verbosity=2
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-7-6" class="outline-4">
<h4 id="sec-2-7-6"><span class="section-number-4">2.7.6</span> fail</h4>
<div class="outline-text-4" id="text-2-7-6">
<p>
通常与条件语句组合使用，当满足条件时，终止当前 play 的运行。
</p>

<div class="org-src-container">

<pre class="src src-yaml"><span style="color: #0087ff;">fail</span>: msg=<span style="color: #00afaf;">"..."</span>
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Task</h2>
<div class="outline-text-2" id="text-3">
<p>
每个任务需要包含的信息：
</p>

<ul class="org-ul">
<li>用到的模块
</li>
<li>模块参数
</li>
<li>用于描述的名称 [可选]
</li>
<li>执行条件 [可选]
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Variable</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> 在 Inventory 中定义变量</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">

<pre class="src src-ini">[<span style="color: #0087ff;">mygroup</span>]
host1
host2

[<span style="color: #0087ff;">mygroup:vars</span>]
<span style="color: #0087ff;">proxy</span>=1.2.3.4
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> 在 Playbook 中定义变量</h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> vars, vars_files 关键字</h4>
<div class="outline-text-4" id="text-4-2-1">
<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">hosts</span>: all
  <span style="color: #0087ff;">user</span>: root
  <span style="color: #0087ff;">vars</span>:
    <span style="color: #0087ff;">var1</span>: a
    <span style="color: #0087ff;">var2</span>: b
  <span style="color: #0087ff;">vars_files</span>:
    - /vars/nginx_vars.yml
</pre>
</div>

<p>
<code>/vars/nginx_vars.yml</code>:
</p>

<pre class="example">
http_port: 80
server_name: localhost
cert_file: /etc/nginx/ssl/nginx.crt
key_file: /etc/nginx/ssh/nginx.key
conf_file: /etc/nginx/conf/default.conf
</pre>
</div>
</div>

<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> vars_prompt 实现人机交互</h4>
<div class="outline-text-4" id="text-4-2-2">
<div class="org-src-container">

<pre class="src src-yaml"><span style="color: #0087ff;">hosts</span>: all
<span style="color: #0087ff;">user</span>: root
<span style="color: #0087ff;">vars_prompt</span>:
  - <span style="color: #0087ff;">name</span>: <span style="color: #00afaf;">'https_passphrase'</span>          <span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#21464;&#37327;&#21517;</span>
    <span style="color: #0087ff;">prompt</span>: <span style="color: #00afaf;">'Please input:'</span>
    <span style="color: #0087ff;">private</span>: yes                      <span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">&#36755;&#20837;&#20869;&#23481;&#19981;&#20250;&#22312;&#32456;&#31471;&#26174;&#31034;</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-4-2-3" class="outline-4">
<h4 id="sec-4-2-3"><span class="section-number-4">4.2.3</span> 通过 roles 带入变量</h4>
</div>
</div>


<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> 注册变量</h3>
<div class="outline-text-3" id="text-4-3">
<p>
使用 <code>register</code> 将任务的执行结果保存到变量中
</p>

<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">hosts</span>: all
    <span style="color: #0087ff;">tasks</span>:
        - <span style="color: #0087ff;">shell</span>: cat /etc/hosts
          <span style="color: #0087ff;">register</span>: result
        - <span style="color: #0087ff;">shell</span>: echo <span style="color: #00afaf;">"/etc/hosts contains localhost"</span>
          <span style="color: #0087ff;">when</span>: result.stdout.find(<span style="color: #00afaf;">'localhost'</span>) <span style="color: #af8700;">!=</span> -1
</pre>
</div>

<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">hosts</span>: all
    <span style="color: #0087ff;">tasks</span>:
      - <span style="color: #0087ff;">command</span>: ls /home
        <span style="color: #0087ff;">register</span>: result
      - <span style="color: #0087ff;">file</span>: path=/mnt/home/{{ item }} src=/home/{{ item }} state=link
        <span style="color: #0087ff;">with_items</span>: result.stdout_lines <span style="color: #585858; font-style: italic;"># </span><span style="color: #585858; font-style: italic;">same as with_items: result.stdout.split()</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> 通过 fact 获取/设置变量</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">name</span>: Configure MySql
  <span style="color: #0087ff;">hosts</span>: sqlservers
  <span style="color: #0087ff;">tasks</span>:
    - <span style="color: #0087ff;">name</span>: Install MySql
      <span style="color: #0087ff;">yum</span>: name=mysql-server state=installed

    - <span style="color: #0087ff;">name</span>: Calculate InnoDB buffer pool size
      <span style="color: #0087ff;">set_fact</span>: innodb_buffer_pool_size_mb=<span style="color: #00afaf;">"{{ ansible_memtotal_mb / 2 }}"</span>

    - <span style="color: #0087ff;">name</span>: Configure MySql
      <span style="color: #0087ff;">template</span>: src=templates/mysql.cnf dest=/etc/mysql.cnf owner=root group=root mode=0644
      <span style="color: #0087ff;">notify</span>: restart mysql

    - <span style="color: #0087ff;">name</span>: Start MySql
      <span style="color: #0087ff;">service</span>: name=mysqld state=started enabled=yes

  <span style="color: #0087ff;">handlers</span>:
    - <span style="color: #0087ff;">name</span>: Restart MySql
      <span style="color: #0087ff;">service</span>: name=mysqld state=restarted
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> 内置变量</h3>
<div class="outline-text-3" id="text-4-5">
</div><div id="outline-container-sec-4-5-1" class="outline-4">
<h4 id="sec-4-5-1"><span class="section-number-4">4.5.1</span> hostvars</h4>
<div class="outline-text-4" id="text-4-5-1">
<p>
用于获取某台指定的主机的相关变量。
</p>

<p>
<code>{{ hostvars['db.example.com'].ansible_eth0.ipv4.address }}</code>
</p>

<p>
需要注意的是 <code>db.example.com</code> 不能使用 ip 地址来取代， <b>只能使用主机名或别名</b> 。
</p>
</div>
</div>


<div id="outline-container-sec-4-5-2" class="outline-4">
<h4 id="sec-4-5-2"><span class="section-number-4">4.5.2</span> inventory_hostname</h4>
<div class="outline-text-4" id="text-4-5-2">
<p>
利用 hostvars 和 inventory_hostname 变量，可以输出与当前主机相关联的所有变量：
</p>

<p>
<code>- debug: var=hostvars[inventory_hostname]</code>
</p>
</div>
</div>


<div id="outline-container-sec-4-5-3" class="outline-4">
<h4 id="sec-4-5-3"><span class="section-number-4">4.5.3</span> inventory_hostname_short</h4>
<div class="outline-text-4" id="text-4-5-3">
<p>
如果一台主机的 inventory_hostname 为 <code>server1.exmaple.com</code> ，则 inventory_hostname_short 的值为 server1 。
</p>
</div>
</div>


<div id="outline-container-sec-4-5-4" class="outline-4">
<h4 id="sec-4-5-4"><span class="section-number-4">4.5.4</span> group_names</h4>
<div class="outline-text-4" id="text-4-5-4">
<p>
用于标识当前正在执行 task 的目标主机位于的主机组。
</p>
</div>
</div>


<div id="outline-container-sec-4-5-5" class="outline-4">
<h4 id="sec-4-5-5"><span class="section-number-4">4.5.5</span> groups</h4>
<div class="outline-text-4" id="text-4-5-5">
<p>
当需要访问一组主机的变量时，groups 变量会很有用。
</p>

<p>
在所有的 dbservers 组的服务器上创建一个数据库用户 test ：
</p>

<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">name</span>: Create a user for all db servers
  <span style="color: #0087ff;">mysql_user</span>: name=test password=test host={{ hostvars.[item].ansible_eth0.ipv4.address }} state=present
  <span style="color: #0087ff;">with_items</span>: groups[<span style="color: #00afaf;">'dbservers'</span>]
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-4-5-6" class="outline-4">
<h4 id="sec-4-5-6"><span class="section-number-4">4.5.6</span> play_hosts</h4>
<div class="outline-text-4" id="text-4-5-6">
<p>
当前 playbook 会在哪些 hosts 上运行。
</p>
</div>
</div>


<div id="outline-container-sec-4-5-7" class="outline-4">
<h4 id="sec-4-5-7"><span class="section-number-4">4.5.7</span> ansible_version</h4>
<div class="outline-text-4" id="text-4-5-7">
<p>
当前 ansible 的版本。
</p>
</div>
</div>


<div id="outline-container-sec-4-5-8" class="outline-4">
<h4 id="sec-4-5-8"><span class="section-number-4">4.5.8</span> inventory_dir</h4>
<div class="outline-text-4" id="text-4-5-8">
<p>
主机清单所在目录。
</p>
</div>
</div>


<div id="outline-container-sec-4-5-9" class="outline-4">
<h4 id="sec-4-5-9"><span class="section-number-4">4.5.9</span> inventory_file</h4>
<div class="outline-text-4" id="text-4-5-9">
<p>
主机清单文件。
</p>
</div>
</div>
</div>


<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> 通过命令行设置变量</h3>
<div class="outline-text-3" id="text-4-6">
<div class="org-src-container">

<pre class="src src-sh">--extra-vars <span style="color: #00afaf;">'user=starbucks'</span>
--extra-vars <span style="color: #00afaf;">'{"pacman":"mrs","ghosts":["inky","pinky","clyde","sue"]}'</span>
</pre>
</div>
</div>
</div>
</div>





<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Template</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> 示例</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">

<pre class="src src-sh">options {
    listen-on port 53 {
        127.0.0.1;
        {% for ip<span style="color: #5f8700;"> in</span> ansible_all_ipv4_addresses %}
        {{ ip }};
        {% endfor %}
    };
};

{# Variables for zone config <span style="color: #585858; font-style: italic;">#</span><span style="color: #585858; font-style: italic;">}</span>

{% if <span style="color: #00afaf;">'authorativenames'</span><span style="color: #5f8700;"> in</span> group_names %}
    {% set zone_type = <span style="color: #00afaf;">'master'</span> %}
{% else %}
    {% set zone_type = <span style="color: #00afaf;">'slave'</span> %}
{% endif %}

<span style="color: #5f8700;">type</span> {{ zone_type }};

{% if <span style="color: #00afaf;">'authorativenames'</span> not<span style="color: #5f8700;"> in</span> group_names %}
masters { 192.168.2.2; };
{% endif %}
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Playbook</h2>
<div class="outline-text-2" id="text-6">
<p>
ansbile-playbook 是一系列 ansible 命令的集合，使用 yaml 语言编写。
playbook 命令根据自上而下的顺序依次执行。
</p>

<p>
playbook 允许你传输某个命令的状态到后面的指令, 如可以从一台机器的文件中抓取内容并附为变量,
然后在另一台机器中使用, 这使得可以实现一些复杂的部署机制, 这是 ansible 命令无法实现的。
</p>


<div class="figure">
<p><img src="img/ansible-playbook.png" alt="ansible-playbook.png">
</p>
</div>
</div>

<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> 示例</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">name</span>: Example
  <span style="color: #0087ff;">hosts</span>: all
  <span style="color: #0087ff;">user</span>: root
  <span style="color: #0087ff;">gather_facts</span>: <span style="color: #00afaf;">True</span>
  <span style="color: #0087ff;">vars</span>:
    <span style="color: #0087ff;">user</span>: test
  <span style="color: #0087ff;">tasks</span>:
    - <span style="color: #0087ff;">name</span>: Create User
      <span style="color: #0087ff;">user</span>: name=<span style="color: #00afaf;">"{{ user }}"</span>
    - <span style="color: #0087ff;">name</span>: Install Apache on CentOS
        <span style="color: #0087ff;">yum</span>: name=httpd state=present
        <span style="color: #0087ff;">when</span>: ansible_os_family ==<span style="color: #00afaf;">"CentOS"</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> 循环</h3>
<div class="outline-text-3" id="text-6-2">
</div><div id="outline-container-sec-6-2-1" class="outline-4">
<h4 id="sec-6-2-1"><span class="section-number-4">6.2.1</span> with_items</h4>
</div>
<div id="outline-container-sec-6-2-2" class="outline-4">
<h4 id="sec-6-2-2"><span class="section-number-4">6.2.2</span> with_nested</h4>
</div>
<div id="outline-container-sec-6-2-3" class="outline-4">
<h4 id="sec-6-2-3"><span class="section-number-4">6.2.3</span> with_dict</h4>
</div>
<div id="outline-container-sec-6-2-4" class="outline-4">
<h4 id="sec-6-2-4"><span class="section-number-4">6.2.4</span> with_subelement</h4>
</div>
<div id="outline-container-sec-6-2-5" class="outline-4">
<h4 id="sec-6-2-5"><span class="section-number-4">6.2.5</span> with_sequence</h4>
</div>
<div id="outline-container-sec-6-2-6" class="outline-4">
<h4 id="sec-6-2-6"><span class="section-number-4">6.2.6</span> with_random_choice</h4>
</div>
<div id="outline-container-sec-6-2-7" class="outline-4">
<h4 id="sec-6-2-7"><span class="section-number-4">6.2.7</span> do_util</h4>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> 条件</h3>
<div class="outline-text-3" id="text-6-3">
</div><div id="outline-container-sec-6-3-1" class="outline-4">
<h4 id="sec-6-3-1"><span class="section-number-4">6.3.1</span> when</h4>
<div class="outline-text-4" id="text-6-3-1">
</div><div id="outline-container-sec-6-3-1-1" class="outline-5">
<h5 id="sec-6-3-1-1"><span class="section-number-5">6.3.1.1</span> jinja2 语法</h5>
</div>

<div id="outline-container-sec-6-3-1-2" class="outline-5">
<h5 id="sec-6-3-1-2"><span class="section-number-5">6.3.1.2</span> 变量不存在</h5>
<div class="outline-text-5" id="text-6-3-1-2">
<div class="org-src-container">

<pre class="src src-yaml"><span style="color: #0087ff;">tasks</span>:
  - <span style="color: #0087ff;">shell</span>: echo <span style="color: #00afaf;">"I've got '{{ foo }}' and am not afraid to use it!"</span>
    <span style="color: #0087ff;">when</span>: foo is defined
  - <span style="color: #0087ff;">fail</span>: msg=<span style="color: #00afaf;">"Bailing out. this play requires 'bar'"</span>
    <span style="color: #0087ff;">when</span>: bar is not defined
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-3-1-3" class="outline-5">
<h5 id="sec-6-3-1-3"><span class="section-number-5">6.3.1.3</span> 用于循环</h5>
<div class="outline-text-5" id="text-6-3-1-3">
<div class="org-src-container">

<pre class="src src-yaml"><span style="color: #0087ff;">tasks</span>:
  - <span style="color: #0087ff;">command</span>: echo {{ item }}
    <span style="color: #0087ff;">with_items</span>: [ 0, 2, 4, 6, 8, 10 ]
    <span style="color: #0087ff;">when</span>: item &gt; 56
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-3-1-4" class="outline-5">
<h5 id="sec-6-3-1-4"><span class="section-number-5">6.3.1.4</span> 用于 include</h5>
<div class="outline-text-5" id="text-6-3-1-4">
<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">include</span>: tasks/sometasks.yml
  <span style="color: #0087ff;">when</span>: <span style="color: #00afaf;">"'reticulating splines' in output"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-3-1-5" class="outline-5">
<h5 id="sec-6-3-1-5"><span class="section-number-5">6.3.1.5</span> 用于 roles</h5>
<div class="outline-text-5" id="text-6-3-1-5">
<div class="org-src-container">

<pre class="src src-yaml">- <span style="color: #0087ff;">hosts</span>: webservers
  <span style="color: #0087ff;">roles</span>:
     - { <span style="color: #0087ff;">role</span>: debian_stock_config, <span style="color: #0087ff;">when</span>: ansible_os_family == <span style="color: #00afaf;">'Debian'</span> }
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> handlers</h3>
<div class="outline-text-3" id="text-6-4">
<p>
用于当关注的资源发生变化时采取一定的操作。
</p>

<p>
notify 这个 action 可用于在每个 play 的最后被触发，这样可以避免多次有改变发生时每次都执行指定的操作，
而仅在所有的变化发生完成后 <b>一次性</b> 地执行指定操作。
</p>
</div>
</div>
</div>


<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Role</h2>
<div class="outline-text-2" id="text-7">
<p>
在 Ansible 中，Playbook 组织 Task ，Role 组织 Playbook 。
</p>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> 创建</h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">

<pre class="src src-sh">ansible-galaxy init &lt;role&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-7-1-1" class="outline-4">
<h4 id="sec-7-1-1"><span class="section-number-4">7.1.1</span> roles 各目录的作用</h4>
<div class="outline-text-4" id="text-7-1-1">
<dl class="org-dl">
<dt> files </dt><dd>  存放由 copy 或 script 等模块调用的文件
</dd>

<dt> tempaltes </dt><dd>  Jinja2 模板文件
</dd>

<dt> tasks </dt><dd>  定义了角色的任务列表。

<p>
可以使用 include 包含其他的位于此目录中的 task 文件。
</p>
</dd>
</dl>


<dl class="org-dl">
<dt> handlers </dt><dd>  用于定义角色用到的各 handler 。

<p>
在 handler 中可以使用 include 包含的其他位于此目录中 的 handler 文件。
</p>
</dd>

<dt> vars </dt><dd>  用于定义角色用到的变量
</dd>

<dt> meta </dt><dd>  定义角色的特殊设定及依赖关系等
</dd>

<dt> default </dt><dd>  设定默认变量
</dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> pre_tasks 和 post_tasks</h3>
<div class="outline-text-3" id="text-7-2">
<p>
在执行 roles 时，需要在其前或其后执行某些任务，可以使用 pre_tasks 及 post_tasks 来声明。
</p>
</div>
</div>

<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> 依赖</h3>
<div class="outline-text-3" id="text-7-3">
<p>
如果当前 role 在执行前需要依赖另一个 role ，可以在 meta 目录中的 main.yml 文件中定义依赖关系。
</p>

<div class="org-src-container">

<pre class="src src-yaml"><span style="color: #0087ff;">dependencies</span>:
  - { <span style="color: #0087ff;">role</span>: common, <span style="color: #0087ff;">some_parameter</span>: 3 }
  - { <span style="color: #0087ff;">role</span>: postgres, <span style="color: #0087ff;">dbname</span>: blarg, <span style="color: #0087ff;">other_parameter</span>: 12 }
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> 项目结构</h3>
<div class="outline-text-3" id="text-7-4">
<pre class="example">
site.yml
ancible.cfg
hosts
group_vars/
   all
   group-1
   group-2
host_var/
   all
   host-1
   host-2
roles/
   common/
     files/
     templates/
     tasks/
     handlers/
     vars/
     defaults/
     meta/
   web/
     files/
     templates/
     tasks/
     handlers/
     vars/
     defaults/
     meta/
</pre>
</div>

<div id="outline-container-sec-7-4-1" class="outline-4">
<h4 id="sec-7-4-1"><span class="section-number-4">7.4.1</span> 入口文件 (site.xml)</h4>
<div class="outline-text-4" id="text-7-4-1">
<pre class="example">
---
- hosts: webservers
  user: root
  roles:
     - common
     - web
</pre>
</div>
</div>

<div id="outline-container-sec-7-4-2" class="outline-4">
<h4 id="sec-7-4-2"><span class="section-number-4">7.4.2</span> 执行</h4>
<div class="outline-text-4" id="text-7-4-2">
<div class="org-src-container">

<pre class="src src-sh">ansible-playbook site.yml -vvv
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>